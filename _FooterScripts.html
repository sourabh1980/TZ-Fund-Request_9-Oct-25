<!-- _FooterScripts.html -->
<!-- Helper to reset/append rows from beneficiaries (used by _ProjectPicker) -->
<script>
(function(){
  'use strict';

  // ========================= Vehicle In Use Prefill =========================
  const VEHICLE_IN_USE_CACHE_KEY = 'vehicleInUseAssignments.v1';

  const vehicleInUseState = (function(){
    const exact = (window.vehicleInUseMap && typeof window.vehicleInUseMap === 'object') ? window.vehicleInUseMap : Object.create(null);
    const lower = (window.vehicleInUseLowerMap && typeof window.vehicleInUseLowerMap === 'object') ? window.vehicleInUseLowerMap : Object.create(null);
    const teamPairs = (window.vehicleInUseTeamMap && typeof window.vehicleInUseTeamMap === 'object') ? window.vehicleInUseTeamMap : Object.create(null);
    const projectPairs = (window.vehicleInUseProjectMap && typeof window.vehicleInUseProjectMap === 'object') ? window.vehicleInUseProjectMap : Object.create(null);
    const records = Array.isArray(window.vehicleInUseRecords) ? window.vehicleInUseRecords.slice() : [];
    return {
      exact: exact,
      lower: lower,
      teamPairs: teamPairs,
      projectPairs: projectPairs,
      records: records,
      fetching: false,
      updatedAt: '',
      lastError: null
    };
  })();

  window.vehicleInUseMap = vehicleInUseState.exact;
  window.vehicleInUseLowerMap = vehicleInUseState.lower;
  window.vehicleInUseTeamMap = vehicleInUseState.teamPairs;
  window.vehicleInUseProjectMap = vehicleInUseState.projectPairs;
  if (!Array.isArray(window.vehicleInUseRecords)) {
    window.vehicleInUseRecords = vehicleInUseState.records;
  }
  if (!window.vehicleReleaseSnapshots || typeof window.vehicleReleaseSnapshots !== 'object') {
    window.vehicleReleaseSnapshots = {};
  }
  window.vehicleReleaseSnapshotsReady = window.vehicleReleaseSnapshotsReady === true;

  if (!window.carTPVehicleMeta || typeof window.carTPVehicleMeta !== 'object') {
    window.carTPVehicleMeta = {};
  }
  window.carTPVehicleMetaReady = window.carTPVehicleMetaReady === true;

  const hasOwn = Object.prototype.hasOwnProperty;
  const NORMALIZE_CACHE_LIMIT = 4000;
  const NAME_NORMALIZE_CACHE = { map: Object.create(null), keys: [] };
  const VEHICLE_NORMALIZE_CACHE = { map: Object.create(null), keys: [] };

  function resetNormalizationCache(cacheState){
    cacheState.map = Object.create(null);
    cacheState.keys.length = 0;
  }

  function invalidateVehicleNormalizationCache(){
    resetNormalizationCache(VEHICLE_NORMALIZE_CACHE);
  }

  function normalizeName(value) {
    const raw = value == null ? '' : String(value);
    if (!raw) return '';
    const cache = NAME_NORMALIZE_CACHE.map;
    if (hasOwn.call(cache, raw)) {
      return cache[raw];
    }
    const normalized = raw
      .replace(/\u00A0/g, ' ')
      .replace(/\s+/g, ' ')
      .trim()
      .toLowerCase();
    if (NAME_NORMALIZE_CACHE.keys.length >= NORMALIZE_CACHE_LIMIT) {
      resetNormalizationCache(NAME_NORMALIZE_CACHE);
    }
    NAME_NORMALIZE_CACHE.map[raw] = normalized;
    NAME_NORMALIZE_CACHE.keys.push(raw);
    return normalized;
  }

  function vehicleNameKey(name){
    return normalizeName(name);
  }

  function onNextFrame(fn) {
    if (typeof fn !== 'function') return;
    if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {
      window.requestAnimationFrame(fn);
    } else {
      setTimeout(fn, 16);
    }
  }

  function stripNameKey(name) {
    return String(name || '')
      .replace(/[^a-z0-9]/gi, '')
      .toLowerCase();
  }

  function beneficiaryKeysMatch(a, b) {
    const keyA = String(a || '').trim().toLowerCase();
    const keyB = String(b || '').trim().toLowerCase();
    if (!keyA || !keyB) return false;
    if (keyA === keyB) return true;
    if (keyA.startsWith(keyB) || keyB.startsWith(keyA)) return true;
    const strippedA = stripNameKey(keyA);
    const strippedB = stripNameKey(keyB);
    if (strippedA && strippedA === strippedB) return true;
    return false;
  }

  const DEFAULT_DA_CACHE_STATE = { map: null, built: false };

  function ensureDefaultDaCache(){
    if (DEFAULT_DA_CACHE_STATE.built && DEFAULT_DA_CACHE_STATE.map) {
      return DEFAULT_DA_CACHE_STATE.map;
    }
    const map = new Map();
    try {
      const tag = document.getElementById('DDC');
      if (tag) {
        const pack = JSON.parse(tag.textContent || '{}');
        if (pack && Array.isArray(pack.rows)) {
          pack.rows.forEach(function(row){
            if (!row) return;
            const beneficiary = String(row[0] || '').trim();
            if (!beneficiary) return;
            const rate = Number(row[3]);
            const finite = typeof Number.isFinite === 'function' ? Number.isFinite(rate) : isFinite(rate);
            map.set(normalizeName(beneficiary), finite ? rate : 0);
          });
        }
      }
    } catch (err) {
      console.warn('Failed to build Default DA cache', err);
    }
    DEFAULT_DA_CACHE_STATE.map = map;
    DEFAULT_DA_CACHE_STATE.built = true;
    return map;
  }

  function lookupDefaultDaRate(name){
    if (!name) return null;
    const normalized = normalizeName(name);
    if (!normalized) return null;
    const map = ensureDefaultDaCache();
    if (!map || !map.has(normalized)) return null;
    const value = map.get(normalized);
    return typeof value === 'number' && !isNaN(value) ? value : null;
  }

  window.getDefaultDaRateForBeneficiary = function(name){
    return lookupDefaultDaRate(name);
  };

  function applyDefaultDaToRow(row, beneficiaryName, explicitRate){
    if (!row) return;
    let rate = null;
    if (typeof explicitRate === 'number' && !isNaN(explicitRate)) {
      rate = explicitRate;
    } else if (beneficiaryName) {
      const lookup = lookupDefaultDaRate(beneficiaryName);
      if (lookup !== null && lookup !== undefined) {
        rate = lookup;
      }
    }

    if (rate !== null && rate !== undefined && !isNaN(rate)) {
      try { row.dataset.defaultDa = String(rate); } catch(_){ /* ignore */ }
    } else {
      try { delete row.dataset.defaultDa; } catch(_){ /* ignore */ }
    }
  }

  function getAssignedVehicleNumber(beneficiary, teamKey, projectKey) {
    const normalizedName = vehicleNameKey(beneficiary);
    const normalizedTeamKey = teamNameKey(teamKey || '');
    const normalizedProjectKey = projectNameKey(projectKey || '');

    const records = Array.isArray(vehicleInUseState.records)
      ? vehicleInUseState.records
      : (Array.isArray(window.vehicleInUseRecords) ? window.vehicleInUseRecords : []);

    if (records && records.length) {
      let projectMatch = '';
      let teamMatch = '';
      let nameOnlyMatch = '';

      for (var i = 0; i < records.length; i++) {
        const rec = records[i];
        if (!rec) continue;
        const recKey = rec.key || vehicleNameKey(rec.beneficiary || rec.responsibleBeneficiary || '');
        if (!beneficiaryKeysMatch(recKey, normalizedName)) continue;

        const recProjectKey = projectNameKey(rec.project);
        const recTeamKey = teamNameKey(rec.team);
        const vehicleValue = String(rec.vehicleNumber || '');

        if (normalizedProjectKey && recProjectKey === normalizedProjectKey) {
          projectMatch = vehicleValue;
          break;
        }

        if (!projectMatch && normalizedTeamKey && recTeamKey && recTeamKey === normalizedTeamKey && !teamMatch) {
          teamMatch = vehicleValue;
        }

        if (!projectMatch && !teamMatch && !nameOnlyMatch) {
          nameOnlyMatch = vehicleValue;
        }
      }

      if (projectMatch) return projectMatch;
      if (teamMatch) return teamMatch;
      if (nameOnlyMatch) return nameOnlyMatch;
    }

    const exactMap = vehicleInUseState.exact;
    if (exactMap && typeof exactMap === 'object') {
      for (const name in exactMap) {
        if (!Object.prototype.hasOwnProperty.call(exactMap, name)) continue;
        if (beneficiaryKeysMatch(name, beneficiary)) {
          return String(exactMap[name] || '');
        }
      }
    }

    const lowerMap = vehicleInUseState.lower;
    if (lowerMap && typeof lowerMap === 'object') {
      if (lowerMap[normalizedName]) return String(lowerMap[normalizedName] || '');
      for (const key in lowerMap) {
        if (!Object.prototype.hasOwnProperty.call(lowerMap, key)) continue;
        if (beneficiaryKeysMatch(key, normalizedName)) {
          return String(lowerMap[key] || '');
        }
      }
    }

    return '';
  }

  function teamNameKey(name){
    return normalizeName(name);
  }

  function projectNameKey(name){
    return normalizeName(name);
  }

  function parseVehicleDate(value){
    if (value instanceof Date) return value.getTime();
    if (typeof value === 'number' && !isNaN(value)) return value;
    if (!value) return 0;
    const parsed = Date.parse(value);
    return isNaN(parsed) ? 0 : parsed;
  }

  function clearObject(obj){
    if (!obj) return;
    Object.keys(obj).forEach(function(key){ delete obj[key]; });
    for (const key in obj) {
      if (Object.prototype.hasOwnProperty.call(obj, key)) {
        delete obj[key];
      }
    }
  }

  function applyVehicleInUseAssignmentsToRows(force){
    const rows = document.querySelectorAll('.tbody .row-data');
    rows.forEach(function(row){
      const benInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
      const carInput = row.querySelector('input.car-number-input');
      if (!benInput || !carInput) return;
      const beneficiary = String(benInput.value || '').trim();
      if (!beneficiary) return;
      const rowTeam = String(row.dataset.team || row.getAttribute('data-team') || '').trim();
      const rowProject = String(row.dataset.project || row.getAttribute('data-project') || '').trim();
      const teamKey = teamNameKey(rowTeam);
      const projectKey = projectNameKey(rowProject);
      let assignedVehicle = getAssignedVehicleNumber(beneficiary, teamKey, projectKey);
      const currentValue = String(carInput.value || '').trim();
      const dataset = carInput.dataset;
      const isPrefilled = dataset && dataset.prefillSource === 'Vehicle_InUse';

      if (!assignedVehicle) {
        const hasPrefillVehicle = dataset && dataset.prefillSource === 'Vehicle_InUse';
        const shouldClear = currentValue && (hasPrefillVehicle || (!dataset || !dataset.prefillSource) && force);
        if (shouldClear) {
          carInput.value = '';
          try { if (hasPrefillVehicle && dataset) { delete dataset.prefillSource; } } catch(_){ /* ignore */ }
          try { if (hasPrefillVehicle) { carInput.removeAttribute('data-prefill-source'); } } catch(_){ /* ignore */ }
          try { carInput.dispatchEvent(new Event('input', { bubbles: true })); } catch(_){ /* ignore */ }
        }
        return;
      }

      if (force || !currentValue || isPrefilled) {
        if (currentValue !== assignedVehicle) {
          carInput.value = assignedVehicle;
          try { if (dataset) { dataset.prefillSource = 'Vehicle_InUse'; } } catch(_){ /* ignore */ }
          try { carInput.setAttribute('data-prefill-source', 'Vehicle_InUse'); } catch(_){ /* ignore */ }
          try { carInput.dispatchEvent(new Event('input', { bubbles: true })); } catch(_){ /* ignore */ }
        } else if (!isPrefilled) {
          try { if (dataset) { dataset.prefillSource = 'Vehicle_InUse'; } } catch(_){ /* ignore */ }
          try { carInput.setAttribute('data-prefill-source', 'Vehicle_InUse'); } catch(_){ /* ignore */ }
        }
      }
    });

    try { highlightDuplicateVehicleCells(); } catch(_){ /* ignore */ }
  }
  window.applyVehicleInUseAssignmentsToRows = applyVehicleInUseAssignmentsToRows;

  const VEHICLE_DUPLICATE_COLORS = ['#fef9c3', '#e0f2fe', '#fce7f3', '#dcfce7', '#ede9fe', '#fee2e2'];

  function highlightDuplicateVehicleCells(){
    const inputs = document.querySelectorAll('.tbody .row-data input.car-number-input');
    if (!inputs || !inputs.length) return;

    inputs.forEach(function(input){
      if (!input) return;
      input.style.backgroundColor = '';
      try { input.classList.remove('vehicle-duplicate-highlight'); } catch(_){ /* ignore */ }
    });

    const groups = new Map();
    inputs.forEach(function(input){
      if (!input) return;
      const value = String(input.value || '').trim().toUpperCase();
      if (!value) return;
      if (!groups.has(value)) groups.set(value, []);
      groups.get(value).push(input);
    });

    let colorIndex = 0;
    groups.forEach(function(list){
      if (!Array.isArray(list) || list.length < 2) return;
      const color = VEHICLE_DUPLICATE_COLORS[colorIndex % VEHICLE_DUPLICATE_COLORS.length];
      colorIndex++;
      list.forEach(function(input){
        if (!input) return;
        input.style.backgroundColor = color;
        try { input.classList.add('vehicle-duplicate-highlight'); } catch(_){ /* ignore */ }
      });
    });
  }
  window.highlightDuplicateVehicleCells = highlightDuplicateVehicleCells;

  document.addEventListener('input', function(event){
    try {
      const target = event && event.target;
      if (!target) return;
      if (target.classList && target.classList.contains('car-number-input')) {
        highlightDuplicateVehicleCells();
      }
    } catch(_){ /* ignore */ }
  });

  const vehicleInUseRetryManager = {
    timer: null,
    attempts: 0,
    maxAttempts: 0,
    delay: 300
  };

  function scheduleVehicleInUseReapply(options){
    const opts = options && typeof options === 'object' ? options : {};
    const attempts = Number.isFinite(opts.attempts) && opts.attempts > 0 ? Math.floor(opts.attempts) : 5;
    const delay = Number.isFinite(opts.delay) && opts.delay > 0 ? opts.delay : 300;

    if (vehicleInUseRetryManager.timer) {
      clearTimeout(vehicleInUseRetryManager.timer);
      vehicleInUseRetryManager.timer = null;
    }

    vehicleInUseRetryManager.attempts = 0;
    vehicleInUseRetryManager.maxAttempts = attempts;
    vehicleInUseRetryManager.delay = delay;

    function runAttempt(){
      vehicleInUseRetryManager.timer = null;
      vehicleInUseRetryManager.attempts++;
      try {
        applyVehicleInUseAssignmentsToRows(false);
      } catch (retryErr) {
        console.warn('[VehicleInUse] Retry prefill failed', retryErr);
      }
      if (vehicleInUseRetryManager.attempts < vehicleInUseRetryManager.maxAttempts) {
        vehicleInUseRetryManager.timer = setTimeout(runAttempt, vehicleInUseRetryManager.delay);
      }
    }

    runAttempt();
  }

  const vehicleMatchPopupState = {
    shown: false,
    setup: false,
    lastSelectionKey: '',
    matches: [],
    lastSummary: ''
  };

  const vehicleRatingsPopupState = {
    setup: false
  };

  const vehicleReleasePrefetchState = {
    entries: Object.create(null),
    maxAgeMs: 600000
  };

  function vehicleReleasePrefetchKey(value){
    const normalized = normalizeVehicleNumber(value);
    return normalized ? normalized.toUpperCase() : '';
  }

  function vehicleReleaseTeamKey(value){
    return String(value || '').trim().toLowerCase();
  }

  function flushPrefetchListeners(list, type, payload){
    if (!Array.isArray(list) || !list.length) return;
    const listeners = list.splice(0);
    listeners.forEach(function(listener){
      if (!listener || typeof listener !== 'object') return;
      try {
        if (type === 'success' && typeof listener.onSuccess === 'function') {
          listener.onSuccess(payload);
        } else if (type === 'failure' && typeof listener.onFailure === 'function') {
          listener.onFailure(payload);
        }
      } catch(_){ /* ignore */ }
    });
  }

  function getVehicleReleaseEntry(carNumber){
    const key = vehicleReleasePrefetchKey(carNumber);
    if (!key) return null;
    const entry = vehicleReleasePrefetchState.entries[key] || null;
    if (entry) entry.lastTouched = Date.now();
    return entry;
  }

  function ensureVehicleReleaseEntry(carNumber){
    const key = vehicleReleasePrefetchKey(carNumber);
    if (!key) return null;
    let entry = vehicleReleasePrefetchState.entries[key];
    if (!entry) {
      entry = {
        carNumber: key,
        detailsReady: false,
        detailsPending: false,
        details: null,
        detailsError: null,
        detailListeners: [],
        releaseReady: false,
        releasePending: false,
        releaseRows: null,
        releaseError: null,
        releaseListeners: [],
        inUseByTeam: Object.create(null),
        lastTouched: Date.now()
      };
      vehicleReleasePrefetchState.entries[key] = entry;
    } else {
      entry.lastTouched = Date.now();
    }
    return entry;
  }

  function ensureInUseBucket(entry, teamName){
    if (!entry) return null;
    const key = vehicleReleaseTeamKey(teamName);
    let bucket = entry.inUseByTeam[key];
    if (!bucket) {
      bucket = {
        teamKey: key,
        teamName: teamName || '',
        ready: false,
        pending: false,
        rows: null,
        error: null,
        listeners: [],
        lastTouched: Date.now()
      };
      entry.inUseByTeam[key] = bucket;
    } else {
      bucket.lastTouched = Date.now();
      if (!bucket.teamName && teamName) bucket.teamName = teamName;
    }
    return bucket;
  }

  function resolveDetailSuccess(entry, payload){
    if (!entry) return;
    entry.details = payload;
    entry.detailsReady = true;
    entry.detailsPending = false;
    entry.detailsError = null;
    flushPrefetchListeners(entry.detailListeners, 'success', payload);
  }

  function resolveDetailFailure(entry, error){
    if (!entry) return;
    entry.detailsReady = false;
    entry.detailsPending = false;
    entry.detailsError = error || null;
    flushPrefetchListeners(entry.detailListeners, 'failure', error);
  }

  function resolveReleaseHistorySuccess(entry, rows){
    if (!entry) return;
    entry.releaseRows = rows;
    entry.releaseReady = true;
    entry.releasePending = false;
    entry.releaseError = null;
    flushPrefetchListeners(entry.releaseListeners, 'success', rows);
  }

  function resolveReleaseHistoryFailure(entry, error){
    if (!entry) return;
    entry.releaseReady = false;
    entry.releasePending = false;
    entry.releaseError = error || null;
    flushPrefetchListeners(entry.releaseListeners, 'failure', error);
  }

  function resolveInUseHistorySuccess(bucket, rows){
    if (!bucket) return;
    bucket.rows = rows;
    bucket.ready = true;
    bucket.pending = false;
    bucket.error = null;
    flushPrefetchListeners(bucket.listeners, 'success', rows);
  }

  function resolveInUseHistoryFailure(bucket, error){
    if (!bucket) return;
    bucket.ready = false;
    bucket.pending = false;
    bucket.error = error || null;
    flushPrefetchListeners(bucket.listeners, 'failure', error);
  }

  function requestVehicleReleaseDetails(carNumber, hooks){
    const entry = ensureVehicleReleaseEntry(carNumber);
    if (!entry) return null;
    if (hooks && typeof hooks === 'object') {
      if (entry.detailsReady) {
        try { if (typeof hooks.onSuccess === 'function') hooks.onSuccess(entry.details); } catch(_){ /* ignore */ }
      } else if (entry.detailsError) {
        try { if (typeof hooks.onFailure === 'function') hooks.onFailure(entry.detailsError); } catch(_){ /* ignore */ }
      } else {
        entry.detailListeners.push(hooks);
      }
    }
    if (entry.detailsReady || entry.detailsPending) return entry;
    if (!(window.google && google.script && google.script.run)) return entry;

    entry.detailsPending = true;
    google.script.run
      .withSuccessHandler(function(res){
        resolveDetailSuccess(entry, res);
      })
      .withFailureHandler(function(err){
        resolveDetailFailure(entry, err);
      })
      .getCarReleaseDetails(carNumber);
    return entry;
  }

  function requestVehicleReleaseHistory(carNumber, hooks){
    const entry = ensureVehicleReleaseEntry(carNumber);
    if (!entry) return null;
    if (hooks && typeof hooks === 'object') {
      if (entry.releaseReady) {
        try { if (typeof hooks.onSuccess === 'function') hooks.onSuccess(entry.releaseRows); } catch(_){ /* ignore */ }
      } else if (entry.releaseError) {
        try { if (typeof hooks.onFailure === 'function') hooks.onFailure(entry.releaseError); } catch(_){ /* ignore */ }
      } else {
        entry.releaseListeners.push(hooks);
      }
    }
    if (entry.releaseReady || entry.releasePending) return entry;
    if (!(window.google && google.script && google.script.run)) return entry;

    entry.releasePending = true;
    google.script.run
      .withSuccessHandler(function(rows){
        resolveReleaseHistorySuccess(entry, rows);
      })
      .withFailureHandler(function(err){
        resolveReleaseHistoryFailure(entry, err);
      })
      .getReleaseHistoryForcedWorking(carNumber);
    return entry;
  }

  function requestVehicleInUseHistory(carNumber, teamName, hooks){
    const entry = ensureVehicleReleaseEntry(carNumber);
    if (!entry) return null;
    const bucket = ensureInUseBucket(entry, teamName);
    if (!bucket) return entry;
    if (hooks && typeof hooks === 'object') {
      if (bucket.ready) {
        try { if (typeof hooks.onSuccess === 'function') hooks.onSuccess(bucket.rows); } catch(_){ /* ignore */ }
      } else if (bucket.error) {
        try { if (typeof hooks.onFailure === 'function') hooks.onFailure(bucket.error); } catch(_){ /* ignore */ }
      } else {
        bucket.listeners.push(hooks);
      }
    }
    if (bucket.ready || bucket.pending) return entry;
    if (!(window.google && google.script && google.script.run)) return entry;

    bucket.pending = true;
    const teamLabel = bucket.teamName || teamName || '';
    google.script.run
      .withSuccessHandler(function(rows){
        resolveInUseHistorySuccess(bucket, rows);
      })
      .withFailureHandler(function(err){
        resolveInUseHistoryFailure(bucket, err);
      })
      .getInUseHistoryForcedWorking(carNumber, teamLabel);
    return entry;
  }

  function pruneVehicleReleasePrefetch(){
    const maxAge = vehicleReleasePrefetchState.maxAgeMs;
    if (!Number.isFinite(maxAge) || maxAge <= 0) return;
    const keys = Object.keys(vehicleReleasePrefetchState.entries);
    if (keys.length <= 40) return;
    const now = Date.now();
    keys.forEach(function(key){
      const entry = vehicleReleasePrefetchState.entries[key];
      if (!entry || entry.detailsPending || entry.releasePending) return;
      let teamPending = false;
      for (const teamKey in entry.inUseByTeam) {
        if (!Object.prototype.hasOwnProperty.call(entry.inUseByTeam, teamKey)) continue;
        const bucket = entry.inUseByTeam[teamKey];
        if (bucket && bucket.pending) {
          teamPending = true;
          break;
        }
      }
      if (teamPending) return;
      if (now - (entry.lastTouched || 0) > maxAge) {
        delete vehicleReleasePrefetchState.entries[key];
      }
    });
  }

  function invalidateVehicleReleaseEntry(carNumber){
    const key = vehicleReleasePrefetchKey(carNumber);
    if (!key) return;
    if (vehicleReleasePrefetchState.entries[key]) {
      delete vehicleReleasePrefetchState.entries[key];
    }
  }

  function invalidateVehicleReleaseTeam(carNumber, teamName){
    const entry = getVehicleReleaseEntry(carNumber);
    if (!entry) return;
    if (!teamName) {
      entry.inUseByTeam = Object.create(null);
      return;
    }
    const teamKey = vehicleReleaseTeamKey(teamName);
    if (teamKey && entry.inUseByTeam && entry.inUseByTeam[teamKey]) {
      delete entry.inUseByTeam[teamKey];
    }
  }

  function prefetchVehicleReleaseData(matches){
    if (!Array.isArray(matches) || !matches.length) return;
    const seen = new Set();
    matches.forEach(function(match){
      if (!match) return;
      const vehicleNumber = match.vehicle || match.vehicleNumber || match.carNumber || '';
      const key = vehicleReleasePrefetchKey(vehicleNumber);
      if (!key || seen.has(key)) return;
      seen.add(key);
      const teamLabel = match.teamName || match.team || '';
      requestVehicleReleaseDetails(vehicleNumber);
      requestVehicleReleaseHistory(vehicleNumber);
      requestVehicleInUseHistory(vehicleNumber, teamLabel);
    });
    pruneVehicleReleasePrefetch();
  }

  window.vehicleReleasePrefetch = {
    state: vehicleReleasePrefetchState,
    primeMatches: prefetchVehicleReleaseData,
    requestDetails: requestVehicleReleaseDetails,
    requestReleaseHistory: requestVehicleReleaseHistory,
    requestInUseHistory: requestVehicleInUseHistory,
    getDetails: function(carNumber){
      const entry = getVehicleReleaseEntry(carNumber);
      return entry && entry.detailsReady ? entry.details : null;
    },
    getReleaseHistory: function(carNumber){
      const entry = getVehicleReleaseEntry(carNumber);
      return entry && entry.releaseReady ? entry.releaseRows : null;
    },
    getInUseHistory: function(carNumber, teamName){
      const entry = getVehicleReleaseEntry(carNumber);
      if (!entry) return null;
      const bucket = entry.inUseByTeam[vehicleReleaseTeamKey(teamName)];
      return bucket && bucket.ready ? bucket.rows : null;
    },
    clear: function(){
      vehicleReleasePrefetchState.entries = Object.create(null);
    },
    invalidate: invalidateVehicleReleaseEntry,
    invalidateTeam: invalidateVehicleReleaseTeam,
    storeDetails: function(carNumber, payload){
      resolveDetailSuccess(ensureVehicleReleaseEntry(carNumber), payload);
    },
    storeDetailsError: function(carNumber, error){
      resolveDetailFailure(ensureVehicleReleaseEntry(carNumber), error);
    },
    storeReleaseHistory: function(carNumber, rows){
      resolveReleaseHistorySuccess(ensureVehicleReleaseEntry(carNumber), rows);
    },
    storeReleaseHistoryError: function(carNumber, error){
      resolveReleaseHistoryFailure(ensureVehicleReleaseEntry(carNumber), error);
    },
    storeInUseHistory: function(carNumber, teamName, rows){
      const entry = ensureVehicleReleaseEntry(carNumber);
      resolveInUseHistorySuccess(ensureInUseBucket(entry, teamName), rows);
    },
    storeInUseHistoryError: function(carNumber, teamName, error){
      const entry = ensureVehicleReleaseEntry(carNumber);
      resolveInUseHistoryFailure(ensureInUseBucket(entry, teamName), error);
    }
  };

  function setupVehicleMatchPopup(){
    if (vehicleMatchPopupState.setup) return;
    const modal = document.getElementById('vehicleMatchModal');
    if (!modal) return;
    vehicleMatchPopupState.setup = true;
    const closeBtn = modal.querySelector('.vehicle-match-close');
    const ratingsBtn = modal.querySelector('.vehicle-match-ratings');
    const close = function(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    };
    if (closeBtn) closeBtn.addEventListener('click', close);
    modal.addEventListener('click', function(event){
      if (event.target === modal) close();
    });
    document.addEventListener('keydown', function(event){
      if (event.key === 'Escape' && modal.style.display === 'grid') {
        close();
      }
    });
    if (ratingsBtn) {
      ratingsBtn.addEventListener('click', function(){
        openVehicleRatingsPopup(vehicleMatchPopupState.matches || []);
      });
    }
    window.closeVehicleMatchPopup = close;
  }

  function setupVehicleRatingsPopup(){
    if (vehicleRatingsPopupState.setup) return;
    const modal = document.getElementById('vehicleRatingsModal');
    if (!modal) return;
    vehicleRatingsPopupState.setup = true;
    const closeBtn = modal.querySelector('.vehicle-ratings-close');
    const close = function(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    };
    if (closeBtn) closeBtn.addEventListener('click', close);
    modal.addEventListener('click', function(event){
      if (event.target === modal) close();
    });
    document.addEventListener('keydown', function(event){
      if (event.key === 'Escape' && modal.style.display === 'grid') {
        close();
      }
    });
    window.closeVehicleRatingsPopup = close;
  }

  function openVehicleRatingsPopup(matches){
    setupVehicleRatingsPopup();
    const modal = document.getElementById('vehicleRatingsModal');
    if (!modal) return;
    populateVehicleRatingsPopup(Array.isArray(matches) ? matches : []);
    modal.style.display = 'grid';
    modal.setAttribute('aria-hidden', 'false');
  }

  function collectVisibleVehicleMatches(){
    const rows = document.querySelectorAll('.tbody .row-data');
    if (!rows || !rows.length) return [];
    const seen = new Set();
    const recordByKey = new Map();
    const recordList = Array.isArray(vehicleInUseState.records) ? vehicleInUseState.records : [];
    recordList.forEach(function(rec){
      if (!rec) return;
      const vehicleNumber = normalizeVehicleNumber(rec.vehicleNumber || rec.carNumber || '');
      const beneficiary = String(rec.responsibleBeneficiary || rec.beneficiary || rec.member || '').trim().toLowerCase();
      if (!vehicleNumber || !beneficiary) return;
      recordByKey.set(beneficiary + '|' + vehicleNumber, rec);
    });
    const matches = [];
    rows.forEach(function(row){
      if (!row) return;
      const benInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
      const carInput = row.querySelector('input.car-number-input');
      if (!benInput || !carInput) return;
      const beneficiary = String(benInput.value || '').trim();
      const vehicle = String(carInput.value || '').trim();
      if (!beneficiary || !vehicle) return;
      const dataset = carInput.dataset || {};
      const prefillSource = dataset.prefillSource || carInput.getAttribute && carInput.getAttribute('data-prefill-source');
      if (prefillSource !== 'Vehicle_InUse') return;
      const team = String(row.dataset.team || row.getAttribute('data-team') || '').trim();
      const project = String(row.dataset.project || row.getAttribute('data-project') || '').trim();
      const key = [beneficiary.toLowerCase(), team.toLowerCase(), project.toLowerCase(), vehicle.toLowerCase()].join('|');
      if (seen.has(key)) return;
      seen.add(key);
      const recKey = beneficiary.toLowerCase() + '|' + vehicle.toUpperCase();
      const record = recordByKey.get(recKey) || null;
      let daysInUse = null;
      let entryDateDisplay = '';
      if (record) {
        const ts = typeof record.entryTimestamp === 'number' ? record.entryTimestamp : parseVehicleDate(record.entryDate);
        if (ts && !isNaN(ts) && ts > 0) {
          const diff = Date.now() - ts;
          if (diff >= 0) {
            daysInUse = Math.floor(diff / 86400000) + 1;
          }
        }
        entryDateDisplay = formatEntryDateDisplay(
          typeof record.entryTimestamp === 'number' ? record.entryTimestamp : parseVehicleDate(record.entryDate),
          record.entryDate || record.entryTimestamp
        );
      }
    const releaseMeta = getVehicleMetaSummary(vehicle);
    const mergedMeta = mergeVehicleMetaSources(vehicle, releaseMeta, record);
      matches.push({
        beneficiary,
        team,
        project,
        vehicle,
        daysInUse: daysInUse,
        entryDateDisplay: entryDateDisplay,
        ratings: mergedMeta.ratings,
        remarks: mergedMeta.remarks
      });
    });
    return matches;
  }

  function createVehicleTableTextCell(value){
    const td = document.createElement('td');
    const text = value == null ? '' : String(value).trim();
    if (text) {
      td.textContent = text;
    } else {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
    }
    return td;
  }

  function createVehicleDaysCell(match){
    const td = document.createElement('td');
    td.className = 'vehicle-days-cell';
    const days = typeof match.daysInUse === 'number' && match.daysInUse >= 0 ? match.daysInUse : null;
    const sinceLabel = match.entryDateDisplay ? String(match.entryDateDisplay).trim() : '';
    if (days == null && !sinceLabel) {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
      return td;
    }
    if (days != null) {
      const main = document.createElement('div');
      main.className = 'vehicle-days-primary';
      if (days === 0) {
        main.textContent = 'Today';
      } else if (days === 1) {
        main.textContent = '1 day';
      } else {
        main.textContent = `${days} days`;
      }
      td.appendChild(main);
    }
    if (sinceLabel) {
      const sub = document.createElement('div');
      sub.className = 'vehicle-days-secondary';
      sub.textContent = `since ${sinceLabel}`;
      td.appendChild(sub);
    }
    if (!td.childNodes.length) {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
    }
    return td;
  }

  function createStarElement(state){
    const span = document.createElement('span');
    span.className = 'vehicle-star';
    span.textContent = '★';
    if (state === 'filled') {
      span.classList.add('filled');
    } else if (state === 'half') {
      span.classList.add('half');
    }
    return span;
  }

  function createRatingRow(value){
    const row = document.createElement('div');
    row.className = 'vehicle-rating-row';
    if (value == null) {
      return row;
    }
    const numeric = parseFloat(value);
    if (!isNaN(numeric) && isFinite(numeric)) {
      const clamped = Math.max(0, Math.min(5, numeric));
      const full = Math.floor(clamped);
      const fraction = clamped - full;
      const starsWrap = document.createElement('span');
      starsWrap.className = 'vehicle-rating-stars';
      for (let i = 0; i < 5; i++) {
        if (i < full) {
          starsWrap.appendChild(createStarElement('filled'));
        } else if (i === full && fraction >= 0.75) {
          starsWrap.appendChild(createStarElement('filled'));
        } else if (i === full && fraction >= 0.25) {
          starsWrap.appendChild(createStarElement('half'));
        } else {
          starsWrap.appendChild(createStarElement('empty'));
        }
      }
      row.appendChild(starsWrap);
      const label = document.createElement('span');
      label.className = 'vehicle-rating-value';
      label.textContent = fraction ? clamped.toFixed(1) : clamped.toFixed(0);
      row.appendChild(label);
      row.title = `${clamped.toFixed(1)} / 5`;
    } else {
      row.textContent = String(value).trim();
    }
    return row;
  }

  function createVehicleRatingsCell(ratings){
    const td = document.createElement('td');
    td.className = 'vehicle-ratings-cell';
    const list = Array.isArray(ratings) ? ratings.filter(Boolean) : [];
    if (!list.length) {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
      return td;
    }
    list.forEach(function(value){
      const row = createRatingRow(value);
      if (row.textContent || row.childNodes.length) {
        td.appendChild(row);
      }
    });
    if (!td.childNodes.length) {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
    }
    return td;
  }

  function createVehicleRemarksCell(remarks){
    const td = document.createElement('td');
    td.className = 'vehicle-remarks-cell';
    const list = Array.isArray(remarks) ? remarks.filter(Boolean) : [];
    if (!list.length) {
      td.classList.add('vehicle-empty-cell');
      td.textContent = '—';
      return td;
    }
    list.forEach(function(text){
      const line = document.createElement('div');
      line.className = 'vehicle-remark-line';
      line.textContent = text;
      td.appendChild(line);
    });
    return td;
  }

  function populateVehicleMatchPopup(matches, summaryOverride){
    const modal = document.getElementById('vehicleMatchModal');
    if (!modal) return;
    const sourceMatches = Array.isArray(matches) ? matches : [];
    const hydratedMatches = enrichMatchesWithMeta(sourceMatches);
    const finalMatches = Array.isArray(hydratedMatches) ? hydratedMatches : sourceMatches;
    const tbody = modal.querySelector('.vehicle-match-body tbody');
    const summary = modal.querySelector('.vehicle-match-summary');
    if (tbody) {
      tbody.innerHTML = '';
      finalMatches.forEach(function(match){
        const tr = document.createElement('tr');
        tr.appendChild(createVehicleTableTextCell(match.beneficiary || '—'));
        tr.appendChild(createVehicleTableTextCell(match.vehicle || '—'));
        tr.appendChild(createVehicleTableTextCell(match.team || '—'));
        tr.appendChild(createVehicleTableTextCell(match.project || '—'));
        tr.appendChild(createVehicleDaysCell(match));
        tr.appendChild(createVehicleRatingsCell(match.ratings));
        tr.appendChild(createVehicleRemarksCell(match.remarks));
        tbody.appendChild(tr);
      });
    }
    if (summary) {
      if (summaryOverride) {
        summary.textContent = summaryOverride;
      } else {
        const count = finalMatches.length;
        summary.textContent = count === 1
          ? 'Found 1 active vehicle assignment matching your current selection.'
          : `Found ${count} active vehicle assignments matching your current selection.`;
      }
      vehicleMatchPopupState.lastSummary = summary.textContent;
    }
    vehicleMatchPopupState.matches = finalMatches.slice();
    prefetchVehicleReleaseData(vehicleMatchPopupState.matches);
  }

  function openVehicleMatchPopup(matches, summaryOverride){
    const modal = document.getElementById('vehicleMatchModal');
    if (!modal) return;
    populateVehicleMatchPopup(matches, summaryOverride);
    modal.style.display = 'grid';
    modal.setAttribute('aria-hidden', 'false');
  }

  function refreshVehicleMatchPopup(summaryOverride){
    setupVehicleMatchPopup();
    const matches = collectVisibleVehicleMatches();
    const list = Array.isArray(matches) ? matches : [];
    vehicleMatchPopupState.matches = list.slice();
    const modal = document.getElementById('vehicleMatchModal');
    if (modal) {
      populateVehicleMatchPopup(list, summaryOverride || vehicleMatchPopupState.lastSummary);
    }
    prefetchVehicleReleaseData(list);
  }
  window.refreshVehicleMatchPopup = refreshVehicleMatchPopup;

  function populateVehicleRatingsPopup(matches){
    const modal = document.getElementById('vehicleRatingsModal');
    if (!modal) return;
    const summary = modal.querySelector('.vehicle-ratings-summary');
    const tbody = modal.querySelector('.vehicle-ratings-table tbody');
    if (summary) {
      summary.textContent = vehicleMatchPopupState.lastSummary || 'Selected team assignments';
    }
    if (!tbody) return;
    tbody.innerHTML = '';

    const seen = new Set();
    const rows = [];
    matches.forEach(function(match){
      if (!match) return;
      const team = String(match.team || '').trim();
      const vehicle = String(match.vehicle || match.vehicleNumber || '').trim();
      const vehicleKey = normalizeVehicleNumber(vehicle);
      const key = [team.toLowerCase(), vehicleKey].join('|');
      if (seen.has(key)) return;
      seen.add(key);
      rows.push({
        team: team,
        vehicle: vehicle,
        ratings: Array.isArray(match.ratings) ? match.ratings.slice(0, 3) : [],
        remarks: Array.isArray(match.remarks) ? match.remarks.slice(0, 3) : []
      });
    });

    rows.sort(function(a, b){
      const teamCompare = String(a.team || '').localeCompare(String(b.team || ''), undefined, { sensitivity: 'base' });
      if (teamCompare !== 0) return teamCompare;
      return String(a.vehicle || '').localeCompare(String(b.vehicle || ''), undefined, { sensitivity: 'base' });
    });

    if (!rows.length) {
      const emptyRow = document.createElement('tr');
      const emptyCell = document.createElement('td');
      emptyCell.colSpan = 4;
      emptyCell.className = 'vehicle-ratings-empty';
      emptyCell.textContent = 'No ratings or remarks available for the selected teams.';
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    rows.forEach(function(record){
      const tr = document.createElement('tr');
      tr.appendChild(createVehicleTableTextCell(record.team || '—'));
      tr.appendChild(createVehicleTableTextCell(record.vehicle || '—'));
      tr.appendChild(createVehicleRatingsCell(record.ratings));
      tr.appendChild(createVehicleRemarksCell(record.remarks));
      tbody.appendChild(tr);
    });
  }

  function maybeShowInitialVehicleMatchPopup(options){
    if (vehicleMatchPopupState.shown) return;
    const opts = options && typeof options === 'object' ? options : {};
    const attempt = Number.isFinite(opts.attempt) ? opts.attempt : 0;
    setupVehicleMatchPopup();
    const matches = collectVisibleVehicleMatches();
    if (!matches.length) {
      if (attempt < 6) {
        setTimeout(function(){ maybeShowInitialVehicleMatchPopup({ attempt: attempt + 1 }); }, 180);
      }
      return;
    }
    prefetchVehicleReleaseData(matches);
    vehicleMatchPopupState.shown = true;
    openVehicleMatchPopup(matches);
    ensureVehicleMetaCache(function(){
      const hydrated = collectVisibleVehicleMatches();
      const list = Array.isArray(hydrated) && hydrated.length ? hydrated : matches;
      populateVehicleMatchPopup(list, vehicleMatchPopupState.lastSummary);
      prefetchVehicleReleaseData(list);
    });
  }
  window.maybeShowInitialVehicleMatchPopup = maybeShowInitialVehicleMatchPopup;

  function buildSelectionKey(projectName, teamNames){
    const projectKey = projectNameKey(projectName || '');
    const teamKeyList = (Array.isArray(teamNames) ? teamNames : [teamNames])
      .map(function(name){ return teamNameKey(name); })
      .filter(Boolean)
      .sort();
    return [projectKey || '', teamKeyList.join('|')].join('::');
  }

  function extractTeamNames(source){
    if (!source) return [];
    if (Array.isArray(source)) {
      return source.map(function(item){
        if (!item) return '';
        if (typeof item === 'string') return item.trim();
        if (typeof item === 'object') {
          const raw = item.name || item.teamName || item.id || item.teamId || '';
          return typeof raw === 'string' ? raw.trim() : String(raw || '').trim();
        }
        return String(item || '').trim();
      }).filter(function(val){ return val && String(val).trim(); });
    }
    return [source].filter(Boolean);
  }

  function coerceMetaList(value){
    if (value == null) return [];
    if (Array.isArray(value)) {
      return value.map(function(entry){
        if (entry == null) return '';
        if (typeof entry === 'string') return entry.trim();
        if (typeof entry === 'number') return Number.isFinite(entry) ? String(entry) : '';
        if (typeof entry === 'object' && Object.prototype.hasOwnProperty.call(entry, 'text')) {
          return String(entry.text || '').trim();
        }
        return String(entry || '').trim();
      }).filter(Boolean);
    }
    if (typeof value === 'number') {
      return Number.isFinite(value) ? [String(value)] : [];
    }
    if (typeof value === 'object') {
      if (Object.prototype.hasOwnProperty.call(value, 'text')) {
        return coerceMetaList(value.text);
      }
      return [];
    }
    const text = String(value || '').trim();
    if (!text) return [];
    if (text.indexOf('\n') >= 0 || text.indexOf(';') >= 0 || text.indexOf('|') >= 0 || text.indexOf('•') >= 0) {
      return text.split(/[\r\n•;|]+/).map(function(part){ return part.trim(); }).filter(Boolean);
    }
    return [text];
  }

  function uniqueList(list){
    const seen = new Set();
    return list.filter(function(item){
      const key = item.toLowerCase ? item.toLowerCase() : item;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  }

  function normalizeVehiclePickerRow(car){
    if (!car || typeof car !== 'object') return null;
    const out = Object.assign({}, car);
    const pickString = function(){
      for (let i = 0; i < arguments.length; i++) {
        const key = arguments[i];
        if (!key) continue;
        if (!Object.prototype.hasOwnProperty.call(car, key)) continue;
        const value = car[key];
        if (value == null) continue;
        if (Array.isArray(value)) {
          const first = value.find(function(entry){ return entry != null && String(entry).trim(); });
          if (first != null) return String(first).trim();
          continue;
        }
        const text = String(value).trim();
        if (text) return text;
      }
      return '';
    };

    const carNumber = pickString('carNumber','car_number','car','vehicleNumber','vehicle_number');
    if (carNumber) {
      out.carNumber = carNumber;
      out.vehicleNumber = carNumber;
    } else {
      const fallbackNumber = pickString('vehicle','Vehicle');
      if (fallbackNumber) {
        out.carNumber = fallbackNumber;
        out.vehicleNumber = fallbackNumber;
      }
    }

    const make = pickString('make','Make','brand','Brand');
    if (make) out.make = make;
    const model = pickString('model','Model');
    if (model) out.model = model;
    const category = pickString('category','Category');
    if (category) out.category = category;
    const usageType = pickString('usageType','usage_type','Usage Type','usage','Usage');
    if (usageType) out.usageType = usageType;
    const contractType = pickString('contractType','contract_type','Contract Type','contract','Contract','agreementType','Agreement Type');
    if (contractType) out.contractType = contractType;
    const owner = pickString('owner','Owner','ownerName','Owner Name');
    if (owner) out.owner = owner;
    const status = pickString('status','Status','inUseRelease','In Use/Release');
    if (status) out.status = status;
    const responsible = pickString('responsibleBeneficiary','Responsible Beneficiary','R.Beneficiary','R Beneficiary','R. Ben','beneficiary','assignedTo');
    if (responsible) out.responsibleBeneficiary = responsible;
    const team = pickString('team','Team','teamName','Team Name');
    if (team) out.team = team;
    const project = pickString('project','Project','projectName','Project Name');
    if (project) out.project = project;

    const remarksList = uniqueList(
      coerceMetaList(car.lastRemarks)
        .concat(coerceMetaList(car.remarks))
        .concat(coerceMetaList(car.notes))
        .concat(coerceMetaList(car.lastUsersRemark || car.lastUsersRemarks))
    ).slice(0, 3);
    if (remarksList.length) {
      out.lastRemarks = remarksList;
    } else if (!Array.isArray(out.lastRemarks)) {
      out.lastRemarks = [];
    }

    const ratingList = uniqueList(
      coerceMetaList(car.lastRatings || car.latestRatings)
        .concat(coerceMetaList(car.ratings))
        .concat(coerceMetaList(car.rating))
        .concat(coerceMetaList(car.stars))
    ).slice(0, 3);
    if (ratingList.length) {
      out.lastRatings = ratingList;
    } else if (!Array.isArray(out.lastRatings)) {
      out.lastRatings = [];
    }

    let lastUsers = [];
    if (Array.isArray(car.lastUsers)) {
      lastUsers = car.lastUsers.map(function(entry){ return String(entry || '').trim(); }).filter(Boolean);
    } else {
      const usersText = pickString('lastUsers','Last Users','users','Users','Last Used By');
      if (usersText) {
        lastUsers = usersText.split(/[,;|\n]+/).map(function(part){ return part.trim(); }).filter(Boolean);
      }
    }
    out.lastUsers = Array.isArray(lastUsers) ? lastUsers.slice(0, 5) : [];

    return out;
  }

  function normalizeVehicleNumber(value){
    const raw = String(value || '').trim();
    if (!raw) return '';
    const cache = VEHICLE_NORMALIZE_CACHE.map;
    if (hasOwn.call(cache, raw)) {
      return cache[raw];
    }
    const upper = raw.toUpperCase();
    const stripped = upper.replace(/[^A-Z0-9]/g, '');
    const normalized = stripped || upper;
    if (VEHICLE_NORMALIZE_CACHE.keys.length >= NORMALIZE_CACHE_LIMIT) {
      resetNormalizationCache(VEHICLE_NORMALIZE_CACHE);
    }
    VEHICLE_NORMALIZE_CACHE.map[raw] = normalized;
    VEHICLE_NORMALIZE_CACHE.keys.push(raw);
    return normalized;
  }

  window.invalidateVehicleNormalizationCache = invalidateVehicleNormalizationCache;

  const vehicleCacheRefreshState = {
    timer: null,
    retries: 0,
    maxRetries: 5
  };

  function refreshAllVehicleCaches(reason) {
    const label = reason ? String(reason) : 'unspecified';
    try {
      console.log('[VehicleCache] Refresh requested', { reason: label });
    } catch (_err) { /* best-effort logging */ }

    const missing = [];

    try {
      invalidateVehicleNormalizationCache();
    } catch (err) {
      console.warn('[VehicleCache] normalize cache reset failed', err);
    }

    if (typeof window.clearVehiclePickerCache === 'function') {
      try {
        window.clearVehiclePickerCache();
      } catch (err) {
        console.warn('[VehicleCache] clearVehiclePickerCache failed', err);
      }
    } else {
      missing.push('clearVehiclePickerCache');
    }

    if (typeof window.forceVehiclePickerWarm === 'function') {
      try {
        window.forceVehiclePickerWarm(true);
      } catch (err) {
        console.warn('[VehicleCache] forceVehiclePickerWarm failed', err);
      }
    } else {
      missing.push('forceVehiclePickerWarm');
    }

    if (typeof invalidateBeneficiaryVehicleCache === 'function') {
      try {
        invalidateBeneficiaryVehicleCache();
      } catch (err) {
        console.warn('[VehicleCache] invalidateBeneficiaryVehicleCache failed', err);
      }
    } else {
      missing.push('invalidateBeneficiaryVehicleCache');
    }

    if (typeof window.refreshVehicleInUseData === 'function') {
      try {
        window.refreshVehicleInUseData();
      } catch (err) {
        console.warn('[VehicleCache] refreshVehicleInUseData failed', err);
      }
    } else {
      missing.push('refreshVehicleInUseData');
    }

    if (typeof ensureBeneficiaryVehicleCache === 'function') {
      try {
        ensureBeneficiaryVehicleCache();
      } catch (err) {
        console.warn('[VehicleCache] ensureBeneficiaryVehicleCache failed', err);
      }
    } else {
      missing.push('ensureBeneficiaryVehicleCache');
    }

    if (typeof window.invalidateVehicleInUseCache === 'function') {
      try {
        window.invalidateVehicleInUseCache();
      } catch (err) {
        console.warn('[VehicleCache] invalidateVehicleInUseCache failed', err);
      }
    }

    const needsRetry = missing.some(function(name){
      return name === 'clearVehiclePickerCache' || name === 'forceVehiclePickerWarm';
    });

    if (needsRetry && vehicleCacheRefreshState.retries < vehicleCacheRefreshState.maxRetries) {
      vehicleCacheRefreshState.retries++;
      if (vehicleCacheRefreshState.timer) {
        clearTimeout(vehicleCacheRefreshState.timer);
      }
      vehicleCacheRefreshState.timer = setTimeout(function(){
        refreshAllVehicleCaches(label + ':retry');
      }, 300);
      return;
    }

    vehicleCacheRefreshState.retries = 0;
    if (vehicleCacheRefreshState.timer) {
      clearTimeout(vehicleCacheRefreshState.timer);
      vehicleCacheRefreshState.timer = null;
    }
  }

  function scheduleVehicleCacheRefresh(reason) {
    const label = reason ? String(reason) : 'unspecified';
    setTimeout(function(){
      refreshAllVehicleCaches(label);
    }, 0);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){
      scheduleVehicleCacheRefresh('page-load');
    }, { once: true });
  } else {
    scheduleVehicleCacheRefresh('page-load');
  }

  document.addEventListener('pp:applied', function(){
    refreshAllVehicleCaches('project-apply');
  });

  window.refreshAllVehicleCaches = refreshAllVehicleCaches;

  function getVehicleMetaSummary(vehicleNumber){
    const rawValue = String(vehicleNumber || '').trim();
    const target = normalizeVehicleNumber(rawValue);
    if (!target) return null;
    const releaseMap = window.vehicleReleaseSnapshots || {};
    let releaseEntries = Array.isArray(releaseMap[target]) ? releaseMap[target] : [];
    if (!releaseEntries.length && rawValue) {
      const rawKey = rawValue.toUpperCase();
      if (rawKey && Array.isArray(releaseMap[rawKey])) {
        releaseEntries = releaseMap[rawKey];
      } else {
        const stripped = rawKey.replace(/[^A-Z0-9]/g, '');
        if (stripped && Array.isArray(releaseMap[stripped])) {
          releaseEntries = releaseMap[stripped];
        }
      }
    }
    if (!releaseEntries.length && releaseMap) {
      try {
        const keys = Object.keys(releaseMap);
        for (let i = 0; i < keys.length; i++) {
          const candidateKey = keys[i];
          if (normalizeVehicleNumber(candidateKey) === target) {
            releaseEntries = Array.isArray(releaseMap[candidateKey]) ? releaseMap[candidateKey] : [];
            if (releaseEntries.length) break;
          }
        }
      } catch(_fallbackErr) {
        // best-effort fallback; ignore errors
      }
    }

    const releaseRatings = releaseEntries
      .map(function(entry){ return entry && entry.rating != null ? String(entry.rating).trim() : ''; })
      .filter(Boolean)
      .slice(0, 3);
    const releaseRemarks = releaseEntries
      .map(function(entry){ return entry && entry.remark != null ? String(entry.remark).trim() : ''; })
      .filter(Boolean)
      .slice(0, 3);
    if (releaseRatings.length || releaseRemarks.length) {
      return {
        ratings: releaseRatings,
        remarks: releaseRemarks
      };
    }
    const candidateLists = [];
    if (Array.isArray(window.availableCarsData)) candidateLists.push(window.availableCarsData);
    if (Array.isArray(window.availableCarsRaw)) candidateLists.push(window.availableCarsRaw);
    let meta = null;
    for (let i = 0; i < candidateLists.length && !meta; i++) {
      const list = candidateLists[i];
      if (!Array.isArray(list)) continue;
      meta = list.find(function(car){
        if (!car) return false;
        const number = normalizeVehicleNumber(car.carNumber || car.vehicleNumber || car.car);
        return number === target;
      }) || null;
    }
    if (!meta) return null;
    const fallbackRatings = uniqueList(
      [].concat(
        coerceMetaList(meta.lastRatings || meta.latestRatings || meta.ratings || meta.rating || meta.stars)
      )
    ).filter(Boolean).slice(0, 3);
    const fallbackRemarks = uniqueList(
      [].concat(
        coerceMetaList(meta.lastUsersRemark || meta.lastUsersRemarks),
        coerceMetaList(meta.remarks),
        coerceMetaList(meta.lastRemarks),
        coerceMetaList(meta.remark),
        coerceMetaList(meta.notes)
      )
    ).filter(Boolean).slice(0, 3);
    return {
      ratings: fallbackRatings,
      remarks: fallbackRemarks
    };
  }

  function getCarTPMetaForVehicle(vehicleNumber){
    if (!vehicleNumber) return null;
    const map = (window.carTPVehicleMeta && typeof window.carTPVehicleMeta === 'object') ? window.carTPVehicleMeta : null;
    if (!map) return null;
    const raw = String(vehicleNumber || '').trim();
    const primaryKey = normalizeVehicleNumber(raw);
    if (primaryKey && Object.prototype.hasOwnProperty.call(map, primaryKey)) {
      return map[primaryKey];
    }
    const upperKey = raw.toUpperCase();
    if (upperKey && Object.prototype.hasOwnProperty.call(map, upperKey)) {
      return map[upperKey];
    }
    if (!primaryKey) return null;
    try {
      for (const key in map) {
        if (!Object.prototype.hasOwnProperty.call(map, key)) continue;
        if (normalizeVehicleNumber(key) === primaryKey) {
          return map[key];
        }
      }
    } catch(_scanErr) {
      // fall through to null on lookup failure
    }
    return null;
  }

  function mergeVehicleMetaSources(vehicleNumber, releaseMeta, record){
    const releaseRatings = releaseMeta && Array.isArray(releaseMeta.ratings) ? releaseMeta.ratings : [];
    const releaseRemarks = releaseMeta && Array.isArray(releaseMeta.remarks) ? releaseMeta.remarks : [];
    let recordRatings = [];
    let recordRemarks = [];
    if (record && typeof record === 'object') {
      recordRatings = uniqueList([].concat(
        coerceMetaList(record.lastRatings || record.latestRatings),
        coerceMetaList(record.ratings || record.rating || record.stars),
        coerceMetaList(record.vehicleRatings)
      )).slice(0, 3);
      recordRemarks = uniqueList([].concat(
        coerceMetaList(record.lastUsersRemarks || record.lastUsersRemark),
        coerceMetaList(record.remarks || record.remark || record.notes || record.feedback),
        coerceMetaList(record.lastRemarks)
      )).slice(0, 3);
    }
    const carTPMeta = getCarTPMetaForVehicle(vehicleNumber || (record && (record.vehicle || record.vehicleNumber || record.carNumber || '')));
    const carTPRatings = carTPMeta && Array.isArray(carTPMeta.ratings) ? carTPMeta.ratings : [];
    const carTPRemarks = carTPMeta && Array.isArray(carTPMeta.remarks) ? carTPMeta.remarks : [];
    const ratings = uniqueList([].concat(recordRatings, releaseRatings, carTPRatings)).slice(0, 3);
    const remarks = uniqueList([].concat(recordRemarks, releaseRemarks, carTPRemarks)).slice(0, 3);
    return {
      ratings: ratings,
      remarks: remarks
    };
  }

  function enrichMatchesWithMeta(matches){
    if (!Array.isArray(matches) || !matches.length) {
      return Array.isArray(matches) ? matches : [];
    }
    return matches.map(function(match){
      if (!match) return match;
      const hasRatings = Array.isArray(match.ratings) && match.ratings.length;
      const hasRemarks = Array.isArray(match.remarks) && match.remarks.length;
      if (hasRatings && hasRemarks) return match;
      const vehicleId = match.vehicle || match.vehicleNumber || match.carNumber || '';
      if (!vehicleId) return match;
      const releaseMeta = getVehicleMetaSummary(vehicleId);
      const merged = mergeVehicleMetaSources(vehicleId, releaseMeta, match);
      if (!merged || (!Array.isArray(merged.ratings) || !merged.ratings.length) && (!Array.isArray(merged.remarks) || !merged.remarks.length)) {
        return match;
      }
      const next = Object.assign({}, match);
      if (!hasRatings && Array.isArray(merged.ratings) && merged.ratings.length) {
        next.ratings = merged.ratings.slice(0, 3);
      }
      if (!hasRemarks && Array.isArray(merged.remarks) && merged.remarks.length) {
        next.remarks = merged.remarks.slice(0, 3);
      }
      return next;
    });
  }

  function formatEntryDateDisplay(timestamp, fallback){
    if (typeof timestamp === 'number' && timestamp > 0) {
      try {
        const date = new Date(timestamp);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
      } catch(_){ /* ignore */ }
    }
    if (fallback) {
      return String(fallback).trim();
    }
    return '';
  }

  function findAssignmentsForSelection(projectName, teamNames){
    const records = Array.isArray(vehicleInUseState.records) ? vehicleInUseState.records : [];
    if (!records.length) return [];
    const projectKey = projectNameKey(projectName || '');
    const teamKeys = new Set(
      extractTeamNames(teamNames).map(function(name){ return teamNameKey(name); }).filter(Boolean)
    );
    const hasProject = !!projectKey;
    const hasTeams = teamKeys.size > 0;
    if (!hasProject && !hasTeams) return [];
    const seen = new Set();
    const matches = [];
    records.forEach(function(rec){
      if (!rec) return;
      const vehicleNumber = String(rec.vehicleNumber || rec.carNumber || '').trim();
      const beneficiary = String(rec.responsibleBeneficiary || rec.beneficiary || rec.member || '').trim();
      if (!vehicleNumber || !beneficiary) return;
      const recProject = projectNameKey(rec.project || '');
      const recTeam = teamNameKey(rec.team || '');
      if (hasProject && recProject !== projectKey) return;
      if (hasTeams && !teamKeys.has(recTeam)) return;
      const key = beneficiary.toLowerCase() + '|' + vehicleNumber.toUpperCase();
      if (seen.has(key)) return;
      seen.add(key);
      const ts = typeof rec.entryTimestamp === 'number' ? rec.entryTimestamp : parseVehicleDate(rec.entryDate);
      let daysInUse = null;
      if (ts && !isNaN(ts) && ts > 0) {
        const diff = Date.now() - ts;
        if (diff >= 0) {
          const wholeDays = Math.floor(diff / 86400000);
          daysInUse = wholeDays + 1; // inclusive of current day
        }
      }
  const releaseMeta = getVehicleMetaSummary(vehicleNumber);
  const mergedMeta = mergeVehicleMetaSources(vehicleNumber, releaseMeta, rec);
      matches.push({
        beneficiary: beneficiary,
        vehicle: vehicleNumber,
        team: rec.team || '',
        project: rec.project || '',
        daysInUse: daysInUse,
        entryDateDisplay: formatEntryDateDisplay(ts, rec.entryDate || rec.entryTimestamp),
        ratings: mergedMeta.ratings,
        remarks: mergedMeta.remarks
      });
    });
    return matches;
  }

  const vehicleMetaCacheState = {
    pending: false,
    queue: [],
    releaseReady: false,
    carTPReady: false
  };

  const beneficiaryVehicleCacheState = {
    building: false,
    ready: false,
    startedAt: 0,
    finishedAt: 0,
    data: Object.create(null),
    queue: [],
    timerId: null,
    statusEl: null,
    styleInjected: false,
    retryTimer: null,
    hasShownLoader: false
  };
  window.beneficiaryVehicleCache = beneficiaryVehicleCacheState;

  function flushVehicleMetaQueue(){
    const queued = vehicleMetaCacheState.queue.splice(0);
    queued.forEach(function(fn){
      try { if (typeof fn === 'function') fn(); } catch(_){ /* ignore */ }
    });
  }

  function ensureBeneficiaryLoaderStyles(){
    if (beneficiaryVehicleCacheState.styleInjected) return;
    beneficiaryVehicleCacheState.styleInjected = true;
    try {
      const style = document.createElement('style');
      style.textContent = '.vehicle-meta-loader{position:fixed;right:18px;bottom:18px;z-index:9999;min-width:220px;padding:10px 16px;border-radius:8px;background:rgba(17,24,39,0.92);color:#f9fafb;font-size:13px;line-height:1.3;display:none;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(0,0,0,0.35);backdrop-filter:blur(6px);}';
      document.head.appendChild(style);
    } catch(_){ /* ignore */ }
  }

  function updateBeneficiaryLoader(){
    if (!beneficiaryVehicleCacheState.statusEl) return;
    const stopAt = beneficiaryVehicleCacheState.finishedAt || Date.now();
    const elapsed = beneficiaryVehicleCacheState.startedAt ? Math.max(0, Math.floor((stopAt - beneficiaryVehicleCacheState.startedAt) / 1000)) : 0;
    beneficiaryVehicleCacheState.statusEl.textContent = beneficiaryVehicleCacheState.ready
      ? `Vehicle insights ready (${elapsed}s)`
      : `Building vehicle insights… ${elapsed}s`;
  }

  function startBeneficiaryLoader(){
    if (beneficiaryVehicleCacheState.ready || beneficiaryVehicleCacheState.hasShownLoader) return;
    ensureBeneficiaryLoaderStyles();
    if (!beneficiaryVehicleCacheState.statusEl) {
      try {
        const node = document.createElement('div');
        node.id = 'vehicleMetaLoader';
        node.className = 'vehicle-meta-loader';
        document.body.appendChild(node);
        beneficiaryVehicleCacheState.statusEl = node;
      } catch(_){ /* ignore */ }
    }
    if (!beneficiaryVehicleCacheState.startedAt) {
      beneficiaryVehicleCacheState.startedAt = Date.now();
    }
    updateBeneficiaryLoader();
    if (beneficiaryVehicleCacheState.statusEl) {
      beneficiaryVehicleCacheState.statusEl.style.display = 'flex';
    }
    if (!beneficiaryVehicleCacheState.timerId) {
      beneficiaryVehicleCacheState.timerId = setInterval(updateBeneficiaryLoader, 1000);
    }
    beneficiaryVehicleCacheState.hasShownLoader = true;
  }

  function finishBeneficiaryLoader(){
    beneficiaryVehicleCacheState.finishedAt = beneficiaryVehicleCacheState.finishedAt || Date.now();
    if (beneficiaryVehicleCacheState.timerId) {
      clearInterval(beneficiaryVehicleCacheState.timerId);
      beneficiaryVehicleCacheState.timerId = null;
    }
    updateBeneficiaryLoader();
    if (beneficiaryVehicleCacheState.statusEl) {
      const node = beneficiaryVehicleCacheState.statusEl;
      setTimeout(function(){ node.style.display = 'none'; }, 1600);
    }
  }

  function flushBeneficiaryVehicleQueue(){
    const queued = beneficiaryVehicleCacheState.queue.splice(0);
    queued.forEach(function(fn){
      try {
        if (typeof fn === 'function') fn(beneficiaryVehicleCacheState.data);
      } catch(_){ /* ignore */ }
    });
  }

  function beneficiaryCacheKey(name){
    return String(name || '').trim().toLowerCase();
  }

  function splitBeneficiaryList(value){
    if (!value) return [];
    if (Array.isArray(value)) {
      return value.map(function(entry){ return String(entry || '').trim(); }).filter(Boolean);
    }
    return String(value || '')
      .split(/[,;/\n\|]+/)
      .map(function(part){ return part.trim(); })
      .filter(Boolean);
  }

  function addBeneficiaryVehicleEntry(map, beneficiary, entry){
    const key = beneficiaryCacheKey(beneficiary);
    if (!key) return;
    let bucket = map[key];
    if (!bucket) {
      bucket = {
        beneficiary: beneficiary,
        entries: []
      };
      map[key] = bucket;
    }
    const exists = bucket.entries.some(function(prev){
      return prev && prev.carNumber === entry.carNumber && prev.source === entry.source;
    });
    if (!exists) {
      bucket.entries.push(entry);
    }
  }

  function finalizeBeneficiaryVehicleCache(map){
    beneficiaryVehicleCacheState.building = false;
    beneficiaryVehicleCacheState.data = map;
    beneficiaryVehicleCacheState.ready = true;
    beneficiaryVehicleCacheState.finishedAt = Date.now();
    finishBeneficiaryLoader();
    flushBeneficiaryVehicleQueue();
  }

  function buildBeneficiaryVehicleCache(){
    if (beneficiaryVehicleCacheState.ready) return;
  const metaReady = Array.isArray(window.availableCarsData);
  const releaseReady = window.vehicleReleaseSnapshotsReady === true;
  const carTPReady = window.carTPVehicleMetaReady === true;
  if (!metaReady || !releaseReady || !carTPReady) {
      if (!beneficiaryVehicleCacheState.retryTimer) {
        beneficiaryVehicleCacheState.retryTimer = setTimeout(function(){
          beneficiaryVehicleCacheState.retryTimer = null;
          buildBeneficiaryVehicleCache();
        }, 220);
      }
      return;
    }

    if (beneficiaryVehicleCacheState.retryTimer) {
      clearTimeout(beneficiaryVehicleCacheState.retryTimer);
      beneficiaryVehicleCacheState.retryTimer = null;
    }

    const map = Object.create(null);

    const inUseRecords = Array.isArray(vehicleInUseState.records) ? vehicleInUseState.records : [];
    inUseRecords.forEach(function(rec){
      if (!rec) return;
      const vehicleNumber = String(rec.vehicleNumber || rec.carNumber || '').trim();
      if (!vehicleNumber) return;
  const releaseMeta = getVehicleMetaSummary(vehicleNumber) || { ratings: [], remarks: [] };
  const mergedMeta = mergeVehicleMetaSources(vehicleNumber, releaseMeta, rec);
      const payload = {
        carNumber: vehicleNumber,
        status: String(rec.status || 'IN USE').trim() || 'IN USE',
        project: rec.project || '',
        team: rec.team || '',
        ratings: mergedMeta.ratings,
        remarks: mergedMeta.remarks,
        source: 'IN_USE',
        entryTimestamp: rec.entryTimestamp || null
      };
      const beneficiaries = splitBeneficiaryList(rec.responsibleBeneficiary || rec.beneficiary || rec.member);
      if (!beneficiaries.length) {
        const fallbackName = rec.beneficiary || rec.responsibleBeneficiary || rec.member || rec.key;
        if (fallbackName) beneficiaries.push(fallbackName);
      }
      beneficiaries.forEach(function(name){
        if (name) addBeneficiaryVehicleEntry(map, name, payload);
      });
    });

    const releaseVehicles = Array.isArray(window.availableCarsData) ? window.availableCarsData : [];
    releaseVehicles.forEach(function(car){
      if (!car) return;
      const vehicleNumber = String(car.carNumber || car.vehicleNumber || '').trim();
      if (!vehicleNumber) return;
    const responsible = car.responsibleBeneficiary || car['R.Beneficiary'] || car['R. Ben'] || car.responsible || '';
      const beneficiaries = splitBeneficiaryList(responsible);
      if (!beneficiaries.length) return;
  const releaseMeta = getVehicleMetaSummary(vehicleNumber) || { ratings: [], remarks: [] };
  const mergedMeta = mergeVehicleMetaSources(vehicleNumber, releaseMeta, car);
      const payload = {
        carNumber: vehicleNumber,
        status: String(car.status || 'RELEASE').trim() || 'RELEASE',
        project: car.project || '',
        team: car.team || '',
        ratings: mergedMeta.ratings,
        remarks: mergedMeta.remarks,
        source: 'RELEASE',
        entryTimestamp: car.entryTimestamp || null
      };
      beneficiaries.forEach(function(name){
        if (name) addBeneficiaryVehicleEntry(map, name, payload);
      });
    });

    finalizeBeneficiaryVehicleCache(map);
  }

  function ensureBeneficiaryVehicleCache(callback){
    if (typeof callback === 'function') {
      if (beneficiaryVehicleCacheState.ready) {
        try { callback(beneficiaryVehicleCacheState.data); } catch(_){ /* ignore */ }
      } else {
        beneficiaryVehicleCacheState.queue.push(callback);
      }
    }
    if (beneficiaryVehicleCacheState.ready || beneficiaryVehicleCacheState.building) return;
    beneficiaryVehicleCacheState.building = true;
    startBeneficiaryLoader();
    ensureVehicleMetaCache(function(){
      ensureVehicleInUseDataReady(function(){
        buildBeneficiaryVehicleCache();
      });
    });
  }

  function invalidateBeneficiaryVehicleCache(){
    if (beneficiaryVehicleCacheState.retryTimer) {
      clearTimeout(beneficiaryVehicleCacheState.retryTimer);
      beneficiaryVehicleCacheState.retryTimer = null;
    }
    beneficiaryVehicleCacheState.building = false;
    beneficiaryVehicleCacheState.ready = false;
    beneficiaryVehicleCacheState.startedAt = Date.now();
    beneficiaryVehicleCacheState.finishedAt = 0;
    beneficiaryVehicleCacheState.data = Object.create(null);
    startBeneficiaryLoader();
    ensureBeneficiaryVehicleCache();
  }

  window.ensureBeneficiaryVehicleCache = ensureBeneficiaryVehicleCache;
  window.invalidateBeneficiaryVehicleCache = invalidateBeneficiaryVehicleCache;
  window.getBeneficiaryVehicleCache = function(){
    return beneficiaryVehicleCacheState.data;
  };

  function ensureVehicleMetaCache(callback){
    const hasVehicleMeta = Array.isArray(window.availableCarsData) && window.availableCarsData.length > 0;
    const releaseReady = window.vehicleReleaseSnapshotsReady === true;
    const carTPReady = window.carTPVehicleMetaReady === true;
    if (hasVehicleMeta && releaseReady && carTPReady) {
      if (typeof callback === 'function') {
        try { callback(); } catch(_){ /* ignore */ }
      }
      return;
    }
    if (typeof callback === 'function') {
      vehicleMetaCacheState.queue.push(callback);
    }
    if (vehicleMetaCacheState.pending) return;
    if (!(window.google && google.script && google.script.run)) {
      window.vehicleReleaseSnapshots = window.vehicleReleaseSnapshots || {};
      window.vehicleReleaseSnapshotsReady = true;
      window.carTPVehicleMeta = window.carTPVehicleMeta || {};
      window.carTPVehicleMetaReady = true;
      flushVehicleMetaQueue();
      return;
    }
    vehicleMetaCacheState.pending = true;
    vehicleMetaCacheState.releaseReady = false;
    vehicleMetaCacheState.carTPReady = false;
    window.vehicleReleaseSnapshots = window.vehicleReleaseSnapshots || {};
    window.vehicleReleaseSnapshotsReady = false;
    window.carTPVehicleMeta = window.carTPVehicleMeta || {};
    window.carTPVehicleMetaReady = false;

    function finalizeIfComplete(){
      if (!vehicleMetaCacheState.releaseReady || !vehicleMetaCacheState.carTPReady) {
        return;
      }
      vehicleMetaCacheState.pending = false;
      window.vehicleReleaseSnapshotsReady = true;
      window.carTPVehicleMetaReady = true;
      if (beneficiaryVehicleCacheState.building) {
        buildBeneficiaryVehicleCache();
      }
      flushVehicleMetaQueue();
    }

    function fetchReleaseSnapshots(){
      google.script.run
        .withSuccessHandler(function(res){
          try {
            if (res && res.ok !== false && res.vehicles && typeof res.vehicles === 'object') {
              window.vehicleReleaseSnapshots = res.vehicles;
            } else {
              window.vehicleReleaseSnapshots = {};
            }
          } catch (releaseErr) {
            console.warn('[VehicleInUse] Failed to hydrate release history cache', releaseErr);
            window.vehicleReleaseSnapshots = {};
          }
          vehicleMetaCacheState.releaseReady = true;
          finalizeIfComplete();
        })
        .withFailureHandler(function(err){
          console.warn('[VehicleInUse] Unable to fetch release history metadata', err);
          window.vehicleReleaseSnapshots = {};
          vehicleMetaCacheState.releaseReady = true;
          finalizeIfComplete();
        })
        .getVehicleReleaseSnapshots(3);
    }

    function fetchCarTPMeta(){
      google.script.run
        .withSuccessHandler(function(res){
          try {
            if (res && res.ok !== false && res.vehicles && typeof res.vehicles === 'object') {
              window.carTPVehicleMeta = res.vehicles;
            } else {
              window.carTPVehicleMeta = {};
            }
          } catch (carTpErr) {
            console.warn('[VehicleInUse] Failed to hydrate CarT_P metadata', carTpErr);
            window.carTPVehicleMeta = {};
          }
          vehicleMetaCacheState.carTPReady = true;
          finalizeIfComplete();
        })
        .withFailureHandler(function(err){
          console.warn('[VehicleInUse] Unable to fetch CarT_P metadata', err);
          window.carTPVehicleMeta = {};
          vehicleMetaCacheState.carTPReady = true;
          finalizeIfComplete();
        })
        .getCarTPVehicleMeta(3);
    }

    google.script.run
      .withSuccessHandler(function(res){
        try {
          if (res && Array.isArray(res.vehicles)) {
            window.availableCarsRaw = res.vehicles.slice();
            window.availableCarsData = res.vehicles.map(normalizeVehiclePickerRow).filter(Boolean);
          } else if (Array.isArray(res)) {
            window.availableCarsRaw = res.slice();
            window.availableCarsData = res.map(normalizeVehiclePickerRow).filter(Boolean);
          } else if (!Array.isArray(window.availableCarsData)) {
            window.availableCarsRaw = [];
            window.availableCarsData = [];
          }
        } catch (metaErr) {
          console.warn('[VehicleInUse] Failed to hydrate vehicle meta cache', metaErr);
          if (!Array.isArray(window.availableCarsData)) {
            window.availableCarsRaw = [];
            window.availableCarsData = [];
          }
        }
        fetchReleaseSnapshots();
        fetchCarTPMeta();
      })
      .withFailureHandler(function(err){
        console.warn('[VehicleInUse] Unable to fetch vehicle metadata', err);
        if (!Array.isArray(window.availableCarsData)) {
          window.availableCarsRaw = [];
          window.availableCarsData = [];
        }
        fetchReleaseSnapshots();
        fetchCarTPMeta();
      })
      .getVehiclePickerData();
  }

  function ensureVehicleInUseDataReady(callback, attempt){
    const attempts = typeof attempt === 'number' ? attempt : 0;
    const maxAttempts = 8;
    if (Array.isArray(vehicleInUseState.records) && vehicleInUseState.records.length) {
      callback();
      return;
    }
    if (attempts >= maxAttempts) {
      callback();
      return;
    }
    if (!vehicleInUseState.fetching) {
      try { fetchVehicleInUseAssignments(); } catch(_){ /* ignore */ }
    }
    setTimeout(function(){
      ensureVehicleInUseDataReady(callback, attempts + 1);
    }, 220 + Math.min(680, attempts * 160));
  }

  function scheduleVehicleAssignmentPopup(projectName, teamNames, options){
    const opts = options && typeof options === 'object' ? options : {};
    const detail = opts.rawDetail || null;
    const attempt = Number.isFinite(opts.attempt) && opts.attempt >= 0 ? Math.floor(opts.attempt) : 0;
    const maxAttempts = Number.isFinite(opts.maxAttempts) && opts.maxAttempts > 0 ? Math.floor(opts.maxAttempts) : 4;
    const projectLabel = projectName ? String(projectName).trim() : '';
    const baseTeams = extractTeamNames(teamNames);
    if (!projectLabel && !baseTeams.length) return;
    const baseSelectionKey = buildSelectionKey(projectLabel, baseTeams);
    if (!opts.force && baseSelectionKey && baseSelectionKey === vehicleMatchPopupState.lastSelectionKey) return;

    const projectCandidates = [];
    const seenProjects = new Set();
    function addProjectCandidate(value){
      const v = String(value || '').trim();
      if (!v) return;
      const key = v.toLowerCase();
      if (seenProjects.has(key)) return;
      seenProjects.add(key);
      projectCandidates.push(v);
    }

    addProjectCandidate(projectLabel);
    if (detail) {
      addProjectCandidate(detail.projectName);
      addProjectCandidate(detail.projectLabel);
      addProjectCandidate(detail.projectCode);
      addProjectCandidate(detail.projectId);
    }
    if (!projectCandidates.length || projectCandidates.every(function(val){ return !String(val || '').trim(); })) {
      projectCandidates.push('');
    } else if (!projectCandidates.some(function(val){ return !String(val || '').trim(); })) {
      projectCandidates.push('');
    }

    const teamCandidates = [];
    const seenTeamKeys = new Set();
    function addTeamCandidate(source){
      const list = extractTeamNames(source);
      if (!Array.isArray(list) || !list.length) return;
      const key = list.map(function(name){ return String(name || '').trim().toLowerCase(); }).sort().join('|');
      if (seenTeamKeys.has(key)) return;
      seenTeamKeys.add(key);
      teamCandidates.push(list);
    }

    addTeamCandidate(baseTeams);
    if (detail) {
      addTeamCandidate(detail.selectedTeams);
      addTeamCandidate(detail.teamNames);
      addTeamCandidate(detail.teamLabels);
      addTeamCandidate(detail.teamIds);
      addTeamCandidate(detail.teams);
    }
    if (!teamCandidates.length) {
      teamCandidates.push([]);
    }

    ensureVehicleInUseDataReady(function(){
      let matchedProject = '';
      let matchedTeams = [];
      let initialMatches = [];

      outer:
      for (let i = 0; i < projectCandidates.length && !initialMatches.length; i++) {
        for (let j = 0; j < teamCandidates.length && !initialMatches.length; j++) {
          const candidateProject = projectCandidates[i];
          const candidateTeams = teamCandidates[j];
          const matches = findAssignmentsForSelection(candidateProject, candidateTeams);
          if (matches.length) {
            matchedProject = candidateProject;
            matchedTeams = candidateTeams;
            initialMatches = matches;
            break outer;
          }
        }
      }

      if (!initialMatches.length) {
        if (attempt < maxAttempts) {
          const nextOptions = Object.assign({}, opts, { attempt: attempt + 1, maxAttempts: maxAttempts, force: true });
          setTimeout(function(){
            scheduleVehicleAssignmentPopup(projectName, teamNames, nextOptions);
          }, 260 + attempt * 180);
        } else {
          console.log('[VehicleInUse] No vehicle assignments found for selection', {
            projectCandidates: projectCandidates,
            teamCandidates: teamCandidates,
            recordsLoaded: Array.isArray(vehicleInUseState.records) ? vehicleInUseState.records.length : 0
          });
        }
        return;
      }

      const summaryProject = matchedProject || projectLabel;
      const summaryTeams = (matchedTeams && matchedTeams.length) ? matchedTeams : baseTeams;
      const finalSelectionKey = buildSelectionKey(summaryProject, summaryTeams);
      if (finalSelectionKey) {
        vehicleMatchPopupState.lastSelectionKey = finalSelectionKey;
      }

      setupVehicleMatchPopup();
      prefetchVehicleReleaseData(initialMatches);
      const summaryParts = [];
      if (summaryProject) summaryParts.push('Project: ' + summaryProject);
      if (summaryTeams.length) {
        summaryParts.push('Team' + (summaryTeams.length > 1 ? 's' : '') + ': ' + summaryTeams.join(', '));
      }
      const summaryText = summaryParts.length
        ? `Found ${initialMatches.length} active vehicle assignment${initialMatches.length === 1 ? '' : 's'} for ${summaryParts.join(' • ')}.`
        : `Found ${initialMatches.length} active vehicle assignment${initialMatches.length === 1 ? '' : 's'}.`;
      openVehicleMatchPopup(initialMatches, summaryText);

      try { ensureBeneficiaryVehicleCache(); } catch(_){ /* ignore */ }
      ensureVehicleMetaCache(function(){
        let enrichedMatches = findAssignmentsForSelection(summaryProject, summaryTeams);
        if (!Array.isArray(enrichedMatches) || !enrichedMatches.length) {
          enrichedMatches = initialMatches;
        }
        populateVehicleMatchPopup(enrichedMatches, summaryText);
        prefetchVehicleReleaseData(enrichedMatches);
      });
    });
  }

  document.addEventListener('pp:applied', function(event){
    try {
      const detail = event && event.detail ? event.detail : {};
      const projectName = detail.projectName || detail.projectLabel || detail.projectId || '';
      const teamSource = (Array.isArray(detail.selectedTeams) && detail.selectedTeams.length) ? detail.selectedTeams
        : (Array.isArray(detail.teamNames) && detail.teamNames.length) ? detail.teamNames
        : (Array.isArray(detail.teamLabels) && detail.teamLabels.length) ? detail.teamLabels
        : detail.teamIds;
      const teamNames = extractTeamNames(teamSource);
      scheduleVehicleAssignmentPopup(projectName, teamNames, { force: true, rawDetail: detail, maxAttempts: 5 });
    } catch (selErr) {
      console.warn('[VehicleInUse] Unable to process selection for vehicle assignments', selErr);
    }
  });

  const vehicleInUseDomMonitor = {
    observer: null,
    pending: false,
    domReadyHooked: false,
    bootstrapped: false,
    retryTimer: null
  };

  function scheduleVehicleRowSync(){
    if (vehicleInUseDomMonitor.pending) return;
    vehicleInUseDomMonitor.pending = true;
    onNextFrame(function(){
      vehicleInUseDomMonitor.pending = false;
      try {
        applyVehicleInUseAssignmentsToRows(false);
      } catch (syncErr) {
        console.error('[VehicleInUse] Failed to sync vehicle numbers after DOM change', syncErr);
      }
    });
  }

  function startVehicleRowObserver(){
    if (vehicleInUseDomMonitor.observer || typeof MutationObserver !== 'function') return;
    const body = getBody();
    if (!body) {
      if (!vehicleInUseDomMonitor.retryTimer) {
        vehicleInUseDomMonitor.retryTimer = setTimeout(function(){
          vehicleInUseDomMonitor.retryTimer = null;
          startVehicleRowObserver();
        }, 150);
      }
      return;
    }

    try {
      const observer = new MutationObserver(function(mutations){
        for (let i = 0; i < mutations.length; i++) {
          const mutation = mutations[i];
          if (mutation.type !== 'childList') continue;
          if ((mutation.addedNodes && mutation.addedNodes.length) || (mutation.removedNodes && mutation.removedNodes.length)) {
            scheduleVehicleRowSync();
            break;
          }
        }
      });
      observer.observe(body, { childList: true });
      vehicleInUseDomMonitor.observer = observer;
    } catch (observerErr) {
      console.warn('[VehicleInUse] Unable to observe beneficiary rows for updates', observerErr);
    }
  }

  function ensureVehicleRowPrefillHooks(){
    if (document.readyState === 'loading') {
      if (!vehicleInUseDomMonitor.domReadyHooked) {
        vehicleInUseDomMonitor.domReadyHooked = true;
        document.addEventListener('DOMContentLoaded', ensureVehicleRowPrefillHooks);
      }
      return;
    }

    startVehicleRowObserver();

    if (!vehicleInUseDomMonitor.bootstrapped) {
      vehicleInUseDomMonitor.bootstrapped = true;
      scheduleVehicleRowSync();
      setupVehicleMatchPopup();
    }
  }

  ensureVehicleRowPrefillHooks();

  function persistVehicleInUseCache(snapshot) {
    try {
      if (!window || !window.localStorage) return;
      window.localStorage.setItem(VEHICLE_IN_USE_CACHE_KEY, JSON.stringify(snapshot));
    } catch (cacheErr) {
      console.warn('[VehicleInUse] Failed to persist cache', cacheErr);
    }
  }

  function restoreVehicleInUseCache(){
    try {
      if (!window || !window.localStorage) return;
      const raw = window.localStorage.getItem(VEHICLE_IN_USE_CACHE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.records) || !parsed.records.length) return;
      storeVehicleInUseRecords(parsed.records, { updatedAt: parsed.updatedAt || '' }, { skipPersistence: true, source: 'cache' });
      scheduleVehicleInUseReapply({ reason: 'cache-restore', attempts: 6, delay: 350 });
    } catch (cacheErr) {
      console.warn('[VehicleInUse] Failed to restore cache', cacheErr);
    }
  }

  function storeVehicleInUseRecords(records, meta, options){
    const opts = options && typeof options === 'object' ? options : {};
    const byKey = new Map();
    (Array.isArray(records) ? records : []).forEach(function(rec){
      if (!rec) return;
      const beneficiary = String(rec.beneficiary || rec.responsibleBeneficiary || rec.member || rec.name || rec['R.Beneficiary'] || rec['R. Ben'] || '').trim();
      const vehicleNumber = String(rec.vehicleNumber || rec.carNumber || rec['Vehicle Number'] || '').trim();
      if (!beneficiary || !vehicleNumber) return;
      let status = String(rec.status || rec.Status || rec['In Use/Release'] || '').trim();
      const key = vehicleNameKey(beneficiary);
      const ts = parseVehicleDate(rec.entryTimestamp || rec.entryDate || rec.timestamp);
      const existing = byKey.get(key);
      if (!existing || ts >= existing.entryTimestamp) {
        byKey.set(key, {
          beneficiary: beneficiary,
          vehicleNumber: vehicleNumber,
          team: String(rec.team || rec.teamName || rec.Team || '').trim(),
          project: String(rec.project || rec.projectName || rec.Project || '').trim(),
          status: status,
          entryDate: rec.entryDate || rec.date || '',
          entryTimestamp: ts,
          rowNumber: rec.rowNumber || rec.row || null,
          key: key
        });
      }
    });

    clearObject(vehicleInUseState.exact);
    clearObject(vehicleInUseState.lower);
    vehicleInUseState.records = [];
    clearObject(vehicleInUseState.teamPairs);
    clearObject(vehicleInUseState.projectPairs);

    byKey.forEach(function(info){
      const synonyms = new Set();
      const beneficiary = String(info.beneficiary || '').trim();
      const baseKey = info.key;
      if (beneficiary) {
        synonyms.add(beneficiary);
        const hyphenParts = beneficiary.split(/[-–—]/);
        if (hyphenParts.length > 1) {
          const prefix = hyphenParts[0].trim();
          if (prefix) {
            synonyms.add(prefix);
            synonyms.add(prefix + '-');
          }
        }
      }

      synonyms.forEach(function(nameVariant){
        if (!nameVariant) return;
        if (!Object.prototype.hasOwnProperty.call(vehicleInUseState.exact, nameVariant)) {
          vehicleInUseState.exact[nameVariant] = info.vehicleNumber;
        }
        const variantKey = vehicleNameKey(nameVariant);
        if (variantKey) {
          vehicleInUseState.lower[variantKey] = info.vehicleNumber;
        }
      });

      if (baseKey) {
        vehicleInUseState.lower[baseKey] = info.vehicleNumber;
      }

      const teamKey = teamNameKey(info.team);
      const projectKey = projectNameKey(info.project);
      const normalizedKeys = new Set();
      synonyms.forEach(function(nameVariant){
        const variantKey = vehicleNameKey(nameVariant);
        if (variantKey) normalizedKeys.add(variantKey);
      });
      if (baseKey) normalizedKeys.add(baseKey);

      normalizedKeys.forEach(function(variantKey){
        if (!variantKey) return;
        if (teamKey) {
          vehicleInUseState.teamPairs[teamKey + '|' + variantKey] = info.vehicleNumber;
        }
        if (projectKey) {
          vehicleInUseState.projectPairs[projectKey + '|' + variantKey] = info.vehicleNumber;
        }
      });

      vehicleInUseState.records.push(info);
    });

    window.vehicleInUseRecords = vehicleInUseState.records.slice();
    if (meta && meta.updatedAt) {
      vehicleInUseState.updatedAt = meta.updatedAt;
    }

    invalidateBeneficiaryVehicleCache();

    if (opts.skipPersistence !== true) {
      persistVehicleInUseCache({
        updatedAt: vehicleInUseState.updatedAt,
        records: vehicleInUseState.records
      });
    }

    if (window.vehicleAssignmentManager) {
      try {
        if (typeof window.vehicleAssignmentManager.hydrateFromSummary === 'function') {
          window.vehicleAssignmentManager.hydrateFromSummary(vehicleInUseState.records);
        } else if (typeof window.vehicleAssignmentManager.loadAssignmentsFromSummaries === 'function') {
          window.vehicleAssignmentManager.clearAll({ suppressUI: true });
          window.vehicleAssignmentManager.loadAssignmentsFromSummaries(vehicleInUseState.records);
        }
      } catch (managerErr) {
        console.error('[VehicleInUse] Failed to sync VehicleAssignmentManager from summaries', managerErr);
      }
    }

    applyVehicleInUseAssignmentsToRows(false);
    scheduleVehicleInUseReapply({ reason: 'store-records', attempts: 5, delay: 320 });
  }

  function processVehicleInUseResponse(res){
    try {
      const payload = res || {};
      let rows = [];
      const meta = {};
      if (Array.isArray(payload)) {
        rows = payload;
      } else {
        if (Array.isArray(payload.assignments)) {
          rows = payload.assignments;
        } else if (Array.isArray(payload.rows)) {
          rows = payload.rows;
        }
        meta.updatedAt = payload.updatedAt || payload.generatedAt || payload.timestamp || '';
      }
      vehicleInUseState.lastError = null;
      storeVehicleInUseRecords(rows, meta);
      try { applyVehicleInUseAssignmentsToRows(true); } catch (_forceErr) { /* best-effort */ }
      try {
        setTimeout(function(){
          try { maybeShowInitialVehicleMatchPopup(); } catch (_popupErr) { /* ignore */ }
        }, 120);
      } catch (_scheduleErr) {
        /* ignore */
      }
      scheduleVehicleInUseReapply({ reason: 'fetch-success', attempts: 6, delay: 320 });
    } catch (err) {
      vehicleInUseState.lastError = err;
      console.error('[VehicleInUse] Failed to process assignments', err);
    }
  }

  restoreVehicleInUseCache();

  function fetchVehicleInUseAssignments(){
    if (vehicleInUseState.fetching) return;
    if (!(window.google && google.script && google.script.run)) {
      console.warn('[VehicleInUse] google.script.run not available, skipping fetch');
      return;
    }
    vehicleInUseState.fetching = true;
    google.script.run
      .withSuccessHandler(function(res){
        vehicleInUseState.fetching = false;
        processVehicleInUseResponse(res);
      })
      .withFailureHandler(function(err){
        vehicleInUseState.fetching = false;
        vehicleInUseState.lastError = err;
        console.error('[VehicleInUse] Failed to load assignments', err);
      })
      .getVehicleInUseData();
  }

  window.refreshVehicleInUseData = fetchVehicleInUseAssignments;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchVehicleInUseAssignments);
    document.addEventListener('DOMContentLoaded', function(){
      scheduleVehicleInUseReapply({ reason: 'dom-ready', attempts: 6, delay: 300 });
    });
  } else {
    fetchVehicleInUseAssignments();
    scheduleVehicleInUseReapply({ reason: 'immediate-load', attempts: 6, delay: 300 });
  }

  ensureBeneficiaryVehicleCache();

  if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
    window.addEventListener('pageshow', function(){
      scheduleVehicleInUseReapply({ reason: 'pageshow', attempts: 6, delay: 300 });
    });
  }

  // ========================= Utilities =========================
  function getBody(){ return document.getElementById('tbody'); }

  function norm(v){ return (v==null? '' : String(v)).trim(); }
  function lower(v){ return norm(v).toLowerCase(); }

  // Designation priority (lower is earlier). Unknowns come after these, A→Z.
  var ROLE_ORDER = ['CM','PM','Mgr','TL','DTE','Tech','Rigg'];
  var ROLE_RANK = {};
  for (var i=0;i<ROLE_ORDER.length;i++){ ROLE_RANK[ROLE_ORDER[i].toLowerCase()] = i; }

  function roleRank(desig){
    var d = lower(desig);
    // starts-with matching (e.g., 'Manager' → 'Mgr')
    if (d.startsWith('chief')) return ROLE_RANK['cm'];
    if (d.startsWith('program') || d==='pm') return ROLE_RANK['pm'];
    if (d.startsWith('manag')) return ROLE_RANK['mgr'];
    if (d==='tl' || d.startsWith('team l')) return ROLE_RANK['tl'];
    if (d==='dte') return ROLE_RANK['dte'];
    if (d.startsWith('tech')) return ROLE_RANK['tech'];
    if (d.startsWith('rigg')) return ROLE_RANK['rigg'];
    // unknowns after defined set; we return a large base rank
    return 1000;
  }

  function teamOf(item){
    return norm(item.teamName || item.team || item.team_id || item.teamId || '');
  }
  function projectOf(item){
    return norm(item.projectName || item.project || '');
  }

  // ========================= Team vehicle prefill =========================
  const vehiclePrefillState = {
    pendingTeams: new Set(),
    timer: null,
    inFlightKey: ''
  };

  function scheduleTeamVehiclePrefill(items){
    if (!Array.isArray(items) || !items.length) return;
    items.forEach(function(it){
      const team = teamOf(it);
      if (team) vehiclePrefillState.pendingTeams.add(team);
    });
    if (vehiclePrefillState.timer) return;
    vehiclePrefillState.timer = setTimeout(function(){
      const teams = Array.from(vehiclePrefillState.pendingTeams).filter(Boolean);
      vehiclePrefillState.pendingTeams.clear();
      vehiclePrefillState.timer = null;
      requestTeamVehiclePrefill(teams);
    }, 150);
  }

  function requestTeamVehiclePrefill(teams){
    if (!Array.isArray(teams) || !teams.length) return;
    if (!(window.google && google.script && google.script.run)) return;
    const key = teams
      .map(function(t){ return String(t || '').toLowerCase(); })
      .filter(Boolean)
      .sort()
      .join('|');
    if (!key || vehiclePrefillState.inFlightKey === key) return;
    vehiclePrefillState.inFlightKey = key;

    google.script.run
      .withSuccessHandler(function(res){
        vehiclePrefillState.inFlightKey = '';
        try{
          if (!res || res.ok !== true || !res.teams) return;
          applyTeamVehiclePrefill(res.teams);
        }catch(err){ console.error('applyTeamVehiclePrefill failed', err); }
      })
      .withFailureHandler(function(err){
        vehiclePrefillState.inFlightKey = '';
        console.error('Team vehicle prefill failed:', err);
      })
      .getLatestInUseVehiclesForTeams(teams);
  }

  function applyTeamVehiclePrefill(mapping){
    if (!mapping) return;
    console.log('[PREFILL] ⚠️ Team vehicle prefill disabled to prevent overriding exclusive assignments');
    console.log('[PREFILL] Vehicle assignments should only be managed through the exclusive assignment system');
    
    // ❌ DISABLED: This function was filling vehicles for ALL team members
    // instead of respecting the exclusive assignment to responsible beneficiary only
    // 
    // Original logic was:
    // - Loop through all rows for each team
    // - Fill vehicle for every row in that team
    // - This violated the exclusive assignment principle
    //
    // Vehicles should ONLY be assigned through the Vehicle Assignment Manager
    // which ensures exclusive assignment to the responsible beneficiary
    
    return; // Exit early to prevent team-wide vehicle assignment
    
    // ❌ COMMENTED OUT - Original team-wide assignment logic
    /*
    const lowerMap = {};
    Object.keys(mapping).forEach(function(key){
      const info = mapping[key];
      if (!info || !info.carNumber) return;
      lowerMap[key.toLowerCase()] = info;
    });
    const rows = document.querySelectorAll('.tbody .row-data');
    rows.forEach(function(row){
      const team = String(row.getAttribute('data-team') || row.dataset.team || '').trim();
      if (!team) return;
      const info = mapping[team] || lowerMap[team.toLowerCase()];
      const input = row.querySelector('input.car-number-input');
      if (!input) return;
      if (!info || !info.carNumber) {
        if (input.dataset && input.dataset.prefillSource) {
          input.value = '';
          try { delete input.dataset.prefillSource; } catch(_){  }
          try { input.dispatchEvent(new Event('input', { bubbles:true })); } catch(_){  }
        }
        return;
      }
      if (input.value && input.value.trim() && !input.dataset.prefillSource) return;
      input.value = info.carNumber;
      try { input.dataset.prefillSource = info.source || 'inUse'; } catch(_){  }
      try { input.dispatchEvent(new Event('input', { bubbles:true })); } catch(_){  }
    });
    */
  }

  // ========================= Prototype clone =========================
  let protoRowTemplate = null;
  function ensurePrototype(){
    if (protoRowTemplate) return protoRowTemplate;
    const body = getBody();
    if (!body) return null;
    const proto = body.querySelector('.row-data');
    if (!proto) return null;
    const clone = proto.cloneNode(true);
    // Clear inputs
    clone.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'number' || inp.classList.contains('amt')) {
        inp.value = (inp.hasAttribute('readonly') ? inp.value : '');
      } else {
        inp.value = '';
      }
      inp.classList.remove('diff-flag');
    });
    // Reset splitflap lines to placeholders if present
    clone.querySelectorAll('.splitflap .line').forEach((line) => { line.textContent = 'DD - MM'; });
    // Ensure no stale attributes
    clone.removeAttribute('data-team'); clone.removeAttribute('data-project');
    clone.removeAttribute('data-default-da');
    try { delete clone.dataset.defaultDa; } catch(_){ /* ignore */ }
    protoRowTemplate = clone;
    return protoRowTemplate;
  }

  // ========================= Painter (fallback) =========================
  function hexToRgb(hex){ var h=hex.replace('#',''); if(h.length===3){h=h.split('').map(function(c){return c+c}).join(''); } var n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function rgba(hex,a){ var c=hexToRgb(hex); return 'rgba('+c.r+','+c.g+','+c.b+','+a+')'; }
  function hash32(str){ var h=2166136261>>>0; for(var i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  // Indian flag colors - Saffron, White, Green pattern for team distinction
  var PALETTE = ['#FF9933','#FFFFFF','#138808','#FFFFFF'];

  function miniPaintByTeam(orderedTeamList){
    try{
      var rows = Array.from(document.querySelectorAll('.tbody .row-data'));
      if(!rows.length) return;

      // Assign palette in sequential order for consistent Saffron-White-Green-White pattern
      var teamToColor = {};
      var order = orderedTeamList && orderedTeamList.length ? orderedTeamList : Array.from(new Set(rows.map(function(r){return r.getAttribute('data-team')||'';}))).filter(Boolean).sort();
      for (var k=0; k<order.length; k++){
        var key = order[k];
        var idx = k % PALETTE.length;
        teamToColor[key] = PALETTE[idx];
      }

      // Apply tints inline with alternating team highlighting
      var teamList = [];
      
      // First pass: collect unique teams in order
      rows.forEach(function(row){
        var t = row.getAttribute('data-team') || '';
        if(t && teamList.indexOf(t) === -1) {
          teamList.push(t);
        }
      });
      
      rows.forEach(function(row){
        var t = row.getAttribute('data-team') || '';
        if(!t) {
          return;
        }
        var accent = teamToColor[t]; if(!accent) return;
        var teamIndex = teamList.indexOf(t);
        
        // Teams cycle through saffron, white, green colors
        if(accent === '#FFFFFF') {
          // White teams get white background
          var tint = 'rgba(255, 255, 255, 0.03)';
          var tintIn = 'rgba(200, 200, 200, 0.05)';
        } else {
          // Colored teams get reduced intensity team color
          var tint = rgba(accent, 0.15);
           var tintIn = rgba(accent, 0.50);
        }
        var cells = row.getElementsByClassName('cell');
        Array.prototype.forEach.call(cells, function(c){ c.style.background = tint; });
        var inputs = row.querySelectorAll('.cell input, .cell select, .cell textarea');
        inputs.forEach(function(inp){ inp.style.backgroundColor = tintIn; });
      });
    }catch(e){ /* silent */ }
    scheduleMobDisplayHighlight();
  }

  function repaintTeams(orderedTeamList){
    if (window.FRTZ && typeof window.FRTZ.applyTeamTints === 'function'){
      try{ window.FRTZ.applyTeamTints(); scheduleMobDisplayHighlight(); return; }catch(e){ /* fall through */ }
    }
    miniPaintByTeam(orderedTeamList);
  }

  const MOB_INPUT_SELECTOR = '.tbody .cells > .cell:nth-child(11) input';
  const DISPLAY_INPUT_SELECTOR = '.tbody .cells > .cell:nth-child(12) input';
  const MOB_DISPLAY_EMPTY_CLASS = 'mob-display-empty';
  const MOB_DISPLAY_FILLED_CLASS = 'mob-display-filled';
  let mobDisplayHighlightScheduled = false;

  function isMobDisplayField(el){
    if (!el || typeof el.matches !== 'function') return false;
    return el.matches(MOB_INPUT_SELECTOR) || el.matches(DISPLAY_INPUT_SELECTOR);
  }

  function hasMeaningfulMobDisplayValue(el){
    if (!el) return false;
    const raw = String(el.value || '').trim();
    if (!raw) return false;

    const compactValue = raw.replace(/\s+/g, '');
    const lowerCompact = compactValue.toLowerCase();

    const placeholder = String(el.getAttribute('placeholder') || '').trim();
    if (placeholder && placeholder.toLowerCase().replace(/\s+/g, '') === lowerCompact) {
      return false;
    }

    if (!lowerCompact) {
      return false;
    }

    // Treat masked default values such as 0XXXXXXX as vacant so they remain red.
    if (/^0x+$/i.test(compactValue)) {
      return false;
    }

    // Explicitly treat "Display Name" (or casing variations) as unfilled.
    if (lowerCompact === 'displayname') {
      return false;
    }

    return true;
  }

  function updateMobDisplayHighlight(el){
    if (!el) return;
    const hasValue = hasMeaningfulMobDisplayValue(el);
    if (hasValue) {
      el.classList.add(MOB_DISPLAY_FILLED_CLASS);
      el.classList.remove(MOB_DISPLAY_EMPTY_CLASS);
    } else {
      el.classList.remove(MOB_DISPLAY_FILLED_CLASS);
      el.classList.add(MOB_DISPLAY_EMPTY_CLASS);
    }
  }

  function refreshMobDisplayHighlights(){
    const nodes = document.querySelectorAll(MOB_INPUT_SELECTOR + ', ' + DISPLAY_INPUT_SELECTOR);
    nodes.forEach(updateMobDisplayHighlight);
  }

  function scheduleMobDisplayHighlight(){
    if (mobDisplayHighlightScheduled) return;
    mobDisplayHighlightScheduled = true;
    onNextFrame(function(){
      mobDisplayHighlightScheduled = false;
      refreshMobDisplayHighlights();
    });
  }

  document.addEventListener('input', function(evt){
    const target = evt.target;
    if (!target || target.tagName !== 'INPUT') return;
    if (!isMobDisplayField(target)) return;
    updateMobDisplayHighlight(target);
  });

  document.addEventListener('change', function(evt){
    const target = evt.target;
    if (!target || target.tagName !== 'INPUT') return;
    if (!isMobDisplayField(target)) return;
    updateMobDisplayHighlight(target);
  });

  document.addEventListener('pp:applied', scheduleMobDisplayHighlight);
  document.addEventListener('pp:clear', scheduleMobDisplayHighlight);
  document.addEventListener('DOMContentLoaded', scheduleMobDisplayHighlight);

  window.refreshMobDisplayHighlights = refreshMobDisplayHighlights;

  // ========================= Row filling =========================
  function fillRowFromItem(row, it){
    // Target inputs by specific classes instead of position to avoid conflicts
    const beneficiaryInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
    const accountHolderInput = row.querySelector('input.account-holder-input');
    const carNumberInput = row.querySelector('input.car-number-input');
    const mobileInput = row.querySelector('.cells > .cell:nth-child(11) input');
    const displayNameInput = row.querySelector('.cells > .cell:nth-child(12) input');
    const designationInput = row.querySelector('input.txt[placeholder="Designation"], input.txt[placeholder*="Designation"]');
    const amts = row.querySelectorAll('input.amt'); // [Row Total, Fuel, ERDA, Car, Air, Misc]

    if (beneficiaryInput) beneficiaryInput.value = it.beneficiary || '';
    if (accountHolderInput) accountHolderInput.value = it.accountHolder || '';
    if (designationInput) designationInput.value = it.designation || '';
    if (mobileInput) mobileInput.value = it.mobNo || it.mobile || '';
    if (displayNameInput) displayNameInput.value = it.displayName || '';
    // Show vehicle number for beneficiaries present in Vehicle_InUse assignments
    if (carNumberInput) {
      const beneficiaryName = String(it.beneficiary || '').trim();
      const rowTeam = String(it.teamName || it.team || row.dataset.team || row.getAttribute('data-team') || '').trim();
      const rowProject = String(it.projectName || it.project || row.dataset.project || row.getAttribute('data-project') || '').trim();
      const teamKey = teamNameKey(rowTeam);
      const projectKey = projectNameKey(rowProject);
      let assignedVehicle = '';
      if (beneficiaryName) {
        assignedVehicle = getAssignedVehicleNumber(beneficiaryName, teamKey, projectKey);
      }

      if (assignedVehicle) {
        carNumberInput.value = assignedVehicle;
        try { carNumberInput.dataset.prefillSource = 'Vehicle_InUse'; } catch(_){ /* ignore */ }
        try { carNumberInput.setAttribute('data-prefill-source', 'Vehicle_InUse'); } catch(_){ /* ignore */ }
      } else if (carNumberInput.dataset && carNumberInput.dataset.prefillSource === 'Vehicle_InUse') {
        try { delete carNumberInput.dataset.prefillSource; } catch(_){ /* ignore */ }
        try { carNumberInput.removeAttribute('data-prefill-source'); } catch(_){ /* ignore */ }
      }
    }

    if (amts[0]) amts[0].value = (window.FRTZ && window.FRTZ.formatAmt ? window.FRTZ.formatAmt(0) : Number(0).toFixed(2));                 // Row Total
    // ER DA amount should remain empty by default - user must fill it manually
    // if (amts[2]) amts[2].value = (window.FRTZ && window.FRTZ.formatAmt ? window.FRTZ.formatAmt(it.erdaAmt || 0) : Number(it.erdaAmt || 0).toFixed(2));   // ER DA Amt

    applyDefaultDaToRow(row, it.beneficiary || '', typeof it.erdaAmt === 'number' ? it.erdaAmt : null);

    // diff flag
    if (it.diffNames){
      if (beneficiaryInput) beneficiaryInput.classList.add('diff-flag');
      if (accountHolderInput) accountHolderInput.classList.add('diff-flag');
    }

    // stamp team/project
    var tName = teamOf(it);
    if (tName){ row.dataset.team = tName; row.setAttribute('data-team', tName); } else { row.removeAttribute('data-team'); }
    var pName = projectOf(it);
    if (pName){
      row.dataset.project = pName;
      row.setAttribute('data-project', pName);
    } else {
      row.removeAttribute('data-project');
      try { delete row.dataset.project; } catch(_){ /* ignore */ }
    }
    
    // Build bDet object for car popup functionality
    if (!window.bDet) window.bDet = {};
    console.log('fillRowFromItem - Processing item:', it);
    console.log('fillRowFromItem - Beneficiary:', it.beneficiary, 'Team:', it.team, 'TeamName:', it.teamName);
    if (it.beneficiary && (it.team || it.teamName || it.teamId)) {
      const teamValue = it.team || it.teamName || it.teamId;
      window.bDet[it.beneficiary] = {
        team: teamValue,
        teamName: it.teamName || teamValue,
        project: it.project || it.projectName
      };
      console.log('fillRowFromItem - Added to bDet:', it.beneficiary, '→', window.bDet[it.beneficiary]);
    } else {
      console.log('fillRowFromItem - Skipped bDet (missing data):', {
        beneficiary: it.beneficiary,
        team: it.team,
        teamName: it.teamName,
        teamId: it.teamId
      });
    }
    console.log('fillRowFromItem - Current bDet state:', window.bDet);

    // Trigger name mismatch check after data is loaded
    setTimeout(function() {
      if (window.checkNameMismatch && typeof window.checkNameMismatch === 'function') {
        window.checkNameMismatch();
      }
    }, 100);

    scheduleMobDisplayHighlight();

    return row;
  }

  document.addEventListener('change', function(evt){
    const target = evt && evt.target;
    if (!target || target.tagName !== 'INPUT') return;
    if (!target.classList.contains('txt') || target.classList.contains('account-holder-input') || target.classList.contains('car-number-input')) return;
    const row = target.closest('.row-data');
    if (!row) return;
    const beneficiaryInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
    if (beneficiaryInput !== target) return;
    applyDefaultDaToRow(row, target.value || '');
  });

  // ========================= Sorting & Grouping =========================
  function sortItemsForRendering(items){
    // Build team order A→Z
    var teamOrder = Array.from(new Set(items.map(teamOf))).filter(Boolean).sort(function(a,b){ return a.localeCompare(b); });

    // Comparator: team by A→Z, then role priority, then beneficiary A→Z
    items.sort(function(a,b){
      var ta = teamOf(a), tb = teamOf(b);
      if (ta !== tb) return ta.localeCompare(tb);
      var ra = roleRank(a.designation), rb = roleRank(b.designation);
      if (ra !== rb){
        // known roles (rank < 1000) come before unknowns (1000)
        return ra - rb;
      }
      // both unknown → alphabetical by designation, then by beneficiary
      var da = lower(a.designation), db = lower(b.designation);
      if (da !== db) return da.localeCompare(db);
      return norm(a.beneficiary).localeCompare(norm(b.beneficiary));
    });

    return teamOrder;
  }

  // ========================= Public helpers =========================
  window.clearAllDataRows = function(){
    const body = getBody(); if (!body) return;
    while (body.firstChild) body.removeChild(body.firstChild);
  };

  function appendMany(items){
    const body = getBody(); if (!body) return;
    const tpl  = ensurePrototype(); if (!tpl) { console.error('No prototype .row-data found in tbody'); return; }

    items.forEach(function(it){
      const row = tpl.cloneNode(true);
      fillRowFromItem(row, it);
      body.appendChild(row);
    });
    if (typeof window.applyVehicleInUseAssignmentsToRows === 'function') {
      try { window.applyVehicleInUseAssignmentsToRows(false); } catch(_){ /* ignore */ }
    }
    scheduleMobDisplayHighlight();
    body.lastElementChild && body.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
  }

  window.appendRowsFromBeneficiaries = function(items){
    try{
      if (!Array.isArray(items) || !items.length) return;
      var teamOrder = sortItemsForRendering(items);
      appendMany(items);
      // repaint using the determined team order so adjacent blocks differ
      setTimeout(function(){ repaintTeams(teamOrder); }, 0);
      scheduleTeamVehiclePrefill(items);
    }catch(err){
      console.error('appendRowsFromBeneficiaries error:', err);
      alert('Could not add rows: ' + err);
    }
  };

  // Debounce mechanism to prevent multiple rapid animation triggers
  let replaceRowsTimeout = null;
  let lastReplaceCall = 0;
  
  window.replaceRowsFromBeneficiaries = function(items){
    const body = getBody(); if (!body) return;
    const tpl = ensurePrototype();
    
    // Clear any pending timeout
    if (replaceRowsTimeout) {
      clearTimeout(replaceRowsTimeout);
      replaceRowsTimeout = null;
    }
    
    // Debounce rapid calls within 100ms
    const now = Date.now();
    if (now - lastReplaceCall < 100) {
      replaceRowsTimeout = setTimeout(() => {
        window.replaceRowsFromBeneficiaries(items);
      }, 100);
      return;
    }
    
    lastReplaceCall = now;
    window.clearAllDataRows();
    if (!Array.isArray(items) || !items.length){ return; }
    var teamOrder = sortItemsForRendering(items);
    appendMany(items);
    setTimeout(function(){ repaintTeams(teamOrder); }, 0);
    scheduleTeamVehiclePrefill(items);
  };

})();
</script>

<!-- Vehicle match popup -->
<style>
  #vehicleMatchModal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.45);backdrop-filter:blur(3px);z-index:10000;}
  .vehicle-match-card{width:min(860px,96vw);max-height:82vh;background:#ffffff;border-radius:18px;box-shadow:0 24px 48px rgba(15,23,42,.28);overflow:hidden;display:flex;flex-direction:column;}
  .vehicle-match-header{padding:16px 18px;background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .vehicle-match-header h3{margin:0;font-size:16px;font-weight:800;}
  .vehicle-match-actions{display:flex;align-items:center;gap:8px;}
  .vehicle-match-actions button{appearance:none;border:0;border-radius:10px;padding:6px 12px;font-weight:600;cursor:pointer;}
  .vehicle-match-ratings{background:#ffffff;color:#1d4ed8;}
  .vehicle-match-ratings:hover{background:#e2e8f0;}
  .vehicle-match-close{background:rgba(255,255,255,.18);color:#fff;}
  .vehicle-match-close:hover{background:rgba(255,255,255,.3);}
  .vehicle-match-body{padding:18px;overflow:auto;}
  .vehicle-match-summary{margin:0 0 12px 0;font-size:14px;color:#1f2937;}
  .vehicle-match-table{width:100%;border-collapse:collapse;font-size:13px;}
  .vehicle-match-table th,.vehicle-match-table td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;white-space:normal;vertical-align:top;}
  .vehicle-match-table th{background:#f8fafc;font-weight:700;color:#0f172a;position:sticky;top:0;z-index:1;}
  .vehicle-days-cell{min-width:120px;}
  .vehicle-days-cell .vehicle-days-primary{font-weight:600;color:#0f172a;margin-bottom:2px;}
  .vehicle-days-cell .vehicle-days-secondary{font-size:12px;color:#64748b;}
  .vehicle-ratings-cell{min-width:140px;}
  .vehicle-rating-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
  .vehicle-rating-row:last-child{margin-bottom:0;}
  .vehicle-rating-stars{display:inline-flex;gap:2px;}
  .vehicle-star{font-size:13px;color:#d1d5db;position:relative;display:inline-block;line-height:1;}
  .vehicle-star.filled{color:#fbbf24;}
  .vehicle-star.half::before{content:'★';position:absolute;left:0;width:50%;overflow:hidden;color:#fbbf24;}
  .vehicle-rating-value{font-size:12px;color:#475569;font-weight:600;}
  .vehicle-remarks-cell{min-width:180px;}
  .vehicle-remark-line{font-size:12px;color:#334155;margin-bottom:4px;white-space:pre-wrap;}
  .vehicle-remark-line:last-child{margin-bottom:0;}
  .vehicle-empty-cell{color:#94a3b8;font-style:italic;}
  .vehicle-match-note{margin:14px 0 0 0;font-size:12px;color:#64748b;}
  #vehicleRatingsModal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.45);backdrop-filter:blur(3px);z-index:10001;}
  .vehicle-ratings-card{width:min(720px,94vw);max-height:78vh;background:#ffffff;border-radius:16px;box-shadow:0 20px 40px rgba(15,23,42,.25);overflow:hidden;display:flex;flex-direction:column;}
  .vehicle-ratings-header{padding:14px 16px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .vehicle-ratings-header h3{margin:0;font-size:15px;font-weight:800;}
  .vehicle-ratings-close{appearance:none;border:0;background:rgba(255,255,255,.18);color:#fff;border-radius:10px;padding:6px 12px;font-weight:600;cursor:pointer;}
  .vehicle-ratings-close:hover{background:rgba(255,255,255,.3);}
  .vehicle-ratings-body{padding:16px;overflow:auto;}
  .vehicle-ratings-summary{margin:0 0 10px 0;font-size:13px;color:#1f2937;}
  .vehicle-ratings-table{width:100%;border-collapse:collapse;font-size:13px;}
  .vehicle-ratings-table th,.vehicle-ratings-table td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;vertical-align:top;}
  .vehicle-ratings-table th{background:#f8fafc;font-weight:700;color:#0f172a;}
  .vehicle-ratings-empty{text-align:center;color:#94a3b8;font-style:italic;padding:18px 10px;}
  .vehicle-ratings-note{margin:12px 0 0;font-size:12px;color:#64748b;}
</style>

<div id="vehicleMatchModal" aria-hidden="true" role="dialog" aria-labelledby="vehicleMatchTitle">
  <div class="vehicle-match-card">
    <div class="vehicle-match-header">
      <h3 id="vehicleMatchTitle">Assigned Vehicles Found</h3>
      <div class="vehicle-match-actions">
        <button type="button" class="vehicle-match-ratings">View Ratings</button>
        <button type="button" class="vehicle-match-close">Close</button>
      </div>
    </div>
    <div class="vehicle-match-body">
      <p class="vehicle-match-summary">Loading assignments…</p>
      <table class="vehicle-match-table">
        <thead>
          <tr>
            <th>Beneficiary</th>
            <th>Vehicle</th>
            <th>Team</th>
            <th>Project</th>
            <th>Vehicle Used Since</th>
            <th>Last 3 Ratings</th>
            <th>Last 3 User Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="vehicle-match-note">Vehicle details combine Vehicle_InUse assignments with CarT_P history (ratings and user remarks) for the selected project and team.</p>
    </div>
  </div>
</div>

<div id="vehicleRatingsModal" aria-hidden="true" role="dialog" aria-labelledby="vehicleRatingsTitle">
  <div class="vehicle-ratings-card">
    <div class="vehicle-ratings-header">
      <h3 id="vehicleRatingsTitle">Team Ratings &amp; Remarks</h3>
      <button type="button" class="vehicle-ratings-close">Close</button>
    </div>
    <div class="vehicle-ratings-body">
      <p class="vehicle-ratings-summary">Loading ratings…</p>
      <table class="vehicle-ratings-table">
        <thead>
          <tr>
            <th>Team</th>
            <th>Vehicle</th>
            <th>Last 3 Ratings</th>
            <th>Last 3 User Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="vehicle-ratings-note">Ratings and remarks are sourced from the Vehicle_History snapshot for the selected teams.</p>
    </div>
  </div>
</div>

<!-- Debug: Car RELEASE list popup (for quick verification) -->
<style>
  #carDebugModal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:10000}
  #carDebugCard{width:min(720px,96vw);max-height:80vh;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column}
  #carDebugHdr{padding:12px 14px;background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;display:flex;align-items:center;justify-content:space-between}
  #carDebugHdr h3{margin:0;font-size:16px;font-weight:800}
  #carDebugClose{appearance:none;border:0;background:rgba(255,255,255,.18);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  #carDebugBd{padding:12px;overflow:auto}
  #carDebugTbl{width:100%;border-collapse:collapse;font-size:12px}
  #carDebugTbl th,#carDebugTbl td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left;white-space:nowrap}
  #carDebugTbl th{position:sticky;top:0;background:#f8fafc;z-index:1}
  #carDebugNote{font-size:12px;opacity:.75;margin:8px 0 0}
</style>

<div id="carDebugModal" aria-hidden="true" role="dialog" aria-labelledby="carDebugTitle">
  <div id="carDebugCard">
    <div id="carDebugHdr">
      <h3 id="carDebugTitle">Available Cars (Latest Entries)</h3>
      <button id="carDebugClose" type="button">Close</button>
    </div>
    <div id="carDebugBd">
      <div id="carDebugStatus">Loading…</div>
      <table id="carDebugTbl" style="display:none">
        <thead>
          <tr>
            <th>Car #</th>
            <th>Make</th>
            <th>Model</th>
            <th>Usage</th>
            <th>Contract</th>
            <th>Owner</th>
            <th>Status</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="carDebugBody"></tbody>
      </table>
      <div id="carDebugNote"></div>
    </div>
  </div>
  
  <script>
  (function(){
    const modal  = document.getElementById('carDebugModal');
    const close  = document.getElementById('carDebugClose');
    const status = document.getElementById('carDebugStatus');
    const table  = document.getElementById('carDebugTbl');
    const tbody  = document.getElementById('carDebugBody');
    const note   = document.getElementById('carDebugNote');

    // Request guard to avoid race conditions from rapid reopens
    let __reqId = 0;

    function fmtDate(v){ try{ return v ? new Date(v).toLocaleString() : ''; }catch(_){ return String(v||''); } }

    function openDebug(){
      const rid = ++__reqId; // token for this open action
      // State for finalization
      function isStale(){ return rid !== __reqId; }
      if(!window.google || !google.script || !google.script.run){
        alert('google.script.run not available. Please run as a deployed web app.');
        return;
      }
      modal.style.display='grid';
      status.textContent = 'Loading…';
      table.style.display = 'none';
      tbody.innerHTML = '';
      note.textContent = '';

      let populated = false;

      const appendMeta = function(metaLines){
        if (!metaLines || !metaLines.length) return;
        const existing = note.textContent ? note.textContent + '\n' : '';
        note.textContent = existing + metaLines.join('\n');
        note.style.whiteSpace = 'pre-wrap';
      };

      google.script.run
        .withSuccessHandler(function(res){
          try{
            if (isStale()) return;
            const ok = res && res.ok !== false;
            const list = ok && Array.isArray(res.vehicles) ? res.vehicles : [];
            const metaLines = [];
            metaLines.push(`Source: ${res && res.source ? res.source : 'Vehicle_Released'}`);
            if (res && res.sheetId) metaLines.push(`Sheet: ${res.sheetId}`);
            if (res && res.summaryMessage) metaLines.push(`Summary: ${res.summaryMessage}`);
            if (res && Array.isArray(res.notes) && res.notes.length) {
              metaLines.push('Notes:');
              res.notes.forEach(function(line){ metaLines.push(` - ${line}`); });
            }
            if (res && Array.isArray(res.tried) && res.tried.length) {
              metaLines.push(`Tried IDs: ${res.tried.join(', ')}`);
            }
            if (res && res.updatedAt) metaLines.push(`Updated: ${fmtDate(res.updatedAt)}`);

            if (!list.length) {
              status.textContent = 'No RELEASE vehicles found in Vehicle_Released.';
              appendMeta(metaLines);
              table.style.display = 'none';
              tbody.innerHTML = '';
              return;
            }

            status.textContent = '';
            const rows = list.map(function(c){
              return `<tr>
                <td>${c.carNumber||''}</td>
                <td>${c.make||''}</td>
                <td>${c.model||''}</td>
                <td>${c.usageType||''}</td>
                <td>${c.contractType||''}</td>
                <td>${c.owner||''}</td>
                <td>${c.status||''}</td>
                <td>${fmtDate(c.latestRelease || res.updatedAt)}</td>
              </tr>`;
            }).join('');
            tbody.innerHTML = rows;
            table.style.display = 'table';
            populated = true;
            metaLines.unshift(`Showing ${list.length} vehicles from Vehicle_Released.`);
            appendMeta(metaLines);
          } catch (err) {
            status.textContent = 'Failed to load Vehicle_Released data.';
            console.error(err);
          }
        })
        .withFailureHandler(function(err){
          if (isStale()) return;
          status.textContent = 'Failed to load vehicles: ' + err;
          console.error(err);
        })
        .getVehiclePickerData();
    }

    function closeDebug(){ modal.style.display='none'; }
    close.addEventListener('click', closeDebug);
    modal.addEventListener('click', function(e){ if(e.target===modal) closeDebug(); });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape' && modal.style.display==='grid') closeDebug(); });

    // Removed: account holder click -> car assignment modal trigger

    // Expose helpers if needed
    window.openCarReleaseDebug = openDebug;
    window.closeCarReleaseDebug = closeDebug;
  })();
  </script>
</div>

<!-- NEW: DDC fast‑path — instant client build on Apply (keeps your renderer; server confirms in background) -->
<script>
(function(){
  if (window.__DDC_FASTPATH_WIRED__) return; window.__DDC_FASTPATH_WIRED__ = true;

  function fromDDC(projectId, teamIds){
    try{
      var tag = document.getElementById('DDC');
      if (!tag) return null;
      var pack = JSON.parse(tag.textContent||'{}');
      if (!pack || !Array.isArray(pack.rows)) return null;
      var p = (projectId||'').trim();
      var tset = new Set((teamIds||[]).map(function(s){ return String(s||'').trim(); }));
      var have = tset.size>0;
      var out = [];
      for (var i=0;i<pack.rows.length;i++){
        var r = pack.rows[i]; // [ben, acct, desig, erda, proj, team, mob, display]
        if (!r || r[4]!==p) continue;
        var team = String(r[5]||'');
        if (have && !tset.has(team)) continue;
        var ben = String(r[0]||'');
        if (!ben) continue;
        const mobNo = r.length > 6 ? String(r[6] || '').trim() : '';
        const displayName = r.length > 7 ? String(r[7] || '').trim() : '';
        out.push({
          beneficiary: ben,
          accountHolder: String(r[1]||''),
          designation: String(r[2]||''),
          erdaAmt: Number(r[3]||0),
          project: p,
          projectName: p,
          team: team,
          teamId: team,
          teamName: team,
          diffNames: (ben && r[1]) ? (ben.toLowerCase() !== String(r[1]).toLowerCase()) : false,
          mobNo: mobNo,
          mobile: mobNo,
          displayName: displayName
        });
      }
      out.sort(function(a,b){ return (a.beneficiary||'').localeCompare(b.beneficiary||''); });
      return out;
    }catch(e){
      console.warn('DDC parse/build failed', e);
      return null;
    }
  }

  // Capture-phase listener so we run before bubble listeners
  document.addEventListener('pp:applied', function(e){
    try{
      var d = (e && e.detail) || {};
      var projectId = d.projectId || '';
      var teamIds = d.teamIds || [];
      if (!projectId) return;
      var arr = fromDDC(projectId, teamIds);
      if (Array.isArray(arr)){
        // Instant paint using your existing builder
        if (window.replaceRowsFromBeneficiaries) window.replaceRowsFromBeneficiaries(arr);
        // Do NOT stop propagation; downstream handler will confirm/replace from server/cache.
      }
    }catch(err){ console.warn('DDC fast-path error', err); }
  }, { capture: true });
})();
</script>

<!-- Wire Right Side Sheet → data rows (your last working Apply logic, unchanged) -->
<script>
// Wire Right Side Sheet → data rows (with Instant Apply cache-first)
(function(){
  function arr(v){ return Array.isArray(v)? v : (v? [v] : []); }
  function setBusy(b){
    try{
      var a = document.getElementById('ppApply');
      if (a){ if (b){ a.dataset.busy='1'; } else { delete a.dataset.busy; } }
    }catch(_){}
  }
  document.addEventListener('pp:applied', function(e){
    var d = (e && e.detail) || {};
    var projectId = d.projectId || '';
    var teamIds = d.teamIds || [];
    if (!projectId){ return; }

    // 1) Try cache first for instant paint
    var cached = (window.ppGetCached && window.ppGetCached(projectId, teamIds)) || null;
    if (cached && cached.length){
      try { window.replaceRowsFromBeneficiaries(cached); } catch(_){}
      // Background refresh for authority (optional)
      google.script.run.withSuccessHandler(function(items){
        try { window.replaceRowsFromBeneficiaries(items || []); } catch(_){}
      }).getBeneficiaries(projectId, teamIds);
      return;
    }

    // 2) Fallback to RPC if cache not ready
    setBusy(true);
    google.script.run
      .withSuccessHandler(function(items){
        try { window.replaceRowsFromBeneficiaries(items || []); } catch(_){}
        setBusy(false);
      })
      .withFailureHandler(function(err){
        console.error('getBeneficiaries failed:', err);
        setBusy(false);
        alert('Could not load beneficiaries for the selected project/teams.');
      })
      .getBeneficiaries(projectId, teamIds);
  });

  document.addEventListener('pp:clear', function(){
    try{ window.clearAllDataRows(); }catch(_){}
  });
})();

/* === Submit Functionality === */
(function(){
  'use strict';
  
  // Function to check for validation violations
  function hasValidationViolations() {
    if (typeof window.getValidationState === 'function') {
      const validationState = window.getValidationState();
      if (validationState && validationState.size > 0) {
        for (let [key, state] of validationState) {
          // Only consider actual error states as violations
          if (state.type === 'missing-dates' || state.type === 'missing-amount') {
            console.log('Validation violation found:', key, state);
            return true;
          }
        }
      }
    }
    return false;
  }
  
  // Function to collect all form data regardless of filtering
  function collectAllFormData() {
    // Get project name from header bar
    let globalProjectName = '';
    const selectedProjectNameElement = document.getElementById('selectedProjectName');
    if (selectedProjectNameElement && selectedProjectNameElement.textContent.trim()) {
      // Extract just the project name (remove existing counts if any)
      const fullText = selectedProjectNameElement.textContent.trim();
      globalProjectName = fullText.split(' [')[0]; // Get text before first bracket
    }
    
    // Make project name globally accessible
    window.globalProjectName = globalProjectName;
    
    const rows = [];
    const allRowElements = document.querySelectorAll('.tbody .row-data');
    
    allRowElements.forEach(rowElement => {
      // Get input elements using the correct selectors
      const beneficiaryElement = rowElement.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
      const accountHolderElement = rowElement.querySelector('input.account-holder-input');
      const designationElement = rowElement.querySelector('.cell:nth-child(4) input.txt');
      const mobElement = rowElement.querySelector('.cell:nth-child(11) input.txt');
      const displayNameElement = rowElement.querySelector('.cell:nth-child(12) input.txt');
      const whChargesElement = rowElement.querySelector('.cell:nth-child(13) input.amt');
      const remarksElement = rowElement.querySelector('.cell:nth-child(14) input.txt');
      const totalElement = rowElement.querySelector('input.amt[readonly]');
      
      if (!beneficiaryElement) return; // Skip if no beneficiary input
      
      const beneficiaryName = beneficiaryElement.value.trim();
      if (!beneficiaryName) return; // Skip empty rows
      
      // Get team and project info
      let team = '';
      let project = globalProjectName; // Use project name from header bar
      
      // Try to get team name using the same logic as getActualTeamNameFromRow
      if (typeof getActualTeamNameFromRow === 'function') {
        team = getActualTeamNameFromRow(rowElement) || '';
      } else {
        // Fallback: get team from data attributes or bDet
        const ds = rowElement.dataset;
        team = (ds.teamName || ds.team || ds.teamid || '').trim();
        if (!team && window.bDet && window.bDet[beneficiaryName]) {
          team = window.bDet[beneficiaryName].teamName || window.bDet[beneficiaryName].team || '';
        }
      }
      
      // Fallback for project from bDet if not found in header
      if (!project && window.bDet && window.bDet[beneficiaryName]) {
        project = window.bDet[beneficiaryName].project || '';
      }
      
      // Collect expense data for each category
      const categories = ['fuel', 'erda', 'car', 'air', 'transport', 'misc'];
      const expenseData = {};
      
      categories.forEach(category => {
        const container = rowElement.querySelector(`[data-cal="${category}"]`);
        if (container) {
          const amountInput = container.querySelector('.amount-input');
          const amount = amountInput ? parseFloat(amountInput.value.replace(/,/g, '')) || 0 : 0;
          
          // Get date information from pills
          let fromDate = '';
          let toDate = '';
          const pills = container.querySelectorAll('.splitflap--holo');
          if (pills.length >= 2) {
            const fromPill = pills[0];
            const toPill = pills[1];
            
            const fromDay = fromPill.querySelector('.day')?.textContent?.trim();
            const fromMonth = fromPill.querySelector('.month')?.textContent?.trim();
            const toDay = toPill.querySelector('.day')?.textContent?.trim();
            const toMonth = toPill.querySelector('.month')?.textContent?.trim();
            
            if (fromDay && fromMonth && fromDay !== 'DD' && fromMonth !== 'MM') {
              const currentYear = new Date().getFullYear();
              // Convert month abbreviation to numeric format
              const monthAbbr = ['JA','FE','MA','AP','MA','JU','JL','AU','SE','OC','NO','DE'];
              const monthIndex = monthAbbr.indexOf(fromMonth);
              const monthNum = monthIndex >= 0 ? String(monthIndex + 1).padStart(2, '0') : fromMonth;
              // Ensure day is zero-padded and use DD/MM/YYYY format for backend parsing
              const dayPadded = String(fromDay).padStart(2, '0');
              fromDate = `${dayPadded}/${monthNum}/${currentYear}`;
            }
            if (toDay && toMonth && toDay !== 'DD' && toMonth !== 'MM') {
              const currentYear = new Date().getFullYear();
              // Convert month abbreviation to numeric format
              const monthAbbr = ['JA','FE','MA','AP','MA','JU','JL','AU','SE','OC','NO','DE'];
              const monthIndex = monthAbbr.indexOf(toMonth);
              const monthNum = monthIndex >= 0 ? String(monthIndex + 1).padStart(2, '0') : toMonth;
              // Ensure day is zero-padded and use DD/MM/YYYY format for backend parsing
              const dayPadded = String(toDay).padStart(2, '0');
              toDate = `${dayPadded}/${monthNum}/${currentYear}`;
            }
          }
          
          expenseData[category] = {
            from: fromDate,
            to: toDate,
            amount: amount
          };
        }
      });
      
      const rowData = {
        beneficiary: beneficiaryName,
        accountHolder: accountHolderElement ? accountHolderElement.value.trim() : '',
        team: team,
        project: project,
        teamName: team, // Add explicit teamName field
        projectName: project, // Add explicit projectName field
        total: totalElement ? parseFloat(totalElement.value.replace(/,/g, '')) || 0 : 0,
        designation: designationElement ? designationElement.value.trim() : '',
        fuel: expenseData.fuel,
        erda: expenseData.erda,
        car: expenseData.car,
        air: expenseData.air,
        transport: expenseData.transport,
        misc: expenseData.misc,
        mob: mobElement ? mobElement.value.trim() : '',
        displayName: displayNameElement ? displayNameElement.value.trim() : '',
        whCharges: whChargesElement ? parseFloat(whChargesElement.value.replace(/,/g, '')) || 0 : 0,
        remarks: remarksElement ? remarksElement.value.trim() : ''
      };
      
      rows.push(rowData);
    });
    
    return rows;
  }
  
  // Submit button event handler
  function handleSubmit() {
    // Check for validation violations
    if (hasValidationViolations()) {
      // Get specific validation errors for better user feedback
      const validationState = window.getValidationState();
      const errors = [];
      if (validationState) {
        for (let [key, state] of validationState) {
          if (state.type === 'missing-dates') {
            errors.push(`${key}: Amount entered but dates not selected`);
          } else if (state.type === 'missing-amount') {
            errors.push(`${key}: Dates selected but amount is zero`);
          }
        }
      }
      
      const errorMessage = errors.length > 0 
        ? `Cannot submit due to validation errors:\n\n${errors.join('\n')}\n\nPlease resolve all validation errors (red highlights and traffic lights) before submitting.`
        : 'Cannot submit: Please resolve all validation errors (red highlights and traffic lights) before submitting.';
      
      alert(errorMessage);
      return;
    }
    
    // Collect all form data
    const formData = collectAllFormData();
    
    if (formData.length === 0) {
      alert('No data to submit. Please add some beneficiaries and fill in their information.');
      return;
    }
    
    // Prepare submission data
    const submissionData = {
      rows: formData,
      hasViolations: false
    };
    
    // Show loading state
    const submitBtn = document.getElementById('btnSubmit');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    // Call Google Apps Script function
    google.script.run
      .withSuccessHandler(function(result) {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        
        if (result.ok) {
          alert(`Successfully submitted ${result.submitted} records with Submission ID: ${result.submissionId}`);
          // Optionally clear the form or redirect
        } else {
          alert('Submission failed: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        alert('Submission failed: ' + error.message);
      })
      .submitToSubmissions(submissionData);
  }
  
  // Wire up submit button when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('btnSubmit');
    if (submitBtn) {
      submitBtn.addEventListener('click', handleSubmit);
    }
    
    // Also wire up via FRTZ if available
    if (window.FRTZ && window.FRTZ.submitBtn) {
      window.FRTZ.submitBtn.addEventListener('click', handleSubmit);
    }
  });
  
  // Expose submit function globally for testing
  window.handleFormSubmit = handleSubmit;
  window.collectAllFormData = collectAllFormData;
  window.hasValidationViolations = hasValidationViolations;
})();
</script>

<!-- Debug: Alt+Click Beneficiary to write a test value to CarT_P!A (first blank) -->
<script>
(function(){
  document.addEventListener('click', function(e){
    // Target: first cell input (Beneficiary) within a row
    const inp = e.target.closest('.tbody .row-data .cell:first-child input.txt');
    if (!inp) return;
    // Require Alt key to avoid interfering with normal typing/clicking
    if (!e.altKey) return;
    e.preventDefault();
    if (!window.google || !google.script || !google.script.run){
      alert('google.script.run not available (not running as web app).');
      return;
    }
    const val = prompt('Enter a test value to write to CarT_P column A (Ref):', 'TEST');
    if (val === null) return; // cancelled
    google.script.run
      .withSuccessHandler(function(res){
        if (res && res.ok){
          alert('Wrote to CarT_P at A' + res.row + ': ' + res.value);
        } else {
          alert('Write failed: ' + (res && res.error ? res.error : 'Unknown error'));
        }
      })
      .withFailureHandler(function(err){
        alert('Write failed: ' + err);
      })
      .debugWriteTest(val);
  });
})();

// Removed: testCarAssignmentModal (car assignment functionality removed)

// Debug function to test CarT_P sheet connection
function debugCarTPConnection() {
  console.log('=== DEBUGGING CART_P CONNECTION ===');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    console.log('Google Apps Script available, testing CarT_P connection...');
    
    // Call the backend function to get detailed debug info
    google.script.run
      .withSuccessHandler((result) => {
        console.log('testCarConnection result:', result);
        if (result && result.success) {
          const debug = result.debug;
          const cars = result.cars;
          const carCount = result.carCount || 0;
          const allCars = result.allCars;
          const allCarsCount = result.allCarsCount || 0;
          
          let message = `CarT_P Sheet Status: OK\n`;
          message += `Sheet ID: ${debug.sheetId}\n`;
          message += `Rows: ${debug.lastRow}\n`;
          message += `Columns: ${debug.lastCol}\n`;
          message += `Total Vehicles: ${allCarsCount}\n`;
          message += `RELEASE Vehicles: ${carCount}\n`;
          
          if (allCars && allCars.length > 0) {
            message += `\nAll Vehicles (first 3):\n`;
            allCars.slice(0, 3).forEach((car, i) => {
              message += `${i+1}. ${car.make} ${car.model} (${car.carNumber}) - Status: '${car.status}'\n`;
            });
          }
          
          if (cars && cars.length > 0) {
            message += `\nRELEASE Vehicles:\n`;
            cars.slice(0, 3).forEach((car, i) => {
              message += `${i+1}. ${car.make} ${car.model} (${car.carNumber}) - Status: '${car.status}'\n`;
            });
          } else {
            message += `\nNo RELEASE vehicles found. Check status values in CarT_P sheet.`;
          }
          
          alert(message);
        } else {
          const errMsg = (result && (result.error || result.reason)) ? (result.error || result.reason) : 'Unknown error';
          alert(`CarT_P Sheet Status: ERROR\nError: ${errMsg}`);
        }
      })
      .withFailureHandler((error) => {
        console.error('testCarConnection failed:', error);
        alert(`Failed to check CarT_P sheet: ${error.message || error}`);
      })
      .testCarConnection();
  } else {
    console.error('Google Apps Script not available!');
    alert('Google Apps Script not available in this environment.');
  }
}

// Function to add sample car data to CarT_P sheet
function addSampleCarData() {
  console.log('Adding sample vehicle data...');
  
  // Check if Google Apps Script is available
  if (typeof google === 'undefined' || !google.script) {
    alert('Google Apps Script not available. This function only works when deployed to Google Apps Script.');
    console.error('Google Apps Script not available');
    return;
  }
  
  // Confirm with user before adding data
  if (!confirm('This will add 5 sample vehicle records to the CarT_P sheet. Continue?')) {
    return;
  }
  
  // Call the backend function
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('addSampleCarData result:', result);
      if (result && result.success) {
        alert(`Success: ${result.message}\nRecords added: ${result.recordsAdded}`);
        // Optionally refresh any UI dependent on vehicle data
        console.log('Sample vehicle data added successfully');
      } else {
        alert(`Error adding sample data: ${result ? result.error : 'Unknown error'}`);
      }
    })
    .withFailureHandler(function(error) {
      console.error('addSampleCarData failed:', error);
      alert(`Failed to add sample vehicle data: ${error.message || error}`);
    })
    .addSampleCarData();
}

</script>
