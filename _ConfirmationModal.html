<style>
  /* Modal overlay with dimmed, blurred background */
  .confirmation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    padding: 32px 16px;
    overflow-y: auto;
  }

  .confirmation-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  /* Modal card with spring animation */
  .confirmation-modal {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 40px 36px;
    max-width: 560px;
    width: min(96%, 560px);
    max-height: min(92vh, 760px);
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 8px 32px rgba(0, 0, 0, 0.15);
    transform: scale(0.7) translateY(50px);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .confirmation-overlay.show .confirmation-modal {
    transform: scale(1) translateY(0);
  }

  /* Pulsing badge */
  .confirmation-badge {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    margin: 0 auto 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    animation: pulse 2s ease-in-out infinite;
  }

  .confirmation-badge::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    opacity: 0.3;
    animation: pulse-ring 2s ease-in-out infinite;
  }

  .confirmation-badge svg {
    width: 40px;
    height: 40px;
    fill: white;
    z-index: 1;
    position: relative;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  @keyframes pulse-ring {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.1); opacity: 0.1; }
    100% { transform: scale(1.2); opacity: 0; }
  }

  /* Modal content */
  .confirmation-title {
    font-size: 24px;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 12px;
    line-height: 1.2;
  }

  .confirmation-message {
    font-size: 16px;
    color: #718096;
    margin-bottom: 32px;
    line-height: 1.5;
  }

  /* Button container */
  .confirmation-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
  }

  @media (min-width: 520px) {
    .confirmation-buttons {
      flex-direction: row;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
    }
  }

  .confirmation-btn {
    position: relative;
    border-radius: 16px;
    padding: 14px 28px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    overflow: hidden;
    flex: 1 1 220px;
    min-width: 220px;
  }

  @media (max-width: 519.98px) {
    .confirmation-btn {
      width: 100%;
      min-width: 0;
    }
  }

  .confirmation-btn:focus-visible {
    outline: 3px solid rgba(102, 126, 234, 0.35);
    outline-offset: 2px;
  }

  .confirmation-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    box-shadow: 0 12px 32px rgba(102, 126, 234, 0.35);
  }

  .confirmation-btn.primary:hover {
    transform: perspective(1000px) rotateX(-4deg) rotateY(4deg);
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
  }

  .confirmation-btn.primary:active {
    transform: scale(0.98);
  }

  .confirmation-btn.success {
    background: linear-gradient(135deg, #34d399 0%, #059669 100%);
    color: #fff;
    box-shadow: 0 12px 32px rgba(52, 211, 153, 0.35);
  }

  .confirmation-btn.success:hover {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #22c55e 0%, #047857 100%);
  }

  .confirmation-btn.success:active {
    transform: scale(0.98);
  }

  .confirmation-btn.destructive {
    background: linear-gradient(135deg, #f56565 0%, #e11d48 100%);
    color: #fff;
    box-shadow: 0 12px 32px rgba(229, 62, 62, 0.3);
  }

  .confirmation-btn.destructive:hover {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #ef4444 0%, #be123c 100%);
  }

  .confirmation-btn.destructive:active {
    transform: scale(0.98);
  }

  .confirmation-btn.accent {
    background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
    color: #fff;
    box-shadow: 0 12px 32px rgba(14, 165, 233, 0.3);
  }

  .confirmation-btn.accent:hover {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
  }

  .confirmation-btn.accent:active {
    transform: scale(0.98);
  }

  .confirmation-message[hidden] {
    display: none;
  }

  .confirmation-content {
    margin: 0 0 28px;
    text-align: left;
  }

  .confirmation-content[hidden] {
    display: none;
  }

  .release-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .release-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px 18px;
  }

  .release-info-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .release-info-label {
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #718096;
  }

  .release-info-value {
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
    word-break: break-word;
  }

  .release-section {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .release-section-title {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: #2d3748;
  }

  .release-section-hint {
    font-size: 13px;
    color: #718096;
  }

  .release-ratings-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .release-rating-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .release-rating-label {
    font-weight: 600;
    color: #2d3748;
    flex: 1 1 220px;
  }

  .release-rating-stars {
    display: inline-flex;
    gap: 6px;
  }

  .release-star {
    background: transparent;
    border: none;
    color: #d5d9e5;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    padding: 2px;
    transition: color 0.15s ease, transform 0.15s ease;
  }

  .release-star:hover,
  .release-star:focus {
    color: #f6ad55;
    transform: translateY(-1px);
    outline: none;
  }

  .release-star.filled {
    color: #f59e0b;
  }

  .release-star.selected {
    color: #d97706;
  }

  .release-star:focus-visible {
    outline: 2px solid rgba(245, 158, 11, 0.45);
    outline-offset: 2px;
  }

  .release-review-input {
    width: 100%;
    min-height: 110px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.65);
    padding: 12px 14px;
    font-size: 14px;
    resize: vertical;
    background: rgba(255, 255, 255, 0.95);
    color: #1a202c;
  }

  .release-review-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    outline: none;
  }

  .release-error {
    font-size: 13px;
    color: #e53e3e;
    min-height: 18px;
  }

  .confirmation-btn.secondary {
    background: transparent;
    color: #4a5568;
    border: 2px solid #e2e8f0;
  }

  .confirmation-btn.secondary:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
  }

  .confirmation-btn.secondary:active {
    transform: scale(0.98);
  }

  .confirmation-btn.with-feedback::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .confirmation-btn.with-feedback.ripple::before {
    width: 260px;
    height: 260px;
  }

  .confirmation-btn.with-feedback.success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
    animation: success-halo 0.6s ease-out;
  }

  @keyframes success-halo {
    0% {
      box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
    }
    70% {
      box-shadow: 0 0 0 20px rgba(72, 187, 120, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(72, 187, 120, 0);
    }
  }

  /* View cost breakdown link */
  .confirmation-link {
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    margin-top: 16px;
    display: inline-block;
    transition: color 0.3s ease;
  }

  .confirmation-link:hover {
    color: #5a67d8;
    text-decoration: underline;
  }

  /* Close indicator */
  .confirmation-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 8px;
    height: 8px;
    background: #f56565;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .confirmation-close:hover {
    transform: scale(1.2);
  }
</style>

<div class="confirmation-overlay" id="confirmationModal">
  <div class="confirmation-modal">
    <div class="confirmation-close" onclick="closeConfirmationModal()"></div>
    
    <div class="confirmation-badge">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7.5V9M15 11.5V9.5L21 9V11L15 11.5ZM11 12C8.8 12 7 10.2 7 8S8.8 4 11 4 15 5.8 15 8 13.2 12 11 12ZM11 14C14.3 14 17 16.7 17 20V22H5V20C5 16.7 7.7 14 11 14Z"/>
      </svg>
    </div>
    
    <h2 class="confirmation-title" id="confirmationTitle">Reactivate beneficiary?</h2>
    <p class="confirmation-message" id="confirmationMessage">Re-enabling means you'll fund their expenses. Continue?</p>

    <div class="confirmation-content" id="confirmationContent" hidden></div>

    <div class="confirmation-buttons" id="confirmationButtons"></div>
    
    <a href="#" class="confirmation-link" onclick="viewCostBreakdown()">View cost breakdown</a>
  </div>
</div>

<script>
(function() {
  let currentResolve = null;
  let currentReject = null;
  let buttonConfigs = [];
  let buttonElements = [];
  let currentOptions = {};
  const DEFAULT_TITLE = 'Reactivate beneficiary?';
  const DEFAULT_MESSAGE = "Re-enabling means you'll fund their expenses. Continue?";

  function getContentSlot() {
    return document.getElementById('confirmationContent');
  }

  function clearModalContent() {
    const slot = getContentSlot();
    if (!slot) return;
    slot.innerHTML = '';
    slot.hidden = true;
  }

  function resolveContentNode(contentOption) {
    if (contentOption == null) {
      return null;
    }
    if (typeof contentOption === 'function') {
      try {
        return contentOption();
      } catch (err) {
        console.error('showConfirmationModal content renderer failed', err);
        return null;
      }
    }
    return contentOption;
  }

  function applyModalContent(contentOption) {
    const slot = getContentSlot();
    if (!slot) return;
    clearModalContent();
    const node = resolveContentNode(contentOption);
    if (!node && node !== '') {
      return;
    }
    if (typeof node === 'string') {
      slot.innerHTML = node;
      slot.hidden = false;
      return;
    }
    if (node instanceof Node) {
      slot.appendChild(node);
      slot.hidden = false;
      return;
    }
    if (node && typeof node === 'object' && typeof node.nodeType === 'number') {
      slot.appendChild(node);
      slot.hidden = false;
      return;
    }
    if (node === '') {
      slot.innerHTML = '';
      slot.hidden = false;
    }
  }

  function normalizeButtons(options = {}) {
    const supplied = Array.isArray(options.buttons) ? options.buttons.filter(Boolean) : [];
    if (supplied.length) {
      return supplied.map((btn, index) => {
        const role = btn.role || (index === 0 ? 'confirm' : 'option');
        const variant = btn.variant || (role === 'destructive' ? 'destructive' : role === 'cancel' ? 'secondary' : 'primary');
        const value = Object.prototype.hasOwnProperty.call(btn, 'value') ? btn.value : (role === 'cancel' ? false : btn.text || true);
        return {
          text: btn.text || btn.label || `Option ${index + 1}`,
          value,
          role,
          variant,
          feedback: btn.feedback === undefined ? (variant === 'primary') : Boolean(btn.feedback),
          successText: btn.successText,
          focus: btn.focus === true,
          id: btn.id ? String(btn.id) : ''
        };
      });
    }

    return [
      {
        text: options.yesText || 'Yes',
        value: true,
        role: 'confirm',
        variant: 'primary',
        feedback: true,
        successText: options.successText || '✓ Confirmed'
      },
      {
        text: options.noText || 'Cancel',
        value: false,
        role: 'cancel',
        variant: 'secondary',
        feedback: false
      }
    ];
  }

  function resetButtons() {
    buttonElements.forEach(btn => {
      btn.classList.remove('ripple', 'success');
      if (btn.dataset && btn.dataset.originalText) {
        btn.textContent = btn.dataset.originalText;
      }
    });
    buttonElements = [];
    buttonConfigs = [];
  }

  function renderButtons(configs) {
    const container = document.getElementById('confirmationButtons');
    container.innerHTML = '';
    buttonElements = configs.map((config, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `confirmation-btn ${config.variant}`;
      if (config.feedback) {
        btn.classList.add('with-feedback');
      }
      btn.textContent = config.text;
      btn.dataset.index = String(index);
      btn.dataset.originalText = config.text;
      if (config.id) {
        btn.dataset.buttonId = config.id;
      }
      btn.addEventListener('click', () => selectButton(index));
      container.appendChild(btn);
      return btn;
    });
  }

  function selectButton(index) {
    const config = buttonConfigs[index];
    const btn = buttonElements[index];
    if (!config || !btn) return;

    let didResolve = false;

    const finalize = () => {
      if (didResolve) return;
      didResolve = true;
      const resolver = currentResolve;
      currentResolve = null;
      if (typeof resolver === 'function') {
        resolver(config.value);
      }
      closeConfirmationModal({ resolve: true });
    };

    const proceed = () => {
      if (didResolve) return;
      if (config.feedback && btn.classList.contains('with-feedback')) {
        btn.classList.add('ripple');
        setTimeout(() => {
          btn.classList.add('success');
          btn.textContent = config.successText || '✓ Confirmed';
          setTimeout(finalize, 650);
        }, 120);
      } else {
        finalize();
      }
    };

    let prevented = false;
    const meta = {
      button: btn,
      config,
      index,
      preventDefault: () => { prevented = true; },
      proceed,
      close: finalize
    };

    if (currentOptions && typeof currentOptions.onSelect === 'function') {
      try {
        const result = currentOptions.onSelect(config.value, meta);
        if (prevented || result === false) {
          return;
        }
        if (result && typeof result.then === 'function') {
          btn.disabled = true;
          result.then(res => {
            if (res === false) return;
            proceed();
          }).catch(err => {
            console.error('showConfirmationModal onSelect promise rejected', err);
          }).finally(() => {
            btn.disabled = false;
          });
          return;
        }
      } catch (err) {
        console.error('showConfirmationModal onSelect handler failed', err);
      }
    }

    proceed();
  }

  function focusInitialButton() {
    const explicitIndex = buttonConfigs.findIndex(cfg => cfg.focus);
    const targetIndex = explicitIndex >= 0 ? explicitIndex : 0;
    const btn = buttonElements[targetIndex];
    if (btn) {
      btn.focus();
    }
  }

  // Show confirmation modal
  window.showConfirmationModal = function(options = {}) {
    return new Promise((resolve, reject) => {
      currentResolve = resolve;
      currentReject = reject;
      currentOptions = options || {};

      const modal = document.getElementById('confirmationModal');
      const title = document.getElementById('confirmationTitle');
      const message = document.getElementById('confirmationMessage');

      const nextTitle = Object.prototype.hasOwnProperty.call(currentOptions, 'title') && currentOptions.title
        ? currentOptions.title
        : DEFAULT_TITLE;
      if (title) {
        title.textContent = nextTitle;
      }

      const messageProvided = Object.prototype.hasOwnProperty.call(currentOptions, 'message');
      const nextMessage = messageProvided ? currentOptions.message : DEFAULT_MESSAGE;
      if (message) {
        if (typeof nextMessage === 'string' && nextMessage.trim()) {
          message.textContent = nextMessage;
          message.hidden = false;
        } else if (typeof nextMessage === 'string') {
          message.textContent = nextMessage;
          message.hidden = true;
        } else {
          message.textContent = '';
          message.hidden = true;
        }
      }

      applyModalContent(currentOptions.content || currentOptions.html || null);

      buttonConfigs = normalizeButtons(currentOptions);
      renderButtons(buttonConfigs);

      if (modal) {
        modal.classList.add('show');
      }
      setTimeout(focusInitialButton, 120);
    });
  };

  window.updateConfirmationButton = function(buttonId, props = {}) {
    if (!buttonId) return;
    const idx = buttonConfigs.findIndex(cfg => cfg && cfg.id === buttonId);
    if (idx < 0) return;
    const config = buttonConfigs[idx];
    const btn = buttonElements[idx];
    if (!config || !btn) return;

    if (Object.prototype.hasOwnProperty.call(props, 'text')) {
      const nextText = props.text == null ? '' : String(props.text);
      config.text = nextText;
      btn.textContent = nextText;
      btn.dataset.originalText = nextText;
    }

    if (props && props.dataset && typeof props.dataset === 'object') {
      Object.keys(props.dataset).forEach(key => {
        const value = props.dataset[key];
        if (value === undefined || value === null) {
          delete btn.dataset[key];
        } else {
          btn.dataset[key] = value;
        }
      });
    }
  };

  // Close confirmation modal
  window.closeConfirmationModal = function(options = {}) {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
      modal.classList.remove('show');
    }

    const resolved = options && options.resolve === true;
    if (!resolved && typeof currentReject === 'function') {
      currentReject(false);
    }

    currentResolve = null;
    currentReject = null;
    currentOptions = {};
    resetButtons();
    clearModalContent();
  };

  // Handle Yes button click
  window.handleConfirmationYes = function() {
    selectButton(0);
  };

  // Handle No button click
  window.handleConfirmationNo = function() {
    const cancelIndex = buttonConfigs.findIndex(cfg => cfg.role === 'cancel');
    const target = cancelIndex >= 0 ? cancelIndex : buttonConfigs.length - 1;
    if (target >= 0) {
      selectButton(target);
    } else {
      closeConfirmationModal();
    }
  };

  // View cost breakdown (placeholder)
  window.viewCostBreakdown = function() {
    console.log('View cost breakdown clicked');
    // Implement cost breakdown functionality here
  };

  // Keyboard support
  document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('confirmationModal');
    if (!modal.classList.contains('show')) return;
    
    if (e.key === 'Escape') {
      closeConfirmationModal();
    } else if (e.key === 'Enter') {
      handleConfirmationYes();
    }
  });

  // Click outside to close
  document.getElementById('confirmationModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeConfirmationModal();
    }
  });
})();
</script>
