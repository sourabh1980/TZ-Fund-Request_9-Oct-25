<!-- _CarReleaseSystem.html -->
  <!-- Vehicle Release System with Approved Design -->

  <!-- Historical Data Modal -->
  <div id="historicalModal" class="modal-backdrop" data-open="false">
    <div class="modal" role="dialog" aria-labelledby="historicalModalTitle" aria-modal="true">
      <!-- Header -->
      <div class="modal-header">
        <div class="window-controls">
          <button class="window-control window-control--close" type="button" onclick="window.closeHistoricalModal()" aria-label="Close window"></button>
          <button class="window-control window-control--minimize" type="button" aria-hidden="true" tabindex="-1"></button>
          <button class="window-control window-control--zoom" type="button" aria-hidden="true" tabindex="-1"></button>
        </div>
        <h2 id="historicalModalTitle" class="modal-title">Vehicle Usage History</h2>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div id="historicalData" class="historical-data">
          <!-- Historical data will be populated here -->
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn--secondary" onclick="window.closeHistoricalModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Vehicle Modal -->
  <div id="carModal" class="modal-backdrop" data-open="false">
    <div class="modal" role="dialog" aria-labelledby="carModalTitle" aria-modal="true">
      <!-- Header -->
      <div class="modal-header">
        <div class="window-controls">
          <button class="window-control window-control--close" type="button" onclick="window.closeCarModal()" aria-label="Close window"></button>
          <button class="window-control window-control--minimize" type="button" aria-hidden="true" tabindex="-1"></button>
          <button class="window-control window-control--zoom" type="button" aria-hidden="true" tabindex="-1"></button>
        </div>
        <h2 id="carModalTitle" class="modal-title">Vehicle Release System</h2>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Vehicle Details Section -->
        <div class="details-grid">
          <div class="label">Project</div>
          <div class="value" id="car-project"></div>

          <div class="label">Team</div>
          <div class="value" id="car-team"></div>

          <div class="label">Vehicle Number</div>
          <div class="value value--mono" id="car-number"></div>

          <div class="label">Make & Model</div>
          <div class="value" id="car-make-model"></div>

          <div class="label">Usage Type</div>
          <div class="value" id="car-usage-type"></div>

          <div class="label">Owner</div>
          <div class="value" id="car-owner"></div>

          <div class="label">Status</div>
          <div class="value">
            <span id="car-status" class="status-chip">IN USE</span>
          </div>

          <div class="label">Last Users</div>
          <div class="value" id="car-last-users"></div>
            <div class="label">Name of Responsible Beneficiary</div>
            <div class="value" id="car-responsible-beneficiary"></div>

            <div class="label">Other Team Members Using Vehicle</div>
            <div class="value team-member-list" id="car-team-members-using"></div>

            <div class="label">Other Team Members NOT Using Vehicle</div>
            <div class="value team-member-list" id="car-team-members-not-using"></div>
        </div>

        <!-- History Section -->
        <div id="carHistorySection" class="car-history-section" style="display: none;">
          <div class="section-header" onclick="carReleaseSystem.toggleHistorySection()">
            <h3>Vehicle Usage History</h3>
            <span class="toggle-icon">▼</span>
          </div>
          <div id="historyContent" class="history-content expanded">
            <div class="history-item">
              <span class="history-label">Last 3 Remarks</span>
              <div class="remarks-history" id="car-remarks-history">
                <div class="remark-item">No previous remarks available</div>
              </div>
            </div>
            <div class="history-item">
              <span class="history-label">Average Rating</span>
              <div class="rating-display" id="car-avg-rating">
                <span class="rating-value">0.0</span>
                <div class="stars-display">
                  <span class="star">★</span>
                  <span class="star">★</span>
                  <span class="star">★</span>
                  <span class="star">★</span>
                  <span class="star">★</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Release Form Section -->
        <div id="carReleaseSection" class="car-release-section" style="display: none;">
          <div class="section-header">
            <h3>Release User</h3>
          </div>
          <div class="release-form">
            <div class="form-group" id="release-user-selector" style="display: none;">
              <label class="form-label" for="release-user-select">
                User to Release <span class="required" id="release-user-required" style="display: none;">*</span>
              </label>
              <select id="release-user-select" class="form-select"></select>
              <div id="release-user-help" class="field-help"></div>
              <div id="release-user-error" class="field-error"></div>
            </div>

            <div id="user-release-selection" class="user-release-selection" style="display: none;">
              <div id="userReleaseTableContainer" class="user-release-table"></div>
              <div id="userReleaseEmptyState" class="user-release-empty" style="display: none;">
                <p>No active beneficiaries available for release.</p>
              </div>
            </div>

            <div id="release-feedback-fields">
              <div class="form-group">
                <label class="form-label" for="release-remarks">
                  Remarks <span class="required">*</span>
                </label>
                <textarea 
                  id="release-remarks" 
                  class="form-textarea" 
                  placeholder="Please provide detailed remarks about the vehicle condition, usage, or any issues..."
                  rows="4"
                  maxlength="500"
                ></textarea>
                <div class="char-counter">
                  <span id="remarks-counter">0</span>/500
                </div>
                <div id="remarks-error" class="field-error"></div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  Rating <span class="required">*</span>
                </label>
                <div id="release-stars" class="stars-input">
                  <span class="star-input" data-rating="1">★</span>
                  <span class="star-input" data-rating="2">★</span>
                  <span class="star-input" data-rating="3">★</span>
                  <span class="star-input" data-rating="4">★</span>
                  <span class="star-input" data-rating="5">★</span>
                </div>
                <div class="rating-labels">
                  <span>Poor</span>
                  <span>Excellent</span>
                </div>
                <div id="rating-error" class="field-error"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <div class="footer-actions">
          <button class="btn btn--secondary" id="btnReleaseHistory">RELEASE History</button>
          <button class="btn btn--secondary" id="btnInUseHistory">IN USE History</button>
          <button class="btn btn--secondary" id="releaseUserBtn">Release User</button>
          <button class="btn btn--primary" id="closeModalBtn">Close</button>
        </div>
        
        <div id="releaseActions" class="release-actions" style="display: none;">
          <button class="btn btn--secondary" id="cancelReleaseBtn">Cancel</button>
          <button class="btn btn--danger" id="confirmReleaseBtn" disabled>Release User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Shared Styles -->
  <!-- Shared styles loaded externally -->

  <!-- Modal Styles -->
  <style>
    :root{
      --mac-backdrop: rgba(15,17,26,0.45);
      --mac-surface: rgba(247,249,255,0.82);
      --mac-border: rgba(255,255,255,0.55);
      --mac-divider: rgba(12,18,32,0.08);
      --mac-shadow: 0 32px 80px rgba(15,23,42,0.38);
      --mac-ink-primary: #0b1220;
      --mac-ink-secondary: rgba(11,18,32,0.68);
      --mac-ink-muted: rgba(11,18,32,0.45);
      --mac-blue: #0a84ff;
      --mac-blue-dark: #0060df;
      --mac-red: #ff453a;
      --mac-red-dark: #d70015;
      --mac-green: #30d158;
      --mac-yellow: #ffd60a;
      --mac-gray: rgba(118,122,134,0.18);
      --modal-radius: 20px;
    }

    #carReleasePreloadOverlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(10,13,27,0.62);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 10000;
      transition: opacity .25s ease;
      opacity: 0;
      pointer-events: none;
    }
    #carReleasePreloadOverlay[data-active="true"]{
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }
    .car-release-preload{
      background: rgba(255,255,255,0.94);
      border-radius: 16px;
      padding: 28px 36px;
      box-shadow: 0 28px 60px rgba(15,23,42,0.32);
      text-align: center;
      min-width: 260px;
    }
    .car-release-preload__title{
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      margin: 0 0 12px;
      letter-spacing: 0.02em;
    }
    .car-release-preload__timer{
      font-size: 34px;
      font-weight: 700;
      color: #2563eb;
      letter-spacing: 0.12em;
    }

    .modal-backdrop{
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 32px;
      background: var(--mac-backdrop);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .24s ease;
      z-index: 9999;
    }
    .modal-backdrop[data-open="true"]{
      opacity: 1;
      pointer-events: auto;
    }

    .modal{
      width: min(960px, 92vw);
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      background: var(--mac-surface);
      border: 1px solid var(--mac-border);
      border-radius: var(--modal-radius);
      box-shadow: var(--mac-shadow);
      backdrop-filter: blur(42px) saturate(180%);
      -webkit-backdrop-filter: blur(42px) saturate(180%);
      color: var(--mac-ink-primary);
      transform: translateY(12px) scale(.98);
      opacity: 0;
      transition: transform .28s cubic-bezier(.18,.82,.22,1), opacity .24s ease;
      font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .modal-backdrop[data-open="true"] .modal{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal-header{
      position: relative;
      padding: 22px 24px 14px;
      text-align: center;
    }
    .modal-header::after{
      content: "";
      display: block;
      height: 1px;
      background: var(--mac-divider);
      margin-top: 14px;
    }
    .modal-title{
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: .14px;
      color: var(--mac-ink-primary);
    }
    .window-controls{
      position: absolute;
      top: 18px;
      left: 18px;
      display: flex;
      gap: 8px;
    }
    .window-control{
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
      background: var(--mac-gray);
      box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4);
      padding: 0;
      cursor: default;
    }
    .window-control--close{
      background: #ff5f57;
      border-color: rgba(214,71,63,0.5);
      cursor: pointer;
    }
    .window-control--minimize{
      background: #febc2e;
      border-color: rgba(206,151,31,0.5);
    }
    .window-control--zoom{
      background: #28c840;
      border-color: rgba(33,155,63,0.5);
    }
    .window-control:focus-visible{
      outline: 2px solid rgba(10,132,255,0.5);
      outline-offset: 2px;
    }
    .window-control--close:hover{
      box-shadow: inset 0 0 0 999px rgba(0,0,0,0.08);
    }
    .window-control[aria-hidden="true"]{
      opacity: .55;
      cursor: default;
    }

    .modal-body{
      padding: 18px 24px 24px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .modal-body::-webkit-scrollbar{ width: 8px; }
    .modal-body::-webkit-scrollbar-thumb{
      border-radius: 999px;
      background: rgba(30,41,59,0.25);
    }

    .details-grid{
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 14px 24px;
      margin-bottom: 20px;
      padding: 20px 22px;
      border-radius: 16px;
      background: rgba(255,255,255,0.58);
      border: 1px solid var(--mac-divider);
      box-shadow: 0 12px 30px rgba(12,16,28,0.08);
    }
    .label{
      font-size: 12px;
      letter-spacing: .36px;
      text-transform: uppercase;
      color: var(--mac-ink-muted);
      font-weight: 700;
    }
    .value{
      font-size: 15px;
      font-weight: 500;
      color: var(--mac-ink-secondary);
    }
    .value strong{ font-weight: 600; color: var(--mac-ink-primary); }
    .value--mono{
      font-family: "SF Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
      letter-spacing: .4px;
      font-weight: 600;
      color: var(--mac-ink-primary);
    }
    .team-member-list{
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .team-member-pill{
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #e2e8f0;
      color: #475569;
      border: 1px solid transparent;
    }
    .team-member-pill--using{
      background: #bbf7d0;
      color: #166534;
      border-color: rgba(22,101,52,0.18);
    }
    .team-member-pill--not-using{
      background: #ffe4e6;
      color: #9f1239;
      border-color: rgba(244,114,182,0.4);
    }
    .team-member-pill--empty{
      background: transparent;
      color: #94a3b8;
      border: 1px dashed rgba(148,163,184,0.5);
      font-weight: 500;
      padding: 4px 8px;
    }
    .team-member-pill--assignable{
      background: #fee2e2;
      color: #991b1b;
      border-color: rgba(220,38,38,0.35);
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .team-member-pill--assignable:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(248,113,113,0.26);
    }
    .team-member-pill--assignable[aria-disabled="true"]{
      cursor: not-allowed;
      opacity: .6;
      box-shadow: none;
      transform: none;
    }
    .team-member-pill--blocked{
      background: #bbf7d0;
      color: #166534;
      border-color: rgba(22,101,52,0.28);
      cursor: default;
    }
    .team-member-pill--loading{
      position: relative;
      pointer-events: none;
      opacity: .72;
    }
    .team-member-pill--loading::after{
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(148,163,184,0.55);
      border-top-color: rgba(79,70,229,0.75);
      margin-left: 6px;
      animation: pill-spin .6s linear infinite;
    }
    @keyframes pill-spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    .status-chip{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .5px;
      text-transform: uppercase;
      background: rgba(134,233,175,0.24);
      color: #1c6b3a;
      border: 1px solid rgba(76,175,120,0.36);
    }
    .status-chip.status--in-use{
      background: rgba(134,233,175,0.24);
      color: #1c6b3a;
      border-color: rgba(76,175,120,0.36);
    }
    .status-chip.status--release{
      background: rgba(255,69,58,0.15);
      color: #ff453a;
      border-color: rgba(255,99,88,0.32);
    }
    .status-chip.status--pending{
      background: rgba(255,214,10,0.18);
      color: #b97d00;
      border-color: rgba(255,214,10,0.32);
    }

    .status-pill{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .4px;
      text-transform: uppercase;
      background: rgba(134,233,175,0.18);
      color: #1c6b3a;
      border: 1px solid rgba(76,175,120,0.28);
      white-space: nowrap;
    }
    .status-pill.status-pill--in-use{
      background: rgba(134,233,175,0.22);
      border-color: rgba(76,175,120,0.36);
      color: #1c6b3a;
    }

    .car-history-section{
      border-radius: 16px;
      border: 1px solid var(--mac-divider);
      background: rgba(255,255,255,0.52);
      box-shadow: 0 12px 28px rgba(12,16,28,0.08);
      margin-bottom: 20px;
    }
    .section-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      font-weight: 600;
      color: var(--mac-ink-primary);
      user-select: none;
    }
    .section-header h3{ margin: 0; font-size: 15px; }
    .section-header:hover{ background: rgba(255,255,255,0.6); }
    .toggle-icon{
      font-size: 12px;
      color: var(--mac-ink-muted);
      transition: transform .2s ease;
    }
    .section-header.expanded .toggle-icon{ transform: rotate(180deg); }

    .history-content{
      padding: 0 20px 18px;
      display: grid;
      gap: 18px;
    }
    .history-item{ display: flex; flex-direction: column; gap: 8px; }
    .history-label{
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .34px;
      color: var(--mac-ink-muted);
    }
    .remarks-history{ display: flex; flex-direction: column; gap: 10px; }
    .remark-item{
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255,255,255,0.65);
      border: 1px solid var(--mac-divider);
      color: var(--mac-ink-secondary);
    }
    .rating-display{ display: flex; align-items: center; gap: 12px; }
    .rating-value{ font-size: 24px; font-weight: 700; color: var(--mac-ink-primary); }
  .stars-display{ display: flex; gap: 4px; font-size: 18px; color: #fbbf24; }
  .stars-display .star{ color: rgba(250,204,21,0.35); transition: color .2s ease; }
  .stars-display .star.filled{ color: #f59e0b; }
  .stars-display--compact{ font-size: 16px; gap: 2px; }

    .car-release-section{
      border-radius: 16px;
      border: 1px solid var(--mac-divider);
      background: rgba(255,255,255,0.55);
      box-shadow: 0 12px 28px rgba(12,16,28,0.08);
      padding: 18px 20px 20px;
    }
    .car-release-section .section-header{ cursor: default; padding: 4px 0 10px; }
    .release-form{ display: flex; flex-direction: column; gap: 18px; }
    .form-group{ display: flex; flex-direction: column; gap: 10px; }
    .form-label{ font-size: 14px; font-weight: 600; color: var(--mac-ink-primary); }
    .required{ color: var(--mac-red); }

    .user-release-selection{
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 12px 0;
    }
    .user-release-table{
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: rgba(255,255,255,0.78);
      max-height: 320px;
      overflow-y: auto;
    }
    .user-release-table table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .user-release-table thead th{
      position: sticky;
      top: 0;
      background: #f8fafc;
      border-bottom: 1px solid #d0d7de;
      padding: 8px 10px;
      text-align: left;
      font-weight: 600;
      color: #0f172a;
      z-index: 1;
    }
    .user-release-table tbody td{
      border-bottom: 1px solid #e2e8f0;
      padding: 8px 10px;
      color: #1e293b;
      vertical-align: top;
    }
    .user-release-table tbody tr:last-child td{
      border-bottom: none;
    }
    .user-release-beneficiary{
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-release-empty{
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed #cbd5f5;
      background: rgba(148,163,184,0.08);
      color: #475569;
      font-size: 13px;
      text-align: center;
    }

    .form-textarea{
      min-height: 110px;
      border-radius: 12px;
      border: 1px solid rgba(142,142,147,0.28);
      background: rgba(255,255,255,0.78);
      padding: 12px 14px;
      font-size: 14px;
      font-family: inherit;
      color: var(--mac-ink-secondary);
      resize: vertical;
      transition: border-color .2s ease, box-shadow .2s ease;
      box-shadow: inset 0 1px 1px rgba(12,16,28,0.05);
    }
    .form-textarea:focus{
      outline: none;
      border-color: rgba(10,132,255,0.45);
      box-shadow: 0 0 0 3px rgba(10,132,255,0.16);
    }
    .form-select{
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(142,142,147,0.28);
      background: rgba(255,255,255,0.78);
      padding: 0 14px;
      font-size: 14px;
      font-family: inherit;
      color: var(--mac-ink-secondary);
      transition: border-color .2s ease, box-shadow .2s ease;
      box-shadow: inset 0 1px 1px rgba(12,16,28,0.05);
    }
    .form-select:focus{
      outline: none;
      border-color: rgba(10,132,255,0.45);
      box-shadow: 0 0 0 3px rgba(10,132,255,0.16);
    }
    .field-help{
      font-size: 12px;
      color: var(--mac-ink-muted);
      line-height: 1.4;
    }
    .char-counter{ align-self: flex-end; font-size: 12px; color: var(--mac-ink-muted); }
    .field-error{ font-size: 12px; color: var(--mac-red); min-height: 16px; }

  .stars-input{ display: flex; gap: 8px; font-size: 22px; color: rgba(250,204,21,0.32); cursor: pointer; }
  .star-input{ color: inherit; transition: transform .18s ease, color .18s ease; }
  .star-input.active,
  .star-input.filled,
  .star-input.hover,
  .star-input:hover,
  .star-input:hover ~ .star-input{ color: #f59e0b; }
    .star-input:hover{ transform: translateY(-1px); }
    .rating-labels{ display: flex; justify-content: space-between; font-size: 11px; letter-spacing: .3px; text-transform: uppercase; color: var(--mac-ink-muted); }

    .modal-footer{
      padding: 16px 24px 20px;
      border-top: 1px solid var(--mac-divider);
      background: rgba(255,255,255,0.55);
      display: flex;
      justify-content: flex-end;
    }
    .footer-actions,
    .release-actions{ display: flex; gap: 12px; width: 100%; justify-content: flex-end; }

    .btn{
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      font-family: inherit;
    }
    .btn:focus-visible{ outline: 2px solid rgba(10,132,255,0.45); outline-offset: 2px; }
    .btn--primary{
      background: linear-gradient(180deg, var(--mac-blue) 0%, var(--mac-blue-dark) 100%);
      color: #fff;
      box-shadow: 0 12px 26px rgba(10,132,255,0.35);
    }
    .btn--primary:hover{ transform: translateY(-1px); box-shadow: 0 16px 32px rgba(10,132,255,0.45); }
    .btn--secondary{
      background: rgba(148,152,160,0.18);
      color: var(--mac-ink-primary);
      border: 1px solid rgba(120,125,135,0.22);
    }
    .btn--secondary:hover{ background: rgba(148,152,160,0.28); transform: translateY(-1px); }
    .btn--danger{
      background: linear-gradient(180deg, var(--mac-red) 0%, var(--mac-red-dark) 100%);
      color: #fff;
      box-shadow: 0 12px 26px rgba(255,69,58,0.32);
    }
    .btn--danger:hover{ transform: translateY(-1px); box-shadow: 0 16px 32px rgba(255,69,58,0.38); }
    .btn:disabled{ opacity: .55; cursor: not-allowed; transform: none; box-shadow: none; }

    @media (max-width: 720px){
      .details-grid{ grid-template-columns: 1fr; }
      .modal{ width: min(640px, 96vw); }
      .footer-actions, .release-actions{ flex-direction: column; align-items: stretch; }
      .window-controls{ left: 16px; top: 16px; }
    }

    @media (prefers-color-scheme: dark){
      .modal{
        background: rgba(26,30,40,0.85);
        border-color: rgba(148,163,184,0.18);
        color: #f8fafc;
        box-shadow: 0 38px 90px rgba(0,0,0,0.65);
      }
      .modal-header::after{ background: rgba(148,163,184,0.18); }
      .details-grid,
      .car-history-section,
      .car-release-section{
        background: rgba(31,36,48,0.8);
        border-color: rgba(148,163,184,0.22);
        box-shadow: none;
      }
      .value,
      .value strong,
      .modal-title{ color: #f1f5f9; }
      .label{ color: rgba(226,232,240,0.55); }
      .section-header{ color: #f8fafc; }
      .section-header:hover{ background: rgba(46,58,78,0.45); }
      .remark-item{ background: rgba(40,49,68,0.85); border-color: rgba(148,163,184,0.22); color: #e2e8f0; }
      .form-textarea{ background: rgba(24,32,45,0.9); border-color: rgba(148,163,184,0.24); color: #e2e8f0; }
      .form-select{ background: rgba(24,32,45,0.9); border-color: rgba(148,163,184,0.24); color: #e2e8f0; }
      .field-help{ color: rgba(226,232,240,0.55); }
      .modal-footer{ background: rgba(26,30,40,0.85); border-top-color: rgba(148,163,184,0.22); }
      .btn--secondary{ background: rgba(148,163,184,0.18); border-color: rgba(148,163,184,0.22); color: #f8fafc; }
      .window-control{ border-color: rgba(0,0,0,0.35); }
      .status-chip,
      .status-pill{
        background: rgba(57,153,110,0.28);
        border-color: rgba(73,194,132,0.42);
        color: #b6f5d1;
      }
      .status-chip.status--in-use,
      .status-pill.status-pill--in-use{
        background: rgba(57,153,110,0.33);
        border-color: rgba(73,194,132,0.48);
        color: #bffbd7;
      }
    }
  </style>


  <!-- JavaScript -->
  <script>
    /**
     * Vehicle Release System - Refactored Architecture
     * Single modal with multiple states for better UX
     */
    class CarReleaseSystem {
      constructor() {
        this.modal = null;
        this.currentCarData = null;
        this.currentState = 'view'; // 'view', 'history', 'release'
        this.selectedRating = 0;
        this.originalCarInput = null;
        this.hideTimer = null;
        this.historyContentTemplate = '';
        this.releaseMode = 'user';
        this.isRemarksRequired = true;
        this.userReleaseHasOtherUsers = false;
        this.userReleaseFeedbackPending = false;
        this.historyView = 'summary'; // 'summary' | 'release' | 'in-use'
        this.lastHistoryData = {
          summary: null,
          release: null,
          inUse: null
        };
        this.userReleaseSelection = {
          rows: [],
          selected: new Map(),
          activeUsers: new Map(),
          listenerAttached: false
        };
        this.beneficiaryVehicleCache = null;
        this.beneficiaryInsightsPromise = null;
        this.beneficiaryInsightsReady = false;
        this.assigningBeneficiary = null;
        this.preloadOverlay = null;
        this.preloadCountdownEl = null;
        this.preloadTimeoutId = null;
        this.preloadIntervalId = null;
        this.preloadDelayMs = 3000;
        this.preloadActive = false;
        this.lastCachePrepareTs = 0;
        this.handleUserReleaseCheckboxChange = this.handleUserReleaseCheckboxChange.bind(this);

        this.init();
      }

      init() {
        this.modal = document.getElementById('carModal');
        this.setupEventListeners();
        this.setupStarRating();
        this.setupRemarksCounter();
        const historyContent = document.getElementById('historyContent');
        if (historyContent) {
          this.historyContentTemplate = historyContent.innerHTML;
        }
        this.setupPreloadOverlay();
        this.prepareReleaseCaches({ source: 'init' });
        setTimeout(() => {
          try {
            this.prepareReleaseCaches({ source: 'init-deferred' });
          } catch (err) {
            console.warn('Vehicle release preload: deferred cache refresh failed', err);
          }
        }, 600);
      }

      setupEventListeners() {
        // Close modal events
        this.modal?.querySelector('.window-control--close')?.addEventListener('click', () => this.closeModal());
        document.getElementById('closeModalBtn')?.addEventListener('click', () => this.closeModal());
        
        // Footer action buttons
        document.getElementById('btnReleaseHistory')?.addEventListener('click', () => this.showReleaseHistory());
  document.getElementById('btnInUseHistory')?.addEventListener('click', () => this.showInUseHistory());
  document.getElementById('viewHistoryBtn')?.addEventListener('click', () => this.toggleHistorySection());
  document.getElementById('releaseUserBtn')?.addEventListener('click', () => this.showUserReleaseForm());
        document.getElementById('release-user-select')?.addEventListener('change', () => this.validateForm());
        
        // Release form actions
        document.getElementById('cancelReleaseBtn')?.addEventListener('click', () => this.hideReleaseForm());
        document.getElementById('confirmReleaseBtn')?.addEventListener('click', () => this.confirmRelease());
        
        // Modal backdrop click
        this.modal?.addEventListener('click', (e) => {
          if (e.target === this.modal) this.closeModal();
        });
        
        // Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isModalOpen()) {
            this.closeModal();
          }
        });
        
        // Form validation
        document.getElementById('release-remarks')?.addEventListener('input', () => this.validateForm());
      }

      setupStarRating() {
        const starsContainer = document.getElementById('release-stars');
        if (!starsContainer) return;
        
        const stars = starsContainer.querySelectorAll('.star-input');
        
        stars.forEach((star, index) => {
          star.addEventListener('mouseenter', () => this.highlightStars(index + 1));
          star.addEventListener('mouseleave', () => this.highlightStars(this.selectedRating));
          star.addEventListener('click', () => this.selectRating(index + 1));
        });
      }

      setupRemarksCounter() {
        const textarea = document.getElementById('release-remarks');
        const counter = document.getElementById('remarks-counter');
        
        if (!textarea || !counter) return;
        
        textarea.addEventListener('input', () => {
          const length = textarea.value.length;
          counter.textContent = length;
          
          if (length > 450) {
            counter.style.color = 'var(--danger-color)';
          } else if (length > 400) {
            counter.style.color = 'var(--warning-color)';
          } else {
            counter.style.color = 'var(--text-muted)';
          }
        });
      }

      setupPreloadOverlay() {
        if (this.preloadOverlay || typeof document === 'undefined') return;
        if (!document.body) {
          document.addEventListener('DOMContentLoaded', () => this.setupPreloadOverlay(), { once: true });
          return;
        }
        let overlay = document.getElementById('carReleasePreloadOverlay');
        if (overlay) {
          this.preloadOverlay = overlay;
          this.preloadCountdownEl = overlay.querySelector('.car-release-preload__timer');
          return;
        }

        overlay = document.createElement('div');
        overlay.id = 'carReleasePreloadOverlay';
        overlay.setAttribute('aria-hidden', 'true');
        overlay.innerHTML = `
          <div class="car-release-preload">
            <div class="car-release-preload__title">Refreshing vehicle data…</div>
            <div class="car-release-preload__timer" role="status" aria-live="polite">3</div>
          </div>
        `;

        document.body.appendChild(overlay);
        this.preloadOverlay = overlay;
        this.preloadCountdownEl = overlay.querySelector('.car-release-preload__timer');
      }

      updatePreloadCountdown(value) {
        if (!this.preloadCountdownEl) return;
        const numeric = Number.isFinite(value) ? Math.max(0, Math.floor(value)) : 0;
        this.preloadCountdownEl.textContent = numeric;
        if (this.preloadOverlay) {
          this.preloadOverlay.setAttribute('data-remaining', String(numeric));
        }
      }

      prepareReleaseCaches(options = {}) {
        this.lastCachePrepareTs = Date.now();
        try { window.invalidateVehicleNormalizationCache?.(); } catch (err) { console.warn('Vehicle release preload: failed to reset normalization cache', err); }
        try {
          const prefetch = window.vehicleReleasePrefetch;
          if (prefetch) {
            if (typeof prefetch.clear === 'function') {
              prefetch.clear();
            } else if (prefetch.state && typeof prefetch.state === 'object') {
              prefetch.state.entries = Object.create(null);
            }
          }
        } catch (err) {
          console.warn('Vehicle release preload: failed to clear release prefetch cache', err);
        }
        try { window.invalidateBeneficiaryVehicleCache?.(); } catch (err) { console.warn('Vehicle release preload: failed to invalidate beneficiary cache', err); }
        try { window.vehicleAssignmentManager?.clearAll?.({ suppressUI: true }); } catch (err) { /* non-fatal */ }
        try { window.refreshVehicleInUseData?.(); } catch (err) { console.warn('Vehicle release preload: failed to refresh in-use data', err); }
        if (typeof window.scheduleVehicleInUseReapply === 'function') {
          try { window.scheduleVehicleInUseReapply({ reason: 'car-release-preload', attempts: 4, delay: 260 }); } catch (err) { console.warn('Vehicle release preload: failed to schedule prefill reapply', err); }
        }
        if (typeof window.refreshVehicleMatchPopup === 'function') {
          try { window.refreshVehicleMatchPopup(); } catch (err) { console.warn('Vehicle release preload: failed to refresh assigned vehicle popup', err); }
        }
      }

      runPreloadCountdown(callback, options = {}) {
        const cb = typeof callback === 'function' ? callback : () => {};
        const duration = Number.isFinite(options.durationMs) && options.durationMs >= 0
          ? Math.floor(options.durationMs)
          : this.preloadDelayMs;

        this.prepareReleaseCaches({ source: options.source || 'preload' });

        if (duration <= 0) {
          cb();
          return;
        }

        if (!this.preloadOverlay || !this.preloadCountdownEl) {
          setTimeout(cb, duration);
          return;
        }

        if (this.preloadIntervalId) {
          clearInterval(this.preloadIntervalId);
          this.preloadIntervalId = null;
        }
        if (this.preloadTimeoutId) {
          clearTimeout(this.preloadTimeoutId);
          this.preloadTimeoutId = null;
        }

        let remaining = Math.ceil(duration / 1000);
        this.updatePreloadCountdown(remaining);
        this.preloadOverlay.setAttribute('data-active', 'true');
        this.preloadOverlay.setAttribute('aria-hidden', 'false');
        this.preloadActive = true;

        if (duration >= 1000) {
          this.preloadIntervalId = setInterval(() => {
            remaining -= 1;
            if (remaining >= 0) {
              this.updatePreloadCountdown(remaining);
            }
            if (remaining <= 0 && this.preloadIntervalId) {
              clearInterval(this.preloadIntervalId);
              this.preloadIntervalId = null;
            }
          }, 1000);
        }

        const finish = () => {
          if (!this.preloadActive) return;
          this.preloadActive = false;
          if (this.preloadIntervalId) {
            clearInterval(this.preloadIntervalId);
            this.preloadIntervalId = null;
          }
          if (this.preloadTimeoutId) {
            clearTimeout(this.preloadTimeoutId);
            this.preloadTimeoutId = null;
          }
          this.updatePreloadCountdown(0);
          this.preloadOverlay.setAttribute('data-active', 'false');
          this.preloadOverlay.setAttribute('aria-hidden', 'true');
          cb();
        };

        this.preloadTimeoutId = setTimeout(finish, duration);
      }

      // Public API Methods
      openModal(carData, options = {}) {
        console.log('Vehicle release modal requested:', carData, 'Options:', options);
        this.runPreloadCountdown(() => this.executeOpenModal(carData, options), { source: 'openModal' });
      }

      executeOpenModal(carData, options = {}) {
        console.log('Opening car modal with data:', carData, 'Options:', options);
        
        this.currentCarData = this.normalizeCarData(carData);
        this.originalCarInput = options.carInput || null;
        this.resetModalState();
        this.populateCarDetails();
        this.showModal();

        const currentCarNumber = this.currentCarData.carNumber || this.currentCarData.car_number || '';
        this.ensureBeneficiaryVehicleInsights().then(() => {
          if (!this.isModalOpen()) return;
          const latestCar = this.currentCarData?.carNumber || this.currentCarData?.car_number || '';
          if (currentCarNumber && latestCar && currentCarNumber !== latestCar) {
            return;
          }
          this.refreshNotUsingPills();
        }).catch((err) => {
          console.warn('Unable to prepare beneficiary vehicle insights', err);
        });

        const carNumber = this.currentCarData.carNumber || this.currentCarData.car_number || '';
        const teamLabel = this.currentCarData.teamName || this.currentCarData.team || '';
        const prefetch = (typeof window !== 'undefined' && window.vehicleReleasePrefetch)
          ? window.vehicleReleasePrefetch
          : null;

        if (this.historyView === 'summary') {
          this.populateHistoryData();
        }

        const hydrateFromResult = (result) => {
          const previousView = this.historyView;
          if (result && result.ok) {
            const usingMembers = Array.isArray(result.teamMembersUsing)
              ? result.teamMembersUsing
              : (Array.isArray(result.teamMembers) ? result.teamMembers : []);
            const notUsingMembers = Array.isArray(result.teamMembersNotUsing)
              ? result.teamMembersNotUsing
              : [];
            const mergedData = {
              ...this.currentCarData,
              responsibleBeneficiary: result.responsible || '',
              otherTeamMembers: Array.isArray(result.teamMembers)
                ? result.teamMembers
                : usingMembers.slice(),
              otherTeamMembersUsing: usingMembers,
              otherTeamMembersNotUsing: notUsingMembers
            };
            const candidateData = result.carData ? { ...mergedData, ...result.carData } : mergedData;
            this.currentCarData = this.normalizeCarData(candidateData);
          } else {
            this.currentCarData = this.normalizeCarData({
              ...this.currentCarData,
              responsibleBeneficiary: '',
              otherTeamMembers: [],
              otherTeamMembersUsing: [],
              otherTeamMembersNotUsing: []
            });
          }
          this.populateCarDetails();
          if (previousView !== 'summary') {
            this.historyView = previousView;
          }
        };

        const handleDetailFailure = (error) => {
          const previousView = this.historyView;
          this.currentCarData = this.normalizeCarData({
            ...this.currentCarData,
            responsibleBeneficiary: '',
            otherTeamMembers: [],
            otherTeamMembersUsing: [],
            otherTeamMembersNotUsing: []
          });
          this.populateCarDetails();
          if (previousView !== 'summary') {
            this.historyView = previousView;
          }
          if (error) {
            console.error('Failed to retrieve vehicle details for modal:', error);
          }
        };

        if (carNumber) {
          if (prefetch && typeof prefetch.requestDetails === 'function') {
            const cachedDetails = prefetch.getDetails(carNumber);
            if (cachedDetails) {
              hydrateFromResult(cachedDetails);
            }
            prefetch.requestDetails(carNumber, {
              onSuccess: hydrateFromResult,
              onFailure: handleDetailFailure
            });
          } else if (window.google && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((result) => {
                hydrateFromResult(result);
                try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeDetails(carNumber, result); } catch(_){ /* ignore */ }
              })
              .withFailureHandler((err) => {
                handleDetailFailure(err);
                try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeDetailsError(carNumber, err); } catch(_){ /* ignore */ }
              })
              .getCarReleaseDetails(carNumber);
          } else {
            handleDetailFailure(null);
          }

          if (prefetch && typeof prefetch.requestReleaseHistory === 'function') {
            prefetch.requestReleaseHistory(carNumber);
          }
          if (prefetch && typeof prefetch.requestInUseHistory === 'function') {
            prefetch.requestInUseHistory(carNumber, teamLabel);
          }
        } else {
          handleDetailFailure(null);
        }
      }

      closeModal() {
        this.hideModal();
        this.resetModalState();
        this.currentCarData = null;
        this.originalCarInput = null;
      }

      // Private Methods
      normalizeCarData(data) {
        return {
          project: data.project || '',
          projectName: data.projectName || data.project || '',
          team: data.team || '',
          teamName: data.teamName || data.team || '',
          carNumber: data.carNumber || data.car_number || '',
          category: data.category || data.Category || data.vehicleCategory || data.categoryName || '',
          make: data.make || '',
          model: data.model || '',
          usageType: data.usageType || data.usage_type || '',
          owner: data.owner || '',
          status: data.status || 'IN USE',
          lastUsers: Array.isArray(data.lastUsers) ? data.lastUsers : (data.lastUsers || '').split(',').map(u => u.trim()).filter(u => u),
          remarks: data.remarks || '',
          stars: data.stars || 0,
          submitter: data.submitter || 'Current User',
          responsibleBeneficiary: data.responsibleBeneficiary || data['R.Beneficiary'] || data['R. Ben'] || '',
          otherTeamMembers: Array.isArray(data.otherTeamMembers) ? data.otherTeamMembers : [],
          otherTeamMembersUsing: Array.isArray(data.otherTeamMembersUsing)
            ? data.otherTeamMembersUsing
            : (Array.isArray(data.otherTeamMembers) ? data.otherTeamMembers : []),
          otherTeamMembersNotUsing: Array.isArray(data.otherTeamMembersNotUsing)
            ? data.otherTeamMembersNotUsing
            : [],
          history: data.history || {
            remarks: [],
            averageRating: 0
          }
        };
      }

      applySupplementalCarData(extraData) {
        if (!extraData || typeof extraData !== 'object') return;
        const current = this.currentCarData ? { ...this.currentCarData } : null;
        if (!current) {
          this.currentCarData = this.normalizeCarData(extraData);
          this.populateCarDetails();
          return;
        }
        const merged = { ...current };
        const keys = Object.keys(extraData);
        keys.forEach((key) => {
          if (!Object.prototype.hasOwnProperty.call(extraData, key)) return;
          const value = extraData[key];
          if (value === undefined) return;
          const primary = key === 'project' || key === 'projectName' || key === 'team' || key === 'teamName' || key === 'carNumber';
          if (primary) {
            if (value) merged[key] = value;
            return;
          }
          merged[key] = value;
        });
        this.currentCarData = this.normalizeCarData(merged);
        this.populateCarDetails();
      }

      normalizeBeneficiaryKey(name) {
        if (!name && name !== 0) return '';
        const baseString = String(name);
        let normalized = baseString;
        try {
          normalized = normalized.normalize('NFKD');
        } catch (_) {
          // normalize not supported, keep original string
        }
        normalized = normalized.replace(/[\u0300-\u036f]/g, '');
        normalized = normalized.replace(/[\u2018\u2019\u201C\u201D]/g, '');
        normalized = normalized.replace(/[^a-zA-Z0-9]+/g, ' ');
        return normalized.trim().replace(/\s+/g, ' ').toLowerCase();
      }

      getCurrentUsers() {
        if (!this.currentCarData) return [];
        const users = [];
        const seen = new Set();
        const addUser = (name) => {
          const trimmed = String(name || '').trim();
          if (!trimmed) return;
          const key = this.normalizeBeneficiaryKey(trimmed);
          if (seen.has(key)) return;
          seen.add(key);
          users.push(trimmed);
        };
        const addFromValue = (value) => {
          if (Array.isArray(value)) {
            value.forEach(addFromValue);
            return;
          }
          if (value == null) return;
          const stringValue = String(value);
          if (!stringValue.trim()) return;
          const separators = /[\n,;]+/;
          if (separators.test(stringValue)) {
            stringValue.split(separators).forEach(addUser);
          } else {
            addUser(stringValue);
          }
        };

        addFromValue(this.currentCarData.responsibleBeneficiary);
        if (this.currentCarData.otherTeamMembersUsing && this.currentCarData.otherTeamMembersUsing.length) {
          addFromValue(this.currentCarData.otherTeamMembersUsing);
        } else if (this.currentCarData.otherTeamMembers) {
          addFromValue(this.currentCarData.otherTeamMembers);
        }
        if (!users.length) {
          addFromValue(this.currentCarData.lastUsers);
        }
        return users;
      }

      renderTeamMemberPills(containerId, members, variant) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const list = Array.isArray(members)
          ? members.map(name => String(name || '').trim()).filter(Boolean)
          : [];
        if (!list.length) {
          container.innerHTML = '<span class="team-member-pill team-member-pill--empty">None</span>';
          return;
        }
        if (variant === 'not-using' && !this.beneficiaryInsightsReady) {
          this.ensureBeneficiaryVehicleInsights().then(() => {
            if (this.isModalOpen()) {
              this.refreshNotUsingPills();
            }
          }).catch((err) => {
            console.warn('Beneficiary vehicle insights unavailable', err);
          });
        }

        const html = list.map((name) => {
          const safeName = this.escapeHtml(name);
          if (variant === 'not-using') {
            const insight = this.getBeneficiaryAssignmentInfo(name);
            const classes = ['team-member-pill', 'team-member-pill--not-using'];
            let attrs = '';
            if (insight && insight.activeElsewhere) {
              classes.push('team-member-pill--blocked');
              const activeList = Array.isArray(insight.activeVehicles) && insight.activeVehicles.length
                ? `Already using ${insight.activeVehicles.join(', ')}`
                : 'Already assigned to another vehicle';
              attrs = ` title="${this.escapeHtml(activeList)}" aria-disabled="true"`;
            } else {
              classes.push('team-member-pill--assignable');
              const descriptor = `Click to assign this vehicle to ${name}`;
              attrs = ` title="${this.escapeHtml(descriptor)}" data-beneficiary-name="${this.escapeHtml(name)}" data-beneficiary-key="${this.escapeHtml(this.getBeneficiaryCacheKey(name))}"`;
            }
            return `<span class="${classes.join(' ')}"${attrs}>${safeName}</span>`;
          }
          const pillClass = variant === 'using'
            ? 'team-member-pill team-member-pill--using'
            : 'team-member-pill team-member-pill--not-using';
          return `<span class="${pillClass}">${safeName}</span>`;
        }).join('');

        container.innerHTML = html;
        if (variant === 'not-using') {
          this.attachNotUsingPillEvents(container);
        }
      }

      refreshNotUsingPills() {
        if (!this.currentCarData) return;
        this.renderTeamMemberPills(
          'car-team-members-not-using',
          this.currentCarData.otherTeamMembersNotUsing,
          'not-using'
        );
      }

      getBeneficiaryCacheKey(name) {
        return String(name || '').trim().toLowerCase();
      }

      ensureBeneficiaryVehicleInsights(forceRefresh = false) {
        if (forceRefresh) {
          this.beneficiaryVehicleCache = null;
          this.beneficiaryInsightsPromise = null;
          this.beneficiaryInsightsReady = false;
        }
        if (this.beneficiaryInsightsPromise) {
          return this.beneficiaryInsightsPromise;
        }
        const ensureFn = (typeof window !== 'undefined' && typeof window.ensureBeneficiaryVehicleCache === 'function')
          ? window.ensureBeneficiaryVehicleCache
          : null;
        const getFn = (typeof window !== 'undefined' && typeof window.getBeneficiaryVehicleCache === 'function')
          ? window.getBeneficiaryVehicleCache
          : null;
        if (!ensureFn) {
          this.beneficiaryInsightsReady = false;
          this.beneficiaryInsightsPromise = Promise.resolve(null);
          return this.beneficiaryInsightsPromise;
        }
        this.beneficiaryInsightsPromise = new Promise((resolve) => {
          try {
            ensureFn((data) => {
              this.beneficiaryVehicleCache = data || (getFn ? getFn() : {}) || {};
              this.beneficiaryInsightsReady = !!this.beneficiaryVehicleCache;
              resolve(this.beneficiaryVehicleCache);
            });
          } catch (err) {
            console.warn('ensureBeneficiaryVehicleCache failed', err);
            this.beneficiaryVehicleCache = getFn ? getFn() : {};
            this.beneficiaryInsightsReady = !!this.beneficiaryVehicleCache;
            resolve(this.beneficiaryVehicleCache);
          }
        }).catch((error) => {
          console.warn('Beneficiary insights promise rejected', error);
          this.beneficiaryInsightsPromise = null;
          return null;
        });
        return this.beneficiaryInsightsPromise;
      }

      getBeneficiaryAssignmentInfo(name) {
        if (!name) {
          return {
            activeElsewhere: false,
            activeVehicles: [],
            entries: []
          };
        }
        const cache = this.beneficiaryVehicleCache
          || ((typeof window !== 'undefined' && typeof window.getBeneficiaryVehicleCache === 'function')
            ? window.getBeneficiaryVehicleCache()
            : null);
        if (!cache || typeof cache !== 'object') {
          return {
            activeElsewhere: false,
            activeVehicles: [],
            entries: []
          };
        }
        const baseKey = this.getBeneficiaryCacheKey(name);
        let bucket = cache[baseKey];
        if (!bucket) {
          const altKey = this.normalizeBeneficiaryKey(name);
          bucket = cache[altKey];
        }
        if (!bucket || !Array.isArray(bucket.entries)) {
          return {
            activeElsewhere: false,
            activeVehicles: [],
            entries: []
          };
        }
        const entries = bucket.entries.slice();
        const currentCar = (this.currentCarData?.carNumber || this.currentCarData?.car_number || '').trim().toUpperCase();
        const activeEntries = entries.filter((entry) => {
          if (!entry) return false;
          const status = String(entry.status || '').trim().toUpperCase();
          if (status !== 'IN USE') return false;
          const entryCar = String(entry.carNumber || entry.vehicleNumber || '').trim();
          if (!entryCar) return false;
          if (currentCar && entryCar.trim().toUpperCase() === currentCar) return false;
          return true;
        });
        const activeVehicles = activeEntries
          .map(entry => String(entry.carNumber || entry.vehicleNumber || '').trim())
          .filter(Boolean);
        return {
          activeElsewhere: activeVehicles.length > 0,
          activeVehicles,
          entries
        };
      }

      attachNotUsingPillEvents(container) {
        if (!container) return;
        if (container.dataset.assignListenerAttached === 'true') return;
        container.addEventListener('click', (event) => {
          const target = event.target instanceof HTMLElement
            ? event.target.closest('.team-member-pill--assignable')
            : null;
          if (!target || !(target instanceof HTMLElement)) return;
          if (target.getAttribute('aria-disabled') === 'true') return;
          const name = target.getAttribute('data-beneficiary-name') || target.textContent || '';
          if (!name.trim()) return;
          this.handleBeneficiaryAllocation(name.trim(), target);
        });
        container.dataset.assignListenerAttached = 'true';
      }

      async handleBeneficiaryAllocation(name, pillElement) {
        if (!name || !this.currentCarData) return;
        const normalized = this.normalizeBeneficiaryKey(name);
        if (this.assigningBeneficiary && this.normalizeBeneficiaryKey(this.assigningBeneficiary) === normalized) {
          return;
        }
        if (this.assigningBeneficiary) {
          this.showErrorMessage('Another assignment is in progress. Please wait.');
          return;
        }
        const insight = this.getBeneficiaryAssignmentInfo(name);
        if (insight && insight.activeElsewhere) {
          const vehicles = insight.activeVehicles.length ? insight.activeVehicles.join(', ') : 'another vehicle';
          this.showErrorMessage(`${name} is already using ${vehicles}.`);
          return;
        }
        const carNumber = this.currentCarData.carNumber || this.currentCarData.car_number || '';
        if (!carNumber) {
          alert('Vehicle details are missing. Unable to assign.');
          return;
        }
        const currentUsers = this.getCurrentUsers();
        const messageLines = [
          `Assign vehicle ${carNumber} to ${name}?`
        ];
        if (currentUsers.length) {
          messageLines.push(`Current users recorded: ${currentUsers.join(', ')}`);
        }
        if (!window.confirm(messageLines.join('\n'))) {
          return;
        }
        this.assigningBeneficiary = name;
        if (pillElement) {
          pillElement.classList.add('team-member-pill--loading');
          pillElement.setAttribute('aria-disabled', 'true');
        }
        try {
          const payload = this.buildAssignmentPayload(name);
          const result = await this.submitAssignmentPayload(payload);
          if (!result || result.ok === false) {
            throw new Error((result && result.error) || 'Assignment failed');
          }
          if (result && result.partial === false && Array.isArray(result.replacedUsers) && result.replacedUsers.length) {
            this.currentCarData.otherTeamMembersUsing = result.replacedUsers
              .filter((user) => user && this.normalizeBeneficiaryKey(user) !== this.normalizeBeneficiaryKey(name));
          }
          this.applyLocalAssignment(name);
          this.recordAssignmentInCache(name);
          this.populateCarDetails();
          this.showSuccessMessage(`Assigned ${name} to vehicle ${carNumber}.`);
          this.handlePostReleaseRefresh(
            carNumber,
            this.currentCarData.teamName || this.currentCarData.team || '',
            { skipPrune: true }
          );
          this.registerVehicleInUseLocalState(name);
          this.applyAssignmentToVisibleRow(name, carNumber);
          try {
            window.vehicleAssignmentManager?.assign?.(carNumber, name);
          } catch (assignErr) {
            console.warn('Failed to sync vehicleAssignmentManager after assignment', assignErr);
          }
          try {
            window.applyVehicleInUseAssignmentsToRows?.(true);
          } catch (assignRefreshErr) {
            console.warn('Failed to refresh visible vehicle assignments', assignRefreshErr);
          }
          try {
            window.invalidateBeneficiaryVehicleCache?.();
          } catch (cacheErr) {
            console.warn('Failed to invalidate beneficiary vehicle cache', cacheErr);
          }
          this.ensureBeneficiaryVehicleInsights(true).then(() => {
            if (this.isModalOpen()) {
              this.refreshNotUsingPills();
            }
          }).catch((err) => {
            console.warn('Failed to refresh beneficiary insights after assignment', err);
          });
        } catch (error) {
          console.error('Vehicle assignment failed', error);
          this.showErrorMessage(`Assignment failed: ${error.message || error}`);
        } finally {
          if (pillElement) {
            pillElement.classList.remove('team-member-pill--loading');
            if (pillElement.classList.contains('team-member-pill--assignable')) {
              pillElement.removeAttribute('aria-disabled');
            }
          }
          this.assigningBeneficiary = null;
        }
      }

      buildAssignmentPayload(beneficiaryName) {
        const data = this.currentCarData || {};
        const carNumber = String(data.carNumber || data.car_number || '').trim().toUpperCase();
        return {
          project: data.projectName || data.project || '',
          team: data.teamName || data.team || '',
          carNumber,
          beneficiaries: [beneficiaryName],
          responsibleBeneficiary: beneficiaryName,
          car: {
            make: data.make || '',
            model: data.model || '',
            category: data.category || '',
            usageType: data.usageType || '',
            owner: data.owner || ''
          }
        };
      }

      submitAssignmentPayload(payload) {
        return new Promise((resolve, reject) => {
          try {
            if (!window.google || !google.script || !google.script.run || typeof google.script.run.assignCarToTeam !== 'function') {
              reject(new Error('Assignment service unavailable'));
              return;
            }
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .assignCarToTeamWithReturn(payload);
          } catch (err) {
            reject(err);
          }
        });
      }

      applyLocalAssignment(name) {
        if (!this.currentCarData) return;
        const normalized = this.normalizeBeneficiaryKey(name);
        const notUsing = Array.isArray(this.currentCarData.otherTeamMembersNotUsing)
          ? this.currentCarData.otherTeamMembersNotUsing.filter(member => this.normalizeBeneficiaryKey(member) !== normalized)
          : [];
        this.currentCarData.otherTeamMembersNotUsing = notUsing;
        const usingList = Array.isArray(this.currentCarData.otherTeamMembersUsing)
          ? this.currentCarData.otherTeamMembersUsing.filter(member => this.normalizeBeneficiaryKey(member) !== normalized)
          : [];
        this.currentCarData.otherTeamMembersUsing = usingList;
        this.currentCarData.responsibleBeneficiary = name;
        if (!Array.isArray(this.currentCarData.lastUsers)) {
          this.currentCarData.lastUsers = [];
        }
        if (!this.currentCarData.lastUsers.some(user => this.normalizeBeneficiaryKey(user) === normalized)) {
          this.currentCarData.lastUsers.push(name);
        }
        this.currentCarData.status = 'IN USE';
      }

      recordAssignmentInCache(name) {
        if (!name) return;
        if (!this.beneficiaryVehicleCache || typeof this.beneficiaryVehicleCache !== 'object') return;
        const key = this.getBeneficiaryCacheKey(name);
        if (!key) return;
        const carNumber = String(this.currentCarData?.carNumber || this.currentCarData?.car_number || '').trim();
        if (!carNumber) return;
        let bucket = this.beneficiaryVehicleCache[key];
        if (!bucket) {
          bucket = { beneficiary: name, entries: [] };
          this.beneficiaryVehicleCache[key] = bucket;
        }
        if (!Array.isArray(bucket.entries)) {
          bucket.entries = [];
        }
        const upperCar = carNumber.toUpperCase();
        let existing = bucket.entries.find(entry => {
          const entryCar = String(entry && (entry.carNumber || entry.vehicleNumber) || '').trim().toUpperCase();
          return entryCar === upperCar;
        });
        if (!existing) {
          existing = {
            carNumber,
            status: 'IN USE',
            project: this.currentCarData?.projectName || this.currentCarData?.project || '',
            team: this.currentCarData?.teamName || this.currentCarData?.team || '',
            source: 'IN_USE',
            entryTimestamp: Date.now()
          };
          bucket.entries.push(existing);
        } else {
          existing.status = 'IN USE';
          existing.project = this.currentCarData?.projectName || this.currentCarData?.project || existing.project || '';
          existing.team = this.currentCarData?.teamName || this.currentCarData?.team || existing.team || '';
          existing.entryTimestamp = Date.now();
          existing.source = existing.source || 'IN_USE';
        }
      }

      populateCarDetails() {
        const data = this.currentCarData;
        const currentUsers = this.getCurrentUsers();
        this.currentCarData.lastUsers = currentUsers;
        
        document.getElementById('car-project').textContent = data.project || 'N/A';
        document.getElementById('car-team').textContent = data.team || 'N/A';
        document.getElementById('car-number').textContent = data.carNumber || 'N/A';
        document.getElementById('car-make-model').textContent = `${data.make || 'N/A'} ${data.model || ''}`.trim();
        document.getElementById('car-usage-type').textContent = data.usageType || 'N/A';
        document.getElementById('car-owner').textContent = data.owner || 'N/A';
        document.getElementById('car-last-users').textContent = currentUsers.length ? currentUsers.join(', ') : 'No previous users';
        const responsibleEl = document.getElementById('car-responsible-beneficiary');
        if (responsibleEl) {
          responsibleEl.textContent = data.responsibleBeneficiary || 'N/A';
        }
        this.renderTeamMemberPills('car-team-members-using', data.otherTeamMembersUsing, 'using');
        this.renderTeamMemberPills('car-team-members-not-using', data.otherTeamMembersNotUsing, 'not-using');
        
        // Status
        const statusEl = document.getElementById('car-status');
        statusEl.textContent = data.status || 'IN USE';
        statusEl.className = `status-chip status--${(data.status || 'IN USE').toLowerCase().replace(' ', '-')}`;
        
        // History data
        if (this.historyView === 'summary') {
          this.populateHistoryData();
        } else if (this.historyView === 'in-use' && Array.isArray(this.lastHistoryData.inUse)) {
          this.renderHistoryTable(this.lastHistoryData.inUse, 'IN USE History');
        } else if (this.historyView === 'release' && Array.isArray(this.lastHistoryData.release)) {
          this.renderHistoryTable(this.lastHistoryData.release, 'RELEASE History');
        }
      }

      populateHistoryData() {
        this.ensureHistoryContentStructure();
        const history = this.currentCarData.history;
        
        // Remarks history
        const remarksContainer = document.getElementById('car-remarks-history');
        if (!remarksContainer) {
          console.warn('Vehicle release modal missing remarks container; skipping history population.');
          return;
        }

        if (history.remarks && history.remarks.length > 0) {
          remarksContainer.innerHTML = history.remarks.slice(-3).map(remark => 
            `<div class="remark-item">${this.escapeHtml(remark)}</div>`
          ).join('');
        } else {
          remarksContainer.innerHTML = '<div class="remark-item">No previous remarks available</div>';
        }
        
        // Average rating
        const avgRating = history.averageRating || 0;
        const ratingValue = document.querySelector('#car-avg-rating .rating-value');
        if (ratingValue) {
          ratingValue.textContent = avgRating.toFixed(1);
        }
        
        const stars = document.querySelectorAll('#car-avg-rating .stars-display .star');
        const fullStars = Math.floor(avgRating);
        stars.forEach((star, index) => {
          star.classList.toggle('filled', index < fullStars);
        });
      }

      resetModalState() {
        this.currentState = 'view';
        this.selectedRating = 0;
  this.releaseMode = 'user';
        this.isRemarksRequired = true;
        this.userReleaseHasOtherUsers = false;
  this.userReleaseFeedbackPending = false;
        this.historyView = 'summary';
        this.lastHistoryData = {
          summary: null,
          release: null,
          inUse: null
        };
        this.assigningBeneficiary = null;
        this.resetUserReleaseSelection();
        this.restoreHistoryContent();
        
        // Hide sections
        document.getElementById('carHistorySection').style.display = 'none';
        document.getElementById('carReleaseSection').style.display = 'none';
        
        // Show default footer
        document.querySelector('.footer-actions').style.display = 'flex';
        document.getElementById('releaseActions').style.display = 'none';
        
        // Reset form
        document.getElementById('release-remarks').value = '';
        document.getElementById('remarks-counter').textContent = '0';
        this.highlightStars(0);
        this.clearErrors();
        const select = document.getElementById('release-user-select');
        if (select) select.innerHTML = '';
        const userSelector = document.getElementById('release-user-selector');
        if (userSelector) userSelector.style.display = 'none';
        const userHelp = document.getElementById('release-user-help');
        if (userHelp) userHelp.textContent = '';
        const feedbackFields = document.getElementById('release-feedback-fields');
        if (feedbackFields) feedbackFields.style.display = 'block';
        const sectionTitle = document.querySelector('#carReleaseSection .section-header h3');
        if (sectionTitle) sectionTitle.textContent = 'Release User';
        const confirmBtn = document.getElementById('confirmReleaseBtn');
        if (confirmBtn) {
          confirmBtn.textContent = 'Release User';
          confirmBtn.disabled = true;
        }
        const responsibleEl = document.getElementById('car-responsible-beneficiary');
        if (responsibleEl) {
          responsibleEl.textContent = 'N/A';
        }
        this.renderTeamMemberPills('car-team-members-using', [], 'using');
        this.renderTeamMemberPills('car-team-members-not-using', [], 'not-using');
      }

      showModal() {
        if (this.hideTimer) {
          clearTimeout(this.hideTimer);
          this.hideTimer = null;
        }
        this.modal.style.display = 'grid';
        requestAnimationFrame(() => {
          this.modal.setAttribute('data-open', 'true');
          this.modal.setAttribute('aria-hidden', 'false');
          
          // Focus management
          const firstFocusable = this.modal.querySelector('button, input, textarea, select');
          if (firstFocusable) {
            setTimeout(() => firstFocusable.focus(), 100);
          }
        });
      }

      hideModal() {
        this.modal.setAttribute('data-open', 'false');
        this.modal.setAttribute('aria-hidden', 'true');
        if (this.hideTimer) {
          clearTimeout(this.hideTimer);
        }
        this.hideTimer = setTimeout(() => {
          this.modal.style.display = 'none';
          this.hideTimer = null;
        }, 200);
      }

      ensureHistoryContentStructure() {
        const historyContent = document.getElementById('historyContent');
        if (!historyContent) return;
        if (!this.historyContentTemplate) {
          this.historyContentTemplate = historyContent.innerHTML;
        }
        if (!historyContent.querySelector('#car-remarks-history') && this.historyContentTemplate) {
          historyContent.innerHTML = this.historyContentTemplate;
        }
      }

      restoreHistoryContent() {
        const historyContent = document.getElementById('historyContent');
        if (!historyContent) return;
        if (!this.historyContentTemplate) {
          this.historyContentTemplate = historyContent.innerHTML;
        }
        if (this.historyContentTemplate) {
          historyContent.innerHTML = this.historyContentTemplate;
        }
      }

      isModalOpen() {
        return this.modal && this.modal.style.display !== 'none';
      }

      toggleHistorySection() {
        const section = document.getElementById('carHistorySection');
        const content = document.getElementById('historyContent');
        const header = section.querySelector('.section-header');
        
        if (section.style.display === 'none') {
          section.style.display = 'block';
          content.classList.add('expanded');
          header.classList.add('expanded');
          document.getElementById('viewHistoryBtn').textContent = 'Hide History';
        } else {
          section.style.display = 'none';
          content.classList.remove('expanded');
          header.classList.remove('expanded');
          document.getElementById('viewHistoryBtn').textContent = 'View History';
        }
      }

      showReleaseForm() {
        this.currentState = 'release';
        this.releaseMode = 'user';

        const feedbackFields = document.getElementById('release-feedback-fields');
        const userSelector = document.getElementById('release-user-selector');
        const userRequiredBadge = document.getElementById('release-user-required');
        const sectionTitle = document.querySelector('#carReleaseSection .section-header h3');
        const confirmBtn = document.getElementById('confirmReleaseBtn');
        const userSelectionBlock = document.getElementById('user-release-selection');
        const userHelp = document.getElementById('release-user-help');

        this.userReleaseHasOtherUsers = this.getCurrentUsers().length > 1;
        this.isRemarksRequired = false;
        this.userReleaseFeedbackPending = false;
        this.resetUserReleaseSelection();
        this.prepareUserReleaseSelection();

        if (sectionTitle) {
          sectionTitle.textContent = 'Release User';
        }
        if (confirmBtn) {
          confirmBtn.textContent = 'Release User';
        }
        if (userSelector) {
          userSelector.style.display = 'none';
        }
        if (userHelp) {
          userHelp.textContent = 'Select the beneficiaries to release from the vehicle.';
        }
        if (userRequiredBadge) {
          userRequiredBadge.style.display = 'none';
        }
        if (feedbackFields) {
          feedbackFields.style.display = 'none';
        }
        if (userSelectionBlock) {
          userSelectionBlock.style.display = 'flex';
        }

        this.selectedRating = 0;
        this.highlightStars(0);
        this.showError('release-user-error', '');
        this.showError('remarks-error', '');
        this.showError('rating-error', '');
        this.validateForm();

        document.getElementById('carReleaseSection').style.display = 'block';
        document.querySelector('.footer-actions').style.display = 'none';
        document.getElementById('releaseActions').style.display = 'flex';

        setTimeout(() => {
          const firstCheckbox = document.querySelector('#userReleaseTableContainer .user-release-checkbox');
          if (firstCheckbox) {
            firstCheckbox.focus({ preventScroll: false });
          }
        }, 100);
      }

      showUserReleaseForm() {
        const users = this.getCurrentUsers();
        if (!users.length) {
          alert('No users are currently assigned to this vehicle.');
          return;
        }

  this.showReleaseForm();
      }

      resetUserReleaseSelection() {
        if (!this.userReleaseSelection) {
          this.userReleaseSelection = {
            rows: [],
            selected: new Map(),
            activeUsers: new Map(),
            listenerAttached: false
          };
        }
        this.userReleaseSelection.rows = [];
        this.userReleaseSelection.selected = new Map();
        this.userReleaseSelection.activeUsers = new Map();
        this.userReleaseFeedbackPending = false;
        const container = document.getElementById('userReleaseTableContainer');
        if (container) {
          container.innerHTML = '';
        }
        const emptyState = document.getElementById('userReleaseEmptyState');
        if (emptyState) {
          emptyState.style.display = 'none';
        }
        this.updateUserReleaseConfirmState();
      }

      prepareUserReleaseSelection() {
        const container = document.getElementById('userReleaseTableContainer');
        const emptyState = document.getElementById('userReleaseEmptyState');
        if (emptyState) {
          emptyState.style.display = 'none';
        }
        if (container) {
          container.innerHTML = '<div style="padding:16px;color:#475569;">Loading current beneficiaries...</div>';
        }

        const cachedRows = Array.isArray(this.lastHistoryData.inUse) ? this.lastHistoryData.inUse : null;
        if (cachedRows && cachedRows.length >= 2) {
          this.renderUserReleaseSelectionTable(cachedRows);
          return;
        }
        this.fetchInUseHistoryForSelection();
      }

      fetchInUseHistoryForSelection() {
        const carNumber = this.currentCarData?.carNumber || this.currentCarData?.car_number || '';
        const teamName = this.currentCarData?.teamName || this.currentCarData?.team || '';
        const container = document.getElementById('userReleaseTableContainer');
        const emptyState = document.getElementById('userReleaseEmptyState');
        const prefetch = (typeof window !== 'undefined' && window.vehicleReleasePrefetch)
          ? window.vehicleReleasePrefetch
          : null;

        const handleSuccess = (rows) => {
          if (Array.isArray(rows)) {
            this.lastHistoryData.inUse = rows;
            this.renderUserReleaseSelectionTable(rows);
          } else {
            if (container) {
              container.innerHTML = '<div style="padding:16px;color:#dc2626;">Unexpected data returned for IN USE history.</div>';
            }
          }
        };

        const handleFailure = (error) => {
          console.error('Failed to load IN USE history for selection:', error);
          if (container) {
            const message = error && error.message ? error.message : (error ? String(error) : 'Unknown error');
            container.innerHTML = `<div style="padding:16px;color:#dc2626;">Failed to load history: ${this.escapeHtml(message)}</div>`;
          }
          if (emptyState) {
            emptyState.style.display = 'block';
          }
        };

        if (!carNumber) {
          if (container) {
            container.innerHTML = '<div style="padding:16px;color:#475569;">No car selected.</div>';
          }
          return;
        }

        if (prefetch && typeof prefetch.requestInUseHistory === 'function') {
          const cached = prefetch.getInUseHistory(carNumber, teamName);
          if (Array.isArray(cached)) {
            handleSuccess(cached);
            return;
          }
          prefetch.requestInUseHistory(carNumber, teamName, {
            onSuccess: handleSuccess,
            onFailure: handleFailure
          });
          return;
        }

        google.script.run
          .withSuccessHandler((data) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeInUseHistory(carNumber, teamName, data); } catch(_){ /* ignore */ }
            handleSuccess(data);
          })
          .withFailureHandler((error) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeInUseHistoryError(carNumber, teamName, error); } catch(_){ /* ignore */ }
            handleFailure(error);
          })
          .getInUseHistoryForcedWorking(carNumber, teamName);
      }

      renderUserReleaseSelectionTable(rows) {
        const container = document.getElementById('userReleaseTableContainer');
        const emptyState = document.getElementById('userReleaseEmptyState');
        if (!container) return;

        if (!Array.isArray(rows) || rows.length < 2) {
          container.innerHTML = '<div style="padding:16px;color:#475569;">No IN USE history available.</div>';
          if (emptyState) {
            emptyState.style.display = 'block';
          }
          this.updateUserReleaseConfirmState();
          return;
        }

        const headerRow = Array.isArray(rows[0]) ? rows[0] : [];
        const beneficiaryIndex = this.findColumnIndex(headerRow, [
          'R.Beneficiary',
          'Responsible beneficiary',
          'Name of responsible beneficiary',
          'Beneficiary',
          'Member'
        ]);

        if (beneficiaryIndex === -1) {
          container.innerHTML = '<div style="padding:16px;color:#dc2626;">Unable to locate beneficiary column in history data.</div>';
          if (emptyState) {
            emptyState.style.display = 'block';
          }
          this.updateUserReleaseConfirmState();
          return;
        }

        const activeUsersList = this.getCurrentUsers();
        const activeUsersMap = new Map();
        activeUsersList.forEach((name) => {
          const trimmed = String(name || '').trim();
          if (!trimmed) return;
          const key = this.normalizeBeneficiaryKey(trimmed);
          if (!activeUsersMap.has(key)) {
            activeUsersMap.set(key, trimmed);
          }
        });
        this.userReleaseSelection.activeUsers = activeUsersMap;

        const processedRows = rows.map(row => Array.isArray(row) ? [...row] : row);
        const headerCopy = processedRows[0];
        const inUseDateColumnIndex = this.findColumnIndex(headerCopy, [
          'Date and time of entry',
          'Date of entry',
          'Date'
        ]);
        const daysColumnIndex = this.findColumnIndex(headerCopy, ['Days in Use']);
        if (inUseDateColumnIndex !== -1) {
          for (let i = 1; i < processedRows.length; i++) {
            const row = processedRows[i];
            if (!Array.isArray(row)) continue;
            row[inUseDateColumnIndex] = this.formatDateForDisplay(row[inUseDateColumnIndex]);
          }
        }

        if (emptyState) {
          emptyState.style.display = activeUsersMap.size ? 'none' : 'block';
        }
        if (!activeUsersMap.size) {
          container.innerHTML = '<div style="padding:16px;color:#475569;">No active beneficiaries found for this vehicle.</div>';
          this.updateUserReleaseConfirmState();
          return;
        }

        const columnsToRemove = ['Vehicle Number', 'Make', 'Model', 'Category', 'Usage Type', 'Owner'];
        const columnsToKeep = [];
        headerCopy.forEach((header, index) => {
          if (!columnsToRemove.includes(header)) {
            columnsToKeep.push(index);
          }
        });
        const beneficiaryFilteredIndex = columnsToKeep.indexOf(beneficiaryIndex);
        if (beneficiaryFilteredIndex === -1) {
          container.innerHTML = '<div style="padding:16px;color:#dc2626;">Unable to prepare selection table.</div>';
          if (emptyState) {
            emptyState.style.display = 'block';
          }
          this.updateUserReleaseConfirmState();
          return;
        }

        const filteredRows = processedRows.map(row => {
          return Array.isArray(row) ? columnsToKeep.map(index => row[index]) : row;
        });

        const headerCells = filteredRows[0].map(h => `<th>${this.escapeHtml(String(h || ''))}</th>`);
        const renderedKeys = new Set();
        let primaryDaysDisplay = '';
        if (daysColumnIndex !== -1 && rows.length > 1) {
          const originalDays = rows[1][daysColumnIndex];
          if (originalDays) primaryDaysDisplay = originalDays;
        }

        const detailItems = [];
        if (this.currentCarData) {
          const makeModel = `${this.currentCarData.make || ''} ${this.currentCarData.model || ''}`.trim();
          let daysLabel = 'N/A';
          if (primaryDaysDisplay) {
            const numericValue = parseInt(String(primaryDaysDisplay).replace(/[^0-9]/g, ''), 10);
            if (Number.isFinite(numericValue) && numericValue > 0) {
              daysLabel = `${numericValue} day${numericValue === 1 ? '' : 's'}`;
            } else {
              daysLabel = String(primaryDaysDisplay).trim();
            }
          }
          detailItems.push(`Vehicle: ${this.escapeHtml(this.currentCarData.carNumber || 'N/A')}`);
          detailItems.push(`Make & Model: ${this.escapeHtml(makeModel || 'N/A')}`);
          detailItems.push(`Category: ${this.escapeHtml(this.currentCarData.category || 'N/A')}`);
          detailItems.push(`Usage Type: ${this.escapeHtml(this.currentCarData.usageType || 'N/A')}`);
          detailItems.push(`Owner: ${this.escapeHtml(this.currentCarData.owner || 'N/A')}`);
          detailItems.push(`Days in Use: ${this.escapeHtml(daysLabel)}`);
        }

        const detailHtml = detailItems.length
          ? `<div style="background-color:#f8f9fa;padding:10px 12px;margin-bottom:12px;border-radius:6px;border-left:3px solid #0ea5e9;font-size:12px;color:#334155;display:flex;flex-wrap:wrap;gap:10px;">${detailItems.join(' <span style="opacity:0.45;">&bull;</span> ')}</div>`
          : '';

  const rowsHtml = [];
  const headerRowHtml = `<tr>${headerCells.join('')}</tr>`;
  rowsHtml.push(headerRowHtml);

        const summaryHeaderNormalized = filteredRows[0].map(header => String(header || '').toLowerCase());
        const statusColumnIndex = summaryHeaderNormalized.findIndex(header => header.includes('status'));
        const ratingColumnIndex = summaryHeaderNormalized.findIndex(header => header.includes('rating'));

        for (let i = 1; i < filteredRows.length; i++) {
          const row = filteredRows[i];
          if (!Array.isArray(row)) continue;
          let rowHtml = '';
          for (let c = 0; c < row.length; c++) {
            const cellValue = row[c];
            const rawText = cellValue == null ? '' : String(cellValue);
            let cellContent = this.escapeHtml(rawText);

            if (c === statusColumnIndex && rawText.trim().toUpperCase() === 'IN USE') {
              cellContent = `<span class="status-pill status-pill--in-use">${cellContent}</span>`;
            } else if (c === ratingColumnIndex) {
              cellContent = this.renderRatingStars(rawText);
            }

            if (c === beneficiaryFilteredIndex) {
              const beneficiaryName = rawText.trim();
              const key = this.normalizeBeneficiaryKey(beneficiaryName);
              const isActive = beneficiaryName && activeUsersMap.has(key);
              if (isActive && !renderedKeys.has(key)) {
                renderedKeys.add(key);
                const checkboxId = `user-release-${key.replace(/[^a-z0-9]+/g, '-') || 'beneficiary'}-${i}`;
                cellContent = `
                  <label class="user-release-beneficiary" for="${checkboxId}">
                    <input
                      type="checkbox"
                      id="${checkboxId}"
                      class="user-release-checkbox"
                      data-beneficiary-key="${this.escapeHtml(key)}"
                      data-beneficiary-name="${this.escapeHtml(activeUsersMap.get(key))}"
                    />
                    <span>${this.escapeHtml(activeUsersMap.get(key) || beneficiaryName)}</span>
                  </label>
                `;
              } else if (isActive) {
                cellContent = `<span>${this.escapeHtml(activeUsersMap.get(key) || beneficiaryName)}</span>`;
              }
            }

            rowHtml += `<td>${cellContent}</td>`;
          }
          rowsHtml.push(`<tr>${rowHtml}</tr>`);
        }

        const missingBeneficiaries = [];
        activeUsersMap.forEach((displayName, key) => {
          if (!renderedKeys.has(key)) {
            missingBeneficiaries.push({ key, displayName });
            renderedKeys.add(key);
          }
        });

        if (missingBeneficiaries.length) {
          const columnCount = filteredRows[0].length;
          missingBeneficiaries.forEach((entry, missingIndex) => {
            const checkboxId = `user-release-${entry.key.replace(/[^a-z0-9]+/g, '-') || 'beneficiary'}-missing-${missingIndex}`;
            const rowCells = [];
            for (let col = 0; col < columnCount; col++) {
              let cellContent = '<span style="color:#94a3b8;">No history</span>';
              if (col === beneficiaryFilteredIndex) {
                cellContent = `
                  <label class="user-release-beneficiary" for="${checkboxId}">
                    <input
                      type="checkbox"
                      id="${checkboxId}"
                      class="user-release-checkbox"
                      data-beneficiary-key="${this.escapeHtml(entry.key)}"
                      data-beneficiary-name="${this.escapeHtml(entry.displayName)}"
                    />
                    <span>${this.escapeHtml(entry.displayName)}</span>
                  </label>
                `;
              }
              rowCells.push(`<td>${cellContent}</td>`);
            }
            rowsHtml.push(`<tr class="user-release-added-row">${rowCells.join('')}</tr>`);
          });
        }

        const selectAllHtml = `
          <div class="user-release-select-all" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:2px 4px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#1e293b;">
              <input type="checkbox" id="user-release-select-all" class="user-release-select-all-checkbox" />
              <span>Select all beneficiaries</span>
            </label>
          </div>
        `;

        container.innerHTML = `${detailHtml}${selectAllHtml}<table><thead>${rowsHtml[0]}</thead><tbody>${rowsHtml.slice(1).join('')}</tbody></table>`;
        this.userReleaseSelection.rows = rows;
        this.userReleaseSelection.selected = new Map();
        this.updateUserReleaseConfirmState();
        this.syncUserReleaseSelectAllState();

        if (!this.userReleaseSelection.listenerAttached) {
          container.addEventListener('change', this.handleUserReleaseCheckboxChange);
          this.userReleaseSelection.listenerAttached = true;
        }
      }

      handleUserReleaseCheckboxChange(event) {
        const target = event.target;
        const container = document.getElementById('userReleaseTableContainer');
        if (!target || !container) {
          return;
        }
        if (target.classList.contains('user-release-select-all-checkbox')) {
          const shouldCheck = target.checked;
          const checkboxes = container.querySelectorAll('.user-release-checkbox');
          this.userReleaseSelection.selected = new Map();
          checkboxes.forEach((checkbox) => {
            checkbox.checked = shouldCheck;
            const key = checkbox.getAttribute('data-beneficiary-key');
            const name = checkbox.getAttribute('data-beneficiary-name') || '';
            if (shouldCheck && key) {
              this.userReleaseSelection.selected.set(key, name || key);
            }
          });
          this.updateUserReleaseConfirmState();
          this.syncUserReleaseSelectAllState();
          return;
        }
        if (!target.classList.contains('user-release-checkbox')) {
          this.syncUserReleaseSelectAllState();
          return;
        }
        const key = target.getAttribute('data-beneficiary-key');
        const name = target.getAttribute('data-beneficiary-name') || '';
        if (!key) return;
        if (target.checked) {
          this.userReleaseSelection.selected.set(key, name || key);
        } else {
          this.userReleaseSelection.selected.delete(key);
        }
        this.updateUserReleaseConfirmState();
        this.syncUserReleaseSelectAllState();
      }

      updateUserReleaseConfirmState() {
        const confirmBtn = document.getElementById('confirmReleaseBtn');
        if (!confirmBtn) return;
        if (this.releaseMode === 'user') {
          if (this.isRemarksRequired) {
            this.validateForm();
          } else {
            const hasSelection = this.userReleaseSelection.selected.size > 0;
            confirmBtn.disabled = !hasSelection;
            this.showError('release-user-error', hasSelection ? '' : 'Please select at least one beneficiary.');
          }
        }
      }

      syncUserReleaseSelectAllState() {
        const container = document.getElementById('userReleaseTableContainer');
        if (!container) return;
        const selectAllEl = container.querySelector('.user-release-select-all-checkbox');
        if (!selectAllEl) return;
        const checkboxes = container.querySelectorAll('.user-release-checkbox');
        if (!checkboxes.length) {
          selectAllEl.checked = false;
          selectAllEl.indeterminate = false;
          selectAllEl.disabled = true;
          return;
        }
        const total = checkboxes.length;
        let checkedCount = 0;
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            checkedCount += 1;
          }
        });
        selectAllEl.disabled = false;
        selectAllEl.checked = checkedCount === total;
        selectAllEl.indeterminate = checkedCount > 0 && checkedCount < total;
      }

      hideReleaseForm() {
        this.currentState = 'view';
        this.releaseMode = 'user';
        this.isRemarksRequired = true;
        this.userReleaseHasOtherUsers = false;
        this.userReleaseFeedbackPending = false;
        
        // Hide release section
        document.getElementById('carReleaseSection').style.display = 'none';
        
        // Switch footer back
        document.querySelector('.footer-actions').style.display = 'flex';
        document.getElementById('releaseActions').style.display = 'none';
        
        // Reset form
        document.getElementById('release-remarks').value = '';
        document.getElementById('remarks-counter').textContent = '0';
        this.selectedRating = 0;
        this.highlightStars(0);
        this.clearErrors();
        const select = document.getElementById('release-user-select');
        if (select) {
          select.innerHTML = '';
        }
        const userSelector = document.getElementById('release-user-selector');
        if (userSelector) {
          userSelector.style.display = 'none';
        }
        const userHelp = document.getElementById('release-user-help');
        if (userHelp) {
          userHelp.textContent = '';
        }
        const feedbackFields = document.getElementById('release-feedback-fields');
        if (feedbackFields) {
          feedbackFields.style.display = 'block';
        }
        const userSelectionBlock = document.getElementById('user-release-selection');
        if (userSelectionBlock) {
          userSelectionBlock.style.display = 'none';
        }
        this.resetUserReleaseSelection();
        const sectionTitle = document.querySelector('#carReleaseSection .section-header h3');
        if (sectionTitle) {
          sectionTitle.textContent = 'Release User';
        }
        const confirmBtn = document.getElementById('confirmReleaseBtn');
        if (confirmBtn) {
          confirmBtn.textContent = 'Release User';
        }
      }

      highlightStars(count) {
        const stars = document.querySelectorAll('#release-stars .star-input');
        stars.forEach((star, index) => {
          star.classList.toggle('hover', index < count);
          star.classList.toggle('filled', index < count);
        });
      }

      selectRating(rating) {
        this.selectedRating = rating;
        const stars = document.querySelectorAll('#release-stars .star-input');
        stars.forEach((star, index) => {
          star.classList.toggle('active', index < rating);
          star.classList.toggle('filled', index < rating);
          star.classList.remove('hover');
        });
        this.validateForm();
      }

      validateForm() {
        const confirmBtn = document.getElementById('confirmReleaseBtn');
        if (this.releaseMode === 'user') {
          const selectedCount = this.userReleaseSelection && this.userReleaseSelection.selected
            ? this.userReleaseSelection.selected.size
            : 0;
          const hasSelection = selectedCount > 0;
          this.showError('release-user-error', hasSelection ? '' : 'Please select at least one beneficiary');
          if (confirmBtn) {
            confirmBtn.disabled = !hasSelection;
          }
          if (!this.isRemarksRequired) {
            return hasSelection;
          }
        }

        const remarksEl = document.getElementById('release-remarks');
        const remarks = remarksEl ? remarksEl.value.trim() : '';
        const remarksValid = remarks.length >= 10;
        const ratingValid = this.selectedRating > 0;
        let isValid = remarksValid && ratingValid;

        if (this.releaseMode === 'user') {
          const selectedCount = this.userReleaseSelection && this.userReleaseSelection.selected
            ? this.userReleaseSelection.selected.size
            : 0;
          const userValid = selectedCount > 0;
          this.showError('release-user-error', userValid ? '' : 'Please select at least one beneficiary');
          isValid = isValid && userValid;
        } else {
          this.showError('release-user-error', '');
        }

        this.showError('remarks-error', remarksValid ? '' : 'Please provide at least 10 characters of remarks');
        this.showError('rating-error', ratingValid ? '' : 'Please provide a rating');

        if (confirmBtn) {
          confirmBtn.disabled = !isValid;
        }

        return isValid;
      }

      showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.toggle('show', !!message);
        }
      }

      clearErrors() {
        ['remarks-error', 'rating-error', 'release-user-error'].forEach(id => {
          this.showError(id, '');
        });
      }

      pruneVehicleInUseLocalState(carNumber, beneficiaries = []) {
        const upper = String(carNumber || '').trim().toUpperCase();
        if (!upper) {
          return;
        }

        const beneficiaryList = Array.isArray(beneficiaries) ? beneficiaries : (beneficiaries ? [beneficiaries] : []);
        const normalizedTargets = new Set();
        const rawTargets = new Set();
        beneficiaryList.forEach((name) => {
          if (!name || typeof name !== 'string') return;
          const trimmed = name.trim();
          if (!trimmed) return;
          rawTargets.add(trimmed);
          rawTargets.add(trimmed.toLowerCase());
          const normalized = this.normalizeBeneficiaryKey(trimmed);
          if (normalized) {
            normalizedTargets.add(normalized);
          }
        });

        try {
          if (Array.isArray(window.vehicleInUseRecords)) {
            for (let i = window.vehicleInUseRecords.length - 1; i >= 0; i--) {
              const rec = window.vehicleInUseRecords[i];
              if (!rec) continue;
              const recVehicle = String(rec.vehicleNumber || rec.carNumber || rec.vehicle || '').trim().toUpperCase();
              const recName = rec.beneficiary || rec.responsibleBeneficiary || rec.member || rec.name || '';
              const recRaw = String(recName || '').trim();
              const recNormalized = this.normalizeBeneficiaryKey(recName);
              const matchesVehicle = recVehicle && recVehicle === upper;
              const matchesNormalized = normalizedTargets.size && recNormalized && normalizedTargets.has(recNormalized);
              const matchesRaw = rawTargets.size && recRaw && (rawTargets.has(recRaw) || rawTargets.has(recRaw.toLowerCase()));
              if (matchesVehicle || matchesNormalized || matchesRaw) {
                window.vehicleInUseRecords.splice(i, 1);
              }
            }
          }
        } catch (err) {
          console.warn('Failed to prune vehicleInUseRecords cache', err);
        }

        const mapCandidates = [
          window.vehicleInUseMap,
          window.vehicleInUseLowerMap,
          window.vehicleInUseTeamMap,
          window.vehicleInUseProjectMap
        ];

        const normalizedSuffixes = normalizedTargets.size
          ? Array.from(normalizedTargets).map((target) => `|${target}`)
          : [];

        mapCandidates.forEach((map) => {
          if (!map || typeof map !== 'object') return;
          try {
            Object.keys(map).forEach((key) => {
              const value = String(map[key] || '').trim().toUpperCase();
              const keyTrimmed = String(key || '').trim();
              const keyLower = keyTrimmed.toLowerCase();
              const keyNormalized = this.normalizeBeneficiaryKey(keyTrimmed);
              const matchesKey =
                (rawTargets.size && (rawTargets.has(keyTrimmed) || rawTargets.has(keyLower))) ||
                (normalizedTargets.size && keyNormalized && normalizedTargets.has(keyNormalized)) ||
                (normalizedSuffixes.length && normalizedSuffixes.some((suffix) => keyLower.endsWith(suffix)));
              if (value === upper || matchesKey) {
                delete map[key];
              }
            });
          } catch (mapErr) {
            console.warn('Failed to prune vehicleInUse map entry', mapErr);
          }
        });
      }

      normalizeTeamKey(value) {
        return String(value || '')
          .trim()
          .toLowerCase()
          .replace(/\s+/g, ' ');
      }

      normalizeProjectKey(value) {
        return this.normalizeTeamKey(value);
      }

      registerVehicleInUseLocalState(beneficiaryName) {
        if (!beneficiaryName) {
          return;
        }

        const carNumber = this.currentCarData?.carNumber || this.currentCarData?.car_number || '';
        const upperCar = String(carNumber || '').trim().toUpperCase();
        if (!upperCar) {
          return;
        }

        const normalizedKey = this.normalizeBeneficiaryKey(beneficiaryName);

        try {
          const exactMap = typeof window !== 'undefined' && window.vehicleInUseMap && typeof window.vehicleInUseMap === 'object'
            ? window.vehicleInUseMap
            : null;
          const lowerMap = typeof window !== 'undefined' && window.vehicleInUseLowerMap && typeof window.vehicleInUseLowerMap === 'object'
            ? window.vehicleInUseLowerMap
            : null;
          const teamMap = typeof window !== 'undefined' && window.vehicleInUseTeamMap && typeof window.vehicleInUseTeamMap === 'object'
            ? window.vehicleInUseTeamMap
            : null;
          const projectMap = typeof window !== 'undefined' && window.vehicleInUseProjectMap && typeof window.vehicleInUseProjectMap === 'object'
            ? window.vehicleInUseProjectMap
            : null;
          const records = typeof window !== 'undefined' && Array.isArray(window.vehicleInUseRecords)
            ? window.vehicleInUseRecords
            : null;

          if (exactMap) {
            Object.keys(exactMap).forEach((key) => {
              if (this.normalizeBeneficiaryKey(key) === normalizedKey) {
                exactMap[key] = upperCar;
              }
            });
            if (!Object.prototype.hasOwnProperty.call(exactMap, beneficiaryName)) {
              exactMap[beneficiaryName] = upperCar;
            }
          }

          if (lowerMap && normalizedKey) {
            lowerMap[normalizedKey] = upperCar;
          }

          const teamValue = this.currentCarData?.teamName || this.currentCarData?.team || '';
          const projectValue = this.currentCarData?.projectName || this.currentCarData?.project || '';
          const teamKey = this.normalizeTeamKey(teamValue);
          const projectKey = this.normalizeProjectKey(projectValue);

          if (teamMap && normalizedKey) {
            Object.keys(teamMap).forEach((key) => {
              if (key.endsWith('|' + normalizedKey)) {
                teamMap[key] = upperCar;
              }
            });
            if (teamKey) {
              teamMap[teamKey + '|' + normalizedKey] = upperCar;
            }
          }

          if (projectMap && normalizedKey) {
            Object.keys(projectMap).forEach((key) => {
              if (key.endsWith('|' + normalizedKey)) {
                projectMap[key] = upperCar;
              }
            });
            if (projectKey) {
              projectMap[projectKey + '|' + normalizedKey] = upperCar;
            }
          }

          if (records) {
            for (let i = records.length - 1; i >= 0; i--) {
              const record = records[i];
              if (!record) continue;
              const recordKey = this.normalizeBeneficiaryKey(
                record.beneficiary || record.responsibleBeneficiary || record.member || record.key
              );
              if (recordKey && recordKey === normalizedKey) {
                records.splice(i, 1);
              }
            }
            records.push({
              beneficiary: beneficiaryName,
              responsibleBeneficiary: beneficiaryName,
              vehicleNumber: upperCar,
              carNumber: upperCar,
              team: teamValue,
              project: projectValue,
              status: 'IN USE',
              key: normalizedKey,
              entryTimestamp: Date.now(),
              entryDate: new Date().toISOString()
            });
          }
        } catch (cacheErr) {
          console.warn('Failed to register vehicleInUse cache entry', cacheErr);
        }
      }

      applyAssignmentToVisibleRow(beneficiaryName, carNumber) {
        if (typeof document === 'undefined') return;
        const normalizedName = this.normalizeBeneficiaryKey(beneficiaryName);
        if (!normalizedName) return;
        const upperCar = String(carNumber || '').trim().toUpperCase();
        const rows = document.querySelectorAll('.tbody .row-data');
        if (!rows || !rows.length) return;
        rows.forEach((row) => {
          if (!row) return;
          const beneficiaryInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
          const vehicleInput = row.querySelector('input.car-number-input');
          if (!beneficiaryInput || !vehicleInput) return;
          const currentName = this.normalizeBeneficiaryKey(beneficiaryInput.value || '');
          if (!currentName || currentName !== normalizedName) return;
          if (upperCar) {
            const trimmed = String(vehicleInput.value || '').trim().toUpperCase();
            if (trimmed !== upperCar) {
              vehicleInput.value = upperCar;
              try { vehicleInput.dispatchEvent(new Event('input', { bubbles: true })); } catch (_) { /* noop */ }
            }
            try { vehicleInput.dataset.prefillSource = 'Vehicle_InUse'; } catch (_) { /* noop */ }
            try { vehicleInput.setAttribute('data-prefill-source', 'Vehicle_InUse'); } catch (_) { /* noop */ }
          }
        });
      }

      handlePostReleaseRefresh(carNumber, teamName = '', options = {}) {
        const carValue = String(carNumber || '').trim();
        if (!carValue) {
          return;
        }

        const opts = options && typeof options === 'object' ? options : {};
        const releasedBeneficiaries = Array.isArray(opts.releasedBeneficiaries)
          ? opts.releasedBeneficiaries.filter(name => typeof name === 'string' && name.trim())
          : [];
        if (!opts.skipPrune) {
          this.pruneVehicleInUseLocalState(carValue, releasedBeneficiaries);
        }

        try {
          window.invalidateVehicleNormalizationCache?.();
        } catch (normErr) {
          console.warn('Failed to reset vehicle normalization cache', normErr);
        }

        try {
          if (opts.skipPrefetch !== true) {
            window.vehicleReleasePrefetch?.invalidate?.(carValue);
            if (teamName) {
              window.vehicleReleasePrefetch?.invalidateTeam?.(carValue, teamName);
            }
          }
        } catch (prefetchErr) {
          console.warn('Failed to invalidate vehicle release prefetch cache', prefetchErr);
        }

        try {
          window.vehicleAssignmentManager?.clear(carValue);
        } catch (err) {
          console.warn('Failed to clear vehicle assignment manager state', err);
        }

        try {
          if (typeof window.refreshVehicleAssignments === 'function') {
            window.refreshVehicleAssignments({ prefetchVehicles: true });
          } else {
            window.clearVehiclePickerCache?.();
            window.refreshVehicleInUseData?.();
          }
        } catch (err) {
          console.warn('Failed to trigger vehicle assignment refresh workflow', err);
        }

        try {
          setTimeout(() => {
            try {
              window.applyVehicleInUseAssignmentsToRows?.(true);
            } catch (applyErr) {
              console.warn('Failed to force vehicle assignment application', applyErr);
            }
            try {
              window.refreshVehicleMatchPopup?.();
            } catch (matchLaterErr) {
              console.warn('Failed to refresh assigned vehicle popup after row update', matchLaterErr);
            }
          }, 750);
        } catch (timerErr) {
          console.warn('Failed to schedule vehicle assignment refresh', timerErr);
        }

        try {
          window.invalidateBeneficiaryVehicleCache?.();
        } catch (beneficiaryErr) {
          console.warn('Failed to invalidate beneficiary vehicle cache', beneficiaryErr);
        }

        try {
          window.refreshVehicleMatchPopup?.();
        } catch (matchErr) {
          console.warn('Failed to refresh assigned vehicle popup', matchErr);
        }
      }

      async confirmRelease() {
        await this.confirmUserRelease();
      }

      async confirmUserRelease() {
        const selectedUsers = this.userReleaseSelection && this.userReleaseSelection.selected
          ? Array.from(this.userReleaseSelection.selected.values())
          : [];
        if (!selectedUsers.length) {
          this.showError('release-user-error', 'Please select at least one beneficiary');
          this.validateForm();
          return;
        }

        const confirmBtn = document.getElementById('confirmReleaseBtn');
        const originalText = confirmBtn ? confirmBtn.textContent : '';

        if (!this.userReleaseFeedbackPending) {
          const confirmMessage = selectedUsers.length === 1
            ? `Release ${selectedUsers[0]} from vehicle ${this.currentCarData.carNumber}?`
            : `Release ${selectedUsers.length} beneficiaries from vehicle ${this.currentCarData.carNumber}?`;
          if (!window.confirm(confirmMessage)) {
            return;
          }

          this.userReleaseFeedbackPending = true;
          this.isRemarksRequired = true;
          const feedbackFields = document.getElementById('release-feedback-fields');
          if (feedbackFields) {
            feedbackFields.style.display = 'block';
          }
          const userHelp = document.getElementById('release-user-help');
          if (userHelp) {
            userHelp.textContent = 'Please provide remarks (min 10 characters) and a rating to complete the release.';
          }
          if (confirmBtn) {
            confirmBtn.textContent = 'Submit Release';
            confirmBtn.disabled = true;
          }
          const remarksEl = document.getElementById('release-remarks');
          if (remarksEl) {
            remarksEl.focus({ preventScroll: false });
          }
          alert('Please provide remarks and a rating to complete this release.');
          this.validateForm();
          return;
        }

        if (!this.validateForm()) {
          return;
        }

  const remarksField = document.getElementById('release-remarks');
  const remarksValue = remarksField ? remarksField.value.trim() : '';
        const payload = {
          scope: 'user',
          carNumber: this.currentCarData.carNumber,
          project: this.currentCarData.project,
          projectName: this.currentCarData.projectName || this.currentCarData.project || '',
          team: this.currentCarData.team,
          teamName: this.currentCarData.teamName || this.currentCarData.team || '',
          category: this.currentCarData.category,
          make: this.currentCarData.make,
          model: this.currentCarData.model,
          usageType: this.currentCarData.usageType,
          owner: this.currentCarData.owner,
          users: selectedUsers,
          remarks: remarksValue,
          stars: this.isRemarksRequired ? this.selectedRating : 0,
          requireFeedback: this.isRemarksRequired,
          submitter: this.currentCarData.submitter,
          responsibleBeneficiary: this.currentCarData.responsibleBeneficiary || '',
          teamMembers: Array.isArray(this.currentCarData.otherTeamMembers) ? this.currentCarData.otherTeamMembers : [],
          otherTeamMembers: Array.isArray(this.currentCarData.otherTeamMembers) ? this.currentCarData.otherTeamMembers : [],
          otherTeamMembersUsing: Array.isArray(this.currentCarData.otherTeamMembersUsing) ? this.currentCarData.otherTeamMembersUsing : [],
          otherTeamMembersNotUsing: Array.isArray(this.currentCarData.otherTeamMembersNotUsing) ? this.currentCarData.otherTeamMembersNotUsing : [],
          lastUsers: this.currentCarData.lastUsers || []
        };

        try {
          if (confirmBtn) {
            confirmBtn.classList.add('loading');
            confirmBtn.disabled = true;
          }

          const result = await this.submitUserRelease(payload);
          if (result && result.ok) {
            const releasedList = Array.isArray(result.releasedUsers) && result.releasedUsers.length
              ? result.releasedUsers
              : selectedUsers;
            releasedList.forEach((name) => this.removeUserFromCurrentData(name));
            this.populateCarDetails();
            this.handlePostReleaseRefresh(
              payload.carNumber,
              payload.teamName || payload.team || '',
              { releasedBeneficiaries: releasedList }
            );
            const message = releasedList.length === 1
              ? `Released ${releasedList[0]} from vehicle ${this.currentCarData.carNumber}.`
              : `Released ${releasedList.length} beneficiaries from vehicle ${this.currentCarData.carNumber}.`;
            this.showSuccessMessage(message);
            if (Array.isArray(result.missingUsers) && result.missingUsers.length) {
              alert(`The following beneficiaries were skipped because they were not assigned: ${result.missingUsers.join(', ')}`);
            }

            if (result.partial === false) {
              if (this.originalCarInput) {
                this.originalCarInput.value = '';
                try { delete this.originalCarInput.dataset.responsibleBeneficiary; } catch(_){ }
              }
              this.closeModal();
            } else {
              this.resetUserReleaseSelection();
              this.hideReleaseForm();
            }
          } else {
            throw new Error((result && result.error) || 'Unknown error occurred');
          }
        } catch (error) {
          this.showErrorMessage(`User release failed: ${error.message}`);
        } finally {
          if (confirmBtn) {
            confirmBtn.classList.remove('loading');
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
          }
        }
      }

      async submitUserRelease(releaseData) {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .releaseCarUser(releaseData);
        });
      }

      removeUserFromCurrentData(user) {
        if (!this.currentCarData) return;
        const normalized = String(user || '').trim().toLowerCase();
        if (!normalized) return;

        const filterNames = (list) => Array.isArray(list)
          ? list.filter(name => String(name || '').trim().toLowerCase() !== normalized)
          : list;

        this.currentCarData.lastUsers = filterNames(this.currentCarData.lastUsers);
        this.currentCarData.otherTeamMembers = filterNames(this.currentCarData.otherTeamMembers);

        if (this.currentCarData.responsibleBeneficiary && this.currentCarData.responsibleBeneficiary.trim().toLowerCase() === normalized) {
          const fallback = (this.currentCarData.otherTeamMembers || []).find(name => name && name.trim());
          this.currentCarData.responsibleBeneficiary = fallback || '';
          if (fallback) {
            const fallbackKey = fallback.trim().toLowerCase();
            this.currentCarData.otherTeamMembers = this.currentCarData.otherTeamMembers.filter(name => String(name || '').trim().toLowerCase() !== fallbackKey);
          }
        }
      }

      showSuccessMessage(message) {
        // You can implement a toast notification system here
        alert(message);
      }

      showErrorMessage(message) {
        // You can implement a toast notification system here
        alert(message);
      }

      showReleaseHistory() {
        const carNumber = this.currentCarData?.carNumber || this.currentCarData?.car_number || '';
        console.log('showReleaseHistory - carNumber:', carNumber);
        console.log('showReleaseHistory - currentCarData:', this.currentCarData);
        
        if (!carNumber) {
          alert('No car selected');
          return;
        }
        this.historyView = 'release';
        const prefetch = (typeof window !== 'undefined' && window.vehicleReleasePrefetch)
          ? window.vehicleReleasePrefetch
          : null;

        const showLoadingState = () => {
          const section = document.getElementById('carHistorySection');
          const content = document.getElementById('historyContent');
          if (!section || !content) return;
          section.style.display = 'block';
          section.querySelector('.section-header h3').textContent = 'RELEASE History';
          content.innerHTML = '<div style="padding:16px;color:#475569;">Loading release history...</div>';
        };

        const handleSuccess = (rows) => {
          console.log('RELEASE history data received:', rows);
          this.lastHistoryData.release = Array.isArray(rows) ? rows : null;
          if (this.historyView === 'release') {
            this.renderHistoryTable(rows, 'RELEASE History');
          }
        };

        const handleFailure = (error) => {
          console.error('Failed to load RELEASE history:', error);
          this.lastHistoryData.release = null;
          const message = error && error.message ? error.message : (error ? String(error) : 'Unknown error');
          if (this.historyView === 'release') {
            alert('Failed to load RELEASE history: ' + message);
          }
        };

        if (prefetch && typeof prefetch.requestReleaseHistory === 'function') {
          const cached = prefetch.getReleaseHistory(carNumber);
          if (Array.isArray(cached)) {
            handleSuccess(cached);
            return;
          }
          showLoadingState();
          prefetch.requestReleaseHistory(carNumber, {
            onSuccess: handleSuccess,
            onFailure: handleFailure
          });
          return;
        }

        showLoadingState();
        google.script.run
          .withSuccessHandler((data) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeReleaseHistory(carNumber, data); } catch(_){ /* ignore */ }
            handleSuccess(data);
          })
          .withFailureHandler((error) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeReleaseHistoryError(carNumber, error); } catch(_){ /* ignore */ }
            handleFailure(error);
          })
          .getReleaseHistoryForcedWorking(carNumber);
      }

      showInUseHistory() {
        const carNumber = this.currentCarData?.carNumber || this.currentCarData?.car_number || '';
        const teamName = this.currentCarData?.teamName || this.currentCarData?.team || '';
        console.log('showInUseHistory - carNumber:', carNumber, 'team:', teamName);
        console.log('showInUseHistory - currentCarData:', this.currentCarData);
        
        if (!carNumber) {
          alert('No car selected');
          return;
        }
        this.historyView = 'in-use';
        const prefetch = (typeof window !== 'undefined' && window.vehicleReleasePrefetch)
          ? window.vehicleReleasePrefetch
          : null;

        const showLoadingState = () => {
          const section = document.getElementById('carHistorySection');
          const content = document.getElementById('historyContent');
          if (!section || !content) return;
          section.style.display = 'block';
          section.querySelector('.section-header h3').textContent = 'IN USE History';
          content.innerHTML = '<div style="padding:16px;color:#475569;">Loading in-use history...</div>';
        };

        const handleSuccess = (data) => {
          console.log('IN USE history data received:', data);
          console.log('Data type:', typeof data);
          console.log('Is array?:', Array.isArray(data));
          console.log('Data content:', JSON.stringify(data));
          this.lastHistoryData.inUse = Array.isArray(data) ? data : null;
          if (this.historyView === 'in-use') {
            this.renderHistoryTable(data, 'IN USE History');
          }
        };

        const handleFailure = (error) => {
          console.error('Failed to load IN USE history:', error);
          this.lastHistoryData.inUse = null;
          const message = error && error.message ? error.message : (error ? String(error) : 'Unknown error');
          if (this.historyView === 'in-use') {
            alert('Failed to load IN USE history: ' + message);
          }
        };

        if (prefetch && typeof prefetch.requestInUseHistory === 'function') {
          const cached = prefetch.getInUseHistory(carNumber, teamName);
          if (Array.isArray(cached)) {
            handleSuccess(cached);
            return;
          }
          showLoadingState();
          prefetch.requestInUseHistory(carNumber, teamName, {
            onSuccess: handleSuccess,
            onFailure: handleFailure
          });
          return;
        }

        showLoadingState();
        google.script.run
          .withSuccessHandler((data) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeInUseHistory(carNumber, teamName, data); } catch(_){ /* ignore */ }
            handleSuccess(data);
          })
          .withFailureHandler((error) => {
            try { window.vehicleReleasePrefetch && window.vehicleReleasePrefetch.storeInUseHistoryError(carNumber, teamName, error); } catch(_){ /* ignore */ }
            handleFailure(error);
          })
          .getInUseHistoryForcedWorking(carNumber, teamName);
      }

      findColumnIndex(headers = [], matchers = []) {
        if (!Array.isArray(headers)) return -1;
        const lowered = headers.map(header => String(header || '').toLowerCase());
        for (const matcher of matchers) {
          const normalized = matcher.toLowerCase();
          const index = lowered.findIndex(header => header.includes(normalized));
          if (index !== -1) {
            return index;
          }
        }
        return -1;
      }

      parseDateValue(value) {
        if (value instanceof Date) {
          return value;
        }

        if (typeof value === 'number' && !Number.isNaN(value)) {
          const dateFromNumber = new Date(value);
          if (!Number.isNaN(dateFromNumber.getTime())) {
            return dateFromNumber;
          }
        }

        if (value === null || value === undefined) {
          return null;
        }

        const strValue = String(value).trim();
        if (!strValue) {
          return null;
        }

        const parsed = new Date(strValue);
        if (!Number.isNaN(parsed.getTime())) {
          return parsed;
        }

        const dateMatch = strValue.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
        if (dateMatch) {
          let [ , part1, part2, part3 ] = dateMatch;
          let day;
          let month;
          const first = parseInt(part1, 10);
          const second = parseInt(part2, 10);
          const year = parseInt(part3.length === 2 ? `20${part3}` : part3, 10);

          if (first > 12 && second <= 12) {
            day = first;
            month = second;
          } else if (second > 12 && first <= 12) {
            month = first;
            day = second;
          } else {
            day = first;
            month = second;
          }

          const normalizedDate = new Date(year, month - 1, day);
          if (!Number.isNaN(normalizedDate.getTime())) {
            return normalizedDate;
          }
        }

        return null;
      }

      formatDateForDisplay(value) {
        const parsed = this.parseDateValue(value);
        if (!parsed) {
          return value ? String(value) : '';
        }

        const day = String(parsed.getDate()).padStart(2, '0');
        const month = String(parsed.getMonth() + 1).padStart(2, '0');
        const year = parsed.getFullYear();
        return `${day}-${month}-${year}`;
      }

      calculateDaysInUse(rows, dateColumnIndex) {
        if (!Array.isArray(rows) || rows.length < 2 || dateColumnIndex < 0) {
          return null;
        }

        let earliestDate = null;
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!Array.isArray(row)) continue;
          const rawValue = row[dateColumnIndex];
          const parsed = this.parseDateValue(rawValue);
          if (!parsed) continue;
          if (!earliestDate || parsed < earliestDate) {
            earliestDate = parsed;
          }
        }

        if (!earliestDate) {
          return null;
        }

        const startOfUse = new Date(earliestDate.getFullYear(), earliestDate.getMonth(), earliestDate.getDate());
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const diffMs = today.getTime() - startOfUse.getTime();
        if (diffMs < 0) {
          return 0;
        }

        const dayMs = 24 * 60 * 60 * 1000;
        const diffDays = Math.floor(diffMs / dayMs) + 1;
        return diffDays;
      }

      renderHistoryTable(rows, title) {
        console.log('renderHistoryTable called with:', { rows, title });
        console.log('Rows type:', typeof rows);
        console.log('Rows value:', rows);
        console.log('Is rows an array?:', Array.isArray(rows));
        
        if (!Array.isArray(rows)) {
          console.error('rows is not an array:', rows);
          console.error('Actual type received:', typeof rows);
          console.error('Actual value received:', JSON.stringify(rows));
          alert(`Invalid history data received. Expected array, got ${typeof rows}: ${JSON.stringify(rows)}`);
          return;
        }

        if (title === 'IN USE History') {
          this.lastHistoryData.inUse = rows;
        } else if (title === 'RELEASE History') {
          this.lastHistoryData.release = rows;
        }
        
        if (rows.length === 0) {
          console.log('Empty array received');
          alert(`No ${title.toLowerCase()} found for this vehicle.`);
          return;
        }
        
        // Check if this is an error message (single row with error text)
        if (rows.length === 1 && rows[0].length === 1) {
          const errorMessage = String(rows[0][0]);
          console.log('Error message received:', errorMessage);
          
          // Show error/info message in the history section
          const section = document.getElementById('carHistorySection');
          section.style.display = 'block';
          section.querySelector('.section-header h3').textContent = title;
          document.getElementById('historyContent').innerHTML = `
            <div style="padding: 20px; text-align: center; color: #666; font-style: italic;">
              ${this.escapeHtml(errorMessage)}
            </div>
          `;
          return;
        }
        
        // Handle normal data with header + data rows
        if (rows.length < 2) {
          console.log('Insufficient data - rows length:', rows.length);
          alert(`No ${title.toLowerCase()} data found for this vehicle.`);
          return;
        }
        
        // Build HTML table from rows
        let html = '';

        const processedRows = rows.map(row => Array.isArray(row) ? [...row] : row);
        let inUseDateColumnIndex = -1;
        let daysColumnIndex = -1;
        let primaryDaysDisplay = '';

        if (title === 'IN USE History') {
          const headerRow = Array.isArray(rows[0]) ? rows[0] : [];
          inUseDateColumnIndex = this.findColumnIndex(headerRow, [
            'Date and time of entry',
            'Date of entry',
            'Date'
          ]);
          daysColumnIndex = this.findColumnIndex(headerRow, ['Days in Use']);
          if (daysColumnIndex !== -1 && rows.length > 1) {
            primaryDaysDisplay = rows[1][daysColumnIndex] || '';
          }

          if (inUseDateColumnIndex !== -1) {
            for (let i = 1; i < processedRows.length; i++) {
              const row = processedRows[i];
              if (!Array.isArray(row)) continue;
              row[inUseDateColumnIndex] = this.formatDateForDisplay(row[inUseDateColumnIndex]);
            }
          }
        }

        // Add vehicle details for IN USE History
        if (title === 'IN USE History' && this.currentCarData) {
          const makeModel = `${this.currentCarData.make || ''} ${this.currentCarData.model || ''}`.trim();
          let daysLabel = 'N/A';
          if (primaryDaysDisplay) {
            const numericValue = parseInt(String(primaryDaysDisplay).replace(/[^0-9]/g, ''), 10);
            if (Number.isFinite(numericValue) && numericValue > 0) {
              daysLabel = `${numericValue} day${numericValue === 1 ? '' : 's'}`;
            } else {
              daysLabel = String(primaryDaysDisplay).trim();
            }
          }

          const detailItems = [
            `Vehicle: ${this.currentCarData.carNumber || 'N/A'}`,
            `Make & Model: ${makeModel || 'N/A'}`,
            `Category: ${this.currentCarData.category || 'N/A'}`,
            `Usage Type: ${this.currentCarData.usageType || 'N/A'}`,
            `Owner: ${this.currentCarData.owner || 'N/A'}`,
            `Days in Use: ${daysLabel}`
          ];

          const detailText = detailItems
            .map(item => this.escapeHtml(item))
            .join(' <span style="opacity:0.45;">&bull;</span> ');

          html += `
            <div style="background-color:#f8f9fa;padding:10px 12px;margin-bottom:12px;border-radius:6px;border-left:3px solid #0ea5e9;font-size:12px;color:#334155;display:flex;flex-wrap:wrap;gap:10px;">
              ${detailText}
            </div>
          `;
        }

        // Filter out vehicle detail columns for IN USE History to avoid duplication
        let filteredRows = processedRows;
        if (title === 'IN USE History' && processedRows.length > 0) {
          const columnsToRemove = ['Vehicle Number', 'Make', 'Model', 'Category', 'Usage Type', 'Owner'];
          const headerRow = processedRows[0];
          const columnsToKeep = [];

          headerRow.forEach((header, index) => {
            if (!columnsToRemove.includes(header)) {
              columnsToKeep.push(index);
            }
          });

          filteredRows = processedRows.map(row => {
            return Array.isArray(row) ? columnsToKeep.map(index => row[index]) : row;
          });
        }

        html += `<table style="width:100%;border-collapse:collapse;font-size:13px;line-height:1.45;">`;
        const headerCells = filteredRows[0].map(h => `<th style="border:1px solid #d0d7de;padding:6px 8px;background:#f8fafc;text-align:left;color:#0f172a;font-size:13px;font-weight:600;">${this.escapeHtml(String(h))}</th>`);
        html += `<tr>${headerCells.join('')}</tr>`;

        const headerRowNormalized = Array.isArray(filteredRows[0])
          ? filteredRows[0].map(header => String(header || '').toLowerCase())
          : [];
        const statusColumnIndex = headerRowNormalized.findIndex(header => header.includes('status'));
        const ratingColumnIndex = headerRowNormalized.findIndex(header => header.includes('rating'));

        for (let i = 1; i < filteredRows.length; i++) {
          const row = filteredRows[i];
          if (!Array.isArray(row)) continue;

          const rowHtml = row.map((cell, cellIndex) => {
            const rawText = cell === null || cell === undefined ? '' : String(cell);
            let cellContent = this.escapeHtml(rawText);

            if (
              cellIndex === statusColumnIndex &&
              rawText.trim().toUpperCase() === 'IN USE'
            ) {
              cellContent = `<span class="status-pill status-pill--in-use">${cellContent}</span>`;
            }

            if (cellIndex === ratingColumnIndex) {
              cellContent = this.renderRatingStars(rawText);
            }

            return `<td style="border:1px solid #e2e8f0;padding:6px 8px;color:#1e293b;">${cellContent}</td>`;
          }).join('');

          html += `<tr>${rowHtml}</tr>`;
        }
        html += '</table>';
        
        // Show in modal (replace carHistorySection content)
        const section = document.getElementById('carHistorySection');
        section.style.display = 'block';
        section.querySelector('.section-header h3').textContent = title;
        document.getElementById('historyContent').innerHTML = html;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      renderRatingStars(value) {
        const normalizedValue = String(value || '').replace(',', '.');
        const numeric = Number(normalizedValue.replace(/[^0-9.]/g, ''));
        if (!isFinite(numeric) || numeric <= 0) {
          const fallback = String(value || '').trim();
          return fallback ? this.escapeHtml(fallback) : '';
        }
        const clamped = Math.max(0, Math.min(5, numeric));
        const rounded = Math.round(clamped * 10) / 10;
        const fullStars = Math.floor(clamped);
        const hasPartial = (clamped - fullStars) >= 0.5 ? 1 : 0;
        let starsHtml = '';
        for (let i = 0; i < 5; i++) {
          const filled = i < fullStars || (hasPartial && i === fullStars);
          starsHtml += `<span class="star${filled ? ' filled' : ''}">★</span>`;
        }
        return `<span class="stars-display stars-display--compact" title="${this.escapeHtml(rounded.toFixed(1))}">${starsHtml}</span>`;
      }
    }

    // Initialize the system
    const carReleaseSystem = new CarReleaseSystem();
    
    // Expose global functions for backward compatibility
    window.openCarModal = (data, options) => carReleaseSystem.openModal(data, options);
    window.closeCarModal = () => carReleaseSystem.closeModal();
  window.applyCarModalSupplementalData = (data) => carReleaseSystem.applySupplementalCarData(data);
    
    // Legacy support for historical modal (redirect to main modal)
    window.openHistoricalModal = (carData, historicalData) => {
      const combinedData = { ...carData, history: historicalData };
      carReleaseSystem.openModal(combinedData);
      // Auto-show history section
      setTimeout(() => carReleaseSystem.toggleHistorySection(), 100);
    };
    window.closeHistoricalModal = () => carReleaseSystem.closeModal();
    
    // Car assignment modal removed; only car release modal remains
    
    // Note: Car number input click handlers are managed by _Table.html to avoid conflicts
    
    // Initialize vehicle popup functionality
    console.log('Setting up car number input click handlers');
    
    // Check for car-number-input elements after DOM is ready
    setTimeout(() => {
      const carInputs = document.querySelectorAll('.car-number-input');
      console.log('Found car-number-input elements:', carInputs.length);
      carInputs.forEach((input, index) => {
        console.log(`Car input ${index + 1}:`, input.value || '(empty)');
      });
      console.log('Vehicle popups functionality loaded successfully');
    }, 1000);
  </script>
