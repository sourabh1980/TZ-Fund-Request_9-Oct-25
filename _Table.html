<!-- _Table.html — row pills switched to Hologlow skin (with Remarks column) -->

<!-- Team legend (sticky, outside the scrollable table) -->
<div class="team-legend" id="teamLegend" role="group" aria-label="Teams"></div>
<section class="table-wrap">
  <div class="thead">
    <div class="th red">Name of Beneficiary</div>
    <div class="th red">Account Holder Name</div>
    <div class="th red">Row Total</div>
    <div class="th red">Designation</div>

    <div class="th fuel">Fuel D & Amt</div>

  <div class="th da" onclick="openBulkEntryModal('da')">DA D & Amt</div>

    <div class="th car">Vehicle Rent D & Amt</div>

    <div class="th air">Airtime D & Amt</div>

    <div class="th transport">Transport D & Amt</div>

    <div class="th misc">Misc D & Amt</div>

    <div class="th red">Mob No</div>
    <div class="th red">Display Name</div>
    <div class="th red">W/H Charge</div>
    <div class="th red">Remarks</div>
  </div>

  <!-- Body placeholder; GAS can render rows here -->
  <div class="tbody" id="tbody">
    <div class="row-data" data-team="Team Alpha" data-project="Project Atlas">
      <div class="cells">
        <div class="cell"><input class="txt" placeholder="Beneficiary" readonly style="cursor: default; background-color: #f8f9fa;" /></div>
        <div class="cell account-holder-cell">
          <input class="txt account-holder-input" placeholder="Account Holder" />
          <input class="txt car-number-input" placeholder="Vehicle Number" readonly style="cursor: pointer; background-color: #f8f9fa;" />
        </div>
        <div class="cell"><input class="amt" value="0.00" readonly /></div>
        <div class="cell"><input class="txt" placeholder="Designation" /></div>

        <!-- Split calendar pill design with combined date and amount -->
        <div class="cell">
          <div class="split-calendar-container" data-cal="fuel">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="fuel" />
            </div>
          </div>
        </div>

        <div class="cell">
          <div class="split-calendar-container" data-cal="da">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="da" tabindex="0" role="button" aria-label="DA from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="da" tabindex="0" role="button" aria-label="DA to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="da" />
            </div>
          </div>
        </div>

        <div class="cell">
          <div class="split-calendar-container" data-cal="car">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="car" />
            </div>
          </div>
        </div>

        <div class="cell">
          <div class="split-calendar-container" data-cal="air">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="air" />
            </div>
          </div>
        </div>

        <div class="cell">
          <div class="split-calendar-container" data-cal="transport">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="transport" />
            </div>
          </div>
        </div>

        <div class="cell">
          <div class="split-calendar-container" data-cal="misc">
            <div class="calendar-pills-row">
              <div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc from date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
              <div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc to date">
                <div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div>
              </div>
            </div>
            <div class="amount-input-row">
              <input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="misc" />
            </div>
          </div>
        </div>


        <div class="cell"><input class="txt" placeholder="0XXXXXXXXX" /></div>
        <div class="cell"><input class="txt" placeholder="Display Name" /></div>
        <div class="cell"><input class="amt" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="wh" /></div>
        <div class="cell"><input class="txt" placeholder="Remarks" /></div>
      </div>
    </div>
    
    <!-- Additional test rows to demonstrate team colors -->
    <div class="row-data" data-team="Team Beta" data-project="Project Beacon">
      <div class="cells">
        <div class="cell"><input class="txt" placeholder="Beneficiary" readonly style="cursor: default; background-color: #f8f9fa;" /></div>
        <div class="cell account-holder-cell">
          <input class="txt account-holder-input" placeholder="Account Holder" />
          <input class="txt car-number-input" placeholder="Vehicle Number" readonly style="cursor: pointer; background-color: #f8f9fa;" />
        </div>
        <div class="cell"><input class="amt" value="0.00" readonly /></div>
        <div class="cell"><input class="txt" placeholder="Designation" /></div>
        <div class="cell"><div class="split-calendar-container" data-cal="fuel"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="fuel" /></div></div></div>
  <div class="cell"><div class="split-calendar-container" data-cal="da"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="da" tabindex="0" role="button" aria-label="DA from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="da" tabindex="0" role="button" aria-label="DA to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="da" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="car"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="car" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="air"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="air" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="transport"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="transport" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="misc"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="misc" /></div></div></div>
        <div class="cell"><input class="txt" placeholder="0XXXXXXXXX" /></div>
        <div class="cell"><input class="txt" placeholder="Display Name" /></div>
        <div class="cell"><input class="amt" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="wh" /></div>
        <div class="cell"><input class="txt" placeholder="Remarks" /></div>
      </div>
    </div>
    
    <div class="row-data" data-team="Team Gamma" data-project="Project Aurora">
      <div class="cells">
        <div class="cell"><input class="txt" placeholder="Beneficiary" readonly style="cursor: default; background-color: #f8f9fa;" /></div>
        <div class="cell account-holder-cell">
          <input class="txt account-holder-input" placeholder="Account Holder" />
          <input class="txt car-number-input" placeholder="Vehicle Number" readonly style="cursor: pointer; background-color: #f8f9fa;" />
        </div>
        <div class="cell"><input class="amt" value="0.00" readonly /></div>
        <div class="cell"><input class="txt" placeholder="Designation" /></div>
        <div class="cell"><div class="split-calendar-container" data-cal="fuel"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="fuel" /></div></div></div>
  <div class="cell"><div class="split-calendar-container" data-cal="erda"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="erda" tabindex="0" role="button" aria-label="DA from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="erda" tabindex="0" role="button" aria-label="DA to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="erda" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="car"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="car" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="air"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="air" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="transport"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="transport" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="misc"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="misc" /></div></div></div>
        <div class="cell"><input class="txt" placeholder="0XXXXXXXXX" /></div>
        <div class="cell"><input class="txt" placeholder="Display Name" /></div>
        <div class="cell"><input class="amt" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="wh" /></div>
        <div class="cell"><input class="txt" placeholder="Remarks" /></div>
      </div>
    </div>
    
    <!-- Test row with beneficiary name but empty car number -->
    <div class="row-data" data-team="Team Beta" data-project="Project Beacon">
      <div class="cells">
        <div class="cell"><input class="txt" placeholder="Beneficiary" readonly style="cursor: default; background-color: #f8f9fa;" /></div>
        <div class="cell account-holder-cell">
          <input class="txt account-holder-input" placeholder="Account Holder" />
          <input class="txt car-number-input" placeholder="Vehicle Number" readonly style="cursor: pointer; background-color: #f8f9fa;" />
        </div>
        <div class="cell"><input class="amt" value="0.00" readonly /></div>
        <div class="cell"><input class="txt" placeholder="Designation" /></div>
        <div class="cell"><div class="split-calendar-container" data-cal="fuel"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="fuel" tabindex="0" role="button" aria-label="Fuel to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="fuel" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="erda"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="erda" tabindex="0" role="button" aria-label="ER DA from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="erda" tabindex="0" role="button" aria-label="ER DA to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="erda" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="car"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="car" tabindex="0" role="button" aria-label="Vehicle rent to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="car" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="air"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="air" tabindex="0" role="button" aria-label="Airtime to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="air" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="transport"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="transport" tabindex="0" role="button" aria-label="Transport to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="transport" /></div></div></div>
        <div class="cell"><div class="split-calendar-container" data-cal="misc"><div class="calendar-pills-row"><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc from date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div><div class="splitflap splitflap--row splitflap--holo" data-cal="misc" tabindex="0" role="button" aria-label="Misc to date"><div class="line"><span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span></div></div></div><div class="amount-input-row"><input class="amt amount-input" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="misc" /></div></div></div>
        <div class="cell"><input class="txt" placeholder="0XXXXXXXXX" /></div>
        <div class="cell"><input class="txt" placeholder="Display Name" /></div>
        <div class="cell"><input class="amt" placeholder="0.00" autocomplete="off" inputmode="decimal" data-field="wh" /></div>
        <div class="cell"><input class="txt" placeholder="Remarks" /></div>
      </div>
    </div>
  </div>
</section>

<!-- Right-aligned actions: colorful arrows + small buttons -->
<div class="table-actions" aria-label="Table controls">
  <div class="scroll-nav">
    <button id="scrollLeft" class="scroll-btn" type="button" title="Scroll left">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="gradL" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ff6ad5"/>
            <stop offset="100%" stop-color="#22d3ee"/>
          </linearGradient>
        </defs>
        <path d="M15 6l-6 6 6 6" fill="none" stroke="url(#gradL)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button id="scrollRight" class="scroll-btn" type="button" title="Scroll right">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="gradR" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#22d3ee"/>
            <stop offset="100%" stop-color="#8b5cf6"/>
          </linearGradient>
        </defs>
        <path d="M9 6l6 6-6 6" fill="none" stroke="url(#gradR)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div class="act-buttons">
    <button id="btnAddRow" class="pill-btn ghost" type="button">Add Rows</button>
    <button id="btnSubmit" class="pill-btn primary" type="button">Submit</button>
  </div>
</div>

<div class="new-beneficiary-overlay" id="newBeneficiaryModal" role="dialog" aria-modal="true" aria-labelledby="newBeneficiaryTitle" hidden>
  <div class="new-beneficiary-card">
    <button type="button" class="new-beneficiary-close" id="newBeneficiaryClose" aria-label="Close add new beneficiary dialog">×</button>
    <div class="new-beneficiary-header">
      <h3 class="new-beneficiary-title" id="newBeneficiaryTitle">Add New Beneficiary</h3>
      <p class="new-beneficiary-subtitle" id="newBeneficiarySubtitle">Provide details to create a released beneficiary record.</p>
    </div>
    <form class="new-beneficiary-form" id="newBeneficiaryForm" novalidate>
      <div class="new-beneficiary-scroll">
        <div class="new-beneficiary-grid">
          <div class="new-beneficiary-field" data-field="name">
            <label for="newBeneficiaryName">Name of Beneficiary</label>
            <input id="newBeneficiaryName" class="new-beneficiary-input" type="text" autocomplete="off" placeholder="Enter name" list="newBeneficiaryNameList" />
            <datalist id="newBeneficiaryNameList"></datalist>
            <div class="new-beneficiary-field-error" data-error-for="name"></div>
          </div>
          <div class="new-beneficiary-field" data-field="designation">
            <label for="newBeneficiaryDesignation">Resource Designation</label>
            <select id="newBeneficiaryDesignation" class="new-beneficiary-select"></select>
            <div class="new-beneficiary-field-error" data-error-for="designation"></div>
          </div>
          <div class="new-beneficiary-field" data-field="defaultDa">
            <label for="newBeneficiaryDa">Default DA Amt</label>
            <input id="newBeneficiaryDa" class="new-beneficiary-input" type="number" step="0.01" min="0" placeholder="Enter amount" />
            <div class="new-beneficiary-field-error" data-error-for="defaultDa"></div>
          </div>
          <div class="new-beneficiary-field" data-field="project">
            <label for="newBeneficiaryProject">Project</label>
            <select id="newBeneficiaryProject" class="new-beneficiary-select"></select>
            <div class="new-beneficiary-field-error" data-error-for="project"></div>
          </div>
          <div class="new-beneficiary-field" data-field="team">
            <label for="newBeneficiaryTeam">Team</label>
            <select id="newBeneficiaryTeam" class="new-beneficiary-select" disabled></select>
            <div class="new-beneficiary-field-error" data-error-for="team"></div>
          </div>
          <div class="new-beneficiary-field" data-field="accountHolder">
            <label for="newBeneficiaryAccount">Account Holder Name</label>
            <select id="newBeneficiaryAccount" class="new-beneficiary-select"></select>
            <div class="new-beneficiary-field-error" data-error-for="accountHolder"></div>
          </div>
          <div class="new-beneficiary-field" data-field="nationality">
            <label for="newBeneficiaryNationality">Nationality</label>
            <select id="newBeneficiaryNationality" class="new-beneficiary-select"></select>
            <div class="new-beneficiary-field-error" data-error-for="nationality"></div>
          </div>
        </div>
      </div>
      <div class="new-beneficiary-footer">
        <div class="new-beneficiary-status" id="newBeneficiaryStatus" aria-live="polite"></div>
        <div class="new-beneficiary-actions">
          <button type="button" class="new-beneficiary-btn secondary" id="newBeneficiaryCancel">Cancel</button>
          <button type="submit" class="new-beneficiary-btn primary" id="newBeneficiarySubmit">Ok</button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .new-beneficiary-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px 24px;
    background: rgba(15, 23, 42, 0.58);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 11000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.24s ease;
  }

  .new-beneficiary-overlay[hidden] {
    display: none;
  }

  .new-beneficiary-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  .new-beneficiary-card {
    width: min(940px, 98vw);
    max-height: min(90vh, 720px);
    background: rgba(255, 255, 255, 0.96);
    border-radius: 20px;
    box-shadow: 0 24px 64px rgba(15, 23, 42, 0.28);
    border: 1px solid rgba(148, 163, 184, 0.28);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    transform: translateY(24px) scale(0.97);
    transition: transform 0.28s ease, opacity 0.28s ease;
  }

  .new-beneficiary-overlay.show .new-beneficiary-card {
    transform: translateY(0) scale(1);
  }

  .new-beneficiary-close {
    position: absolute;
    top: 18px;
    right: 18px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: rgba(15, 23, 42, 0.08);
    color: #1f2937;
    font-size: 22px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .new-beneficiary-close:hover {
    background: rgba(79, 70, 229, 0.12);
    color: #4338ca;
  }

  .new-beneficiary-close:focus-visible {
    outline: 3px solid rgba(79, 70, 229, 0.35);
    outline-offset: 2px;
  }

  .new-beneficiary-header {
    padding: 32px 40px 0;
  }

  .new-beneficiary-title {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
    color: #1f2937;
  }

  .new-beneficiary-subtitle {
    margin: 10px 0 0;
    font-size: 15px;
    color: #475569;
  }

  .new-beneficiary-form {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    padding: 0 40px 36px;
    gap: 28px;
  }

  .new-beneficiary-scroll {
    flex: 1 1 auto;
    overflow-x: hidden;
    overflow-y: auto;
    padding-top: 24px;
  }

  .new-beneficiary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 24px 28px;
    align-items: flex-start;
  }

  @media (min-width: 1180px) {
    .new-beneficiary-grid {
      grid-template-columns: repeat(3, minmax(220px, 1fr));
    }
  }

  .new-beneficiary-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
  }

  .new-beneficiary-field label {
    font-size: 13px;
    font-weight: 600;
    color: #1f2937;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }

  .new-beneficiary-input,
  .new-beneficiary-select {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    background: rgba(248, 250, 252, 0.92);
    padding: 12px 14px;
    font-size: 15px;
    color: #0f172a;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    min-height: 44px;
    box-sizing: border-box;
  }

  .new-beneficiary-input:focus-visible,
  .new-beneficiary-select:focus-visible {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.24);
    background: #fff;
  }

  .new-beneficiary-select:disabled,
  .new-beneficiary-input:disabled {
    background: rgba(241, 245, 249, 0.9);
    cursor: not-allowed;
    color: #64748b;
  }

  .new-beneficiary-field-error {
    min-height: 18px;
    font-size: 12px;
    color: #dc2626;
    font-weight: 500;
  }

  .new-beneficiary-field.has-error .new-beneficiary-input,
  .new-beneficiary-field.has-error .new-beneficiary-select {
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.16);
    background: rgba(255, 247, 237, 0.9);
  }

  .new-beneficiary-footer {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .new-beneficiary-status {
    flex: 1 1 auto;
    min-height: 20px;
    font-size: 14px;
    color: #475569;
    font-weight: 500;
  }

  .new-beneficiary-status.error {
    color: #dc2626;
  }

  .new-beneficiary-status.success {
    color: #15803d;
  }

  .new-beneficiary-status.info {
    color: #2563eb;
  }

  .new-beneficiary-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-end;
  }

  .new-beneficiary-btn {
    border-radius: 999px;
    border: none;
    padding: 12px 26px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .new-beneficiary-btn.primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    box-shadow: 0 14px 32px rgba(99, 102, 241, 0.28);
  }

  .new-beneficiary-btn.primary:hover {
    transform: translateY(-1px);
  }

  .new-beneficiary-btn.secondary {
    background: rgba(226, 232, 240, 0.85);
    color: #0f172a;
  }

  .new-beneficiary-btn.secondary:hover {
    background: rgba(203, 213, 225, 0.95);
  }

  .new-beneficiary-btn[disabled] {
    opacity: 0.6;
    cursor: wait;
    transform: none;
    box-shadow: none;
  }

  .new-beneficiary-overlay.new-beneficiary-loading .new-beneficiary-status {
    color: #2563eb;
  }

  @media (max-width: 720px) {
    .new-beneficiary-card {
      width: min(100%, 96vw);
      padding-top: 40px;
    }

    .new-beneficiary-header {
      padding: 24px 24px 0;
    }

    .new-beneficiary-form {
      padding: 0 24px 28px;
    }

    .new-beneficiary-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
    }

    .new-beneficiary-footer {
      flex-direction: column;
      align-items: flex-start;
    }

    .new-beneficiary-actions {
      width: 100%;
      justify-content: flex-end;
    }
  }
</style>
<script>
(function(){
  'use strict';

  const overlay = document.getElementById('newBeneficiaryModal');
  if (!overlay) return;

  const form = overlay.querySelector('#newBeneficiaryForm');
  const closeBtn = overlay.querySelector('#newBeneficiaryClose');
  const cancelBtn = overlay.querySelector('#newBeneficiaryCancel');
  const submitBtn = overlay.querySelector('#newBeneficiarySubmit');
  const statusEl = overlay.querySelector('#newBeneficiaryStatus');

  const nameInput = overlay.querySelector('#newBeneficiaryName');
  const nameDatalist = overlay.querySelector('#newBeneficiaryNameList');
  const designationSelect = overlay.querySelector('#newBeneficiaryDesignation');
  const defaultDaInput = overlay.querySelector('#newBeneficiaryDa');
  const projectSelect = overlay.querySelector('#newBeneficiaryProject');
  const teamSelect = overlay.querySelector('#newBeneficiaryTeam');
  const accountSelect = overlay.querySelector('#newBeneficiaryAccount');
  const nationalitySelect = overlay.querySelector('#newBeneficiaryNationality');

  const DUPLICATE_NAME_MESSAGE = 'Duplicate beneficiary name detected.';
  const knownBeneficiaryNames = new Set();
  let hasNameDuplicate = false;

  const fieldState = {};
  overlay.querySelectorAll('.new-beneficiary-field').forEach(function(field) {
    const key = field.getAttribute('data-field');
    if (!key) return;
    fieldState[key] = {
      container: field,
      messageEl: field.querySelector('.new-beneficiary-field-error')
    };
  });

  function normalizeBeneficiaryName(value) {
    return value == null ? '' : String(value).trim().toLowerCase();
  }

  function isExistingBeneficiaryName(value) {
    const normalized = normalizeBeneficiaryName(value);
    if (!normalized) return false;
    return knownBeneficiaryNames.has(normalized);
  }

  function showNameDuplicateWarning(message) {
    const state = fieldState.name;
    if (!state || !state.container) return;
    if (message) {
      if (state.container.dataset) {
        state.container.dataset.errorType = 'duplicate';
      }
      state.container.classList.add('has-error');
      if (state.messageEl) state.messageEl.textContent = message;
    } else if (state.container.dataset && state.container.dataset.errorType === 'duplicate') {
      state.container.classList.remove('has-error');
      if (state.messageEl) state.messageEl.textContent = '';
      delete state.container.dataset.errorType;
    }
  }

  function evaluateNameDuplicate() {
    if (!nameInput) {
      hasNameDuplicate = false;
      return false;
    }
    const duplicate = isExistingBeneficiaryName(nameInput.value);
    hasNameDuplicate = duplicate;
    if (duplicate) {
      showNameDuplicateWarning(DUPLICATE_NAME_MESSAGE);
    } else {
      showNameDuplicateWarning('');
    }
    updateFormDisabledState();
    return duplicate;
  }

  let optionsCache = null;
  let optionsPromise = null;
  let teamsByProject = {};
  let pendingTeamValue = null;
  let optionsReady = false;
  let loadingOptions = false;
  let submitting = false;
  let teamEnabled = false;
  let isOpen = false;
  let lastActiveElement = null;
  let openContext = {};
  const submitOriginalText = submitBtn ? submitBtn.textContent : '';
  const PLACEHOLDER_VALUE = '__placeholder__';

  function setStatus(message, tone) {
    if (!statusEl) return;
    const text = message || '';
    statusEl.textContent = text;
    statusEl.classList.remove('error', 'success', 'info');
    if (text) {
      statusEl.classList.add(tone || 'info');
    }
  }

  function clearFieldErrors() {
    Object.keys(fieldState).forEach(function(key) {
      const state = fieldState[key];
      if (!state) return;
      state.container.classList.remove('has-error');
      if (state.messageEl) state.messageEl.textContent = '';
      if (state.container && state.container.dataset) {
        delete state.container.dataset.errorType;
      }
    });
  }

  function showFieldError(field, message) {
    const state = fieldState[field];
    if (!state) return;
    if (state.container && state.container.dataset) {
      state.container.dataset.errorType = 'validation';
    }
    state.container.classList.add('has-error');
    if (state.messageEl) state.messageEl.textContent = message || '';
  }

  function focusFirstError(errors) {
    if (!Array.isArray(errors)) return;
    for (let i = 0; i < errors.length; i++) {
      const state = fieldState[errors[i].field];
      if (!state || !state.container) continue;
      const el = state.container.querySelector('input, select, textarea, button');
      if (el && typeof el.focus === 'function') {
        el.focus();
        break;
      }
    }
  }

  function resetTeamSelect(message) {
    if (!teamSelect) return;
    teamSelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = PLACEHOLDER_VALUE;
    placeholder.textContent = message;
    placeholder.disabled = true;
    placeholder.selected = true;
    teamSelect.appendChild(placeholder);
    teamSelect.dataset.userSet = 'false';
    teamEnabled = false;
  }

  function updateFormDisabledState() {
    const disableInputs = loadingOptions || submitting || !optionsReady;
    [nameInput, designationSelect, defaultDaInput, projectSelect, accountSelect, nationalitySelect].forEach(function(el) {
      if (!el) return;
      el.disabled = disableInputs;
    });
    if (teamSelect) {
      teamSelect.disabled = disableInputs || !teamEnabled;
    }
    if (submitBtn) {
      const shouldDisable = disableInputs || submitting || hasNameDuplicate;
      submitBtn.disabled = shouldDisable;
      if (shouldDisable && hasNameDuplicate) {
        submitBtn.setAttribute('aria-disabled-reason', 'duplicate-name');
      } else {
        submitBtn.removeAttribute('aria-disabled-reason');
      }
    }
    if (cancelBtn) {
      cancelBtn.disabled = submitting;
    }
    if (closeBtn) {
      closeBtn.disabled = submitting;
    }
  }

  function setLoading(flag) {
    loadingOptions = flag;
    overlay.classList.toggle('new-beneficiary-loading', flag);
    if (flag) {
      resetTeamSelect('Loading options…');
    }
    updateFormDisabledState();
  }

  function setSubmitting(flag) {
    submitting = flag;
    overlay.classList.toggle('new-beneficiary-submitting', flag);
    if (submitBtn) {
      submitBtn.textContent = flag ? 'Saving…' : submitOriginalText;
    }
    updateFormDisabledState();
  }

  function setSelectValue(select, value) {
    if (!select) return false;
    const target = value == null ? '' : String(value);
    const len = select.options.length;
    for (let i = 0; i < len; i++) {
      const opt = select.options[i];
      if (opt.value === target) {
        select.selectedIndex = i;
        return true;
      }
    }
    const normalized = target.trim().toLowerCase();
    if (!normalized) return false;
    for (let i = 0; i < len; i++) {
      const opt = select.options[i];
      if (opt.value.trim().toLowerCase() === normalized) {
        select.selectedIndex = i;
        return true;
      }
    }
    return false;
  }

  function populateSelect(select, list, placeholderText) {
    if (!select) return;
    const previous = select.value;
    select.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = placeholderText;
    placeholder.disabled = true;
    placeholder.selected = true;
    select.appendChild(placeholder);
    if (Array.isArray(list)) {
      list.forEach(function(item) {
        const option = document.createElement('option');
        const val = item && item.value != null ? String(item.value) : '';
        option.value = val;
        option.textContent = item && item.label != null ? item.label : val;
        select.appendChild(option);
      });
    }
    if (previous && setSelectValue(select, previous)) {
      placeholder.selected = false;
    }
  }

  function populateNameSuggestions(list) {
    if (!nameDatalist) return;
    nameDatalist.innerHTML = '';
    if (!Array.isArray(list) || !list.length) {
      return;
    }
    const fragment = document.createDocumentFragment();
    const seen = new Set();
    list.forEach(function(name) {
      const value = name == null ? '' : String(name).trim();
      if (!value) return;
      if (seen.has(value.toLowerCase())) {
        // Allow duplicates to be entered manually while avoiding redundant options.
        return;
      }
      seen.add(value.toLowerCase());
      const option = document.createElement('option');
      option.value = value;
      fragment.appendChild(option);
    });
    nameDatalist.appendChild(fragment);
  }

  function updateTeamOptions(projectValue, preferTeam) {
    if (!teamSelect) return;
    const trimmed = (projectValue || '').toString().trim();
    teamSelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = PLACEHOLDER_VALUE;
    placeholder.textContent = trimmed ? 'Select team' : 'Select a project first';
    placeholder.disabled = true;
    placeholder.selected = true;
    teamSelect.appendChild(placeholder);
    teamSelect.dataset.userSet = 'false';

    if (!trimmed) {
      teamEnabled = false;
      updateFormDisabledState();
      return;
    }

    let list = (teamsByProject && (teamsByProject[projectValue] || teamsByProject[trimmed])) || null;
    if (!list && teamsByProject) {
      const lower = trimmed.toLowerCase();
      Object.keys(teamsByProject).some(function(key) {
        if (key && key.toLowerCase() === lower) {
          list = teamsByProject[key];
          return true;
        }
        return false;
      });
    }

    if (!Array.isArray(list) || list.length === 0) {
      placeholder.textContent = 'No teams found for project';
      placeholder.disabled = true;
      teamEnabled = false;
      updateFormDisabledState();
      return;
    }

    list.forEach(function(item) {
      const option = document.createElement('option');
      const val = item && item.value != null ? String(item.value) : '';
      option.value = val;
      option.textContent = item && item.label ? item.label : (val || 'Unassigned / Blank');
      if (item && item.blank) {
        option.dataset.blank = 'true';
      }
      teamSelect.appendChild(option);
    });

    teamEnabled = true;
    updateFormDisabledState();

    const desired = preferTeam != null ? preferTeam : pendingTeamValue;
    if (desired != null) {
      if (desired === '') {
        const blankOption = Array.from(teamSelect.options).find(function(opt) {
          return opt.value === '' && !opt.disabled;
        });
        if (blankOption) {
          blankOption.selected = true;
          placeholder.selected = false;
          teamSelect.dataset.userSet = 'true';
        }
      } else if (setSelectValue(teamSelect, desired)) {
        placeholder.selected = false;
        teamSelect.dataset.userSet = 'true';
      }
    }
    pendingTeamValue = null;
  }

  function ensureOptions() {
    if (optionsCache) {
      return Promise.resolve(optionsCache);
    }
    if (optionsPromise) {
      return optionsPromise;
    }
    if (!(window.google && google.script && google.script.run)) {
      return Promise.reject(new Error('Beneficiary options can only be loaded inside Google Sheets.'));
    }
    optionsPromise = new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(function(res) {
          optionsPromise = null;
          if (!res || res.ok === false) {
            reject(new Error(res && res.error ? res.error : 'Unable to load beneficiary options.'));
            return;
          }
          optionsCache = res;
          resolve(res);
        })
        .withFailureHandler(function(err) {
          optionsPromise = null;
          const message = err && err.message ? err.message : 'Unable to load beneficiary options.';
          reject(new Error(message));
        })
        .getNewBeneficiaryFormOptions();
    });
    return optionsPromise;
  }

  function applyOptions(opts) {
    if (!opts) return;
    teamsByProject = opts.teamsByProject || {};
    populateSelect(designationSelect, opts.designations || [], 'Select designation');
    populateSelect(accountSelect, opts.accountHolders || [], 'Select account holder');
    populateSelect(nationalitySelect, opts.nationalities || [], 'Select nationality');
    populateSelect(projectSelect, opts.projects || [], 'Select project');
    populateNameSuggestions(opts.beneficiaryNames || []);

    if (defaultDaInput) {
      const ctxDa = openContext && Object.prototype.hasOwnProperty.call(openContext, 'defaultDa') ? openContext.defaultDa : '';
      defaultDaInput.value = ctxDa == null ? '' : ctxDa;
    }

    pendingTeamValue = openContext && Object.prototype.hasOwnProperty.call(openContext, 'team') ? openContext.team : null;

    if (projectSelect) {
      const ctxProject = openContext && openContext.project ? openContext.project : '';
      if (ctxProject) {
        if (!setSelectValue(projectSelect, ctxProject)) {
          pendingTeamValue = null;
        }
      } else {
        projectSelect.selectedIndex = 0;
      }
    }

    updateTeamOptions(projectSelect ? projectSelect.value : '', pendingTeamValue);
    if (openContext && openContext.accountHolder) setSelectValue(accountSelect, openContext.accountHolder);
    if (openContext && openContext.nationality) setSelectValue(nationalitySelect, openContext.nationality);
    if (openContext && openContext.designation) setSelectValue(designationSelect, openContext.designation);
  }

  function collectValues() {
    return {
      name: nameInput ? nameInput.value.trim() : '',
      designation: designationSelect ? designationSelect.value : '',
      defaultDa: defaultDaInput ? defaultDaInput.value.trim() : '',
      project: projectSelect ? projectSelect.value : '',
      teamRaw: teamSelect ? teamSelect.value : PLACEHOLDER_VALUE,
      accountHolder: accountSelect ? accountSelect.value : '',
      nationality: nationalitySelect ? nationalitySelect.value : ''
    };
  }

  function validateForm() {
    const values = collectValues();
    const errors = [];
    const payload = {
      beneficiary: values.name,
      designation: values.designation,
      project: values.project,
      accountHolder: values.accountHolder,
      nationality: values.nationality,
      team: '',
      teamProvided: false
    };

    if (!payload.beneficiary) {
      errors.push({ field: 'name', message: 'Enter the beneficiary name.' });
    }
    if (!payload.designation) {
      errors.push({ field: 'designation', message: 'Select a resource designation.' });
    }
    if (!payload.project) {
      errors.push({ field: 'project', message: 'Select a project.' });
    }

    if (teamSelect) {
      if (!teamEnabled) {
        payload.team = '';
        payload.teamProvided = true;
      } else if (values.teamRaw !== PLACEHOLDER_VALUE) {
        payload.team = values.teamRaw == null ? '' : values.teamRaw;
        payload.teamProvided = true;
      } else {
        errors.push({ field: 'team', message: 'Select a team or choose the blank option.' });
      }
    }

    if (!payload.accountHolder) {
      errors.push({ field: 'accountHolder', message: 'Select an account holder name.' });
    }
    if (!payload.nationality) {
      errors.push({ field: 'nationality', message: 'Select a nationality.' });
    }

    if (isExistingBeneficiaryName(payload.beneficiary)) {
      errors.push({ field: 'name', message: DUPLICATE_NAME_MESSAGE, duplicate: true });
    }

    if (values.defaultDa !== '') {
      const numeric = Number(values.defaultDa);
      if (!Number.isFinite(numeric) || numeric < 0) {
        errors.push({ field: 'defaultDa', message: 'Enter a non-negative amount.' });
      } else {
        payload.defaultDa = numeric;
      }
    }

    return { errors: errors, payload: payload };
  }

  function buildConfirmation(payload) {
    const project = payload.project || '—';
    const team = payload.team ? payload.team : 'Unassigned / Blank';
    const designation = payload.designation || '—';
    const accountHolder = payload.accountHolder || '—';
    return [
      'Create and mark this beneficiary as RELEASE?',
      'Name: ' + payload.beneficiary,
      'Designation: ' + designation,
      'Project: ' + project,
      'Team: ' + team,
      'Account Holder: ' + accountHolder
    ].join('\n');
  }

  function focusFirstField() {
    if (!isOpen) return;
    if (nameInput && !nameInput.disabled) {
      nameInput.focus();
      nameInput.select && nameInput.select();
      return;
    }
    const focusable = overlay.querySelector('input:not([disabled]), select:not([disabled])');
    if (focusable && typeof focusable.focus === 'function') {
      focusable.focus();
    }
  }

  function openDialog(context) {
    if (isOpen && !submitting) {
      closeDialog();
    }
    openContext = context && typeof context === 'object' ? context : {};
    pendingTeamValue = openContext && Object.prototype.hasOwnProperty.call(openContext, 'team') ? openContext.team : null;
    knownBeneficiaryNames.clear();
    hasNameDuplicate = false;
    showNameDuplicateWarning('');

    lastActiveElement = document.activeElement;
    overlay.hidden = false;
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    isOpen = true;

    if (form) form.reset();
    clearFieldErrors();
    if (optionsCache) {
      setStatus('', '');
    } else {
      setStatus('Loading beneficiary options…', 'info');
    }

    if (defaultDaInput) {
      defaultDaInput.value = openContext && Object.prototype.hasOwnProperty.call(openContext, 'defaultDa')
        ? (openContext.defaultDa == null ? '' : openContext.defaultDa)
        : '';
    }

    optionsReady = false;
    setLoading(!optionsCache);
    updateFormDisabledState();

    if (optionsCache) {
      applyOptions(optionsCache);
      optionsReady = true;
      setLoading(false);
      updateFormDisabledState();
      setTimeout(focusFirstField, 80);
    }

    ensureOptions().then(function(opts) {
      if (!isOpen) return;
      applyOptions(opts);
      optionsReady = true;
      setLoading(false);
      setStatus('', '');
      updateFormDisabledState();
      setTimeout(focusFirstField, 60);
    }).catch(function(err) {
      if (!isOpen) return;
      setLoading(false);
      optionsReady = false;
      const message = err && err.message ? err.message : 'Failed to load beneficiary options. Close and try again.';
      setStatus(message, 'error');
      resetTeamSelect('Unable to load teams');
      updateFormDisabledState();
    });
  }

  function closeDialog() {
    if (!isOpen) return;
    if (submitting) return;
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
    overlay.classList.remove('new-beneficiary-loading', 'new-beneficiary-submitting');
    overlay.hidden = true;
    isOpen = false;
    loadingOptions = false;
    submitting = false;
    optionsReady = !!optionsCache;
    teamEnabled = false;
    pendingTeamValue = null;
    if (form) form.reset();
    clearFieldErrors();
    knownBeneficiaryNames.clear();
    hasNameDuplicate = false;
    showNameDuplicateWarning('');
    setStatus('', '');
    resetTeamSelect('Select a project first');
    if (submitBtn) {
      submitBtn.textContent = submitOriginalText;
      submitBtn.disabled = false;
    }
    if (cancelBtn) {
      cancelBtn.disabled = false;
    }
    if (closeBtn) {
      closeBtn.disabled = false;
    }
    updateFormDisabledState();
    if (lastActiveElement && typeof lastActiveElement.focus === 'function') {
      try { lastActiveElement.focus(); } catch (_focusErr) {}
    }
    lastActiveElement = null;
  }

  function handleSubmit(event) {
    event.preventDefault();
    if (submitting) return;
    clearFieldErrors();
    setStatus('', '');
    evaluateNameDuplicate();

    const result = validateForm();
    if (result.errors.length) {
      let hasDuplicateError = false;
      result.errors.forEach(function(err) {
        if (err && err.duplicate) {
          hasDuplicateError = true;
          showNameDuplicateWarning(err.message);
        } else {
          showFieldError(err.field, err.message);
        }
      });
      if (!hasDuplicateError) {
        showNameDuplicateWarning('');
      }
      setStatus('Please resolve the highlighted fields.', 'error');
      focusFirstError(result.errors);
      return;
    }

    const payload = result.payload;
    const message = buildConfirmation(payload);
    if (typeof window.confirm === 'function' && !window.confirm(message)) {
      return;
    }

    if (!(window.google && google.script && google.script.run)) {
      setStatus('Saving beneficiaries is only available inside Google Sheets.', 'error');
      return;
    }

    setSubmitting(true);
    setStatus('Saving new beneficiary…', 'info');

    google.script.run
      .withSuccessHandler(function(res) {
        if (!isOpen) {
          setSubmitting(false);
          return;
        }
        if (!res || res.ok === false) {
          setSubmitting(false);
          const errMsg = res && res.error ? res.error : 'Failed to create new beneficiary.';
          setStatus(errMsg, 'error');
          return;
        }
        setStatus('Beneficiary created successfully.', 'success');
        setSubmitting(false);
        const detail = res;
        optionsCache = null;
        optionsReady = false;
        teamsByProject = {};
        setTimeout(function() {
          closeDialog();
          try {
            document.dispatchEvent(new CustomEvent('frtz:new-beneficiary-created', { detail: detail }));
          } catch (_evtErr) {}
          if (window.FRTZ && typeof window.FRTZ.refreshReleasedBeneficiaryCount === 'function') {
            try {
              window.FRTZ.refreshReleasedBeneficiaryCount(detail.project, detail.team);
            } catch (refreshErr) {
              console.warn('refreshReleasedBeneficiaryCount failed', refreshErr);
            }
          }
        }, 600);
      })
      .withFailureHandler(function(err) {
        if (!isOpen) {
          setSubmitting(false);
          return;
        }
        setSubmitting(false);
        const message = err && err.message ? err.message : 'Failed to create new beneficiary.';
        setStatus(message, 'error');
      })
      .createNewReleasedBeneficiary(payload);
  }

  if (form) {
    form.addEventListener('submit', handleSubmit);
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      if (!submitting) closeDialog();
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      if (!submitting) closeDialog();
    });
  }

  if (nameInput) {
    nameInput.addEventListener('input', evaluateNameDuplicate);
    nameInput.addEventListener('blur', evaluateNameDuplicate);
  }

  overlay.addEventListener('click', function(event) {
    if (event.target === overlay && !submitting) {
      closeDialog();
    }
  });

  document.addEventListener('keydown', function(event) {
    if (!isOpen || submitting) return;
    if (event.key === 'Escape') {
      event.preventDefault();
      closeDialog();
    }
  });

  if (projectSelect) {
    projectSelect.addEventListener('change', function() {
      if (!isOpen) return;
      pendingTeamValue = null;
      updateTeamOptions(projectSelect.value, null);
    });
  }

  if (teamSelect) {
    teamSelect.addEventListener('change', function() {
      if (!isOpen) return;
      if (teamSelect.value !== PLACEHOLDER_VALUE) {
        teamSelect.dataset.userSet = 'true';
      }
    });
  }

  window.FRTZ = window.FRTZ || {};
  window.FRTZ.openNewBeneficiaryDialog = openDialog;
  window.FRTZ.closeNewBeneficiaryDialog = closeDialog;
  window.FRTZ.invalidateNewBeneficiaryOptions = function() {
    optionsCache = null;
    optionsReady = false;
  };

  document.addEventListener('frtz:add-new-beneficiary', function(event) {
    const context = event && event.detail ? event.detail : {};
    openDialog(context);
  });
})();
</script>

<script>
(function(){
  const tableWrap = document.querySelector('.table-wrap');
  const leftBtn = document.getElementById('scrollLeft');
  const rightBtn = document.getElementById('scrollRight');
  if(!tableWrap || !leftBtn || !rightBtn) return;

  function amount(){ return Math.round(tableWrap.clientWidth * 0.8); }

  function updateDisabled(){
    const maxScroll = tableWrap.scrollWidth - tableWrap.clientWidth - 1;
    leftBtn.disabled  = tableWrap.scrollLeft <= 0;
    rightBtn.disabled = tableWrap.scrollLeft >= maxScroll;
  }

  leftBtn.addEventListener('click', () => tableWrap.scrollBy({ left: -amount(), behavior: 'smooth' }));
  rightBtn.addEventListener('click', () => tableWrap.scrollBy({ left: amount(), behavior: 'smooth' }));

  tableWrap.addEventListener('scroll', updateDisabled, { passive: true });
  window.addEventListener('resize', updateDisabled);
  updateDisabled();

  // expose hooks for GAS to wire later
  window.FRTZ = window.FRTZ || {};
  window.FRTZ.addRowBtn = document.getElementById('btnAddRow');
  window.FRTZ.submitBtn = document.getElementById('btnSubmit');
})();
</script>





<!-- Mock Google Apps Script removed for GAS compliance -->



<!-- Bulk Entry Modal -->
<div id="bulkEntryModal" class="bulk-entry-modal" style="display: none;">
  <div class="bulk-entry-scrim" role="presentation"></div>
  <section class="bulk-entry-card" role="dialog" aria-labelledby="bulkEntryTitle" aria-modal="true">
    <header class="bulk-entry-hd">
      <span id="bulkEntryTitle">Bulk Entry</span>
      <button class="bulk-entry-x" aria-label="Close" onclick="closeBulkEntryModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </header>
    <div class="bulk-entry-bd">
      <div class="bulk-entry-label">Enter amount for all visible beneficiaries:</div>
      <div class="bulk-entry-field">
        <div class="bulk-entry-input-wrap">
              <input id="bulkAmount" type="text" placeholder="0.00" inputmode="decimal" autocomplete="off" />
            </div>
      </div>
      <div class="bulk-entry-actions">
        <button class="bulk-entry-cancel" onclick="closeBulkEntryModal()">Cancel</button>
        <button class="bulk-entry-confirm" onclick="confirmBulkEntry()">Apply to All</button>
      </div>
    </div>
  </section>
</div>

<script>
// Bulk Entry Modal Functionality
let currentBulkField = null;
let currentFieldColor = null;

// Field color mapping for gradients
const fieldColors = {
  da:  { color1: '#06b6d4', color2: '#3b82f6', color3: '#8b5cf6' },
  fuel: { color1: '#ff6ad5', color2: '#8b5cf6', color3: '#22d3ee' },
  car: { color1: '#22c55e', color2: '#06b6d4', color3: '#8b5cf6' },
  air: { color1: '#f59e0b', color2: '#ef4444', color3: '#ff6ad5' },
  transport: { color1: '#14b8a6', color2: '#06b6d4', color3: '#8b5cf6' },
  misc: { color1: '#8b5cf6', color2: '#6366f1', color3: '#22d3ee' }
};

// Field display names
const fieldNames = {
  fuel: 'Fuel',
  da: 'DA',
  car: 'Vehicle Rent',
  air: 'Airtime',
  transport: 'Transport',
  misc: 'Misc'
};

// Number formatting functions
function formatNumberWithCommas(value) {
  // Remove any existing commas and non-numeric characters except decimal point
  const cleanValue = value.replace(/[^\d.]/g, '');
  
  // Split by decimal point
  const parts = cleanValue.split('.');
  
  // Add commas to the integer part
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  
  // Rejoin with decimal point (limit to 2 decimal places)
  return parts.length > 1 ? parts[0] + '.' + parts[1].substring(0, 2) : parts[0];
}

function handleBulkAmountInput(event) {
  const input = event.target;
  const cursorPosition = input.selectionStart;
  const oldValue = input.value;
  const newValue = formatNumberWithCommas(oldValue);
  
  if (newValue !== oldValue) {
    input.value = newValue;
    
    // Adjust cursor position after formatting
    const diff = newValue.length - oldValue.length;
    const newCursorPosition = cursorPosition + diff;
    input.setSelectionRange(newCursorPosition, newCursorPosition);
  }
}

// Add click listeners to expense headers
document.addEventListener('DOMContentLoaded', function() {
  const expenseHeaders = document.querySelectorAll('.thead .th.fuel, .thead .th.da, .thead .th.car, .thead .th.air, .thead .th.transport, .thead .th.misc');
  
  expenseHeaders.forEach(header => {
    header.addEventListener('click', function() {
      const classList = Array.from(this.classList);
  const fieldClass = classList.find(cls => ['fuel', 'da', 'car', 'air', 'transport', 'misc'].includes(cls));
      
      if (fieldClass) {
        openBulkEntryModal(fieldClass);
      }
    });
  });
  
  // Add input formatting to bulk amount field
  const bulkAmountInput = document.getElementById('bulkAmount');
  if (bulkAmountInput) {
    bulkAmountInput.addEventListener('input', handleBulkAmountInput);
  }
});

function openBulkEntryModal(field) {
  currentBulkField = field;
  currentFieldColor = fieldColors[field];
  
  const modal = document.getElementById('bulkEntryModal');
  const title = document.getElementById('bulkEntryTitle');
  const input = document.getElementById('bulkAmount');
  
  // Set field-specific colors as CSS variables
  modal.style.setProperty('--field-color-1', currentFieldColor.color1);
  modal.style.setProperty('--field-color-2', currentFieldColor.color2);
  modal.style.setProperty('--field-color-3', currentFieldColor.color3);
  modal.style.setProperty('--ring-a', `${currentFieldColor.color3}E6`);
  modal.style.setProperty('--ring-b', `${currentFieldColor.color2}D9`);
  modal.style.setProperty('--ring-c', `${currentFieldColor.color1}E6`);
  
  // Update title
  title.textContent = `Bulk Entry – ${fieldNames[field]}`;
  
  // Show modal and focus input
  modal.style.display = 'grid';
  input.value = '';
  
  // Focus management with slight delay for animation
  setTimeout(() => {
    input.focus({ preventScroll: true });
  }, 100);
}

function closeBulkEntryModal() {
  const modal = document.getElementById('bulkEntryModal');
  modal.style.display = 'none';
  currentBulkField = null;
  currentFieldColor = null;
  
  // Clear CSS variables
  modal.style.removeProperty('--field-color-1');
  modal.style.removeProperty('--field-color-2');
  modal.style.removeProperty('--field-color-3');
  modal.style.removeProperty('--ring-a');
  modal.style.removeProperty('--ring-b');
  modal.style.removeProperty('--ring-c');
}

function confirmBulkEntry() {
  const input = document.getElementById('bulkAmount');
  const cleanValue = input.value.replace(/,/g, '');
  const amount = parseFloat(cleanValue);
  
  if (!amount || amount <= 0) {
    alert('Please enter a valid amount greater than 0');
    return;
  }
  
  if (!currentBulkField) {
    alert('No field selected');
    return;
  }
  
  // Apply amount to all visible beneficiaries
  applyBulkAmount(currentBulkField, amount);
  
  // Close modal
  closeBulkEntryModal();
}

function applyBulkAmount(field, amount) {
  // Get all visible rows (not hidden by team filtering)
  const allRows = document.querySelectorAll('.tbody .row-data');
  const visibleRows = Array.from(allRows).filter(row => {
    const computedStyle = window.getComputedStyle(row);
    const isHidden = computedStyle.display === 'none';
    const isDeactivated = row.classList.contains('row-deactivated');
    return !isHidden && !isDeactivated;
  });

  let appliedCount = 0;

  visibleRows.forEach(row => {
    // Find the amount input for the specific field
    const amountInput = row.querySelector(`input.amount-input[data-field="${field}"]`);

    if (amountInput) {
      // Format the amount with commas before setting
      const formattedAmount = formatNumberWithCommas(amount.toFixed(2));
      amountInput.value = formattedAmount;
      
      // Trigger input event to update calculations
      const event = new Event('input', { bubbles: true });
      amountInput.dispatchEvent(event);
      
      appliedCount++;
    }
  });
  
  // Show confirmation message
  if (appliedCount > 0) {
    const fieldName = fieldNames[field];
    alert(`Applied ${amount.toFixed(2)} to ${appliedCount} visible beneficiaries in ${fieldName} field`);
    
    // Trigger recalculation if available
    if (typeof window.FRTZ !== 'undefined' && typeof window.FRTZ.recalculateAll === 'function') {
      window.FRTZ.recalculateAll();
    }
  } else {
    alert('No visible beneficiaries found to apply the amount to');
  }
}

// Close modal when clicking overlay
document.addEventListener('click', function(event) {
  const modal = document.getElementById('bulkEntryModal');
  if (event.target === modal.querySelector('.bulk-entry-scrim')) {
    closeBulkEntryModal();
  }
});

// Keyboard event handling
document.addEventListener('keydown', function(event) {
  const modal = document.getElementById('bulkEntryModal');
  if (modal.style.display === 'grid') {
    if (event.key === 'Escape') {
      closeBulkEntryModal();
    } else if (event.key === 'Enter') {
      event.preventDefault();
      confirmBulkEntry();
    }
  }
});

// Handle Enter key in amount input
document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter' && event.target.id === 'bulkAmount') {
    confirmBulkEntry();
  }
});
</script>

<style>
/* Bulk Entry Modal Styles - Enhanced Design */
.bulk-entry-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
  display: grid;
  place-items: center;
}

/* Scrim with fade-in animation */
.bulk-entry-scrim {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.55);
  backdrop-filter: blur(6px);
  opacity: 0;
  animation: fadeIn 0.18s ease-out forwards;
}

@keyframes fadeIn {
  to { opacity: 1; }
}

/* Card with rise animation */
.bulk-entry-card {
  width: min(320px, 46vw);
  border-radius: 16px;
  background: white;
  border: 1px solid rgba(0,0,0,0.16);
  box-shadow: 0 1px 0 rgba(0,0,0,0.05) inset, 0 10px 30px rgba(0,0,0,0.35);
  transform: translateY(14px) scale(0.98);
  opacity: 0;
  animation: rise 0.2s ease-out 0.06s forwards;
}

@keyframes rise {
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

/* Header with animated gradient */
.bulk-entry-hd {
  position: relative;
  padding: 14px 18px;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  color: #fff;
  font-weight: 800;
  letter-spacing: 0.2px;
}

.bulk-entry-hd::before {
  content: "";
  position: absolute;
  inset: 0;
  border-top-left-radius: inherit;
  border-top-right-radius: inherit;
  background: linear-gradient(90deg, var(--field-color-1, #16d9c3), var(--field-color-2, #5b5bd6), var(--field-color-3, #00e5ff));
  background-size: 220% 100%;
  animation: sheen 4s linear infinite;
}

.bulk-entry-hd > span {
  position: relative;
  z-index: 1;
}

@keyframes sheen {
  0% { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}

/* Close button */
.bulk-entry-x {
  position: absolute;
  right: 10px;
  top: 10px;
  width: 34px;
  height: 34px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  color: #fff;
  background: rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(255, 255, 255, 0.18);
  cursor: pointer;
  transition: filter 0.18s ease, box-shadow 0.18s ease;
}

.bulk-entry-x:hover {
  filter: brightness(1.08);
  box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.55);
}

.bulk-entry-x svg {
  width: 16px;
  height: 16px;
}

/* Body */
.bulk-entry-bd {
  padding: 18px 18px 22px;
}

.bulk-entry-label {
  font-size: 16px;
  font-weight: 700;
  color: #333;
}

.bulk-entry-field {
  margin-top: 14px;
}

/* Input with enhanced focus effects */
.bulk-entry-input-wrap {
  position: relative;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.06);
  border: 2px solid rgba(0, 0, 0, 0.18);
  box-shadow: none;
  transition: border-color 0.2s ease;
}

.bulk-entry-input-wrap input[type="text"] {
  appearance: textfield;
  -webkit-appearance: textfield;
  color: #333;
  background: transparent;
  border: 0;
  outline: 0;
  width: 100%;
  padding: 18px 18px;
  font-size: 22px;
  font-weight: 800;
  letter-spacing: 0.3px;
  box-sizing: border-box;
}

.bulk-entry-input-wrap input[type="text"]::placeholder {
  color: rgba(0, 0, 0, 0.5);
}

/* Focus state without animation */
.bulk-entry-input-wrap:focus-within {
  border-color: var(--field-color-1, #16d9c3);
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 3px var(--ring-a, rgba(0,229,255,0.9)), 0 0 24px 6px var(--ring-b, rgba(91,91,214,0.85)), 0 0 60px 20px var(--ring-c, rgba(22,217,195,0.9));
  }
  50% {
    box-shadow: 0 0 0 4px var(--ring-c, rgba(22,217,195,0.9)), 0 0 34px 10px var(--ring-a, rgba(0,229,255,0.9)), 0 0 80px 28px var(--ring-b, rgba(91,91,214,0.85));
  }
  100% {
    box-shadow: 0 0 0 3px var(--ring-a, rgba(0,229,255,0.9)), 0 0 24px 6px var(--ring-b, rgba(91,91,214,0.85)), 0 0 60px 20px var(--ring-c, rgba(22,217,195,0.9));
  }
}

/* Action buttons */
.bulk-entry-actions {
  margin-top: 20px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.bulk-entry-cancel,
.bulk-entry-confirm {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

.bulk-entry-cancel {
  background: rgba(0, 0, 0, 0.1);
  color: #333;
  border: 1px solid rgba(0, 0, 0, 0.2);
}

.bulk-entry-cancel:hover {
  background: rgba(0, 0, 0, 0.15);
  transform: translateY(-1px);
}

.bulk-entry-confirm {
  background: linear-gradient(135deg, var(--field-color-1, #16d9c3), var(--field-color-2, #5b5bd6));
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.bulk-entry-confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}

/* Reduced motion preferences */
@media (prefers-reduced-motion: reduce) {
  .bulk-entry-hd::before {
    animation: none;
  }
  .bulk-entry-card {
    animation: none;
    opacity: 1;
    transform: none;
  }
  .bulk-entry-scrim {
    animation: none;
    opacity: 1;
  }
  .bulk-entry-input-wrap {
    animation: none;
  }
}

/* Make expense headers clickable */
.thead .th.fuel,
.thead .th.da,
.thead .th.erda,
.thead .th.car,
.thead .th.air,
.thead .th.transport,
.thead .th.misc {
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}

.thead .th.fuel:hover,
.thead .th.da:hover,
.thead .th.car:hover,
.thead .th.air:hover,
.thead .th.transport:hover,
.thead .th.misc:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

/* Vehicle number input styling */
.car-number-input {
  transition: all 0.2s ease;
}

.car-number-input:hover {
  background-color: #e9ecef !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.car-number-input:focus {
  outline: 2px solid #007bff;
  outline-offset: 2px;
}
</style>

<!-- === Option 1 overrides (safe, local to table) === -->
<style>
  /* 0) ULTRA‑compact table columns (force override + recompose --table-cols) */
  .table-wrap{
    /* widths tuned for combined date & amount columns */
    --c1:108px;  /* Name of Beneficiary */
    --c2:118px;  /* Account Holder Name */
    --c3:110px;  /* Row Total (narrower; ~9 digits) */
    --c4:55px;   /* Designation (further reduced) */

    --c5:135px;  /* Fuel D & Amt (expanded for pills) */
    --c6:135px;  /* ER DA D & Amt (expanded for pills) */
    --c7:135px;  /* Vehicle Rent D & Amt (expanded for pills) */
    --c8:135px;  /* Airtime D & Amt (expanded for pills) */
    --c9:135px;  /* Transport D & Amt (expanded for pills) */
    --c10:135px; /* Misc D & Amt (expanded for pills) */

    --c11:88px;   /* Mob No */
    --c12:132px;  /* Display Name */
    --c13:100px;  /* W/H Charges (shifted right) */
    --c14:90px;   /* (spare) */
    --c15:132px;  /* (spare) */
    --c16:148px;  /* Remarks */

    /* RECOMPOSE to ensure children pick up local values */
    --table-cols: var(--c1) var(--c2) var(--c3) var(--c4) var(--c5) var(--c6) var(--c7) var(--c8) var(--c9) var(--c10) var(--c11) var(--c12) var(--c13) var(--c14) var(--c15) var(--c16);
  }

  /* 1) Transport headers gradient (match Transport card) */
  .thead .th.transport{
    background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%) !important;
    color:#fff;
  }
  .thead .th[data-col="transport"],
  .thead .th[title~="Transport"]{ 
    background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%) !important; 
    color:#fff;
  }

  /* 2) Even tighter header row */
  .table-wrap .thead .th{
    font-size: 10px !important;
    padding: 5px 6px !important;
  }

  /* 3) Body rows: compact (unchanged from your working) */
  .tbody .cell .txt,
  .tbody .cell .amt,
  .tbody .cell .sel{
    font-size: 11px !important;
    height: 22px !important;
    padding: 0 6px !important;
    line-height: 22px !important;
  }
  .tbody .cell .amt{ text-align: right; font-variant-numeric: tabular-nums; }
  /* Larger digits for editable amount inputs; keep Row Total slightly smaller */
  .tbody .cell input.amt:not([readonly]){ font-size:13px !important; }
  .tbody .cell input.amt[readonly]{ font-size:12px !important; font-weight:900; }
  
  /* Vertical alignment for Name of Beneficiary, Account Holder, Row Total, and Designation cells */
  .tbody .cell:nth-child(1),  /* Name of Beneficiary */
  .tbody .cell:nth-child(2),  /* Account Holder */
  .tbody .cell:nth-child(3),  /* Row Total */
  .tbody .cell:nth-child(4) { /* Designation */
    display: flex !important;
    align-items: flex-start !important;
    justify-content: center !important;
    padding: 8px 6px !important;
  }
  
  /* Align all input fields to the same baseline as calendar pills */
  .tbody .cell:nth-child(1) .txt,  /* Name of Beneficiary input */
  .tbody .cell:nth-child(3) .amt,  /* Row Total input */
  .tbody .cell:nth-child(4) .txt { /* Designation input */
    margin-top: 8px !important;
  }

  /* Row split‑flap pills: still legible but dense */
  .tbody .splitflap{ padding-block: 1.5px !important; }
  .tbody .splitflap .line{ font-size: 13px !important; }

  /* Account holder cell layout - align with calendar pills */
  .account-holder-cell {
    display: flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
    justify-content: flex-start !important;
    gap: 4px !important;
    padding: 8px 6px !important;
  }
  
  /* Align account holder inputs with calendar pills baseline */
  .account-holder-input {
    margin-top: 8px !important;
  }
  
  .account-holder-input,
   .car-number-input {
    width: 100% !important;
    height: 20px !important;
    font-size: 10px !important;
    padding: 0 4px !important;
    margin: 0 !important;
  }
  
  /* Orange border for differing names */
  .name-mismatch .txt {
    border: 2px solid #f97316 !important;
    box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.2) !important;
  }
  
  /* Deactivated row styling */
  .row-deactivated {
    background-color: #f8f9fa !important;
    opacity: 0.7;
  }
  
  .row-deactivated .splitflap {
    background-color: #e9ecef !important;
    color: #6c757d !important;
  }
  
  .row-deactivated input:not([readonly]) {
    background-color: #e9ecef !important;
    color: #6c757d !important;
  }

  .row-action-pending {
    opacity: 0.55;
    pointer-events: none;
  }

  .row-action-pending::after {
    content: 'Processing…';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(15, 23, 42, 0.88);
    color: #fff;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 12px;
    letter-spacing: 0.02em;
    box-shadow: 0 10px 28px rgba(15, 23, 42, 0.25);
  }

  .row-released {
    opacity: 0;
    transition: opacity 0.22s ease;
  }
  
  /* Row total pill cursor pointer */
  input.amt[readonly] {
    cursor: pointer !important;
  }
  
  /* Make all beneficiary inputs readonly and non-editable */
  .tbody .cell:first-child input.txt {
    cursor: default !important;
    background-color: #f8f9fa !important;
    pointer-events: none;
    user-select: none;
  }
  
  /* Ensure beneficiary inputs cannot be focused or edited */
  .tbody .cell:first-child input.txt:focus {
    outline: none !important;
    box-shadow: none !important;
  }
  
  /* Confirmation modal styling */
  .confirmation-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  
  .confirmation-modal {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 90%;
    animation: modalSlideIn 0.2s ease-out;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-content {
    padding: 24px;
  }
  
  .modal-message {
    font-size: 16px;
    color: #333;
    margin: 0 0 20px 0;
    line-height: 1.5;
    text-align: center;
  }
  
  .modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }
  
  .modal-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 80px;
  }
  
  .modal-btn-no {
    background-color: #6c757d;
    color: white;
  }
  
  .modal-btn-no:hover {
    background-color: #5a6268;
  }
  
  .modal-btn-yes {
    background-color: #dc3545;
    color: white;
  }
  
  .modal-btn-yes:hover {
    background-color: #c82333;
  }
</style>
<!-- === Team row tinting + legend (UI/UX pastel) — refined to detect team correctly === -->
<style>
  /* Legend bar */
  .team-legend{
    display:flex; flex-wrap:wrap; gap:6px; align-items:center;
    margin:8px 0 6px;
  }
  .team-legend .label{ font-weight:900; font-size:11px; opacity:.7; margin-right:4px }
  .team-chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; font-weight:800; font-size:11px;
    background: var(--chip-bg,#eef2ff); color:#0b1220; border:1px solid var(--chip-ring,rgba(0,0,0,.06));
    box-shadow:0 2px 6px rgba(0,0,0,.05);
  }
  .team-chip .dot{ width:10px; height:10px; border-radius:50%; background: var(--chip-dot,#888); box-shadow:0 0 0 2px rgba(255,255,255,.9) inset }
  .team-chip .x{ margin-left:2px; opacity:.45 }

  /* Row tint (entire data row, not headers/cards) */
  .tbody .row-data{ position:relative }
  .tbody .row-data[data-team] .cell{
    background: var(--row-tint, #fff) !important;
  }
  /* left accent stripe */
  .tbody .row-data[data-team]::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:3px;
    background: var(--row-ring, transparent); border-radius:3px; pointer-events:none;
  }
</style>


<script>
// === Team tinting & legend — per-team colors + compact view preserved ===
(function(){
  // Prevent recursive/looping re-tints from the MutationObserver
  var __tinting = false;

  // Robustly get team from a row: supports multiple attributes/locations
  function projectFromRow(row){
    var ds = row.dataset || {};
    var p = (ds.project || ds.projectName || '').trim();
    if(p) return p;
    var el = row.closest('[data-project]') || row.querySelector('[data-project]');
    if(el){ var v=(el.getAttribute('data-project')||el.dataset.project||'').trim(); if(v) return v; }
    return '';
  }

  function teamFromRow(row){
    var ds = row.dataset || {};
    var t = (ds.teamName || ds.team || ds.teamid || '').trim();
    if(t) return t;
    var el = row.querySelector('[data-team]');
    if(el){
      var v = (el.getAttribute('data-team') || el.dataset.team || '').trim();
      if(v) return v;
    }
    var tag = row.querySelector('.team-tag');
    if(tag && tag.textContent.trim()) return tag.textContent.trim();
    var input = row.querySelector('input[name="team"], input[data-field="team"]');
    if(input && input.value.trim()) return input.value.trim();
    return ''; // no team info found
  }

  // FNV-like hash -> index
  function hash32(str){
    var h=2166136261>>>0;
    for(var i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h>>>0);
  }
  function hexToRgb(hex){
    var h = hex.replace('#','');
    if(h.length===3){ h = h.split('').map(function(c){return c+c}).join(''); }
    var num = parseInt(h,16);
    return {r:(num>>16)&255, g:(num>>8)&255, b:num&255};
  }
  function rgba(hex, a){
    var c=hexToRgb(hex); return 'rgba('+c.r+','+c.g+','+c.b+','+a+')';
  }

  // Indian flag colors for team distinction
  var PALETTE = ['#FF9933','#FFFFFF','#138808','#FFFFFF'];

  function colorFor(team, teamIndex){
    // Use sequential assignment instead of hash to ensure proper Saffron-White-Green-White pattern
    var idx = teamIndex % PALETTE.length;
    return PALETTE[idx];
  }

  function applyTeamTints(){
    if (__tinting) return;
    __tinting = true;
    try {
      var rows = document.querySelectorAll('.tbody .row-data');
      var legend = document.getElementById('teamLegend');
      if(!legend) return;
      var map = new Map();
      var teamList = [];
      
      // First pass: collect unique teams in order
      rows.forEach(function(row){
        var team = teamFromRow(row);
        if(team && teamList.indexOf(team) === -1) {
          teamList.push(team);
        }
      });

      rows.forEach(function(row){
        var team = teamFromRow(row);
        if(!team){ 
          row.style.removeProperty('--row-tint');
          row.style.removeProperty('--row-ring');
          return; 
        }
        
        var teamIndex = teamList.indexOf(team);
        var accent = colorFor(team, teamIndex);
        
        // Teams cycle through saffron, white, green colors
        if(accent === '#FFFFFF') {
          // White teams get white background
          row.style.setProperty('--row-tint', 'rgba(255, 255, 255, 0.35)');
          row.style.setProperty('--row-ring', 'rgba(200, 200, 200, 0.15)');
        } else {
          // Colored teams get team color background
          row.style.setProperty('--row-tint', rgba(accent, 0.15));
           row.style.setProperty('--row-ring', rgba(accent, 0.50));
        }
        if(!map.has(team)) map.set(team, accent);
      });

      // Build legend chips (clear + rebuild)
      while(legend.firstChild) legend.removeChild(legend.firstChild);
      if(map.size){
        var label = document.createElement('span'); label.className='label'; label.textContent = 'Teams:';
        legend.appendChild(label);
      }
      Array.from(map.keys()).sort(function(a,b){return a.localeCompare(b);}).forEach(function(team){
        var accent = map.get(team);
        var chip = document.createElement('span'); chip.className='team-chip';
        chip.style.setProperty('--chip-dot', accent);
        chip.style.setProperty('--chip-ring', rgba(accent, .28));
        chip.style.setProperty('--chip-bg', rgba(accent, .16));
        var dot = document.createElement('span'); dot.className='dot';
        var name = document.createElement('span'); name.textContent = team;
        chip.appendChild(dot); chip.appendChild(name);
        legend.appendChild(chip);
      });
    } finally { 
      __tinting = false; 
    }
  }

  // Expose + observe for dynamic rows
  window.FRTZ = window.FRTZ || {};
  window.FRTZ.applyTeamTints = applyTeamTints;

  var tbody = document.getElementById('tbody');
  if(tbody){
    var tintScheduled = false;
    var mo = new MutationObserver(function(){
      if (tintScheduled) return;
      tintScheduled = true;
      requestAnimationFrame(function(){
        tintScheduled = false;
        applyTeamTints();
      });
    });
    mo.observe(tbody, { childList:true, subtree:true, attributes:true, attributeFilter:['data-team', 'data-teamname', 'data-teamid'] });
  }
  // initial
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', applyTeamTints); }
  else{ applyTeamTints(); }
})();
</script>

<!-- Mobile Number Change Flow Modals -->
<style>
  /* Keep below global confirmation modal (z-index ~10000) so it can appear on top */
  .overlay-slim { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:9990; }
  .overlay-slim.show { display:flex; }
  .card-slim { background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); width:min(420px, 92vw); padding:18px; }
  .card-slim h3 { margin:6px 0 12px; font-size:18px; }
  .type-actions { display:flex; gap:10px; justify-content:center; }
  .type-btn { border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .type-btn.perm { background:#d1fae5; color:#065f46; }
  .type-btn.temp { background:#ffedd5; color:#7c2d12; }
  .type-btn.cancel { background:#e5e7eb; color:#374151; }

  /* Keep below confirmation modal so confirmation appears above */
  .ops-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9995; }
  .ops-overlay.show { display:flex; }
  .ops-modal { background:#fff; width:min(560px, 96vw); border-radius:14px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.35); }
  .ops-hd { padding:14px 18px; color:#0b1220; font-weight:800; }
  .ops-hd.permanent { background:#ecfdf5; border-bottom:1px solid #a7f3d0; }
  .ops-hd.temporary { background:#fff7ed; border-bottom:1px solid #fed7aa; }
  .ops-bd { padding:16px 18px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .ops-bd .full { grid-column:1 / -1; }
  .ops-field { display:flex; flex-direction:column; gap:6px; }
  .ops-field label { font-size:12px; font-weight:700; color:#374151; }
  .ops-field input, .ops-field select { padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; }
  .ops-actions { display:flex; justify-content:flex-end; gap:10px; padding:10px 14px 16px; border-top:1px solid #e5e7eb; }
  .ops-btn { border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .ops-btn.cancel { background:#e5e7eb; color:#111827; }
  .ops-btn.submit.permanent { background:#10b981; color:#fff; }
  .ops-btn.submit.temporary { background:#f59e0b; color:#fff; }
  .ops-note { font-size:12px; color:#6b7280; }
</style>

<div id="mobTypeModal" class="overlay-slim" aria-modal="true" role="dialog">
  <div class="card-slim">
    <h3>You want to change Mobile Money Number to:</h3>
    <div class="type-actions">
      <button class="type-btn perm" data-type="Permanent">Permanent</button>
      <button class="type-btn temp" data-type="Temporary">Temporary</button>
      <button class="type-btn cancel" data-type="Cancel">Cancel</button>
    </div>
  </div>
  
  
</div>

<div id="opsEntryModal" class="ops-overlay" aria-modal="true" role="dialog">
  <div class="ops-modal">
    <div id="opsEntryHeader" class="ops-hd">Change Mobile Money Number</div>
    <div class="ops-bd">
      <div class="ops-field full">
        <label>Account Holder Name</label>
        <input id="opsAccHolder" type="text" readonly>
      </div>
      <div class="ops-field">
        <label>Mob Num</label>
        <input id="opsMobNum" type="text" placeholder="0XXXXXXXXX" inputmode="numeric" maxlength="9">
        <div class="ops-note">Must start with 0 and be 9 digits.</div>
      </div>
      <div class="ops-field">
        <label>Display Name</label>
        <input id="opsDisplayName" type="text" placeholder="Enter display name">
      </div>
      <div class="ops-field full">
        <label>Operator</label>
        <select id="opsOperator"></select>
      </div>
      <div class="ops-field full">
        <label>Change requester</label>
        <input id="opsRequester" type="text" readonly>
        <div class="ops-note">Date and Tanzania time captured on submit.</div>
      </div>
    </div>
    <div class="ops-actions">
      <button class="ops-btn cancel" id="opsCancelBtn">Cancel</button>
      <button class="ops-btn submit" id="opsSubmitBtn">Submit</button>
    </div>
  </div>
</div>

<!-- Released Beneficiary Picker Modal -->
<style>
  #beneficiaryPickerModal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 9985;
    padding: 20px;
  }

  #beneficiaryPickerModal.show {
    display: flex;
  }

  #beneficiaryPickerModal.loading .beneficiary-picker-table-wrapper {
    opacity: 0.6;
    pointer-events: none;
  }

  .beneficiary-picker-card {
    width: min(1120px, 96vw);
    max-height: 88vh;
    background: rgba(255, 255, 255, 0.97);
    border-radius: 22px;
    box-shadow: 0 24px 48px rgba(15, 23, 42, 0.28);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .beneficiary-picker-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .beneficiary-picker-header-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .beneficiary-picker-title {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    color: #1e293b;
  }

  .beneficiary-picker-subtitle {
    font-size: 13px;
    color: #64748b;
  }

  .beneficiary-picker-close {
    appearance: none;
    border: 0;
    background: rgba(148, 163, 184, 0.18);
    color: #1e293b;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, background 0.2s ease;
  }

  .beneficiary-picker-close:hover {
    background: rgba(148, 163, 184, 0.32);
    transform: rotate(90deg);
  }

  .beneficiary-picker-body {
    padding: 16px 24px 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: hidden;
    flex: 1 1 auto;
  }

  .beneficiary-picker-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }

  .beneficiary-picker-search {
    flex: 1 1 280px;
    min-width: 220px;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid #cbd5f5;
    background: #f8fafc;
    font-size: 14px;
    color: #1e293b;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .beneficiary-picker-search:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
  }

  .beneficiary-picker-count {
    font-size: 13px;
    color: #475569;
  }

  .beneficiary-picker-table-wrapper {
    flex: 1 1 auto;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: auto;
    background: #ffffff;
  }

  .beneficiary-picker-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .beneficiary-picker-table thead th {
    position: sticky;
    top: 0;
    background: #f1f5f9;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 12px;
    font-weight: 700;
    color: #0f172a;
    padding: 10px 12px;
    border-bottom: 1px solid #e2e8f0;
    z-index: 1;
  }

  .beneficiary-picker-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #e2e8f0;
    color: #1f2937;
  }

  .beneficiary-picker-table tbody tr:hover {
    background: #f8fafc;
  }

  .beneficiary-picker-table tbody tr.selected {
    background: #ecfdf5;
  }

  .beneficiary-picker-table .picker-checkbox {
    width: 44px;
    text-align: center;
  }

  .beneficiary-picker-table .picker-checkbox input {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .beneficiary-picker-table .numeric {
    text-align: right;
    font-variant-numeric: tabular-nums;
    color: #0f172a;
  }

  .beneficiary-picker-table .picker-history {
    min-width: 200px;
    white-space: normal;
  }

  .beneficiary-picker-table .picker-history.picker-rating {
    min-width: 240px;
  }

  .beneficiary-picker-table .picker-history-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .beneficiary-picker-table .picker-history-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    line-height: 1.35;
    color: #334155;
  }

  .beneficiary-picker-table .picker-history-item.picker-rating-item {
    gap: 10px;
  }

  .beneficiary-picker-table .picker-history-index {
    flex: 0 0 auto;
    color: #94a3b8;
    font-weight: 600;
  }

  .beneficiary-picker-table .picker-history-empty {
    color: #94a3b8;
    font-style: italic;
  }

  .beneficiary-picker-table .picker-rating-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .beneficiary-picker-table .picker-rating-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
  }

  .beneficiary-picker-table .picker-rating-label {
    font-weight: 600;
    color: #1e293b;
  }

  .beneficiary-picker-table .picker-rating-stars {
    font-family: 'Segoe UI Symbol', 'Apple Color Emoji', sans-serif;
    letter-spacing: 1px;
    font-size: 15px;
  }

  .beneficiary-picker-table .picker-rating-stars.rating-low {
    color: #dc2626;
  }

  .beneficiary-picker-table .picker-rating-stars.rating-mid {
    color: #f59e0b;
  }

  .beneficiary-picker-table .picker-rating-stars.rating-high {
    color: #16a34a;
  }

  .beneficiary-picker-table .picker-rating-value {
    font-size: 13px;
    color: #475569;
  }

  .beneficiary-picker-table .picker-rating-extra {
    font-size: 12px;
    color: #64748b;
    white-space: normal;
  }

  .beneficiary-picker-empty {
    padding: 28px 16px;
    text-align: center;
    font-size: 14px;
    color: #64748b;
  }

  .beneficiary-picker-footer {
    padding: 16px 24px 20px;
    border-top: 1px solid rgba(226, 232, 240, 0.8);
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
  }

  .beneficiary-picker-status {
    font-size: 13px;
    color: #475569;
    min-height: 18px;
  }

  .beneficiary-picker-status.error {
    color: #dc2626;
  }

  .beneficiary-picker-status.success {
    color: #047857;
  }

  .beneficiary-picker-actions {
    display: flex;
    gap: 10px;
  }

  .picker-btn {
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .picker-btn.primary {
    background: linear-gradient(135deg, #34d399 0%, #059669 100%);
    color: #ffffff;
    box-shadow: 0 12px 28px rgba(52, 211, 153, 0.32);
  }

  .picker-btn.primary:not(:disabled):hover {
    transform: translateY(-1px);
  }

  .picker-btn.primary:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    box-shadow: none;
  }

  .picker-btn.secondary {
    background: #e2e8f0;
    color: #1e293b;
  }

  .picker-btn.secondary:hover {
    background: #cbd5f5;
  }

  @media (max-width: 720px) {
    .beneficiary-picker-card {
      width: 100%;
      max-height: 92vh;
    }

    .beneficiary-picker-footer {
      flex-direction: column;
      align-items: stretch;
    }

    .beneficiary-picker-actions {
      width: 100%;
      justify-content: flex-end;
    }

    .picker-btn {
      width: 100%;
    }
  }
</style>

<div id="beneficiaryPickerModal" role="dialog" aria-modal="true" aria-labelledby="beneficiaryPickerTitle">
  <div class="beneficiary-picker-card">
    <div class="beneficiary-picker-header">
      <div class="beneficiary-picker-header-group">
        <h3 class="beneficiary-picker-title" id="beneficiaryPickerTitle">Add Existing Beneficiaries</h3>
        <div class="beneficiary-picker-subtitle" id="beneficiaryPickerSubtitle"></div>
      </div>
      <button type="button" class="beneficiary-picker-close" aria-label="Close add existing beneficiary dialog">×</button>
    </div>
    <div class="beneficiary-picker-body">
      <div class="beneficiary-picker-controls">
        <input type="search" id="beneficiaryPickerSearch" class="beneficiary-picker-search" placeholder="Search by name, project, team, account holder, or nationality" autocomplete="off">
        <div class="beneficiary-picker-count" id="beneficiaryPickerCount"></div>
      </div>
      <div class="beneficiary-picker-table-wrapper">
        <table class="beneficiary-picker-table" role="grid" aria-describedby="beneficiaryPickerCount">
          <thead>
            <tr>
              <th scope="col" class="picker-checkbox"><input type="checkbox" id="beneficiaryPickerSelectAll" aria-label="Select all visible beneficiaries"></th>
              <th scope="col">S.No</th>
              <th scope="col">Name of Beneficiary</th>
              <th scope="col">Resource Designation</th>
              <th scope="col">Project</th>
              <th scope="col">Team</th>
              <th scope="col">Account Holder Name</th>
              <th scope="col" class="numeric">Idle since (days)</th>
              <th scope="col">Nationality</th>
              <th scope="col">Last 3 Remarks</th>
              <th scope="col">Last 3 Ratings</th>
            </tr>
          </thead>
          <tbody id="beneficiaryPickerRows"></tbody>
        </table>
        <div class="beneficiary-picker-empty" id="beneficiaryPickerEmpty" hidden>No released beneficiaries are available right now.</div>
      </div>
    </div>
    <div class="beneficiary-picker-footer">
      <div class="beneficiary-picker-status" id="beneficiaryPickerStatus"></div>
      <div class="beneficiary-picker-actions">
        <button type="button" class="picker-btn secondary" id="beneficiaryPickerCancel">Cancel</button>
        <button type="button" class="picker-btn primary" id="beneficiaryPickerApply" disabled>Add Selected</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const isMobInput = (el)=>{
    if(!el || el.tagName !== 'INPUT') return false;
    if (el.dataset && el.dataset.field && el.dataset.field.toLowerCase() === 'mob') return true;
    const ph = (el.getAttribute('placeholder')||'').toLowerCase();
    return ph.includes('0xxxx') || ph.includes('0xxxxxxxxx') || ph.includes('mob');
  };

  const mobPattern = /^0\d{8}$/; // 9 digits total, starting with 0

  // Track previous values
  document.addEventListener('focusin', (e)=>{
    const inp = e.target;
    if(isMobInput(inp)){
      inp.dataset.prevMobVal = inp.value || '';
    }
  });

  document.addEventListener('blur', (e)=>{
    const inp = e.target;
    if(!isMobInput(inp)) return;
    const prev = inp.dataset.prevMobVal || '';
    const now = (inp.value||'').trim();
    if(now === prev) return;
    const row = inp.closest('.row-data');
    const accHolder = row ? (row.querySelector('.account-holder-input')?.value || '') : '';

    // Step 1: Are you sure?
    showConfirmationModal({
      title: 'Change Mobile Money Number?',
      message: 'Are you sure you want to change the Mobile Money Number?',
      yesText: 'Yes, Continue'
    }).then(confirmed=>{
      if(!confirmed){ inp.value = prev; return; }
      // Step 2: Type selection (Permanent / Temporary / Cancel)
      pickChangeType().then(type=>{
        if(!type){ inp.value = prev; return; }
        // Step 3: Open entry modal
        openOpsEntry({ type, accHolder, mobNow: now, row, input: inp }).then(submitted=>{
          if(!submitted){ /* keep new value in field unless user cancelled earlier */ }
        });
      });
    });
  }, true);

  function pickChangeType(){
    return new Promise((resolve)=>{
      const overlay = document.getElementById('mobTypeModal');
      function onClick(e){
        const btn = e.target.closest('button.type-btn');
        if(!btn) return;
        const t = btn.dataset.type;
        overlay.classList.remove('show');
        overlay.removeEventListener('click', onClick);
        if(t === 'Cancel') resolve(null); else resolve(t);
      }
      overlay.addEventListener('click', onClick);
      overlay.classList.add('show');
    });
  }

  function loadOperators(){
    return new Promise((resolve)=>{
      try{
        if(!(window.google && google.script && google.script.run)) return resolve([]);
        google.script.run
          .withSuccessHandler(function(list){ resolve(Array.isArray(list)?list:[]); })
          .withFailureHandler(function(err){ console.error('getOpsOperators failed', err); resolve([]); })
          .getOpsOperators();
      }catch(_e){ resolve([]); }
    });
  }

  function loadUser(){
    return new Promise((resolve)=>{
      try{
        if(!(window.google && google.script && google.script.run)) return resolve({});
        google.script.run
          .withSuccessHandler(function(info){ resolve(info||{}); })
          .withFailureHandler(function(err){ console.error('getCurrentUser failed', err); resolve({}); })
          .getCurrentUser();
      }catch(_e){ resolve({}); }
    });
  }

  function openOpsEntry(ctx){
    return new Promise(async (resolve)=>{
      const overlay = document.getElementById('opsEntryModal');
      const hd = document.getElementById('opsEntryHeader');
      const acc = document.getElementById('opsAccHolder');
      const mob = document.getElementById('opsMobNum');
      const disp = document.getElementById('opsDisplayName');
      const opr = document.getElementById('opsOperator');
      const req = document.getElementById('opsRequester');
      const btnCancel = document.getElementById('opsCancelBtn');
      const btnSubmit = document.getElementById('opsSubmitBtn');

      // Theme + header
      hd.classList.toggle('permanent', ctx.type === 'Permanent');
      hd.classList.toggle('temporary', ctx.type === 'Temporary');
      hd.textContent = ctx.type === 'Permanent' ? 'Permanent Mobile Number Change' : 'Temporary Mobile Number Change';
      btnSubmit.classList.toggle('permanent', ctx.type === 'Permanent');
      btnSubmit.classList.toggle('temporary', ctx.type === 'Temporary');

      // Prefill
      acc.value = ctx.accHolder || '';
      mob.value = ctx.mobNow || '';
      disp.value = '';
      req.value = '';

      // Load operators and user
      opr.innerHTML = '';
      const ops = await loadOperators();
      const frag = document.createDocumentFragment();
      const def = document.createElement('option');
      def.value = ''; def.textContent = 'Select operator';
      frag.appendChild(def);
      ops.forEach(o=>{ const opt = document.createElement('option'); opt.value = o; opt.textContent = o; frag.appendChild(opt); });
      opr.appendChild(frag);
      const user = await loadUser();
      req.value = user && (user.username || user.email) ? (user.username || user.email) : '';

      function close(){ overlay.classList.remove('show'); btnCancel.removeEventListener('click', onCancel); btnSubmit.removeEventListener('click', onSubmit); document.removeEventListener('keydown', onKey); }
      function onCancel(){ close(); resolve(false); }
      function onKey(e){ if(e.key==='Escape'){ onCancel(); } }
      let submitting = false;
      async function onSubmit(){
        if(submitting) return;
        const vMob = mob.value.trim();
        if(!mobPattern.test(vMob)){ alert('Invalid Mobile Number. It must start with 0 and be exactly 9 digits.'); return; }
        if(!disp.value.trim()){ alert('Please enter a Display Name.'); return; }
        if(!opr.value){ alert('Please select an Operator.'); return; }

        // Final confirmation
        const msg = ctx.type === 'Permanent' ? 'Submit to Ops_P?' : 'Submit to Ops_T?';
        showConfirmationModal({ title:'Confirm submission', message: msg, yesText: 'Submit' }).then(function(yes){
          if(!yes) return;
          try{
            if(!(window.google && google.script && google.script.run)){
              alert('Not running inside Google Apps Script web app. Cannot submit.');
              return;
            }
            submitting = true;
            const prevText = btnSubmit.textContent;
            btnSubmit.disabled = true; btnSubmit.textContent = 'Submitting...';
            google.script.run
              .withSuccessHandler(function(res){
                btnSubmit.disabled = false; btnSubmit.textContent = prevText; submitting = false;
                if(res && res.ok){ close(); resolve(true); }
                else { alert('Save failed: ' + (res && res.error ? res.error : 'unknown error')); }
              })
              .withFailureHandler(function(err){
                btnSubmit.disabled = false; btnSubmit.textContent = prevText; submitting = false;
                alert('Save failed: ' + (err && err.message ? err.message : err));
              })
              .saveOpsChange({ type: ctx.type, accountHolder: acc.value, mobNo: vMob, displayName: disp.value.trim(), operator: opr.value });
          }catch(err){ alert('Save failed. Please try again.'); submitting = false; }
        });
      }

      btnCancel.addEventListener('click', onCancel);
      btnSubmit.addEventListener('click', onSubmit);
      document.addEventListener('keydown', onKey);
      overlay.classList.add('show');
      setTimeout(()=>{ try{ mob.focus(); }catch(_e){} }, 60);
    });
  }
})();
</script>

<script>
/* === Name Mismatch Detection === */
(function(){
  'use strict';
  
  function checkNameMismatch() {
    var rows = document.querySelectorAll('.tbody .row-data');
    
    rows.forEach(function(row) {
      var beneficiaryInput = row.querySelector('.cell:first-child .txt');
      var accountHolderInput = row.querySelector('.account-holder-input');
      
      if (beneficiaryInput && accountHolderInput) {
        var beneficiaryName = beneficiaryInput.value.trim().toLowerCase();
        var accountHolderName = accountHolderInput.value.trim().toLowerCase();
        
        // Check if names are different and both are not empty
        if (beneficiaryName && accountHolderName && beneficiaryName !== accountHolderName) {
          // Add orange border class to both cells
          beneficiaryInput.closest('.cell').classList.add('name-mismatch');
          accountHolderInput.closest('.cell').classList.add('name-mismatch');
        } else {
          // Remove orange border class
          beneficiaryInput.closest('.cell').classList.remove('name-mismatch');
          accountHolderInput.closest('.cell').classList.remove('name-mismatch');
        }
      }
    });
  }
  
  // Expose globally for external access
  window.checkNameMismatch = checkNameMismatch;
  
  // Add event listeners to all beneficiary and account holder inputs
  function initNameMismatchDetection() {
    var tbody = document.getElementById('tbody');
    if (tbody) {
      // Use event delegation for dynamically added content
      tbody.addEventListener('input', function(e) {
        if (e.target.matches('.txt') && 
            (e.target.closest('.cell:first-child') || e.target.classList.contains('account-holder-input'))) {
          setTimeout(checkNameMismatch, 50); // Small delay to ensure value is set
        }
      });
      
      // Also listen for change events
      tbody.addEventListener('change', function(e) {
        if (e.target.matches('.txt') && 
            (e.target.closest('.cell:first-child') || e.target.classList.contains('account-holder-input'))) {
          setTimeout(checkNameMismatch, 50);
        }
      });
      
      // Initial check
      checkNameMismatch();
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNameMismatchDetection);
  } else {
    initNameMismatchDetection();
  }
  
  // Listen for custom events that indicate data has been loaded
  document.addEventListener('pp:apply', function() {
    setTimeout(checkNameMismatch, 200);
  });
})();
</script>

<script>
/* === Calendar Pills - Keyboard Support Only === */
(function(){
  'use strict';
  
  // Add keyboard support to calendar pills (click handling is done by _SideCalendar.html global delegation)
  function initCalendarPills(){
    const pills = document.querySelectorAll('.splitflap--holo[data-cal]');
    pills.forEach(pill => {
      // Add keyboard support
      pill.addEventListener('keydown', function(e){
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          this.click();
        }
      });
    });
  }
  
  // Initialize on DOM ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initCalendarPills);
  } else {
    initCalendarPills();
  }
  
  // Re-initialize when new rows are added
  const tbody = document.getElementById('tbody');
  if(tbody){
    const observer = new MutationObserver(function(){
      initCalendarPills();
    });
    observer.observe(tbody, { childList: true, subtree: true });
  }
})();
</script>
<script>
/* === Row totals + summary aggregation (per-row only; no cross-row mirroring) === */
(function(){
  'use strict';

  function initTableModule(tbody){
    if(!tbody) return false;

    function parseAmt(v){
    if(v==null || v==='') return 0;
    if (typeof v === 'number') return v;
    var s = String(v).replace(/\u00A0/g,' ').trim();
    var m = s.match(/-?\d[\d,\.\s]*/);
    if(!m) return 0;
    var numStr = m[0].replace(/[ ,\s]+/g,'');
    var n = parseFloat(numStr);
    return isNaN(n) ? 0 : n;
  }

  // Shared formatter: 1,234.56 style with 2 decimals
  const __NF = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  function formatAmt(v){ return __NF.format(parseAmt(v)); }
  // Expose for other scripts if needed
  window.FRTZ = window.FRTZ || {};
  if (!window.FRTZ.formatAmt) window.FRTZ.formatAmt = formatAmt;

  // Pair each row's split calendar container to its amount input
  function bindRow(row){
    const containers = row.querySelectorAll('.split-calendar-container[data-cal]');
    containers.forEach(container=>{
      const key = container.dataset.cal;
      const inp = container.querySelector('input.amount-input');
      if(inp){ 
        inp.dataset.field = key;
        inp.classList.add('amt'); // Add amt class for compatibility
      }
    });
  }
  function bindAll(){ document.querySelectorAll('.tbody .row-data').forEach(bindRow); }

  function rowTotal(row){
    const amts = row.querySelectorAll('input.amt:not([readonly]), input.amount-input:not([readonly])');
    let s = 0;
    amts.forEach(inp => { s += parseAmt(inp.value); });
    const totalInp = row.querySelector('input.amt[readonly]');
    if (totalInp){ totalInp.value = formatAmt(s); }
    return s;
  }

  function recalcAll(){
    const rows = Array.from(document.querySelectorAll('.tbody .row-data'));
    const sums = { fuel:0, da:0, erda:0, car:0, air:0, transport:0, misc:0, total:0 };

    rows.forEach(row=>{
      const subtotal = rowTotal(row);
      sums.total += subtotal;
      row.querySelectorAll('input.amt[data-field]').forEach(inp=>{
        const k = inp.dataset.field;
        if(k && (k in sums)){
          sums[k] += parseAmt(inp.value);
        }
      });
    });

    Object.keys(sums).forEach(k => sums[k] = Number(sums[k].toFixed(2)));

    window.FRTZ = window.FRTZ || {};
    window.FRTZ.sums = sums;
    document.dispatchEvent(new CustomEvent('frtz:totals-changed', { detail: sums }));

    updateSummaryUI(sums);
  }

  function updateSummaryUI(sums){
    const map = {
      fuel: ['[data-field-amt="fuel"]','[data-sum="fuel"]','[data-total="fuel"]','#sum-fuel','#fuel-sum','#fuelTotal','#total-fuel','.sum-fuel','.total-fuel','.summary-card.fuel .value','.card.fuel .value','.fuel .sum','.fuel .value'],
      da:   ['[data-field-amt="da"]','[data-sum="da"]','[data-total="da"]','#sum-da','#da-sum','#daTotal','#total-da','.sum-da','.total-da','.summary-card.da .value','.da .value'],
      erda: ['[data-field-amt="erda"]','[data-sum="erda"]','[data-total="erda"]','#sum-erda','#erda-sum','#erdaTotal','#total-erda','.sum-erda','.total-erda','.summary-card.erda .value','.erda .value'],
      car:  ['[data-field-amt="car"]','[data-sum="car"]','[data-total="car"]','#sum-car','#car-sum','#carTotal','#total-car','.sum-car','.total-car','.summary-card.car .value','.car .value','.car-rent .value'],
      air:  ['[data-field-amt="air"]','[data-sum="air"]','[data-total="air"]','#sum-air','#air-sum','#airTotal','#total-air','.sum-air','.total-air','.summary-card.air .value','.airtime .value','.air .value'],
      transport: ['[data-field-amt="transport"]','[data-sum="transport"]','[data-total="transport"]','#sum-transport','#transport-sum','#transportTotal','#total-transport','.sum-transport','.total-transport','.summary-card.transport .value','.transport .value'],
      misc: ['[data-field-amt="misc"]','[data-sum="misc"]','[data-total="misc"]','#sum-misc','#misc-sum','#miscTotal','#total-misc','.sum-misc','.total-misc','.summary-card.misc .value','.misc .value'],
      total: ['[data-field-amt="total"]','[data-sum="total"]','[data-total="total"]','#sum-total','#total-sum','#grandTotal','#total-req','.sum-total','.total-req','.summary-card.total .value','.total-req .value']
    };
    Object.entries(sums).forEach(([k,v])=>{
      const selectors = map[k] || [];
      let matched = false;
      selectors.forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{
          el.textContent = formatAmt(v);
          matched = true;
        });
      });
      if(!matched){
        const cards = document.querySelectorAll('.summary-card, .card, [data-card]');
  const nameMap = {fuel:'FUEL', da:'DA', erda:'DA', car:'VEHICLE RENT', air:'AIRTIME', transport:'TRANSPORT', misc:'MISC', total:'TOTAL'};
        cards.forEach(card=>{
          const txt = (card.textContent || '').toUpperCase();
          if(txt.includes(nameMap[k])){
            const num = card.querySelector('.value, .val, [data-value], .amount');
            if(num){ num.textContent = formatAmt(v); }
          }
        });
      }
    });
    // Refit amounts on cards if autoshrink helper is present
    try{ if(window.fitSummaryAmounts) window.fitSummaryAmounts(); }catch(_){ }
  }

  // delegate input/blur to a single handler per tbody
  tbody.addEventListener('input', (e)=>{
    const inp = e.target.closest('input.amt, input.amount-input');
    if(!inp) return;
    const row = inp.closest('.row-data');
    if(row){
      bindRow(row);
      rowTotal(row);
    }
    recalcAll();
  });

  tbody.addEventListener('blur', (e)=>{
    const inp = e.target.closest('input.amt, input.amount-input');
    if(!inp || inp.hasAttribute('readonly')) return;
    const val = parseAmt(inp.value);
    inp.value = val ? formatAmt(val) : '';
    const row = inp.closest('.row-data');
    if(row) rowTotal(row);
    recalcAll();
  }, true);

  // initial
  bindAll();
  recalcAll();

  // new rows support
  const mo = new MutationObserver((mutList)=>{
    let changed=false;
    mutList.forEach(m=>{
      m.addedNodes && m.addedNodes.forEach(n=>{
        if(n.nodeType===1 && n.classList.contains('row-data')){
          bindRow(n);
          changed=true;
        }
      });
    });
    if(changed) recalcAll();
  });
  mo.observe(tbody, { childList:true, subtree:true });

  // Row total pill click functionality using the new confirmation modal
  
  function deactivateRow(row) {
    row.classList.add('row-deactivated');
    
    // Reset all calendar pills - handle both span structure and direct text content
    var pills = row.querySelectorAll('.splitflap');
    pills.forEach(function(pill) {
      var daySpan = pill.querySelector('.day');
      var monthSpan = pill.querySelector('.month');
      var lineDiv = pill.querySelector('.line');
      
      if (daySpan && monthSpan) {
        // Standard structure with day and month spans
        daySpan.textContent = 'DD';
        monthSpan.textContent = 'MM';
      } else if (lineDiv) {
        // Fallback: reset entire line content to standard format
        lineDiv.innerHTML = '<span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span>';
      } else {
        // Last resort: reset any text content in the pill
        var textNodes = pill.querySelectorAll('*');
        textNodes.forEach(function(node) {
          if (node.textContent && (node.textContent.includes('Select') || node.textContent.includes('dates'))) {
            node.innerHTML = '<span class="day">DD</span><span class="separator"> - </span><span class="month">MM</span>';
          }
        });
      }
    });
    
    // Reset all amount inputs (except readonly row total)
    var amountInputs = row.querySelectorAll('input.amount-input');
    amountInputs.forEach(function(input) {
      input.value = '';
    });
    
    // Disable all interactive elements
    var interactiveElements = row.querySelectorAll('input:not([readonly]), .splitflap');
    interactiveElements.forEach(function(element) {
      element.disabled = true;
      if (element.classList.contains('splitflap')) {
        element.style.pointerEvents = 'none';
        element.style.opacity = '0.5';
      }
    });
    
    // Recalculate totals
    rowTotal(row);
    recalcAll();
  }
  
  function reactivateRow(row) {
    row.classList.remove('row-deactivated');

    // Enable all interactive elements
    var interactiveElements = row.querySelectorAll('input:not([readonly]), .splitflap');
    interactiveElements.forEach(function(element) {
      element.disabled = false;
      if (element.classList.contains('splitflap')) {
        element.style.pointerEvents = '';
        element.style.opacity = '';
      }
    });
    
    // Recalculate totals
    rowTotal(row);
    recalcAll();
  }

  function buildReleaseContext(row) {
    var cells = row ? row.querySelectorAll('.cells > .cell') : [];
    var readCellValue = function(index) {
      if (!cells || index < 0 || index >= cells.length) return '';
      var el = cells[index].querySelector('input, textarea');
      return el && el.value != null ? String(el.value).trim() : '';
    };

    var accountHolderInput = row ? row.querySelector('.account-holder-input') : null;
    var projectRaw = row ? (row.dataset.project || row.getAttribute('data-project') || '') : '';
    var teamRaw = row ? (row.dataset.team || row.getAttribute('data-team') || '') : '';

    return {
      beneficiary: readCellValue(0),
      accountHolder: accountHolderInput && accountHolderInput.value != null ? String(accountHolderInput.value).trim() : '',
      project: String(projectRaw || '').trim(),
      team: String(teamRaw || '').trim(),
      designation: readCellValue(3),
      mobile: readCellValue(10),
      displayName: readCellValue(11),
      whCharge: readCellValue(12),
      remarks: readCellValue(13)
    };
  }

  function setRowPending(row, pending) {
    if (!row) return;
    if (pending) {
      row.classList.add('row-action-pending');
    } else {
      row.classList.remove('row-action-pending');
    }
  }

  function describeBeneficiaryAction(context) {
    var name = context && context.beneficiary ? context.beneficiary : 'this beneficiary';
    var segments = [];
    if (context && context.team) segments.push(context.team);
    if (context && context.project) segments.push(context.project);
    var suffix = segments.length ? ' (' + segments.join(' • ') + ')' : '';
    return name + suffix;
  }

  function promptReactivateRow(row, context, totalText) {
    if (!row) return;
    var subject = describeBeneficiaryAction(context);
    var hasSubject = subject && subject !== 'this beneficiary';
    var title = hasSubject ? ('Reactivate ' + subject + '?') : 'Reactivate beneficiary?';
    if (title && title.length > 80) {
      title = 'Reactivate beneficiary?';
    }
    var note = totalText && totalText.trim() ? 'Row total is ' + totalText.trim() + '. ' : '';
    var message = (note + "Re-enabling means you'll fund their expenses. Continue?").trim();

    if (typeof showConfirmationModal !== 'function') {
      reactivateRow(row);
      return;
    }

    showConfirmationModal({
      title: title,
      message: message,
      buttons: [
        { text: 'Reactivate', value: true, role: 'confirm', variant: 'primary', feedback: true, successText: '✓ Reactivated' },
        { text: 'Keep Inactive', value: false, role: 'cancel', variant: 'secondary', feedback: false }
      ]
    }).then(function(choice) {
      if (choice) {
        reactivateRow(row);
      }
    }).catch(function(err) {
      if (err && err !== false) {
        console.error('Reactivate confirmation failed', err);
      }
    });
  }

  function promptRowAction(row, context, totalText) {
    if (!row) return;

    if (typeof showConfirmationModal !== 'function') {
      console.warn('showConfirmationModal unavailable; skipping row action prompt.');
      return;
    }

    var subject = describeBeneficiaryAction(context);
    var totalLabel = totalText && totalText.trim() ? totalText.trim() : '0.00';
    var message = (subject && subject !== 'this beneficiary')
      ? 'Row total is ' + totalLabel + '. What would you like to do with ' + subject + '?'
      : 'Row total is ' + totalLabel + '. What would you like to do with this beneficiary?';

    var existingCount = null;
    if (window.FRTZ) {
      if (typeof window.FRTZ.getReleasedBeneficiaryCount === 'function') {
        existingCount = window.FRTZ.getReleasedBeneficiaryCount();
      } else if (typeof window.FRTZ.releasedBeneficiaryCount !== 'undefined') {
        existingCount = window.FRTZ.releasedBeneficiaryCount;
      }
    }
    existingCount = coerceCount(existingCount);

    var confirmationPromise = showConfirmationModal({
      title: 'Deactivate or release beneficiary?',
      message: message,
      buttons: [
        { text: 'Deactivate', value: 'deactivate', role: 'destructive', variant: 'destructive', feedback: false },
        { text: 'Release', value: 'release', role: 'confirm', variant: 'primary', feedback: true, successText: '✓ Continue' },
        { text: formatExistingBeneficiaryLabel(existingCount), id: 'add-existing', value: 'add-existing', role: 'option', variant: 'success', feedback: true, successText: '✓ Opening' },
        { text: 'Add New Beneficiary', id: 'add-new', value: 'add-new', role: 'option', variant: 'accent', feedback: true, successText: '✓ Opening' },
        { text: 'No, Keep Active', value: 'cancel', role: 'cancel', variant: 'secondary', feedback: false }
      ]
    });

    var removeCountWatcher = null;
    if (window.FRTZ && typeof window.FRTZ.onReleasedBeneficiaryCountChange === 'function') {
      removeCountWatcher = window.FRTZ.onReleasedBeneficiaryCountChange(function(count) {
        updateExistingBeneficiaryButton(count);
      });
    }

    setTimeout(function() {
      updateExistingBeneficiaryButton(existingCount);
    }, 0);

    if (window.FRTZ && typeof window.FRTZ.refreshReleasedBeneficiaryCount === 'function') {
      window.FRTZ.refreshReleasedBeneficiaryCount(context.project, context.team);
    }

    var cleanupWatcher = function() {
      if (removeCountWatcher) {
        try {
          removeCountWatcher();
        } catch (err) {
          console.error('remove count watcher failed', err);
        }
        removeCountWatcher = null;
      }
    };

    confirmationPromise.then(function(action) {
      cleanupWatcher();
      if (action === 'deactivate') {
        deactivateRow(row);
      } else if (action === 'release') {
        confirmReleaseRow(row, context);
      } else if (action === 'add-existing') {
        openAddBeneficiaryModal(context);
      } else if (action === 'add-new') {
        triggerAddNewBeneficiary(context);
      }
    }).catch(function(err) {
      cleanupWatcher();
      if (err && err !== false) {
        console.error('confirmation dialog rejected', err);
      }
    });
  }

  function submitRelease(row, context) {
    if (row && row.classList.contains('row-action-pending')) {
      return;
    }
    if (!(window.google && google.script && google.script.run)) {
      alert('Release is only available inside the Google Sheets web app environment.');
      return;
    }

    setRowPending(row, true);

    var reviewText = context && context.releaseReview ? String(context.releaseReview).trim() : '';
    var payload = {
      beneficiary: context.beneficiary,
      project: context.project,
      team: context.team,
      accountHolder: context.accountHolder,
      designation: context.designation,
      mobile: context.mobile,
      displayName: context.displayName,
      whCharge: context.whCharge,
      remarks: reviewText || context.remarks || ''
    };

    if (reviewText) {
      payload.review = reviewText;
    }
    if (context && context.releaseRatings) {
      payload.ratingSummary = context.releaseRatings;
    }
    if (context && context.releaseRatingValues) {
      payload.ratingValues = context.releaseRatingValues;
    }

    google.script.run
      .withSuccessHandler(function(res) {
        setRowPending(row, false);
        if (res && res.ok) {
          finalizeRelease(row, context);
        } else {
          var err = res && res.error ? res.error : 'Unknown error';
          alert('Failed to release beneficiary: ' + err);
        }
      })
      .withFailureHandler(function(err) {
        setRowPending(row, false);
        alert('Failed to release beneficiary: ' + (err && err.message ? err.message : err));
      })
      .releaseBeneficiary(payload);
  }

  function finalizeRelease(row, context) {
    if (!row) return;
    row.classList.remove('row-action-pending');
    row.classList.add('row-released');

    var detail = {
      beneficiary: context && context.beneficiary ? context.beneficiary : '',
      team: context && context.team ? context.team : '',
      project: context && context.project ? context.project : ''
    };

    setTimeout(function() {
      if (row.parentNode) {
        row.parentNode.removeChild(row);
      }
      recalcAll();
      try {
        if (window.FRTZ && typeof window.FRTZ.applyTeamTints === 'function') {
          window.FRTZ.applyTeamTints();
        }
      } catch (_e) {}

      try {
        document.dispatchEvent(new CustomEvent('frtz:beneficiary-released', { detail: detail }));
      } catch (_eventErr) {}
    }, 240);
  }

  function confirmReleaseRow(row, baseContext) {
    var context = baseContext || buildReleaseContext(row);
    var subject = describeBeneficiaryAction(context);

    var ratingCategories = [
      { key: 'coreKnowledge', label: 'Core Knowledge' },
      { key: 'discipline', label: 'Discipline' },
      { key: 'honestyIntegrity', label: 'Honesty and Integrity' },
      { key: 'teamwork', label: 'Teamwork' },
      { key: 'attitudeBehaviour', label: 'Attitude and Behaviour' }
    ];

    function clampRating(value) {
      var num = Number(value);
      if (!isFinite(num)) return 0;
      if (num < 0) return 0;
      if (num > 5) return 5;
      return Math.round(num);
    }

    function countNonSpace(str) {
      return String(str || '').replace(/\s/g, '').length;
    }

    function displayValue(value) {
      var text = value == null ? '' : String(value).trim();
      return text ? text : '—';
    }

    function formatRatingsSummary(ratingValues) {
      var parts = [];
      ratingCategories.forEach(function(cat) {
        var rating = clampRating(ratingValues && ratingValues[cat.key]);
        if (rating > 0) {
          var stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
          parts.push(cat.label + ': ' + stars + ' (' + rating + '/5)');
        } else {
          parts.push(cat.label + ': ☆☆☆☆☆ (0/5)');
        }
      });
      return parts.join(' | ');
    }

    function openReleaseForm(prefill) {
      var ratingState = {};
      var hoverState = {};
      var initialRatings = prefill && prefill.ratingValues && typeof prefill.ratingValues === 'object'
        ? prefill.ratingValues
        : null;

      ratingCategories.forEach(function(cat) {
        var initial = initialRatings ? clampRating(initialRatings[cat.key]) : 0;
        ratingState[cat.key] = initial;
        hoverState[cat.key] = 0;
      });

      var content = document.createElement('div');
      content.className = 'release-form';

      var infoGrid = document.createElement('div');
      infoGrid.className = 'release-info-grid';
      [
        { label: 'Name of Beneficiary', value: context.beneficiary },
        { label: 'Resource Designation', value: context.designation },
        { label: 'Project', value: context.project },
        { label: 'Team', value: context.team }
      ].forEach(function(field) {
        var fieldEl = document.createElement('div');
        fieldEl.className = 'release-info-field';
        var labelEl = document.createElement('span');
        labelEl.className = 'release-info-label';
        labelEl.textContent = field.label;
        var valueEl = document.createElement('span');
        valueEl.className = 'release-info-value';
        valueEl.textContent = displayValue(field.value);
        fieldEl.appendChild(labelEl);
        fieldEl.appendChild(valueEl);
        infoGrid.appendChild(fieldEl);
      });
      content.appendChild(infoGrid);

      var ratingsSection = document.createElement('div');
      ratingsSection.className = 'release-section';
      var ratingsTitle = document.createElement('div');
      ratingsTitle.className = 'release-section-title';
      ratingsTitle.textContent = 'Ratings';
      ratingsSection.appendChild(ratingsTitle);
      var ratingsHint = document.createElement('div');
      ratingsHint.className = 'release-section-hint';
      ratingsHint.textContent = 'Tap a star (1–5) for each category.';
      ratingsSection.appendChild(ratingsHint);

      var ratingsList = document.createElement('div');
      ratingsList.className = 'release-ratings-list';
      ratingsSection.appendChild(ratingsList);

      var ratingsError = document.createElement('div');
      ratingsError.className = 'release-error';
      ratingsError.textContent = '';
      ratingsSection.appendChild(ratingsError);

      var starRefs = {};

      function updateStars(catKey) {
        var stars = starRefs[catKey] || [];
        var hover = hoverState[catKey] || 0;
        var active = ratingState[catKey] || 0;
        var highlight = hover > 0 ? hover : active;
        stars.forEach(function(star) {
          var value = Number(star.dataset.value);
          var filled = value <= highlight;
          var selected = value <= active;
          star.classList.toggle('filled', filled);
          star.classList.toggle('selected', selected);
          star.setAttribute('aria-pressed', selected ? 'true' : 'false');
        });
      }

      function updateAllStars() {
        ratingCategories.forEach(function(cat) {
          updateStars(cat.key);
        });
      }

      ratingCategories.forEach(function(cat) {
        var rowEl = document.createElement('div');
        rowEl.className = 'release-rating-row';
        rowEl.setAttribute('data-category', cat.key);

        var labelEl = document.createElement('span');
        labelEl.className = 'release-rating-label';
        labelEl.textContent = cat.label;
        rowEl.appendChild(labelEl);

        var starsWrap = document.createElement('div');
        starsWrap.className = 'release-rating-stars';

        var catStars = [];
        for (var i = 1; i <= 5; i++) {
          (function(catKey, catLabel, value) {
            var starBtn = document.createElement('button');
            starBtn.type = 'button';
            starBtn.className = 'release-star';
            starBtn.dataset.value = String(value);
            starBtn.setAttribute('aria-label', catLabel + ' ' + value + ' star' + (value === 1 ? '' : 's'));
            starBtn.innerHTML = '★';
            starBtn.addEventListener('mouseenter', function() {
              hoverState[catKey] = value;
              updateStars(catKey);
            });
            starBtn.addEventListener('mouseleave', function() {
              hoverState[catKey] = 0;
              updateStars(catKey);
            });
            starBtn.addEventListener('focus', function() {
              hoverState[catKey] = value;
              updateStars(catKey);
            });
            starBtn.addEventListener('blur', function() {
              hoverState[catKey] = 0;
              updateStars(catKey);
            });
            starBtn.addEventListener('click', function() {
              ratingState[catKey] = value;
              hoverState[catKey] = 0;
              updateAllStars();
              if (ratingsError.textContent) {
                ratingsError.textContent = '';
              }
            });
            starsWrap.appendChild(starBtn);
            catStars.push(starBtn);
          })(cat.key, cat.label, i);
        }

        starRefs[cat.key] = catStars;
        rowEl.appendChild(starsWrap);
        ratingsList.appendChild(rowEl);
      });

      updateAllStars();

      var reviewSection = document.createElement('div');
      reviewSection.className = 'release-section';
      var reviewLabel = document.createElement('label');
      reviewLabel.className = 'release-section-title';
      reviewLabel.setAttribute('for', 'releaseReviewInput');
      reviewLabel.textContent = 'Review';
      reviewSection.appendChild(reviewLabel);
      var reviewHint = document.createElement('div');
      reviewHint.className = 'release-section-hint';
      reviewHint.textContent = 'Minimum 10 letters.';
      reviewSection.appendChild(reviewHint);
      var reviewInput = document.createElement('textarea');
      reviewInput.id = 'releaseReviewInput';
      reviewInput.className = 'release-review-input';
      reviewInput.placeholder = 'Share a brief review…';
      reviewInput.value = prefill && prefill.review ? prefill.review : '';
      reviewSection.appendChild(reviewInput);
      var reviewError = document.createElement('div');
      reviewError.className = 'release-error';
      reviewError.textContent = '';
      reviewSection.appendChild(reviewError);

      reviewInput.addEventListener('input', function() {
        if (reviewError.textContent && countNonSpace(reviewInput.value) >= 10) {
          reviewError.textContent = '';
        }
      });

      content.appendChild(ratingsSection);
      content.appendChild(reviewSection);

      function validateForm() {
        var missing = ratingCategories.filter(function(cat) {
          return (ratingState[cat.key] || 0) <= 0;
        });
        if (missing.length) {
          ratingsError.textContent = 'Please provide a rating for all categories.';
        } else {
          ratingsError.textContent = '';
        }

        var reviewValue = reviewInput.value || '';
        if (countNonSpace(reviewValue) < 10) {
          reviewError.textContent = 'Review must be at least 10 letters.';
        } else {
          reviewError.textContent = '';
        }

        if (missing.length) {
          var firstKey = missing[0].key;
          var focusStars = starRefs[firstKey];
          if (focusStars && focusStars[0]) {
            focusStars[0].focus();
          }
          return { ok: false };
        }

        if (countNonSpace(reviewValue) < 10) {
          reviewInput.focus();
          return { ok: false };
        }

        var cleanedReview = reviewValue.trim();
        var ratingValues = {};
        ratingCategories.forEach(function(cat) {
          ratingValues[cat.key] = ratingState[cat.key] || 0;
        });

        return {
          ok: true,
          review: cleanedReview,
          ratingValues: ratingValues,
          summary: formatRatingsSummary(ratingValues)
        };
      }

      var capturedResult = null;

      showConfirmationModal({
        title: 'Release beneficiary',
        message: 'Complete the ratings and add a review before releasing.',
        content: content,
        buttons: [
          { text: 'Cancel', value: 'cancel', role: 'cancel', variant: 'secondary', feedback: false },
          { text: 'Submit Review', value: 'submit', role: 'confirm', variant: 'primary', feedback: false }
        ],
        onSelect: function(value) {
          if (value === 'submit') {
            var result = validateForm();
            if (!result.ok) {
              return false;
            }
            capturedResult = result;
          } else {
            capturedResult = null;
          }
          return true;
        }
      }).then(function(choice) {
        if (choice === 'submit' && capturedResult) {
          showConfirmationModal({
            title: 'Confirm release',
            message: 'Are you sure you want to release ' + subject + ' with the submitted review?',
            buttons: [
              { text: 'Yes, Release', value: true, role: 'confirm', variant: 'primary', feedback: true, successText: '✓ Releasing' },
              { text: 'No, Go Back', value: false, role: 'cancel', variant: 'secondary', feedback: false }
            ]
          }).then(function(confirmed) {
            if (confirmed) {
              var releaseContext = {};
              for (var key in context) {
                if (Object.prototype.hasOwnProperty.call(context, key)) {
                  releaseContext[key] = context[key];
                }
              }
              releaseContext.releaseReview = capturedResult.review;
              releaseContext.releaseRatings = capturedResult.summary;
              releaseContext.releaseRatingValues = capturedResult.ratingValues;
              submitRelease(row, releaseContext);
            } else {
              openReleaseForm(capturedResult);
            }
          }).catch(function(err) {
            if (err && err !== false) {
              console.error('Release confirmation dialog failed', err);
            }
          });
        }
      }).catch(function(err) {
        if (err && err !== false) {
          console.error('Release form dialog failed', err);
        }
      });
    }

    openReleaseForm();
  }

  var addBeneficiaryPicker = (function() {
    var overlay = document.getElementById('beneficiaryPickerModal');
    if (!overlay) {
      return {
        open: function() {
          alert('The Add Existing Beneficiary dialog is unavailable. Please reload the page.');
        },
        close: function() {}
      };
    }

    var rowsTbody = document.getElementById('beneficiaryPickerRows');
    var emptyEl = document.getElementById('beneficiaryPickerEmpty');
    var searchInput = document.getElementById('beneficiaryPickerSearch');
    var selectAll = document.getElementById('beneficiaryPickerSelectAll');
    var applyBtn = document.getElementById('beneficiaryPickerApply');
    var cancelBtn = document.getElementById('beneficiaryPickerCancel');
    var closeBtn = overlay.querySelector('.beneficiary-picker-close');
    var statusEl = document.getElementById('beneficiaryPickerStatus');
    var countEl = document.getElementById('beneficiaryPickerCount');
    var subtitleEl = document.getElementById('beneficiaryPickerSubtitle');

    var allItems = [];
    var filteredItems = [];
    var selectedKeys = new Set();
    var currentContext = { project: '', team: '' };
    var searchTimer = null;
    var loading = false;
    var releasedCount = null;
    var countListeners = new Set();
    var inflightCountPromise = null;

    function notifyCountListeners() {
      countListeners.forEach(function(listener) {
        try {
          listener(releasedCount);
        } catch (err) {
          console.error('beneficiaryPicker count listener failed', err);
        }
      });
    }

    function setReleasedCount(countValue) {
      var next = coerceCount(countValue);
      releasedCount = next;
      window.FRTZ = window.FRTZ || {};
      window.FRTZ.releasedBeneficiaryCount = releasedCount;
      try {
        if (typeof window.updateExistingBeneficiaryButton === 'function') {
          window.updateExistingBeneficiaryButton(releasedCount);
        }
      } catch (err) {
        console.error('updateExistingBeneficiaryButton failed', err);
      }
      notifyCountListeners();
    }

    function onReleasedCountChange(listener) {
      if (typeof listener !== 'function') {
        return function() {};
      }
      countListeners.add(listener);
      try {
        listener(releasedCount);
      } catch (err) {
        console.error('initial count listener call failed', err);
      }
      return function() {
        countListeners.delete(listener);
      };
    }

    function updateStatus(message, tone) {
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('error', 'success');
      if (tone) statusEl.classList.add(tone);
    }

    function refreshReleasedCount(projectOverride, teamOverride) {
      if (!(window.google && google.script && google.script.run)) {
        return Promise.resolve(null);
      }

      var project = typeof projectOverride === 'string' ? projectOverride : currentContext.project;
      var team = typeof teamOverride === 'string' ? teamOverride : currentContext.team;

      if (inflightCountPromise) {
        return inflightCountPromise;
      }

      inflightCountPromise = new Promise(function(resolve) {
        google.script.run
          .withSuccessHandler(function(res) {
            inflightCountPromise = null;
            if (res && res.ok !== false) {
              if (typeof res.targetProject === 'string') currentContext.project = res.targetProject;
              if (typeof res.targetTeam === 'string') currentContext.team = res.targetTeam;
              var total = (typeof res.total === 'number' && isFinite(res.total))
                ? res.total
                : (Array.isArray(res.beneficiaries) ? res.beneficiaries.length : null);
              setReleasedCount(total);
            } else {
              setReleasedCount(null);
            }
            resolve(res || null);
          })
          .withFailureHandler(function(err) {
            inflightCountPromise = null;
            console.error('refreshReleasedBeneficiaryCount failed:', err);
            setReleasedCount(null);
            resolve(null);
          })
          .getReleasedBeneficiariesForInduction(project, team);
      });

      return inflightCountPromise;
    }

    function setLoading(flag, message) {
      loading = !!flag;
      overlay.classList.toggle('loading', loading);
      if (message) {
        updateStatus(message);
      }
      if (loading && applyBtn) {
        applyBtn.disabled = true;
      }
    }

    function updateSubtitle(projectOverride, teamOverride) {
      if (!subtitleEl) return;
      var proj = typeof projectOverride === 'string' ? projectOverride : currentContext.project;
      var team = typeof teamOverride === 'string' ? teamOverride : currentContext.team;
      if (!proj) {
        subtitleEl.textContent = 'Project not detected for this row.';
        return;
      }
      var parts = ['Project: ' + proj];
      parts.push('Team: ' + (team ? team : 'Unassigned'));
      subtitleEl.textContent = parts.join(' • ');
    }

    function showEmpty(message) {
      if (!emptyEl) return;
      emptyEl.textContent = message || 'No released beneficiaries found.';
      emptyEl.hidden = false;
    }

    function hideEmpty() {
      if (emptyEl) emptyEl.hidden = true;
    }

    function updateCounts() {
      if (!countEl) return;
      var total = allItems.length;
      var visible = filteredItems.length;
      if (!total && !visible) {
        countEl.textContent = '';
        return;
      }
      if (visible === total) {
        countEl.textContent = visible === 1 ? 'Showing 1 beneficiary' : 'Showing ' + visible + ' beneficiaries';
      } else {
        countEl.textContent = 'Showing ' + visible + ' of ' + total + ' beneficiaries';
      }
    }

    function updateApplyState() {
      if (!applyBtn) return;
      var count = selectedKeys.size;
      applyBtn.disabled = loading || !count;
      applyBtn.textContent = count ? ('Add Selected (' + count + ')') : 'Add Selected';
    }

    function updateSelectAllState() {
      if (!selectAll) return;
      if (loading || !filteredItems.length) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = loading || !filteredItems.length;
        return;
      }
      var selectedInView = 0;
      for (var i = 0; i < filteredItems.length; i++) {
        var item = filteredItems[i];
        if (item && selectedKeys.has(item.beneficiaryKey)) {
          selectedInView++;
        }
      }
      selectAll.disabled = loading;
      if (selectedInView === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (selectedInView === filteredItems.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    function normalizeHistoryValues(values) {
      var entries = [];
      if (Array.isArray(values)) {
        for (var i = 0; i < values.length && entries.length < 3; i++) {
          entries.push(values[i]);
        }
      } else if (values != null && values !== '') {
        entries.push(values);
      }
      return entries;
    }

    function historySearchText(values) {
      return normalizeHistoryValues(values).map(function(value) {
        return value == null ? '' : String(value);
      }).join(' ');
    }

    function renderRemarkHistoryCell(cell, values) {
      if (!cell) return;
      cell.textContent = '';
      cell.classList.add('picker-history');
      var entries = normalizeHistoryValues(values);
      if (!entries.length) {
        var emptyEl = document.createElement('div');
        emptyEl.className = 'picker-history-empty';
        emptyEl.textContent = '—';
        cell.appendChild(emptyEl);
        return;
      }
      var listEl = document.createElement('div');
      listEl.className = 'picker-history-list';
      entries.forEach(function(value, idx) {
        var itemEl = document.createElement('div');
        itemEl.className = 'picker-history-item';
        var indexEl = document.createElement('span');
        indexEl.className = 'picker-history-index';
        indexEl.textContent = (idx + 1) + '.';
        itemEl.appendChild(indexEl);
        var textEl = document.createElement('span');
        var text = value == null ? '' : String(value).trim();
        if (!text) {
          textEl.className = 'picker-history-empty';
          textEl.textContent = '—';
        } else {
          textEl.textContent = text;
        }
        itemEl.appendChild(textEl);
        listEl.appendChild(itemEl);
      });
      cell.appendChild(listEl);
    }

    function parseRatingEntry(value) {
      if (value == null) return null;
      var original = String(value).trim();
      if (!original) return null;
      var label = '';
      var content = original;
      var colonIndex = content.indexOf(':');
      if (colonIndex >= 0) {
        label = content.slice(0, colonIndex).trim();
        content = content.slice(colonIndex + 1).trim();
      }

      var ratingValue = null;
      var ratingOutOf = 5;
      var fractionMatch = content.match(/(-?\d+(?:\.\d+)?)\s*\/\s*(\d+(?:\.\d+)?)/);
      if (fractionMatch) {
        ratingValue = parseFloat(fractionMatch[1]);
        ratingOutOf = parseFloat(fractionMatch[2]) || 5;
        content = (content.slice(0, fractionMatch.index) + content.slice(fractionMatch.index + fractionMatch[0].length)).trim();
      } else {
        var numberMatch = content.match(/(-?\d+(?:\.\d+)?)/);
        if (numberMatch) {
          ratingValue = parseFloat(numberMatch[1]);
          content = (content.slice(0, numberMatch.index) + content.slice(numberMatch.index + numberMatch[0].length)).trim();
        }
      }

      if ((ratingValue == null || !isFinite(ratingValue)) && /★/.test(original)) {
        var starCount = (original.match(/★/g) || []).length;
        if (starCount > 0) {
          ratingValue = starCount;
          ratingOutOf = Math.max(ratingOutOf, 5, starCount);
        }
      }

      if (!isFinite(ratingValue)) ratingValue = null;
      if (!isFinite(ratingOutOf) || ratingOutOf <= 0) ratingOutOf = 5;

      content = content.replace(/★/g, ' ');
      content = content.replace(/☆/g, ' ');
      content = content.replace(/\(\s*\)/g, ' ');
      var extra = content.replace(/\s+/g, ' ').trim();
      if (extra.charAt(0) === ':') {
        extra = extra.slice(1).trim();
      }
      if (extra === '-' || extra === '–') extra = '';

      return {
        label: label,
        value: ratingValue,
        outOf: ratingOutOf,
        extra: extra,
        original: original
      };
    }

    function ratingClassForStars(starCount) {
      if (!isFinite(starCount)) return '';
      if (starCount < 3) return 'rating-low';
      if (starCount === 3) return 'rating-mid';
      if (starCount > 3) return 'rating-high';
      return '';
    }

    function formatRatingValue(value, outOf) {
      if (!isFinite(value)) return '';
      var formatted = (Math.abs(value % 1) < 0.001) ? String(Math.round(value)) : value.toFixed(1);
      var total = (!isFinite(outOf) || outOf <= 0) ? 5 : outOf;
      var totalText = (Math.abs(total % 1) < 0.001) ? String(Math.round(total)) : total.toFixed(1);
      return formatted + '/' + totalText;
    }

    function renderRatingHistoryCell(cell, values) {
      if (!cell) return;
      cell.textContent = '';
      cell.classList.add('picker-history', 'picker-rating');
      var entries = normalizeHistoryValues(values);
      if (!entries.length) {
        var emptyEl = document.createElement('div');
        emptyEl.className = 'picker-history-empty';
        emptyEl.textContent = '—';
        cell.appendChild(emptyEl);
        return;
      }
      var listEl = document.createElement('div');
      listEl.className = 'picker-history-list';
      entries.forEach(function(value, idx) {
        var itemEl = document.createElement('div');
        itemEl.className = 'picker-history-item picker-rating-item';
        var indexEl = document.createElement('span');
        indexEl.className = 'picker-history-index';
        indexEl.textContent = (idx + 1) + '.';
        itemEl.appendChild(indexEl);

        var contentEl = document.createElement('div');
        contentEl.className = 'picker-rating-content';
        var parsed = parseRatingEntry(value);

        if (!parsed) {
          var fallback = document.createElement('span');
          var fallbackText = value == null ? '' : String(value).trim();
          if (!fallbackText) {
            fallback.className = 'picker-history-empty';
            fallback.textContent = '—';
          } else {
            fallback.textContent = fallbackText;
          }
          contentEl.appendChild(fallback);
        } else if (parsed.value != null) {
          var normalized = parsed.outOf ? (parsed.value / parsed.outOf) * 5 : parsed.value;
          if (!isFinite(normalized)) normalized = parsed.value;
          if (!isFinite(normalized)) normalized = 0;
          if (normalized < 0) normalized = 0;
          if (normalized > 5) normalized = 5;
          var starCount = Math.round(normalized);
          if (!isFinite(starCount)) starCount = 0;
          starCount = Math.max(0, Math.min(5, starCount));
          var starsText = '';
          for (var s = 0; s < starCount; s++) starsText += '★';
          for (var e = starCount; e < 5; e++) starsText += '☆';

          var headerEl = document.createElement('div');
          headerEl.className = 'picker-rating-header';
          if (parsed.label) {
            var labelEl = document.createElement('span');
            labelEl.className = 'picker-rating-label';
            labelEl.textContent = parsed.label + ':';
            headerEl.appendChild(labelEl);
          }

          var starsEl = document.createElement('span');
          var ratingClass = ratingClassForStars(starCount);
          starsEl.className = 'picker-rating-stars' + (ratingClass ? (' ' + ratingClass) : '');
          starsEl.textContent = starsText;
          headerEl.appendChild(starsEl);

          var valueEl = document.createElement('span');
          valueEl.className = 'picker-rating-value';
          valueEl.textContent = '(' + formatRatingValue(parsed.value, parsed.outOf) + ')';
          headerEl.appendChild(valueEl);

          contentEl.appendChild(headerEl);

          if (parsed.extra) {
            var extraEl = document.createElement('span');
            extraEl.className = 'picker-rating-extra';
            extraEl.textContent = parsed.extra;
            contentEl.appendChild(extraEl);
          }
        } else {
          if (parsed.extra) {
            if (parsed.label) {
              var labelOnly = document.createElement('span');
              labelOnly.className = 'picker-rating-label';
              labelOnly.textContent = parsed.label + ':';
              contentEl.appendChild(labelOnly);
            }
            var extraOnly = document.createElement('span');
            extraOnly.className = 'picker-rating-extra';
            extraOnly.textContent = parsed.extra;
            contentEl.appendChild(extraOnly);
          } else {
            var fallbackOriginal = document.createElement('span');
            fallbackOriginal.textContent = parsed.original;
            contentEl.appendChild(fallbackOriginal);
          }
        }

        itemEl.appendChild(contentEl);
        listEl.appendChild(itemEl);
      });
      cell.appendChild(listEl);
    }

    function renderRows(list) {
      if (!rowsTbody) return;
      rowsTbody.innerHTML = '';
      if (!Array.isArray(list) || !list.length) {
        showEmpty('No released beneficiaries match your filters.');
        updateSelectAllState();
        return;
      }
      hideEmpty();
      for (var i = 0; i < list.length; i++) {
        var item = list[i];
        if (!item) continue;
        var tr = document.createElement('tr');
        if (selectedKeys.has(item.beneficiaryKey)) {
          tr.classList.add('selected');
        }
        var tdCheck = document.createElement('td');
        tdCheck.className = 'picker-checkbox';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.key = item.beneficiaryKey || '';
        cb.checked = selectedKeys.has(item.beneficiaryKey);
        cb.disabled = loading;
        cb.setAttribute('aria-label', 'Select ' + (item.beneficiary || 'beneficiary'));
        tdCheck.appendChild(cb);
        tr.appendChild(tdCheck);

        var tdIndex = document.createElement('td');
        tdIndex.textContent = String(i + 1);
        tr.appendChild(tdIndex);

        var tdBeneficiary = document.createElement('td');
        tdBeneficiary.textContent = item.beneficiary || '';
        tr.appendChild(tdBeneficiary);

        var tdDesignation = document.createElement('td');
        tdDesignation.textContent = item.designation || '—';
        tr.appendChild(tdDesignation);

        var tdProject = document.createElement('td');
        tdProject.textContent = item.project || '—';
        tr.appendChild(tdProject);

        var tdTeam = document.createElement('td');
        tdTeam.textContent = item.team || '—';
        tr.appendChild(tdTeam);

        var tdAccount = document.createElement('td');
        tdAccount.textContent = item.accountHolder || '—';
        tr.appendChild(tdAccount);

        var tdIdle = document.createElement('td');
        tdIdle.className = 'numeric';
        var idleText = (typeof item.idleDays === 'number' && item.idleDays >= 0) ? String(item.idleDays) : '—';
        tdIdle.textContent = idleText;
        if (item.releasedAt) {
          var releaseDate = new Date(item.releasedAt);
          if (!isNaN(releaseDate.getTime())) {
            tdIdle.title = 'Released on ' + releaseDate.toLocaleString();
          }
        }
        tr.appendChild(tdIdle);

        var tdNationality = document.createElement('td');
        tdNationality.textContent = item.nationality || '—';
        tr.appendChild(tdNationality);

        var tdRemarks = document.createElement('td');
        renderRemarkHistoryCell(tdRemarks, item.lastRemarks);
        tr.appendChild(tdRemarks);

        var tdRatings = document.createElement('td');
        renderRatingHistoryCell(tdRatings, item.lastRatings);
        tr.appendChild(tdRatings);

        rowsTbody.appendChild(tr);
      }
      updateSelectAllState();
    }

    function applyFilterNow() {
      var term = searchInput ? searchInput.value.trim().toLowerCase() : '';
      if (!term) {
        filteredItems = allItems.slice();
      } else {
        filteredItems = allItems.filter(function(item) {
          if (!item) return false;
          var remarkText = historySearchText(item.lastRemarks);
          var ratingText = historySearchText(item.lastRatings);
          return [
            item.beneficiary,
            item.designation,
            item.project,
            item.team,
            item.accountHolder,
            item.nationality,
            remarkText,
            ratingText
          ].some(function(part) {
            return String(part || '').toLowerCase().indexOf(term) >= 0;
          });
        });
      }
      renderRows(filteredItems);
      updateCounts();
      updateApplyState();
    }

    function scheduleFilter() {
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(applyFilterNow, 120);
    }

    function namesForKeys(keys) {
      return keys.map(function(key) {
        var match = allItems.find(function(item) {
          return item && item.beneficiaryKey === key;
        });
        return match && match.beneficiary ? match.beneficiary : key;
      }).filter(Boolean);
    }

    function executeAdd(keys) {
      if (!(window.google && google.script && google.script.run)) {
        updateStatus('Beneficiary updates are only available inside the Google Sheets environment.', 'error');
        return;
      }
      setLoading(true, 'Adding beneficiaries…');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoading(false);
          if (!res || res.ok === false) {
            updateStatus(res && res.error ? res.error : 'Failed to induct beneficiaries.', 'error');
            updateApplyState();
            return;
          }

          if (typeof res.project === 'string') currentContext.project = res.project;
          if (typeof res.team === 'string') currentContext.team = res.team;
          updateSubtitle();

          var addedKeys = Array.isArray(res.addedKeys) ? new Set(res.addedKeys) : new Set(keys);
          if (addedKeys.size) {
            allItems = allItems.filter(function(item) {
              return !(item && addedKeys.has(item.beneficiaryKey));
            });
          }

          filteredItems = allItems.slice();
          selectedKeys.clear();
          applyFilterNow();

          if (res && typeof res.remaining === 'number' && isFinite(res.remaining)) {
            setReleasedCount(res.remaining);
          } else {
            setReleasedCount(allItems.length);
          }

          var addedCount = res.inserted || addedKeys.size || 0;
          var statusMsg = addedCount
            ? ('Added ' + addedCount + ' beneficiary' + (addedCount === 1 ? '' : 'ies') + ' to ' + (currentContext.project || 'project') + (currentContext.team ? ' • ' + currentContext.team : '') + '.')
            : 'No beneficiaries were added.';

          if (Array.isArray(res.skipped) && res.skipped.length) {
            var skippedKeys = res.skipped.map(function(info) { return info && info.key; }).filter(Boolean);
            var skippedNames = namesForKeys(skippedKeys);
            if (skippedNames.length) {
              statusMsg += ' Skipped: ' + skippedNames.join(', ') + '.';
            }
          }

          updateStatus(statusMsg, addedCount ? 'success' : null);
          updateApplyState();

          if (res && Array.isArray(res.beneficiaries) && res.beneficiaries.length && typeof window.appendRowsFromBeneficiaries === 'function') {
            try {
              window.appendRowsFromBeneficiaries(res.beneficiaries);
            } catch (appendErr) {
              console.warn('appendRowsFromBeneficiaries failed:', appendErr);
            }
          }

          try {
            document.dispatchEvent(new CustomEvent('frtz:beneficiary-inducted', {
              detail: {
                project: currentContext.project,
                team: currentContext.team,
                beneficiaries: res && res.beneficiaries ? res.beneficiaries : []
              }
            }));
          } catch (_eventErr) {}
        })
        .withFailureHandler(function(err) {
          setLoading(false);
          console.error('inductReleasedBeneficiaries failed:', err);
          updateStatus('Failed to induct beneficiaries. Please try again.', 'error');
          updateApplyState();
        })
        .inductReleasedBeneficiaries({
          project: currentContext.project,
          team: currentContext.team,
          beneficiaryKeys: keys
        });
    }

    function performAdd() {
      if (loading || !selectedKeys.size) return;
      if (!currentContext.project) {
        updateStatus('Project information is missing for this row.', 'error');
        return;
      }
      var keys = Array.from(selectedKeys);
      var names = namesForKeys(keys);
      var targetLabel = currentContext.project + (currentContext.team ? ' • ' + currentContext.team : '');
      var message = names.length === 1
        ? 'Are you sure you want to induct ' + names[0] + ' into ' + targetLabel + '?'
        : 'Are you sure you want to induct ' + names.length + ' beneficiaries into ' + targetLabel + '?';

      showConfirmationModal({
        title: 'Induct beneficiaries?',
        message: message,
        yesText: 'Yes, Induct',
        noText: 'Cancel'
      }).then(function(confirmed) {
        if (!confirmed) return;
        executeAdd(keys);
      });
    }

    function close() {
      overlay.classList.remove('show');
      overlay.classList.remove('loading');
      if (searchTimer) {
        clearTimeout(searchTimer);
        searchTimer = null;
      }
      document.removeEventListener('keydown', onKeydown);
    }

    function open(context) {
      context = context || {};
      currentContext.project = context.project ? String(context.project).trim() : '';
      currentContext.team = context.team ? String(context.team).trim() : '';
      selectedKeys.clear();
      updateStatus('');
      updateSubtitle();
      hideEmpty();
      if (searchInput) searchInput.value = '';
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = true;
      }
      allItems = [];
      filteredItems = [];
      renderRows(filteredItems);
      updateCounts();
      updateApplyState();

      overlay.classList.add('show');
      setTimeout(function() {
        try { if (searchInput) searchInput.focus(); } catch (_e) {}
      }, 120);
      document.addEventListener('keydown', onKeydown);

      if (!(window.google && google.script && google.script.run)) {
        updateStatus('Beneficiary picker is only available inside the Google Sheets web app.', 'error');
        showEmpty('Open this sheet in the Google Sheets web app to induct released beneficiaries.');
        return;
      }

      setLoading(true, 'Loading released beneficiaries…');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoading(false);
          if (!res || res.ok === false) {
            updateStatus(res && res.error ? res.error : 'Unable to load released beneficiaries.', 'error');
            showEmpty('No released beneficiaries found.');
            setReleasedCount(null);
            allItems = [];
            filteredItems = [];
            updateCounts();
            updateApplyState();
            updateSelectAllState();
            return;
          }

          if (typeof res.targetProject === 'string') currentContext.project = res.targetProject;
          if (typeof res.targetTeam === 'string') currentContext.team = res.targetTeam;
          updateSubtitle();

          var total = (typeof res.total === 'number' && isFinite(res.total))
            ? res.total
            : (Array.isArray(res.beneficiaries) ? res.beneficiaries.length : null);
          setReleasedCount(total);

          allItems = Array.isArray(res.beneficiaries) ? res.beneficiaries : [];
          filteredItems = allItems.slice();
          applyFilterNow();
          if (!allItems.length) {
            showEmpty('No released beneficiaries are available right now.');
          }
        })
        .withFailureHandler(function(err) {
          setLoading(false);
          console.error('getReleasedBeneficiariesForInduction failed:', err);
          updateStatus('Unable to load released beneficiaries. Please try again.', 'error');
          showEmpty('No released beneficiaries found.');
          setReleasedCount(null);
          allItems = [];
          filteredItems = [];
          updateCounts();
          updateApplyState();
          updateSelectAllState();
        })
        .getReleasedBeneficiariesForInduction(currentContext.project, currentContext.team);
    }

    function onKeydown(e) {
      if (e.key === 'Escape' && overlay.classList.contains('show')) {
        close();
      }
    }

    if (cancelBtn) cancelBtn.addEventListener('click', close);
    if (closeBtn) closeBtn.addEventListener('click', close);
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) close();
    });

    if (searchInput) searchInput.addEventListener('input', scheduleFilter);

    if (selectAll) {
      selectAll.addEventListener('change', function() {
        if (loading) return;
        var checked = !!selectAll.checked;
        filteredItems.forEach(function(item) {
          if (!item || !item.beneficiaryKey) return;
          if (checked) {
            selectedKeys.add(item.beneficiaryKey);
          } else {
            selectedKeys.delete(item.beneficiaryKey);
          }
        });
        if (rowsTbody) {
          Array.prototype.forEach.call(rowsTbody.querySelectorAll('input[type="checkbox"][data-key]'), function(box) {
            box.checked = checked;
            var row = box.closest('tr');
            if (row) row.classList.toggle('selected', box.checked);
          });
        }
        selectAll.indeterminate = false;
        updateApplyState();
      });
    }

    if (rowsTbody) {
      rowsTbody.addEventListener('change', function(e) {
        var cb = e.target.closest('input[type="checkbox"][data-key]');
        if (!cb || loading) return;
        var key = cb.dataset.key || '';
        if (!key) return;
        if (cb.checked) {
          selectedKeys.add(key);
        } else {
          selectedKeys.delete(key);
        }
        var row = cb.closest('tr');
        if (row) row.classList.toggle('selected', cb.checked);
        updateApplyState();
        updateSelectAllState();
      });

      rowsTbody.addEventListener('click', function(e) {
        var row = e.target.closest('tr');
        if (!row || loading) return;
        var cb = row.querySelector('input[type="checkbox"][data-key]');
        if (!cb || e.target === cb) return;
        cb.checked = !cb.checked;
        cb.dispatchEvent(new Event('change', { bubbles: true }));
      });
    }

    if (applyBtn) applyBtn.addEventListener('click', performAdd);

    window.FRTZ = window.FRTZ || {};
    window.FRTZ.onReleasedBeneficiaryCountChange = onReleasedCountChange;
    window.FRTZ.getReleasedBeneficiaryCount = function() { return releasedCount; };
    window.FRTZ.refreshReleasedBeneficiaryCount = refreshReleasedCount;

    return {
      open: open,
      close: close
    };
  })();

  function coerceCount(value) {
    if (typeof value === 'number' && isFinite(value) && value >= 0) {
      return Math.floor(value);
    }
    if (typeof value === 'string' && value.trim() !== '') {
      var parsed = Number(value);
      if (Number.isFinite(parsed) && parsed >= 0) {
        return Math.floor(parsed);
      }
    }
    return null;
  }

  function openAddBeneficiaryModal(context) {
    try {
      addBeneficiaryPicker.open(context || {});
    } catch (err) {
      console.error('openAddBeneficiaryModal failed:', err);
      alert('Unable to open the Add Existing Beneficiary dialog. Please try again.');
    }
  }

  function formatExistingBeneficiaryLabel(count) {
    var normalized = coerceCount(count);
    if (normalized === null) {
      return 'Add Existing Beneficiary [—]';
    }
    return 'Add Existing Beneficiary [' + normalized + ']';
  }

  function updateExistingBeneficiaryButton(count) {
    var text = formatExistingBeneficiaryLabel(count);
    var normalized = coerceCount(count);
    if (typeof window.updateConfirmationButton === 'function') {
      window.updateConfirmationButton('add-existing', {
        text: text,
        dataset: { releasedCount: normalized != null ? normalized : '' }
      });
    } else {
      var btn = document.querySelector('.confirmation-buttons button[data-button-id="add-existing"]');
      if (btn) {
        btn.textContent = text;
        btn.dataset.originalText = text;
        if (normalized == null) {
          delete btn.dataset.releasedCount;
        } else {
          btn.dataset.releasedCount = normalized;
        }
      }
    }
  }

  window.updateExistingBeneficiaryButton = updateExistingBeneficiaryButton;

  function triggerAddNewBeneficiary(context) {
    try {
      var detail = context && typeof context === 'object' ? context : {};
      document.dispatchEvent(new CustomEvent('frtz:add-new-beneficiary', { detail: detail }));
    } catch (err) {
      console.error('dispatch add-new-beneficiary event failed', err);
    }

    if (window.FRTZ && typeof window.FRTZ.openNewBeneficiaryDialog === 'function') {
      window.FRTZ.openNewBeneficiaryDialog(context || {});
      return;
    }

    if (window.FRTZ && window.FRTZ.addRowBtn) {
      try {
        window.FRTZ.addRowBtn.click();
        return;
      } catch (errClick) {
        console.error('click addRowBtn failed', errClick);
      }
    }

    alert('Please use the Add Rows button to add a new beneficiary.');
  }

  var addBeneficiaryPicker = (function() {
    var overlay = document.getElementById('beneficiaryPickerModal');
    if (!overlay) {
      return {
        open: function() {
          alert('The Add Existing Beneficiary dialog is unavailable. Please reload the page.');
        },
        close: function() {}
      };
    }

    var rowsTbody = document.getElementById('beneficiaryPickerRows');
    var emptyEl = document.getElementById('beneficiaryPickerEmpty');
    var searchInput = document.getElementById('beneficiaryPickerSearch');
    var selectAll = document.getElementById('beneficiaryPickerSelectAll');
    var applyBtn = document.getElementById('beneficiaryPickerApply');
    var cancelBtn = document.getElementById('beneficiaryPickerCancel');
    var closeBtn = overlay.querySelector('.beneficiary-picker-close');
    var statusEl = document.getElementById('beneficiaryPickerStatus');
    var countEl = document.getElementById('beneficiaryPickerCount');
    var subtitleEl = document.getElementById('beneficiaryPickerSubtitle');

    var allItems = [];
    var filteredItems = [];
    var selectedKeys = new Set();
    var currentContext = { project: '', team: '' };
    var searchTimer = null;
    var loading = false;
    var releasedCount = null;
    var countListeners = new Set();
    var inflightCountPromise = null;

    function notifyCountListeners() {
      countListeners.forEach(function(listener) {
        try {
          listener(releasedCount);
        } catch (err) {
          console.error('beneficiaryPicker count listener failed', err);
        }
      });
    }

    function setReleasedCount(countValue) {
      var next = coerceCount(countValue);
      releasedCount = next;
      window.FRTZ = window.FRTZ || {};
      window.FRTZ.releasedBeneficiaryCount = releasedCount;
      try {
        if (typeof window.updateExistingBeneficiaryButton === 'function') {
          window.updateExistingBeneficiaryButton(releasedCount);
        }
      } catch (err) {
        console.error('updateExistingBeneficiaryButton failed', err);
      }
      notifyCountListeners();
    }

    function onReleasedCountChange(listener) {
      if (typeof listener !== 'function') {
        return function() {};
      }
      countListeners.add(listener);
      try {
        listener(releasedCount);
      } catch (err) {
        console.error('initial count listener call failed', err);
      }
      return function() {
        countListeners.delete(listener);
      };
    }

    function updateStatus(message, tone) {
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('error', 'success');
      if (tone) statusEl.classList.add(tone);
    }

    function refreshReleasedCount(projectOverride, teamOverride) {
      if (!(window.google && google.script && google.script.run)) {
        return Promise.resolve(null);
      }

      var project = typeof projectOverride === 'string' ? projectOverride : currentContext.project;
      var team = typeof teamOverride === 'string' ? teamOverride : currentContext.team;

      if (inflightCountPromise) {
        return inflightCountPromise;
      }

      inflightCountPromise = new Promise(function(resolve) {
        google.script.run
          .withSuccessHandler(function(res) {
            inflightCountPromise = null;
            if (res && res.ok !== false) {
              if (typeof res.targetProject === 'string') currentContext.project = res.targetProject;
              if (typeof res.targetTeam === 'string') currentContext.team = res.targetTeam;
              var total = (typeof res.total === 'number' && isFinite(res.total))
                ? res.total
                : (Array.isArray(res.beneficiaries) ? res.beneficiaries.length : null);
              setReleasedCount(total);
            } else {
              setReleasedCount(null);
            }
            resolve(res || null);
          })
          .withFailureHandler(function(err) {
            inflightCountPromise = null;
            console.error('refreshReleasedBeneficiaryCount failed:', err);
            setReleasedCount(null);
            resolve(null);
          })
          .getReleasedBeneficiariesForInduction(project, team);
      });

      return inflightCountPromise;
    }

    function setLoading(flag, message) {
      loading = !!flag;
      overlay.classList.toggle('loading', loading);
      if (message) {
        updateStatus(message);
      }
      if (loading && applyBtn) {
        applyBtn.disabled = true;
      }
    }

    function updateSubtitle(projectOverride, teamOverride) {
      if (!subtitleEl) return;
      var proj = typeof projectOverride === 'string' ? projectOverride : currentContext.project;
      var team = typeof teamOverride === 'string' ? teamOverride : currentContext.team;
      if (!proj) {
        subtitleEl.textContent = 'Project not detected for this row.';
        return;
      }
      var parts = ['Project: ' + proj];
      parts.push('Team: ' + (team ? team : 'Unassigned'));
      subtitleEl.textContent = parts.join(' • ');
    }

    function showEmpty(message) {
      if (!emptyEl) return;
      emptyEl.textContent = message || 'No released beneficiaries found.';
      emptyEl.hidden = false;
    }

    function hideEmpty() {
      if (emptyEl) emptyEl.hidden = true;
    }

    function updateCounts() {
      if (!countEl) return;
      var total = allItems.length;
      var visible = filteredItems.length;
      if (!total && !visible) {
        countEl.textContent = '';
        return;
      }
      if (visible === total) {
        countEl.textContent = visible === 1 ? 'Showing 1 beneficiary' : 'Showing ' + visible + ' beneficiaries';
      } else {
        countEl.textContent = 'Showing ' + visible + ' of ' + total + ' beneficiaries';
      }
    }

    function updateApplyState() {
      if (!applyBtn) return;
      var count = selectedKeys.size;
      applyBtn.disabled = loading || !count;
      applyBtn.textContent = count ? ('Add Selected (' + count + ')') : 'Add Selected';
    }

    function updateSelectAllState() {
      if (!selectAll) return;
      if (loading || !filteredItems.length) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = loading || !filteredItems.length;
        return;
      }
      var selectedInView = 0;
      for (var i = 0; i < filteredItems.length; i++) {
        var item = filteredItems[i];
        if (item && selectedKeys.has(item.beneficiaryKey)) {
          selectedInView++;
        }
      }
      selectAll.disabled = loading;
      if (selectedInView === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (selectedInView === filteredItems.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    function renderRows(list) {
      if (!rowsTbody) return;
      rowsTbody.innerHTML = '';
      if (!Array.isArray(list) || !list.length) {
        showEmpty('No released beneficiaries match your filters.');
        updateSelectAllState();
        return;
      }
      hideEmpty();
      for (var i = 0; i < list.length; i++) {
        var item = list[i];
        if (!item) continue;
        var tr = document.createElement('tr');
        if (selectedKeys.has(item.beneficiaryKey)) {
          tr.classList.add('selected');
        }
        var tdCheck = document.createElement('td');
        tdCheck.className = 'picker-checkbox';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.key = item.beneficiaryKey || '';
        cb.checked = selectedKeys.has(item.beneficiaryKey);
        cb.disabled = loading;
        cb.setAttribute('aria-label', 'Select ' + (item.beneficiary || 'beneficiary'));
        tdCheck.appendChild(cb);
        tr.appendChild(tdCheck);

        var tdIndex = document.createElement('td');
        tdIndex.textContent = String(i + 1);
        tr.appendChild(tdIndex);

        var tdBeneficiary = document.createElement('td');
        tdBeneficiary.textContent = item.beneficiary || '';
        tr.appendChild(tdBeneficiary);

        var tdDesignation = document.createElement('td');
        tdDesignation.textContent = item.designation || '—';
        tr.appendChild(tdDesignation);

        var tdProject = document.createElement('td');
        tdProject.textContent = item.project || '—';
        tr.appendChild(tdProject);

        var tdTeam = document.createElement('td');
        tdTeam.textContent = item.team || '—';
        tr.appendChild(tdTeam);

        var tdAccount = document.createElement('td');
        tdAccount.textContent = item.accountHolder || '—';
        tr.appendChild(tdAccount);

        var tdIdle = document.createElement('td');
        tdIdle.className = 'numeric';
        var idleText = (typeof item.idleDays === 'number' && item.idleDays >= 0) ? String(item.idleDays) : '—';
        tdIdle.textContent = idleText;
        if (item.releasedAt) {
          var releaseDate = new Date(item.releasedAt);
          if (!isNaN(releaseDate.getTime())) {
            tdIdle.title = 'Released on ' + releaseDate.toLocaleString();
          }
        }
        tr.appendChild(tdIdle);

        var tdNationality = document.createElement('td');
        tdNationality.textContent = item.nationality || '—';
        tr.appendChild(tdNationality);

        var tdRemarks = document.createElement('td');
        renderRemarkHistoryCell(tdRemarks, item.lastRemarks);
        tr.appendChild(tdRemarks);

        var tdRatings = document.createElement('td');
        renderRatingHistoryCell(tdRatings, item.lastRatings);
        tr.appendChild(tdRatings);

        rowsTbody.appendChild(tr);
      }
      updateSelectAllState();
    }

    function applyFilterNow() {
      var term = searchInput ? searchInput.value.trim().toLowerCase() : '';
      if (!term) {
        filteredItems = allItems.slice();
      } else {
        filteredItems = allItems.filter(function(item) {
          if (!item) return false;
          var remarkText = historySearchText(item.lastRemarks);
          var ratingText = historySearchText(item.lastRatings);
          return [
            item.beneficiary,
            item.designation,
            item.project,
            item.team,
            item.accountHolder,
            item.nationality,
            remarkText,
            ratingText
          ].some(function(part) {
            return String(part || '').toLowerCase().indexOf(term) >= 0;
          });
        });
      }
      renderRows(filteredItems);
      updateCounts();
      updateApplyState();
    }

    function scheduleFilter() {
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(applyFilterNow, 120);
    }

    function namesForKeys(keys) {
      return keys.map(function(key) {
        var match = allItems.find(function(item) {
          return item && item.beneficiaryKey === key;
        });
        return match && match.beneficiary ? match.beneficiary : key;
      }).filter(Boolean);
    }

    function executeAdd(keys) {
      if (!(window.google && google.script && google.script.run)) {
        updateStatus('Beneficiary updates are only available inside the Google Sheets environment.', 'error');
        return;
      }
      setLoading(true, 'Adding beneficiaries…');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoading(false);
          if (!res || res.ok === false) {
            updateStatus(res && res.error ? res.error : 'Failed to induct beneficiaries.', 'error');
            updateApplyState();
            return;
          }

          if (typeof res.project === 'string') currentContext.project = res.project;
          if (typeof res.team === 'string') currentContext.team = res.team;
          updateSubtitle();

          var addedKeys = Array.isArray(res.addedKeys) ? new Set(res.addedKeys) : new Set(keys);
          if (addedKeys.size) {
            allItems = allItems.filter(function(item) {
              return !(item && addedKeys.has(item.beneficiaryKey));
            });
          }

          filteredItems = allItems.slice();
          selectedKeys.clear();
          applyFilterNow();

          if (res && typeof res.remaining === 'number' && isFinite(res.remaining)) {
            setReleasedCount(res.remaining);
          } else {
            setReleasedCount(allItems.length);
          }

          var addedCount = res.inserted || addedKeys.size || 0;
          var statusMsg = addedCount
            ? ('Added ' + addedCount + ' beneficiary' + (addedCount === 1 ? '' : 'ies') + ' to ' + (currentContext.project || 'project') + (currentContext.team ? ' • ' + currentContext.team : '') + '.')
            : 'No beneficiaries were added.';

          if (Array.isArray(res.skipped) && res.skipped.length) {
            var skippedKeys = res.skipped.map(function(info) { return info && info.key; }).filter(Boolean);
            var skippedNames = namesForKeys(skippedKeys);
            if (skippedNames.length) {
              statusMsg += ' Skipped: ' + skippedNames.join(', ') + '.';
            }
          }

          updateStatus(statusMsg, addedCount ? 'success' : null);
          updateApplyState();

          if (res && Array.isArray(res.beneficiaries) && res.beneficiaries.length && typeof window.appendRowsFromBeneficiaries === 'function') {
            try {
              window.appendRowsFromBeneficiaries(res.beneficiaries);
            } catch (appendErr) {
              console.warn('appendRowsFromBeneficiaries failed:', appendErr);
            }
          }

          try {
            document.dispatchEvent(new CustomEvent('frtz:beneficiary-inducted', {
              detail: {
                project: currentContext.project,
                team: currentContext.team,
                beneficiaries: res && res.beneficiaries ? res.beneficiaries : []
              }
            }));
          } catch (_eventErr) {}
        })
        .withFailureHandler(function(err) {
          setLoading(false);
          console.error('inductReleasedBeneficiaries failed:', err);
          updateStatus('Failed to induct beneficiaries. Please try again.', 'error');
          updateApplyState();
        })
        .inductReleasedBeneficiaries({
          project: currentContext.project,
          team: currentContext.team,
          beneficiaryKeys: keys
        });
    }

    function performAdd() {
      if (loading || !selectedKeys.size) return;
      if (!currentContext.project) {
        updateStatus('Project information is missing for this row.', 'error');
        return;
      }
      var keys = Array.from(selectedKeys);
      var names = namesForKeys(keys);
      var targetLabel = currentContext.project + (currentContext.team ? ' • ' + currentContext.team : '');
      var message = names.length === 1
        ? 'Are you sure you want to induct ' + names[0] + ' into ' + targetLabel + '?'
        : 'Are you sure you want to induct ' + names.length + ' beneficiaries into ' + targetLabel + '?';

      showConfirmationModal({
        title: 'Induct beneficiaries?',
        message: message,
        yesText: 'Yes, Induct',
        noText: 'Cancel'
      }).then(function(confirmed) {
        if (!confirmed) return;
        executeAdd(keys);
      });
    }

    function close() {
      overlay.classList.remove('show');
      overlay.classList.remove('loading');
      if (searchTimer) {
        clearTimeout(searchTimer);
        searchTimer = null;
      }
      document.removeEventListener('keydown', onKeydown);
    }

    function open(context) {
      context = context || {};
      currentContext.project = context.project ? String(context.project).trim() : '';
      currentContext.team = context.team ? String(context.team).trim() : '';
      selectedKeys.clear();
      updateStatus('');
      updateSubtitle();
      hideEmpty();
      if (searchInput) searchInput.value = '';
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        selectAll.disabled = true;
      }
      allItems = [];
      filteredItems = [];
      renderRows(filteredItems);
      updateCounts();
      updateApplyState();

      overlay.classList.add('show');
      setTimeout(function() {
        try { if (searchInput) searchInput.focus(); } catch (_e) {}
      }, 120);
      document.addEventListener('keydown', onKeydown);

      if (!(window.google && google.script && google.script.run)) {
        updateStatus('Beneficiary picker is only available inside the Google Sheets web app.', 'error');
        showEmpty('Open this sheet in the Google Sheets web app to induct released beneficiaries.');
        return;
      }

      setLoading(true, 'Loading released beneficiaries…');
      google.script.run
        .withSuccessHandler(function(res) {
          setLoading(false);
          if (!res || res.ok === false) {
            updateStatus(res && res.error ? res.error : 'Unable to load released beneficiaries.', 'error');
            showEmpty('No released beneficiaries found.');
            setReleasedCount(null);
            allItems = [];
            filteredItems = [];
            updateCounts();
            updateApplyState();
            updateSelectAllState();
            return;
          }

          if (typeof res.targetProject === 'string') currentContext.project = res.targetProject;
          if (typeof res.targetTeam === 'string') currentContext.team = res.targetTeam;
          updateSubtitle();

          var total = (typeof res.total === 'number' && isFinite(res.total))
            ? res.total
            : (Array.isArray(res.beneficiaries) ? res.beneficiaries.length : null);
          setReleasedCount(total);

          allItems = Array.isArray(res.beneficiaries) ? res.beneficiaries : [];
          filteredItems = allItems.slice();
          applyFilterNow();
          if (!allItems.length) {
            showEmpty('No released beneficiaries are available right now.');
          }
        })
        .withFailureHandler(function(err) {
          setLoading(false);
          console.error('getReleasedBeneficiariesForInduction failed:', err);
          updateStatus('Unable to load released beneficiaries. Please try again.', 'error');
          showEmpty('No released beneficiaries found.');
          setReleasedCount(null);
          allItems = [];
          filteredItems = [];
          updateCounts();
          updateApplyState();
          updateSelectAllState();
        })
        .getReleasedBeneficiariesForInduction(currentContext.project, currentContext.team);
    }

    function onKeydown(e) {
      if (e.key === 'Escape' && overlay.classList.contains('show')) {
        close();
      }
    }

    if (cancelBtn) cancelBtn.addEventListener('click', close);
    if (closeBtn) closeBtn.addEventListener('click', close);
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) close();
    });

    if (searchInput) searchInput.addEventListener('input', scheduleFilter);

    if (selectAll) {
      selectAll.addEventListener('change', function() {
        if (loading) return;
        var checked = !!selectAll.checked;
        filteredItems.forEach(function(item) {
          if (!item || !item.beneficiaryKey) return;
          if (checked) {
            selectedKeys.add(item.beneficiaryKey);
          } else {
            selectedKeys.delete(item.beneficiaryKey);
          }
        });
        if (rowsTbody) {
          Array.prototype.forEach.call(rowsTbody.querySelectorAll('input[type="checkbox"][data-key]'), function(box) {
            box.checked = checked;
            var row = box.closest('tr');
            if (row) row.classList.toggle('selected', box.checked);
          });
        }
        selectAll.indeterminate = false;
        updateApplyState();
      });
    }

    if (rowsTbody) {
      rowsTbody.addEventListener('change', function(e) {
        var cb = e.target.closest('input[type="checkbox"][data-key]');
        if (!cb || loading) return;
        var key = cb.dataset.key || '';
        if (!key) return;
        if (cb.checked) {
          selectedKeys.add(key);
        } else {
          selectedKeys.delete(key);
        }
        var row = cb.closest('tr');
        if (row) row.classList.toggle('selected', cb.checked);
        updateApplyState();
        updateSelectAllState();
      });

      rowsTbody.addEventListener('click', function(e) {
        var row = e.target.closest('tr');
        if (!row || loading) return;
        var cb = row.querySelector('input[type="checkbox"][data-key]');
        if (!cb || e.target === cb) return;
        cb.checked = !cb.checked;
        cb.dispatchEvent(new Event('change', { bubbles: true }));
      });
    }

    if (applyBtn) applyBtn.addEventListener('click', performAdd);

    window.FRTZ = window.FRTZ || {};
    window.FRTZ.onReleasedBeneficiaryCountChange = onReleasedCountChange;
    window.FRTZ.getReleasedBeneficiaryCount = function() { return releasedCount; };
    window.FRTZ.refreshReleasedBeneficiaryCount = refreshReleasedCount;

    return {
      open: open,
      close: close
    };
  })();

  function coerceCount(value) {
    if (typeof value === 'number' && isFinite(value) && value >= 0) {
      return Math.floor(value);
    }
    if (typeof value === 'string' && value.trim() !== '') {
      var parsed = Number(value);
      if (Number.isFinite(parsed) && parsed >= 0) {
        return Math.floor(parsed);
      }
    }
    return null;
  }

  function openAddBeneficiaryModal(context) {
    try {
      addBeneficiaryPicker.open(context || {});
    } catch (err) {
      console.error('openAddBeneficiaryModal failed:', err);
      alert('Unable to open the Add Existing Beneficiary dialog. Please try again.');
    }
  }

  function formatExistingBeneficiaryLabel(count) {
    var normalized = coerceCount(count);
    if (normalized === null) {
      return 'Add Existing Beneficiary [—]';
    }
    return 'Add Existing Beneficiary [' + normalized + ']';
  }

  function updateExistingBeneficiaryButton(count) {
    var text = formatExistingBeneficiaryLabel(count);
    var normalized = coerceCount(count);
    if (typeof window.updateConfirmationButton === 'function') {
      window.updateConfirmationButton('add-existing', {
        text: text,
        dataset: { releasedCount: normalized != null ? normalized : '' }
      });
    } else {
      var btn = document.querySelector('.confirmation-buttons button[data-button-id="add-existing"]');
      if (btn) {
        btn.textContent = text;
        btn.dataset.originalText = text;
        if (normalized == null) {
          delete btn.dataset.releasedCount;
        } else {
          btn.dataset.releasedCount = normalized;
        }
      }
    }
  }

  window.updateExistingBeneficiaryButton = updateExistingBeneficiaryButton;

  function triggerAddNewBeneficiary(context) {
    try {
      var detail = context && typeof context === 'object' ? context : {};
      document.dispatchEvent(new CustomEvent('frtz:add-new-beneficiary', { detail: detail }));
    } catch (err) {
      console.error('dispatch add-new-beneficiary event failed', err);
    }

    if (window.FRTZ && typeof window.FRTZ.openNewBeneficiaryDialog === 'function') {
      window.FRTZ.openNewBeneficiaryDialog(context || {});
      return;
    }

    if (window.FRTZ && window.FRTZ.addRowBtn) {
      try {
        window.FRTZ.addRowBtn.click();
        return;
      } catch (errClick) {
        console.error('click addRowBtn failed', errClick);
      }
    }

    alert('Please use the Add Rows button to add a new beneficiary.');
  }

  window.FRTZ = window.FRTZ || {};
  if (!window.FRTZ.buildReleaseContext) {
    window.FRTZ.buildReleaseContext = buildReleaseContext;
  }
  
  // Add click handler for row total pills
  tbody.addEventListener('click', function(e) {
    var totalInput = e.target.closest('input.amt[readonly]');
    if (!totalInput) return;

    var row = totalInput.closest('.row-data');
    if (!row) return;
    if (row.classList.contains('row-action-pending')) return;

    var context = buildReleaseContext(row);
    var totalText = totalInput.value ? String(totalInput.value).trim() : '';

    if (row.classList.contains('row-deactivated')) {
      promptReactivateRow(row, context, totalText);
    } else {
      promptRowAction(row, context, totalText);
    }
  });

  // Car number input click handler will be attached after modal is loaded

  return true;
}

var initialTbody = document.getElementById('tbody');
if (!initTableModule(initialTbody)) {
  document.addEventListener('DOMContentLoaded', function handleFRTZTableInit() {
    var lateTbody = document.getElementById('tbody');
    if (initTableModule(lateTbody)) {
      document.removeEventListener('DOMContentLoaded', handleFRTZTableInit);
    }
  });
}

})();

// Include Car Release Modal HTML and JavaScript
// Car Modal HTML
// Note: Car modal HTML is now loaded from _CarReleaseSystem.html to avoid duplication

// Car assignment modal removed

// Note: Car modal CSS is now loaded from _CarReleaseSystem.html to avoid duplication

// CSS is now loaded from external files to avoid duplication and syntax conflicts

// Car Release System JavaScript - Using global instance from _CarReleaseSystem.html
// The CarReleaseSystem class and instance are defined in _CarReleaseSystem.html

// Global car data storage
let availableCars = [];

// loadAvailableCars: no longer used (car assignment removed)

// Populate car filter dropdowns
function populateCarFilters() {
  const makeFilter = document.getElementById('car-make-filter');
  const modelFilter = document.getElementById('car-model-filter');
  const carNumberFilter = document.getElementById('car-number-filter');
  
  if (!makeFilter || !modelFilter || !carNumberFilter) return;
  
  // Clear existing options (except first default option)
  makeFilter.innerHTML = '<option value="">Select Make</option>';
  modelFilter.innerHTML = '<option value="">Select Model</option>';
  carNumberFilter.innerHTML = '<option value="">Select Vehicle Number</option>';
  
  // Get unique makes
  const makes = [...new Set(availableCars.map(car => car.make))].sort();
  makes.forEach(make => {
    const option = document.createElement('option');
    option.value = make;
    option.textContent = make;
    makeFilter.appendChild(option);
  });
}

// Filter models based on selected make
function filterModelsByMake() {
  const makeFilter = document.getElementById('car-make-filter');
  const modelFilter = document.getElementById('car-model-filter');
  const carNumberFilter = document.getElementById('car-number-filter');
  
  if (!makeFilter || !modelFilter || !carNumberFilter) return;
  
  const selectedMake = makeFilter.value;
  
  // Clear model and car number filters
  modelFilter.innerHTML = '<option value="">Select Model</option>';
  carNumberFilter.innerHTML = '<option value="">Select Vehicle Number</option>';
  
  if (selectedMake) {
    // Get models for selected make
    const models = [...new Set(availableCars
      .filter(car => car.make === selectedMake)
      .map(car => car.model))].sort();
    
    models.forEach(model => {
      const option = document.createElement('option');
      option.value = model;
      option.textContent = model;
      modelFilter.appendChild(option);
    });
  }
  
  // Hide car details section
  const carDetailsSection = document.getElementById('carDetailsSection');
  if (carDetailsSection) carDetailsSection.style.display = 'none';
}

// Filter car numbers based on selected make and model
function filterCarNumbers() {
  const makeFilter = document.getElementById('car-make-filter');
  const modelFilter = document.getElementById('car-model-filter');
  const carNumberFilter = document.getElementById('car-number-filter');
  
  if (!makeFilter || !modelFilter || !carNumberFilter) return;
  
  const selectedMake = makeFilter.value;
  const selectedModel = modelFilter.value;
  
  // Clear car number filter
  carNumberFilter.innerHTML = '<option value="">Select Vehicle Number</option>';
  
  if (selectedMake && selectedModel) {
    // Get car numbers for selected make and model
    const carNumbers = availableCars
      .filter(car => car.make === selectedMake && car.model === selectedModel)
      .map(car => car.carNumber)
      .sort();
    
    carNumbers.forEach(carNumber => {
      const option = document.createElement('option');
      option.value = carNumber;
      option.textContent = carNumber;
      carNumberFilter.appendChild(option);
    });
  }
  
  // Hide car details section
  const carDetailsSection = document.getElementById('carDetailsSection');
  if (carDetailsSection) carDetailsSection.style.display = 'none';
}

// Display car details when car is selected
function displayCarDetails() {
  const carNumberFilter = document.getElementById('car-number-filter');
  const carDetailsSection = document.getElementById('carDetailsSection');
  
  if (!carNumberFilter || !carDetailsSection) return;
  
  const selectedCarNumber = carNumberFilter.value;
  
  if (selectedCarNumber) {
    const selectedCar = availableCars.find(car => car.carNumber === selectedCarNumber);
    
    if (selectedCar) {
      // Populate usage type dropdown dynamically from CarT_P data
      const usageTypeSelect = document.getElementById('car-usage-type');
      if (usageTypeSelect && window.availableCarsData) {
        const uniqueUsageTypes = [...new Set(window.availableCarsData.map(car => car.usageType).filter(type => type && type.trim()))];
        usageTypeSelect.innerHTML = uniqueUsageTypes.map(type => 
          `<option value="${type}" ${selectedCar.usageType === type ? 'selected' : ''}>${type}</option>`
        ).join('');
      }
      
      // Populate contract type dropdown dynamically from CarT_P data
      const contractTypeSelect = document.getElementById('car-contract-type');
      if (contractTypeSelect && window.availableCarsData) {
        const uniqueContractTypes = [...new Set(window.availableCarsData.map(car => car.contractType).filter(type => type && type.trim()))];
        contractTypeSelect.innerHTML = uniqueContractTypes.map(type => 
          `<option value="${type}" ${selectedCar.contractType === type ? 'selected' : ''}>${type}</option>`
        ).join('');
      }
      
      // Set owner information (non-editable)
      const ownerInfo = document.getElementById('car-owner-info');
      if (ownerInfo) {
        ownerInfo.value = selectedCar.owner || 'N/A';
      }
      
      // Display last 3 remarks
      const remarksList = document.getElementById('car-remarks-list');
      if (remarksList && selectedCar.remarks) {
        remarksList.innerHTML = '';
        selectedCar.remarks.slice(0, 3).forEach((remark, index) => {
          const remarkItem = document.createElement('div');
          remarkItem.className = 'remark-item';
          remarkItem.innerHTML = `
            <span class="remark-text">${remark}</span>
            <span class="remark-date">${selectedCar.dates ? selectedCar.dates[index] : 'N/A'}</span>
          `;
          remarksList.appendChild(remarkItem);
        });
      }
      
      // Display last 3 ratings
      const ratingsList = document.getElementById('car-ratings-list');
      if (ratingsList && selectedCar.ratings) {
        ratingsList.innerHTML = '';
        selectedCar.ratings.slice(0, 3).forEach((rating, index) => {
          const ratingItem = document.createElement('div');
          ratingItem.className = 'rating-item';
          
          const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
          ratingItem.innerHTML = `
            <span class="rating-stars">${stars}</span>
            <span class="rating-date">${selectedCar.dates ? selectedCar.dates[index] : 'N/A'}</span>
          `;
          ratingsList.appendChild(ratingItem);
        });
      }
      
      // Show car details section
      carDetailsSection.style.display = 'block';
    }
  } else {
    // Hide car details section if no car selected
    carDetailsSection.style.display = 'none';
  }
}

// Note: Global functions openCarModal and closeCarModal are now defined in _CarReleaseSystem.html

// Add event listeners for car filtering
document.addEventListener('DOMContentLoaded', function() {
  const makeFilter = document.getElementById('car-make-filter');
  const modelFilter = document.getElementById('car-model-filter');
  const carNumberFilter = document.getElementById('car-number-filter');
  
  if (makeFilter) {
    makeFilter.addEventListener('change', filterModelsByMake);
  }
  
  if (modelFilter) {
    modelFilter.addEventListener('change', filterCarNumbers);
  }
  
  if (carNumberFilter) {
    carNumberFilter.addEventListener('change', displayCarDetails);
  }
});

// Car assignment modal removed

// Helper function to get project from beneficiary (placeholder)
function getProjectFromBeneficiary(beneficiaryName) {
  // This is a placeholder - you can enhance this to fetch actual project data
  // from Google Apps Script or local data
  return 'Tanzania Fund Request Project';
}

// (Removed legacy Car Assignment Modal listeners)

</script>

<!-- Car assignment modal removed -->

<script>
// Only keeping the car number click handlers here

(function() {
  'use strict';
  const normalizeCarRecord = (car) => {
    if (!car) return null;
    const get = (...keys) => {
      for (const key of keys) {
        if (key in car && car[key] != null) {
          const val = String(car[key]).trim();
          if (val) return val;
        }
      }
      return '';
    };
    const carNumber = get('carNumber','car_number','car','vehicleNumber','vehicle_number');
    const make = get('make','Make','brand','Brand');
    const model = get('model','Model');
    const usageType = get('usageType','usage_type','Usage Type','usage','Usage');
    const contractType = get('contractType','contract_type','Contract Type','contract','Contract','agreementType','Agreement Type');
    const owner = get('owner','Owner','ownerName','Owner Name');
    const status = get('status','Status','inUseRelease','In Use/Release');
    const remarksRaw = get('remarks','Remarks','feedback','Feedback');
    const stars = get('stars','rating','Rating');
    const category = get('category','Category','vehicleCategory','Vehicle Category','Cat');
    const responsibleBeneficiary = get('responsibleBeneficiary','Responsible Beneficiary','R.Beneficiary','R Beneficiary','R. Ben','responsible');
    let lastUsers = car.lastUsers;
    if (!Array.isArray(lastUsers)) {
      const lu = get('lastUsers','Last Users','users','Users','Last Used By');
      lastUsers = lu ? lu.split(',').map(u=>u.trim()).filter(Boolean) : [];
    }
    return {
      ...car,
      carNumber: carNumber || car.carNumber || '',
      make,
      model,
      usageType,
      contractType,
      owner,
      status,
      category,
      responsibleBeneficiary,
      'R.Beneficiary': car['R.Beneficiary'] || car['R. Ben'] || responsibleBeneficiary || '',
      'R. Ben': car['R. Ben'] || car['R.Beneficiary'] || responsibleBeneficiary || '',
      remarks: remarksRaw || car.remarks || '',
      stars: stars || car.stars || 0,
      lastUsers: lastUsers.length ? lastUsers : (Array.isArray(car.lastUsers) ? car.lastUsers : [])
    };
  };
  // Car number click handlers - essential functionality only
  
  // Essential car number click handlers only
  
  // Attach click handlers immediately
  attachCarNumberClickHandlers();



  
  // Function to attach car number click handlers
  function resolveRowTeam(row) {
    if (!row) return '';
    const ds = row.dataset || {};
    let team = (ds.teamName || ds.team || ds.teamid || row.getAttribute('data-team') || '').trim();
    if (!team && typeof window.getActualTeamNameFromRow === 'function') {
      try { team = (window.getActualTeamNameFromRow(row) || '').trim(); } catch(_){ /* ignore */ }
    }
    if (!team) {
      const benInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
      const ben = benInput ? benInput.value.trim() : '';
      if (ben && window.bDet && window.bDet[ben]) {
        team = (window.bDet[ben].teamName || window.bDet[ben].team || '').trim();
      }
    }
    if (team && team.toLowerCase() === 'unknown team') return '';
    return team;
  }

  function resolveRowProject(row) {
    if (!row) return '';
    const ds = row.dataset || {};
    let project = (row.getAttribute('data-project') || ds.project || '').trim();
    if (!project) {
      const headerEl = document.getElementById('selectedProjectName');
      if (headerEl && headerEl.textContent.trim()) {
        project = headerEl.textContent.trim().split(' [')[0];
      }
    }
    if (!project) {
      const benInput = row.querySelector('input.txt:not(.account-holder-input):not(.car-number-input)');
      const ben = benInput ? benInput.value.trim() : '';
      if (ben && window.bDet && window.bDet[ben]) {
        project = (window.bDet[ben].project || '').trim();
      }
    }
    if (project && project.toLowerCase() === 'unknown project') return '';
    return project;
  }

  function attachCarNumberClickHandlers() {
      // Ensure click handlers are attached after modal is loaded
      setTimeout(() => {
        // Attach car number input click handler for fragmented approach
        document.addEventListener('click', function(event) {
          if (event.target.classList.contains('car-number-input')) {
            console.log('Car number input clicked:', event.target);
            const carNumberValue = event.target.value.trim();
            console.log('Car number value:', carNumberValue);
            
            if (carNumberValue) {
              console.log('Car number filled, opening release modal for:', carNumberValue);

              const row = event.target.closest('.row-data');
              const resolvedTeam = resolveRowTeam(row);
              const resolvedProject = resolveRowProject(row);
              let baseCarData = {
                carNumber: carNumberValue,
                project: resolvedProject || 'Unknown Project',
                projectName: resolvedProject || '',
                team: resolvedTeam || 'Unknown Team',
                teamName: resolvedTeam || '',
                category: row ? (row.getAttribute('data-category') || '') : '',
                make: 'Unknown Make',
                model: 'Unknown Model',
                usageType: 'Unknown Usage',
                contractType: 'Unknown Contract',
                owner: 'Unknown Owner',
                status: 'IN USE',
                lastUsers: ['Current User'],
                remarks: '',
                stars: 0,
                submitter: 'Current User',
                responsibleBeneficiary: (event.target?.dataset?.responsibleBeneficiary || '').trim()
              };

              const openModalWith = (carData) => {
                if (typeof window.openCarModal === 'function') {
                  window.openCarModal(carData, { carInput: event.target });
                } else {
                  console.error('Car modal function not available');
                }
              };

              const applySupplemental = (extraData) => {
                if (!extraData) return;
                const normalized = normalizeCarRecord(extraData);
                if (!normalized) return;
                const merged = { ...normalized };
                merged.project = baseCarData.project || merged.project || merged.Project || '';
                merged.projectName = baseCarData.projectName || merged.projectName || merged.Project || merged.project || '';
                merged.team = baseCarData.team || merged.team || merged.Team || '';
                merged.teamName = baseCarData.teamName || merged.teamName || merged.Team || merged.team || '';
                merged.category = baseCarData.category || merged.category || merged.Category || '';
                if (baseCarData.projectName && !merged.projectName) merged.projectName = baseCarData.projectName;
                if (baseCarData.teamName && !merged.teamName) merged.teamName = baseCarData.teamName;
                merged.responsibleBeneficiary = baseCarData.responsibleBeneficiary || merged.responsibleBeneficiary || merged['R.Beneficiary'] || merged['R. Ben'] || '';
                if (merged.responsibleBeneficiary) {
                  if (!merged['R.Beneficiary']) merged['R.Beneficiary'] = merged.responsibleBeneficiary;
                  if (!merged['R. Ben']) merged['R. Ben'] = merged.responsibleBeneficiary;
                }
                if (merged.lastUsers && !Array.isArray(merged.lastUsers)) {
                  const users = String(merged.lastUsers || '').split(',').map(u => u.trim()).filter(Boolean);
                  merged.lastUsers = users.length ? users : baseCarData.lastUsers;
                }
                if (typeof window.applyCarModalSupplementalData === 'function') {
                  window.applyCarModalSupplementalData(merged);
                } else {
                  openModalWith({ ...baseCarData, ...merged });
                }
              };

              const matchFromCached = () => {
                if (!window.availableCarsData || !window.availableCarsData.length) return null;
                const target = carNumberValue.trim().toUpperCase();
                return window.availableCarsData.find(car => String(car.carNumber || '').trim().toUpperCase() === target) || null;
              };

              openModalWith(baseCarData);

              const cached = matchFromCached();
              if (cached) {
                applySupplemental(cached);
                return;
              }

              if (window.google && google.script && google.script.run) {
                google.script.run
                  .withSuccessHandler(function(list){
                    if (Array.isArray(list) && list.length) {
                      const normalizedList = list.map(normalizeCarRecord);
                      try { window.availableCarsData = normalizedList; } catch(_){ window.availableCarsData = normalizedList; }
                      const freshMatch = matchFromCached();
                      applySupplemental(freshMatch || null);
                    } else {
                      applySupplemental(null);
                    }
                  })
                  .withFailureHandler(function(err){
                    console.error('Failed to fetch vehicle metadata', err);
                    applySupplemental(null);
                  })
                  .getAllUniqueCars();
              } else {
                applySupplemental(null);
              }
            }
            else {
              // Empty Vehicle Number: open vehicle picker dropdown modal
              if (typeof window.openVehiclePicker === 'function') {
                window.openVehiclePicker(event.target);
              } else {
                alert('Vehicle picker is not available. Please refresh the page.');
              }
            }
          }
        });
        
        // Debug elements removed - modal should work normally now
      }, 100);
    }
})();
</script>

<script>
// --- Vehicle Number Assignment Logic ---
(function(){
  'use strict';
  
  // Global storage for vehicle assignments (only for manual popup selections)
  window.vehicleAssignments = {};
  
  // Function to store vehicle assignment (only used by vehicle popup)
  function storeVehicleAssignment(vehicleNumber, responsibleBeneficiary) {
    window.vehicleAssignments[vehicleNumber] = responsibleBeneficiary;
  }
  
  // Function to get responsible beneficiary for a vehicle (only used by vehicle popup)
  function getResponsibleBeneficiary(vehicleNumber) {
    return window.vehicleAssignments[vehicleNumber] || null;
  }
  
  // [REMOVED] All automatic vehicle assignment functions - only manual popup selection allowed
  // [REMOVED] Automatic clearing and monitoring - only manual popup selection allowed

})();
</script>

<script>
// [REMOVED] Legacy backend clearing hook – vehicle assignments now managed exclusively via release summary refresh.
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// [REMOVED] All automatic vehicle assignment logic - only vehicle popup selection allowed
</script>

<script>
// --- Make Beneficiary Fields Non-Editable ---
(function(){
  'use strict';
  
  // Function to make beneficiary inputs readonly
  function makeBeneficiaryInputsReadonly() {
    const rows = document.querySelectorAll('.tbody .row-data');
    rows.forEach(row => {
      const benInput = row.querySelector('.cell:first-child input.txt');
      if (benInput) {
        benInput.setAttribute('readonly', 'true');
        benInput.style.cursor = 'default';
        benInput.style.backgroundColor = '#f8f9fa';
        benInput.style.pointerEvents = 'none';
        benInput.style.userSelect = 'none';
        
        // Prevent any editing attempts
        benInput.addEventListener('keydown', function(e) {
          e.preventDefault();
          return false;
        });
        
        benInput.addEventListener('input', function(e) {
          e.preventDefault();
          return false;
        });
        
        benInput.addEventListener('paste', function(e) {
          e.preventDefault();
          return false;
        });
      }
    });
  }
  
  // Apply to existing rows
  makeBeneficiaryInputsReadonly();
  
  // Observer for dynamically added rows
  const tbody = document.getElementById('tbody');
  if (tbody) {
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.classList.contains('row-data')) {
              const benInput = node.querySelector('.cell:first-child input.txt');
              if (benInput) {
                benInput.setAttribute('readonly', 'true');
                benInput.style.cursor = 'default';
                benInput.style.backgroundColor = '#f8f9fa';
                benInput.style.pointerEvents = 'none';
                benInput.style.userSelect = 'none';
                
                // Prevent any editing attempts
                benInput.addEventListener('keydown', function(e) {
                  e.preventDefault();
                  return false;
                });
                
                benInput.addEventListener('input', function(e) {
                  e.preventDefault();
                  return false;
                });
                
                benInput.addEventListener('paste', function(e) {
                  e.preventDefault();
                  return false;
                });
              }
            }
          });
        }
      });
    });
    
    observer.observe(tbody, { childList: true, subtree: true });
  }
  
  // Also apply when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', makeBeneficiaryInputsReadonly);
  }
})();
</script>

<script>
// --- Manual Vehicle Entry with CarT_P Integration ---
(function(){
  'use strict';
  
  console.log('[MANUAL_VEHICLE] Initializing manual vehicle entry system');
  
  // [REMOVED] enableManualVehicleEntry function - no manual vehicle entry system
  
  // [REMOVED] saveManualVehicleAssignment function - no manual vehicle entry system
  
  // [REMOVED] attachManualEntryHandlers function - no manual vehicle entry system
  
  // [REMOVED] handleManualVehicleEntry function - no manual vehicle entry system
  
  // [REMOVED] initializeManualVehicleEntry function - no manual vehicle entry system
  
  // [REMOVED] DOMContentLoaded handler for manual vehicle entry - no manual vehicle entry system
  
  // [REMOVED] Global function exports for manual vehicle entry - no manual vehicle entry system
})();
</script>
